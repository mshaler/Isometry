# v4.4 SuperGrid PAFV Projection

**Created:** 2026-02-10
**Status:** Proposed
**Dependencies:** v4.3 Navigator Integration (Phase 51 complete)

## Problem Statement

Navigator drag-drop successfully updates PAFV axis mappings in context and URL, but **SuperGrid does not consume these mappings** to position cards in a 2D grid. The chain is broken:

```
Navigator → PAFVContext → URL ✅
PAFVContext → SuperGrid → 2D Projection ❌ NOT IMPLEMENTED
```

**Current behavior:** Cards render as flat list regardless of axis configuration.
**Expected behavior:** Cards position based on X-axis (column) and Y-axis (row) facet values.

## Scope

### In Scope
- SuperGrid consuming PAFV axis mappings from context
- 2D cell positioning based on X and Y axis facet values
- Header generation from unique axis values
- View transitions when axis mappings change

### Out of Scope
- Color/Size/Shape plane projections (future phase)
- GRAPH bucket axis support (research needed)
- SuperStack nested headers (separate feature)
- SuperDensity Janus controls (already implemented)

## Success Criteria

| ID | Requirement | Verification |
|----|-------------|--------------|
| PROJ-01 | SuperGrid reads current axis mappings from PAFVContext | grep for usePAFV in SuperGrid or GridRenderingEngine |
| PROJ-02 | X-axis mapping determines column headers and card positioning | Visual: change X axis → columns reorganize |
| PROJ-03 | Y-axis mapping determines row headers and card positioning | Visual: change Y axis → rows reorganize |
| PROJ-04 | Cards with same X+Y values appear in same cell | Visual: multiple cards in single cell |
| PROJ-05 | Changing axis mapping triggers smooth transition | Visual: animated reposition when dragging new facet |
| PROJ-06 | Empty cells render appropriately (sparse vs dense mode) | Visual: toggle shows/hides empty cells |

## Technical Approach

### Phase 56: PAFV Projection Core

**Goal:** Wire SuperGrid to consume PAFV axis mappings and compute 2D positions

#### Plan 56-01: PAFV State Consumption
- Add `usePAFV()` hook to SuperGridDemo or parent component
- Pass axis mappings to SuperGrid constructor/config
- Add `configureProjection(mappings: AxisMapping[])` method to SuperGrid

#### Plan 56-02: Position Computation
- Extract unique values for X-axis facet → column headers
- Extract unique values for Y-axis facet → row headers
- Compute (row, col) position for each card based on facet values
- Handle null/undefined facet values (unassigned bucket)

#### Plan 56-03: Rendering Integration
- Update GridRenderingEngine to use computed positions
- Generate header elements from unique axis values
- Animate card transitions when positions change

### Phase 57: Header Generation

**Goal:** Dynamic row/column headers from axis values

#### Plan 57-01: Column Headers
- Query unique X-axis facet values from current dataset
- Render as clickable headers with sort capability
- Handle facet type (date → format, category → label)

#### Plan 57-02: Row Headers
- Query unique Y-axis facet values from current dataset
- Render as expandable/collapsible row headers
- Support hierarchy nesting (future: SuperStack)

### Phase 58: Transitions & Polish

**Goal:** Smooth animations when axis mappings change

#### Plan 58-01: FLIP Animations
- Calculate before/after positions for all cards
- Apply D3 transitions with easing
- Handle enter/exit for new/removed cells

#### Plan 58-02: Empty Cell Handling
- Dense mode: show only cells with cards
- Sparse mode: show full Cartesian grid
- Toggle via Janus density controls

## Architecture Changes

### Files to Modify

| File | Change |
|------|--------|
| `src/d3/SuperGrid.ts` | Add `configureProjection()` method, read PAFV state |
| `src/d3/grid-rendering/GridRenderingEngine.ts` | Compute 2D positions from axis mappings |
| `src/demos/SuperGridDemo.tsx` | Pass PAFV state to SuperGrid |
| `src/types/grid.ts` | Add `PAFVProjection` to GridConfig |

### New Types

```typescript
interface PAFVProjection {
  xAxis: { axis: LATCHAxis; facet: string } | null;
  yAxis: { axis: LATCHAxis; facet: string } | null;
  colorAxis?: { axis: LATCHAxis; facet: string } | null;
}

interface GridConfig {
  // ... existing fields
  projection?: PAFVProjection;
}

interface CellPosition {
  row: number;
  col: number;
  rowValue: string;
  colValue: string;
}
```

## Estimated Effort

| Phase | Plans | Complexity | Notes |
|-------|-------|------------|-------|
| 56 | 3 | Medium | Core wiring, computation |
| 57 | 2 | Medium | Header generation |
| 58 | 2 | Low | Polish, animations |
| **Total** | **7** | **Medium** | ~2 days estimated |

## Dependencies

- **Requires:** Phase 51 complete (Navigator axis mappings working)
- **Requires:** Phase 41 complete (ViewEngine architecture)
- **Blocked by:** v5.0 Type Safety (1,254 TS errors) - may want to fix types first

## Open Questions

1. **PAFV Context Location:** Use `/src/state/PAFVContext.tsx` (AxisMapping-based) or `/src/contexts/PAFVContext.tsx` (Wells-based)?
   - Recommendation: Use `/src/state/` version - it has the AxisMapping type we need

2. **Null Facet Values:** How to handle cards missing the axis facet?
   - Option A: "Unassigned" bucket row/column
   - Option B: Filter out unassigned cards
   - Recommendation: Option A for completeness

3. **Execution Timing:** Execute before or after v5.0 Type Safety?
   - Before: May create new TS errors that need fixing
   - After: Cleaner baseline but delays feature
   - Recommendation: After v5.0 for cleaner execution

## References

- Phase 41 Research: `.planning/phases/41-pafv-architectural-unification/41-RESEARCH.md`
- Phase 51 Summary: `.planning/phases/51-navigator-integration/51-02-SUMMARY.md`
- SuperGrid Implementation: `src/d3/SuperGrid.ts`
- PAFV Context: `src/state/PAFVContext.tsx`
