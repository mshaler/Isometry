---
phase: 30-apple-notes-data-lifecycle-management
plan: 05
type: tdd
wave: 5
depends_on: ["30-04"]
files_modified: [
  "native/Tests/PropertyBasedTests/NotesDataLifecyclePropertyTests.swift",
  "native/Sources/Isometry/Testing/PropertyBasedTestFramework.swift",
  "native/Sources/Isometry/Testing/DataGenerators.swift"
]
autonomous: true

must_haves:
  truths:
    - "Property-based tests validate data lifecycle invariants with random inputs"
    - "Round-trip testing ensures data integrity across all operation combinations"
    - "Test framework generates realistic Notes data for comprehensive validation"
    - "Property tests detect edge cases missed by traditional unit testing"
  artifacts:
    - path: "native/Tests/PropertyBasedTests/NotesDataLifecyclePropertyTests.swift"
      provides: "Comprehensive property-based test suite"
      min_lines: 600
      contains: "property-based round-trip validation"
    - path: "native/Sources/Isometry/Testing/PropertyBasedTestFramework.swift"
      provides: "Framework for property-based testing infrastructure"
      exports: ["PropertyTest", "TestData", "PropertyAssertion"]
    - path: "native/Sources/Isometry/Testing/DataGenerators.swift"
      provides: "Realistic test data generation"
      contains: "Notes data synthesis algorithms"
  key_links:
    - from: "NotesDataLifecyclePropertyTests.swift"
      to: "DataVerificationPipeline.swift"
      via: "property-based verification testing"
      pattern: "verificationPipeline\\.verifyProperty"
    - from: "PropertyBasedTestFramework.swift"
      to: "DatabaseLifecycleManager.swift"
      via: "lifecycle operation property validation"
      pattern: "lifecycleManager\\.testProperty"
---

<objective>
Implement comprehensive property-based test framework with round-trip validation, ensuring data lifecycle operations maintain invariants across all possible input combinations and detecting edge cases that traditional unit testing might miss.

Purpose: Establish highest confidence in data integrity by implementing property-based testing that validates fundamental invariants (reversibility, preservation, consistency) across the entire Apple Notes data lifecycle with randomly generated realistic test data.
Output: Production-ready property-based test framework with comprehensive round-trip validation and realistic data generation
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@native/Sources/Isometry/Import/AltoIndexImporter.swift
@native/Sources/Isometry/Verification/DataVerificationPipeline.swift
@native/Sources/Isometry/Database/DatabaseLifecycleManager.swift
@.planning/phases/30-apple-notes-data-lifecycle-management/30-04-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>RED: Create Failing Property-Based Test Framework</name>
  <files>
    native/Tests/PropertyBasedTests/NotesDataLifecyclePropertyTests.swift
    native/Sources/Isometry/Testing/PropertyBasedTestFramework.swift
  </files>
  <action>
    Write comprehensive property-based tests that will initially fail:

    1. **Core Property Tests:**
    ```swift
    func testRoundTripProperty() throws {
        PropertyTest.forAll(generateNote()) { note in
            let exported = try export(note)
            let imported = try import(exported)
            return note.isEquivalent(to: imported)
        }
    }

    func testDumpRestoreProperty() throws {
        PropertyTest.forAll(generateDatabase()) { db in
            let dump = try dump(db)
            let restored = try restore(dump)
            return db.isEquivalent(to: restored)
        }
    }

    func testPurgeProperty() throws {
        PropertyTest.forAll(generateDatabase(), generatePurgeCriteria()) { db, criteria in
            let originalCount = db.count
            let purged = try purge(db, criteria: criteria)
            return purged.count <= originalCount && purged.satisfies(criteria)
        }
    }
    ```

    2. **Property Framework Foundation:**
    - Create PropertyTest struct with forAll method for test execution
    - Implement test data generation infrastructure with shrinking
    - Add property assertion helpers for common invariants
    - Build test result aggregation and reporting

    3. **Data Generation Framework:**
    - Create realistic Notes data generators with configurable parameters
    - Generate edge cases: empty notes, large content, Unicode, attachments
    - Support shrinking for minimal failing test case identification
    - Add combinatorial generators for complex test scenarios

    Run tests - they should fail because implementations don't exist yet.
  </action>
  <verify>
    swift test --filter NotesDataLifecyclePropertyTests || echo "Expected failures - property tests not implemented"
  </verify>
  <done>
    Property-based test framework created with failing tests that define expected invariants for round-trip validation, dump/restore cycles, and data lifecycle operations
  </done>
</task>

<task type="auto">
  <name>GREEN: Implement Property-Based Test Infrastructure</name>
  <files>
    native/Sources/Isometry/Testing/PropertyBasedTestFramework.swift
    native/Sources/Isometry/Testing/DataGenerators.swift
  </files>
  <action>
    Implement property-based testing framework to make tests pass:

    1. **PropertyTest Framework Implementation:**
    ```swift
    public struct PropertyTest<T> {
        public static func forAll<U>(_ generator: DataGenerator<U>, test: (U) throws -> Bool) throws {
            for _ in 0..<100 {  // Run 100 random tests
                let testData = generator.generate()
                if try !test(testData) {
                    let shrunk = generator.shrink(testData)
                    throw PropertyTestFailure("Property failed with: \(shrunk)")
                }
            }
        }
    }
    ```

    2. **Data Generator Implementation:**
    - Create DataGenerator protocol with generate() and shrink() methods
    - Implement NoteGenerator with realistic content patterns
    - Build DatabaseGenerator for complex multi-note scenarios
    - Add AttachmentGenerator for binary content testing

    3. **Realistic Data Generation:**
    - Generate Notes with varied content (markdown, plain text, rich formatting)
    - Create realistic folder hierarchies and tag structures
    - Generate attachment content with various file types and sizes
    - Add temporal patterns (creation/modification date relationships)

    4. **Property Assertion Helpers:**
    - Implement isEquivalent methods for Node comparison
    - Add tolerance-based comparison for floating-point precision
    - Create attachment content verification helpers
    - Build database state comparison utilities

    5. **Integration with Existing Systems:**
    - Connect property tests to DataVerificationPipeline
    - Use DatabaseLifecycleManager operations in property tests
    - Integrate with ContentAwareStorageManager for attachment testing
    - Link to DatabaseVersionControl for operation testing

    Make all property tests pass by implementing the infrastructure they depend on.
  </action>
  <verify>
    swift test --filter NotesDataLifecyclePropertyTests
  </verify>
  <done>
    Property-based test framework successfully generates realistic test data and validates round-trip invariants across all data lifecycle operations
  </done>
</task>

<task type="auto">
  <name>REFACTOR: Optimize and Enhance Property Testing</name>
  <files>
    native/Tests/PropertyBasedTests/NotesDataLifecyclePropertyTests.swift
    native/Sources/Isometry/Testing/PropertyBasedTestFramework.swift
    native/Sources/Isometry/Testing/DataGenerators.swift
  </files>
  <action>
    Refactor and enhance property-based testing framework for production use:

    1. **Enhanced Property Test Coverage:**
    - Add concurrency property tests for multi-threaded operations
    - Implement temporal property tests for date-based operations
    - Add attachment property tests for binary content handling
    - Create versioning property tests for DatabaseVersionControl integration

    2. **Advanced Data Generation:**
    - Implement weighted generators for realistic data distribution
    - Add Unicode stress testing with complex character combinations
    - Create large dataset generators for performance testing
    - Add corrupted data generators for error handling validation

    3. **Sophisticated Invariant Validation:**
    - Implement deep equality checking with customizable tolerances
    - Add performance invariants (operation time bounds)
    - Create memory usage invariants for large dataset handling
    - Add consistency invariants across concurrent operations

    4. **Test Framework Optimization:**
    - Optimize generator performance for faster test execution
    - Add parallel test execution for independent properties
    - Implement intelligent shrinking for faster failure diagnosis
    - Add test result caching for regression testing

    5. **Integration and Reporting:**
    - Create detailed property test reports with statistics
    - Add integration with CI/CD pipeline for continuous validation
    - Implement property test mutation testing for framework validation
    - Add benchmarking integration for performance property tracking

    Only refactor if meaningful improvements are identified. Keep existing working functionality intact.
  </action>
  <verify>
    swift test --filter NotesDataLifecyclePropertyTests && echo "Property tests optimized and enhanced"
  </verify>
  <done>
    Property-based test framework optimized for production use with enhanced coverage, advanced data generation, and comprehensive invariant validation
  </done>
</task>

</tasks>

<verification>
1. Run complete property-based test suite: `swift test --filter PropertyBasedTests`
2. Verify property tests generate diverse realistic test data
3. Confirm round-trip validation detects data integrity issues
4. Test framework identifies edge cases missed by unit tests
5. Validate performance properties with large generated datasets
6. Confirm integration with existing verification pipeline
</verification>

<success_criteria>
- Property-based tests validate core data lifecycle invariants (reversibility, preservation)
- Test framework generates realistic Notes data covering edge cases
- Round-trip validation achieves >99.9% accuracy on generated data
- Property tests execute efficiently with 100+ random test cases per property
- Framework integrates seamlessly with existing test infrastructure
- Advanced properties validate concurrency, performance, and memory constraints
- Test results provide actionable feedback for data integrity issues
</success_criteria>

<output>
After completion, create `.planning/phases/30-apple-notes-data-lifecycle-management/30-05-SUMMARY.md`
</output>