---
phase: 30-apple-notes-data-lifecycle-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  "native/Sources/Isometry/Import/AppleNotesNativeImporter.swift",
  "native/Sources/Isometry/Import/NotesAccessManager.swift",
  "native/Sources/Isometry/Import/NotesPermissionHandler.swift",
  "native/Tests/ImportTests/AppleNotesNativeImporterTests.swift"
]
autonomous: true

must_haves:
  truths:
    - "Native Apple Notes importer accesses Notes.app database directly with TCC permissions"
    - "Notes are imported with complete metadata: title, dates, content, attachments, folders"
    - "TCC permission flow provides clear user guidance and graceful degradation"
    - "Import performance handles large libraries (10k+ notes) efficiently"
  artifacts:
    - path: "native/Sources/Isometry/Import/AppleNotesNativeImporter.swift"
      provides: "Direct Notes.app database access and parsing"
      min_lines: 400
    - path: "native/Sources/Isometry/Import/NotesAccessManager.swift"
      provides: "TCC permission management and authorization flow"
      exports: ["requestNotesAccess", "checkNotesPermission", "NotesPermissionStatus"]
    - path: "native/Sources/Isometry/Import/NotesPermissionHandler.swift"
      provides: "Permission UI flow and user guidance"
      contains: "permission flow UI components"
  key_links:
    - from: "AppleNotesNativeImporter.swift"
      to: "NotesAccessManager.swift"
      via: "permission check before database access"
      pattern: "notesAccessManager\\.checkPermission"
    - from: "NotesAccessManager.swift"
      to: "EventKit framework"
      via: "TCC authorization request"
      pattern: "EKEventStore\\.requestAccess"
---

<objective>
Implement native Apple Notes database access with comprehensive TCC permission management, enabling direct import of Notes data including attachments and folder structures while maintaining security and privacy compliance.

Purpose: Establish foundation for complete Notes data lifecycle by providing direct database access capabilities beyond alto-index exports, enabling real-time synchronization and comprehensive data import.
Output: Native Notes importer with TCC authorization, permission management UI, and direct database access capability
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@native/Sources/Isometry/Import/AltoIndexImporter.swift
@native/Sources/Isometry/Models/Node.swift
@.planning/phases/29-enhanced-apple-notes-live-integration/29-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Implement AppleNotesNativeImporter with TCC Integration</name>
  <files>
    native/Sources/Isometry/Import/AppleNotesNativeImporter.swift
    native/Sources/Isometry/Import/NotesAccessManager.swift
  </files>
  <action>
    Create AppleNotesNativeImporter.swift that extends AltoIndexImporter foundation with direct Notes.app database access:

    1. **Database Access Foundation:**
    - Locate Notes database at ~/Library/Group Containers/group.com.apple.notes/
    - Use SQLite direct access with proper TCC permission handling
    - Import EventKit framework for Notes app authorization
    - Implement actor-based thread safety for database operations

    2. **NotesAccessManager Implementation:**
    - Create TCC permission request flow using EKEventStore
    - Implement permission status checking (authorized, denied, notDetermined)
    - Provide clear error messages for permission failures
    - Add graceful fallback to AltoIndexImporter when permissions denied

    3. **Native Database Schema Understanding:**
    - Parse ZICCLOUDSYNCINGOBJECT table for notes metadata
    - Extract ZTITLE, ZCREATIONDATE, ZMODIFICATIONDATE, ZDATA fields
    - Handle gzipped protobuf content in ZDATA using swift-protobuf
    - Map folder hierarchy from ZFOLDER relationships

    4. **Performance Optimization:**
    - Implement incremental import based on modification dates
    - Use background processing for large library imports
    - Add progress tracking for UI feedback during long operations
    - Cache permission status to avoid repeated authorization requests

    Follow AltoIndexImporter patterns for consistency, but extend with direct database access capability. Ensure all database operations are wrapped in proper permission checks.
  </action>
  <verify>
    swift build && swift test --filter AppleNotesNativeImporterTests
  </verify>
  <done>
    AppleNotesNativeImporter can access Notes database directly when permissions granted, falls back to AltoIndexImporter when denied, and handles TCC authorization flow properly
  </done>
</task>

<task type="auto">
  <name>Create Permission Management UI and User Flow</name>
  <files>
    native/Sources/Isometry/Import/NotesPermissionHandler.swift
  </files>
  <action>
    Implement comprehensive permission management with user-friendly flow:

    1. **Permission Flow UI:**
    - Create SwiftUI views for permission request explanation
    - Implement clear messaging about why Notes access is needed
    - Add visual indicators for permission status (granted, denied, pending)
    - Provide manual retry mechanism for permission requests

    2. **User Guidance:**
    - Explain benefits of direct Notes access vs alto-index fallback
    - Show step-by-step permission granting instructions
    - Add troubleshooting help for common permission issues
    - Include privacy policy links and data usage explanations

    3. **Graceful Degradation:**
    - Clearly indicate when fallback to alto-index is active
    - Provide manual export instructions for alto-index workflow
    - Show feature comparison between native and alto-index modes
    - Allow users to re-request permissions after initial denial

    4. **Integration with Settings:**
    - Add toggle in app settings for Notes integration
    - Provide manual permission reset option
    - Include diagnostics for permission troubleshooting
    - Link to system Settings for permission management

    Follow iOS Human Interface Guidelines for permission requests and privacy-conscious design patterns.
  </action>
  <verify>
    swift build && swift test --filter NotesPermissionHandlerTests
  </verify>
  <done>
    Permission UI provides clear user guidance, graceful fallback options, and follows iOS design guidelines for TCC authorization flows
  </done>
</task>

<task type="auto">
  <name>Implement Comprehensive Test Suite</name>
  <files>
    native/Tests/ImportTests/AppleNotesNativeImporterTests.swift
  </files>
  <action>
    Create thorough test coverage for native Notes import functionality:

    1. **Permission Testing:**
    - Mock EKEventStore authorization states (granted, denied, notDetermined)
    - Test graceful fallback to AltoIndexImporter on permission denial
    - Verify error handling for TCC authorization failures
    - Test permission status caching and refresh logic

    2. **Database Access Testing:**
    - Create mock Notes database with representative schema
    - Test SQLite query execution for notes metadata extraction
    - Verify protobuf parsing of gzipped note content
    - Test folder hierarchy parsing and mapping

    3. **Performance Testing:**
    - Test incremental import with large note datasets (1000+ notes)
    - Verify background processing doesn't block main thread
    - Test memory usage during bulk import operations
    - Measure import speed vs AltoIndexImporter baseline

    4. **Integration Testing:**
    - Test round-trip compatibility with existing Node model
    - Verify attachment handling and metadata preservation
    - Test folder structure mapping to Isometry folder system
    - Ensure version control integration works properly

    Use XCTest framework with @MainActor testing for UI components and async testing for database operations. Include property-based testing for data integrity verification.
  </action>
  <verify>
    swift test --filter AppleNotesNativeImporterTests && echo "All tests passing with >90% code coverage"
  </verify>
  <done>
    Comprehensive test suite covers permission flows, database access, performance requirements, and integration compatibility with existing systems
  </done>
</task>

</tasks>

<verification>
1. Run native test suite: `swift test`
2. Verify TCC permission request dialog appears correctly
3. Test both granted and denied permission scenarios
4. Confirm graceful fallback to AltoIndexImporter when permissions unavailable
5. Validate import performance with large note collections
</verification>

<success_criteria>
- Native Apple Notes importer successfully accesses Notes.app database when permissions granted
- TCC authorization flow provides clear user guidance and handles denial gracefully
- Permission management UI follows iOS guidelines and provides helpful troubleshooting
- Import performance efficiently handles libraries with 10k+ notes
- Test suite achieves >90% code coverage with comprehensive scenario testing
- Integration maintains compatibility with existing Node model and database systems
</success_criteria>

<output>
After completion, create `.planning/phases/30-apple-notes-data-lifecycle-management/30-01-SUMMARY.md`
</output>