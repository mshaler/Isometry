---
phase: 30-apple-notes-data-lifecycle-management
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified: [
  "native/Sources/Isometry/Storage/ContentAwareStorageManager.swift",
  "native/Sources/Isometry/Storage/AttachmentManager.swift",
  "native/Sources/Isometry/Storage/CASIntegration.swift",
  "native/Tests/StorageTests/AttachmentManagerTests.swift"
]
autonomous: true

must_haves:
  truths:
    - "Apple Notes attachments are stored in Content-Addressable Storage with SQLite links"
    - "CAS system deduplicates identical attachments across notes efficiently"
    - "Attachment metadata preserved: original filename, creation date, file type, size"
    - "Large attachments (images, PDFs, videos) stored efficiently without database bloat"
  artifacts:
    - path: "native/Sources/Isometry/Storage/AttachmentManager.swift"
      provides: "Attachment extraction, storage, and retrieval system"
      min_lines: 300
      exports: ["storeAttachment", "retrieveAttachment", "AttachmentMetadata"]
    - path: "native/Sources/Isometry/Storage/CASIntegration.swift"
      provides: "Content-Addressable Storage implementation"
      contains: "SHA-256 hash-based storage"
    - path: "native/Sources/Isometry/Storage/ContentAwareStorageManager.swift"
      provides: "Enhanced storage manager with attachment support"
      min_lines: 200
  key_links:
    - from: "AttachmentManager.swift"
      to: "CASIntegration.swift"
      via: "content hashing for deduplication"
      pattern: "casIntegration\\.store.*hash"
    - from: "AppleNotesNativeImporter.swift"
      to: "AttachmentManager.swift"
      via: "attachment processing during import"
      pattern: "attachmentManager\\.store"
---

<objective>
Implement Content-Addressable Storage (CAS) system for Apple Notes attachments, enabling efficient storage, deduplication, and retrieval of media files while maintaining SQLite database performance and providing robust attachment lifecycle management.

Purpose: Handle Apple Notes attachments (images, PDFs, videos, documents) efficiently by implementing CAS storage that deduplicates identical files, preserves metadata, and maintains high-performance database operations without bloat.
Output: Complete attachment management system with CAS storage, deduplication, metadata preservation, and seamless integration with Notes import pipeline
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@native/Sources/Isometry/Database/DatabaseVersionControl.swift
@native/Sources/Isometry/Models/Node.swift
@.planning/phases/30-apple-notes-data-lifecycle-management/30-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Implement Content-Addressable Storage Foundation</name>
  <files>
    native/Sources/Isometry/Storage/CASIntegration.swift
    native/Sources/Isometry/Storage/ContentAwareStorageManager.swift
  </files>
  <action>
    Create robust Content-Addressable Storage system for attachment management:

    1. **CAS Core Implementation:**
    - Implement SHA-256 content hashing for unique file identification
    - Create hierarchical directory structure: /storage/cas/[first-2-chars]/[hash]
    - Add atomic file operations to prevent corruption during writes
    - Implement content verification on retrieval to detect corruption

    2. **Storage Manager Enhancement:**
    - Extend existing ContentAwareStorageManager with attachment capabilities
    - Add file type detection and validation for Notes attachments
    - Implement size limits and compression for large files
    - Add cleanup mechanisms for orphaned attachments

    3. **Deduplication Logic:**
    - Hash-based duplicate detection before storage
    - Reference counting for shared attachments across notes
    - Garbage collection for unreferenced content
    - Storage space optimization reporting

    4. **Metadata Management:**
    - Store original filename, creation date, MIME type, file size
    - Preserve Apple Notes attachment identifiers for round-trip fidelity
    - Track relationship between notes and attachments via SQLite
    - Add attachment versioning for conflict resolution

    Follow database versioning patterns from DatabaseVersionControl.swift for consistency. Ensure all operations are atomic and reversible.
  </action>
  <verify>
    swift build && swift test --filter CASIntegrationTests
  </verify>
  <done>
    CAS system stores attachments efficiently with deduplication, preserves metadata, and provides atomic operations with corruption detection
  </done>
</task>

<task type="auto">
  <name>Build AttachmentManager with Notes Integration</name>
  <files>
    native/Sources/Isometry/Storage/AttachmentManager.swift
  </files>
  <action>
    Create comprehensive attachment management system for Apple Notes integration:

    1. **Attachment Extraction:**
    - Parse Notes database attachment tables (ZICCLOUDSYNCINGOBJECT with UTI data)
    - Extract embedded attachments from protobuf note content
    - Handle various attachment types: images, PDFs, documents, audio, video
    - Preserve original Apple Notes attachment metadata and identifiers

    2. **Storage Operations:**
    - Store attachments in CAS with content hashing
    - Create SQLite links between notes and stored attachments
    - Implement batch operations for efficient bulk import
    - Add progress tracking for large attachment processing

    3. **Retrieval and Access:**
    - Provide fast attachment lookup by note ID or content hash
    - Implement lazy loading for attachment content
    - Cache frequently accessed attachments for performance
    - Support streaming for large video/audio files

    4. **Integration with Node Model:**
    - Extend Node model to include attachment references
    - Add attachment count and total size to note metadata
    - Implement attachment search and filtering capabilities
    - Support attachment export for round-trip testing

    Use Swift actor pattern for thread-safe attachment operations. Implement robust error handling for file system operations and memory management for large files.
  </action>
  <verify>
    swift build && swift test --filter AttachmentManagerTests
  </verify>
  <done>
    AttachmentManager extracts, stores, and retrieves Notes attachments efficiently while maintaining metadata and providing seamless Node model integration
  </done>
</task>

<task type="auto">
  <name>Create Comprehensive Attachment Test Suite</name>
  <files>
    native/Tests/StorageTests/AttachmentManagerTests.swift
  </files>
  <action>
    Implement thorough test coverage for attachment management system:

    1. **CAS Testing:**
    - Test content hashing consistency and collision handling
    - Verify deduplication works correctly for identical files
    - Test atomic file operations and corruption recovery
    - Validate storage space optimization and cleanup

    2. **Attachment Processing Testing:**
    - Create mock Notes databases with various attachment types
    - Test extraction of embedded images, PDFs, documents
    - Verify metadata preservation during storage operations
    - Test batch processing performance with large attachment sets

    3. **Integration Testing:**
    - Test Node model integration with attachment references
    - Verify round-trip fidelity for attachment export/import
    - Test attachment search and filtering functionality
    - Validate memory usage during large file operations

    4. **Performance Testing:**
    - Benchmark attachment storage and retrieval speed
    - Test concurrent access with multiple Notes being processed
    - Measure memory usage with large video/image files
    - Validate garbage collection and cleanup performance

    5. **Error Handling Testing:**
    - Test disk space exhaustion scenarios
    - Verify corrupted attachment detection and recovery
    - Test permission errors and file system issues
    - Validate graceful degradation when attachments unavailable

    Include property-based testing for hash consistency and stress testing for large attachment collections (1000+ files).
  </action>
  <verify>
    swift test --filter AttachmentManagerTests && swift test --filter CASIntegrationTests && echo "All attachment tests passing with >95% coverage"
  </verify>
  <done>
    Comprehensive test suite validates CAS functionality, attachment processing, integration points, performance requirements, and error handling scenarios
  </done>
</task>

</tasks>

<verification>
1. Run complete test suite: `swift test`
2. Import test Notes with various attachment types (images, PDFs, documents)
3. Verify deduplication works by importing duplicate attachments
4. Test attachment retrieval performance with large files
5. Validate storage space optimization and cleanup mechanisms
6. Confirm Node model integration preserves attachment relationships
</verification>

<success_criteria>
- CAS system efficiently stores and deduplicates attachments with SHA-256 hashing
- AttachmentManager successfully extracts all attachment types from Notes database
- Metadata preservation maintains original filenames, dates, and type information
- Storage system handles large files (100MB+) without database performance impact
- Test suite achieves >95% code coverage with comprehensive scenario validation
- Integration with Node model provides seamless attachment access and search
- Performance targets: <100ms attachment retrieval, <10% storage overhead from deduplication
</success_criteria>

<output>
After completion, create `.planning/phases/30-apple-notes-data-lifecycle-management/30-02-SUMMARY.md`
</output>