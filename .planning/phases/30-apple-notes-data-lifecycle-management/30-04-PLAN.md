---
phase: 30-apple-notes-data-lifecycle-management
plan: 04
type: execute
wave: 4
depends_on: ["30-03"]
files_modified: [
  "native/Sources/Isometry/Database/DatabaseLifecycleManager.swift",
  "native/Sources/Isometry/Database/DatabaseOperations.swift",
  "native/Sources/Isometry/Export/DatabaseExporter.swift",
  "native/Tests/DatabaseTests/DatabaseLifecycleManagerTests.swift"
]
autonomous: true

must_haves:
  truths:
    - "Database operations (dump, restore, export, purge, rehydrate) execute reliably"
    - "All operations are versioned and reversible using git-like branching"
    - "Export formats maintain data fidelity for external system integration"
    - "Operations handle large datasets (100k+ records) efficiently"
  artifacts:
    - path: "native/Sources/Isometry/Database/DatabaseLifecycleManager.swift"
      provides: "Complete database lifecycle operation management"
      min_lines: 500
      exports: ["dump", "restore", "export", "purge", "rehydrate", "LifecycleOperation"]
    - path: "native/Sources/Isometry/Database/DatabaseOperations.swift"
      provides: "Core database operation implementations"
      contains: "atomic operation handling"
    - path: "native/Sources/Isometry/Export/DatabaseExporter.swift"
      provides: "Multi-format database export capability"
      exports: ["exportToJSON", "exportToCSV", "exportToSQL"]
  key_links:
    - from: "DatabaseLifecycleManager.swift"
      to: "DatabaseVersionControl.swift"
      via: "versioned operation tracking"
      pattern: "versionControl\\.createBranch.*operation"
    - from: "DatabaseLifecycleManager.swift"
      to: "ContentAwareStorageManager.swift"
      via: "attachment backup and restore"
      pattern: "storageManager\\.backup.*attachments"
---

<objective>
Implement comprehensive database lifecycle management system providing dump, restore, export, purge, and rehydrate operations with versioning integration, enabling complete database management, backup/recovery, and external system integration while maintaining data integrity and performance.

Purpose: Establish complete database operations capability for Apple Notes data lifecycle, enabling enterprise-grade backup/recovery, data export for integration, efficient purging for privacy compliance, and reliable rehydration for testing and development scenarios.
Output: Production-ready database lifecycle management with versioned operations, multi-format export, and enterprise-scale performance
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@native/Sources/Isometry/Database/DatabaseVersionControl.swift
@native/Sources/Isometry/Database/IsometryDatabase.swift
@native/Sources/Isometry/Storage/ContentAwareStorageManager.swift
@.planning/phases/30-apple-notes-data-lifecycle-management/30-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Implement Core Database Lifecycle Operations</name>
  <files>
    native/Sources/Isometry/Database/DatabaseLifecycleManager.swift
    native/Sources/Isometry/Database/DatabaseOperations.swift
  </files>
  <action>
    Create comprehensive database lifecycle management system:

    1. **DatabaseLifecycleManager Foundation:**
    - Build unified interface for all database lifecycle operations
    - Integrate with DatabaseVersionControl for operation versioning
    - Add transaction coordination for atomic operations
    - Implement progress tracking for long-running operations

    2. **Dump Operations:**
    - Create complete database snapshots including schema, data, and indexes
    - Include attachment content via ContentAwareStorageManager integration
    - Generate metadata manifest with operation details and checksums
    - Support incremental dumps based on date ranges or change tracking
    - Add compression and encryption options for sensitive data

    3. **Restore Operations:**
    - Restore database from complete or incremental dumps
    - Validate checksums and integrity before applying changes
    - Support point-in-time recovery with precise timestamp targeting
    - Handle attachment restoration with content verification
    - Provide rollback capability if restoration fails

    4. **Purge Operations:**
    - Implement selective purging by date range, source, or criteria
    - Add hard deletion with secure data wiping for privacy compliance
    - Support dry-run mode for purge impact analysis
    - Maintain referential integrity during selective purging
    - Generate audit logs for compliance requirements

    5. **Rehydrate Operations:**
    - Rebuild database from external data sources (Notes, alto-index)
    - Support development and testing data generation
    - Add synthetic data generation for performance testing
    - Enable selective rehydration of specific data types or time periods
    - Maintain performance optimization during bulk operations

    Use actor patterns for thread safety and background processing. Integrate with existing DatabaseVersionControl branching for operation isolation.
  </action>
  <verify>
    swift build && swift test --filter DatabaseLifecycleManagerTests
  </verify>
  <done>
    DatabaseLifecycleManager provides comprehensive operations (dump, restore, purge, rehydrate) with versioning integration, transaction safety, and enterprise-scale performance
  </done>
</task>

<task type="auto">
  <name>Build Multi-Format Database Export System</name>
  <files>
    native/Sources/Isometry/Export/DatabaseExporter.swift
  </files>
  <action>
    Implement comprehensive database export capability for external integration:

    1. **Export Format Support:**
    - JSON export with hierarchical structure preservation
    - CSV export with configurable field selection and relationships
    - SQL export with schema recreation and data insertion scripts
    - XML export for enterprise system integration
    - Protocol buffer export for high-performance data exchange

    2. **Data Fidelity Preservation:**
    - Maintain exact field types and precision during export
    - Preserve Unicode, emoji, and special character encoding
    - Include complete attachment metadata and content references
    - Export relationship data with referential integrity
    - Validate export completeness with source verification

    3. **Configuration and Filtering:**
    - Support selective export by table, date range, or custom criteria
    - Add field mapping and transformation capabilities
    - Enable attachment inclusion/exclusion options
    - Provide schema-only or data-only export modes
    - Support batch export for large datasets

    4. **Performance Optimization:**
    - Implement streaming export for large datasets (100k+ records)
    - Add parallel processing for multi-table exports
    - Optimize memory usage with lazy loading and pagination
    - Provide progress tracking and cancellation support
    - Add resumable export for network interruptions

    5. **Integration and Validation:**
    - Include export metadata with generation timestamp and checksums
    - Add validation hooks for external system compatibility
    - Support custom export templates and transformations
    - Enable round-trip testing with import validation
    - Provide export audit logging and tracking

    Follow existing Node model patterns and ensure compatibility with AltoIndexImporter round-trip validation.
  </action>
  <verify>
    swift build && swift test --filter DatabaseExporterTests
  </verify>
  <done>
    DatabaseExporter provides multi-format export capability with data fidelity preservation, performance optimization, and validation for external system integration
  </done>
</task>

<task type="auto">
  <name>Create Comprehensive Lifecycle Test Suite</name>
  <files>
    native/Tests/DatabaseTests/DatabaseLifecycleManagerTests.swift
  </files>
  <action>
    Implement thorough test coverage for database lifecycle operations:

    1. **Operation Testing:**
    - Test complete dump and restore cycles with data verification
    - Verify purge operations maintain referential integrity
    - Test rehydrate operations with various data sources
    - Validate export format accuracy with round-trip testing
    - Test incremental operations and delta processing

    2. **Versioning Integration Testing:**
    - Test lifecycle operations with DatabaseVersionControl branching
    - Verify operation rollback and recovery scenarios
    - Test concurrent operations and conflict resolution
    - Validate branch isolation during lifecycle operations
    - Test merge scenarios after purge/rehydrate operations

    3. **Performance Testing:**
    - Benchmark operations with large datasets (100k+ notes)
    - Test memory usage during bulk operations
    - Verify streaming performance for large exports
    - Test concurrent operation handling and resource management
    - Measure operation speed vs baseline requirements

    4. **Data Integrity Testing:**
    - Test attachment handling during dump/restore cycles
    - Verify Unicode and special character preservation
    - Test relationship integrity during purge operations
    - Validate checksum verification and corruption detection
    - Test recovery from interrupted operations

    5. **Integration Testing:**
    - Test integration with ContentAwareStorageManager
    - Verify compatibility with existing import/export systems
    - Test external system export format compatibility
    - Validate audit logging and compliance features
    - Test backup/recovery workflows end-to-end

    6. **Edge Case and Error Testing:**
    - Test operations with corrupted or incomplete databases
    - Verify handling of disk space exhaustion scenarios
    - Test permission errors and file system issues
    - Validate graceful degradation during network interruptions
    - Test recovery from partial operation failures

    Include stress testing with enterprise-scale datasets (1M+ records) to validate production readiness.
  </action>
  <verify>
    swift test --filter DatabaseLifecycleManagerTests && swift test --filter DatabaseExporterTests && echo "All lifecycle tests passing with enterprise-scale validation"
  </verify>
  <done>
    Comprehensive test suite validates lifecycle operations, versioning integration, performance requirements, data integrity, and enterprise-scale scenarios
  </done>
</task>

</tasks>

<verification>
1. Run complete database lifecycle test suite: `swift test`
2. Execute dump/restore cycle on production-size dataset (10k+ notes)
3. Test export to multiple formats and verify data fidelity
4. Validate purge operations with referential integrity checks
5. Test rehydrate operations from Notes and alto-index sources
6. Confirm versioning integration with DatabaseVersionControl
7. Verify performance targets with large datasets (100k+ records)
</verification>

<success_criteria>
- All lifecycle operations (dump, restore, export, purge, rehydrate) execute reliably
- Versioning integration enables reversible operations with git-like branching
- Export formats maintain >99.9% data fidelity for external systems
- Performance handles 100k+ records efficiently (<5 minutes for full dump/restore)
- Test suite achieves >95% code coverage with enterprise-scale validation
- Operations integrate seamlessly with existing DatabaseVersionControl system
- Attachment handling preserves content and metadata through all operations
- Audit logging provides compliance-grade operation tracking
</success_criteria>

<output>
After completion, create `.planning/phases/30-apple-notes-data-lifecycle-management/30-04-SUMMARY.md`
</output>