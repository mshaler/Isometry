---
phase: 10-foundation-cleanup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [
  "src/components/ImportWizard.tsx",
  "src/components/notebook/CaptureComponent.tsx",
  "src/components/notebook/D3VisualizationRenderer.tsx",
  "src/types/browser-bridge.d.ts",
  "src/utils/sync-manager.ts",
  "src/utils/webview-bridge.ts",
  "src/utils/performance-benchmarks.ts",
  "tsconfig.json"
]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "TypeScript compiler produces zero errors with strict mode enabled"
    - "Production build (npm run build) completes successfully without TypeScript errors"
    - "All type assertions properly handle null/undefined boundary cases"
    - "D3 visualization components have complete type safety"
    - "WebView bridge maintains type safety across message boundaries"
  artifacts:
    - path: "tsconfig.json"
      provides: "Strict TypeScript configuration"
      contains: "strict: true"
    - path: "src/components/ImportWizard.tsx"
      provides: "Proper null/undefined type handling"
      min_lines: 180
    - path: "src/components/notebook/D3VisualizationRenderer.tsx"
      provides: "Complete D3 type definitions"
      min_lines: 300
    - path: "src/utils/sync-manager.ts"
      provides: "Type-safe event handling"
      exports: ["SyncManager"]
    - path: "src/utils/webview-bridge.ts"
      provides: "Type-safe bridge communication"
      exports: ["WebViewBridge"]
  key_links:
    - from: "tsconfig.json"
      to: "all TypeScript files"
      via: "strict mode compilation"
      pattern: "strict.*true"
    - from: "ImportWizard.tsx"
      to: "OfficeImportOptions type"
      via: "proper null/undefined alignment"
      pattern: "OfficeImportOptions.*folder.*string"
    - from: "D3VisualizationRenderer.tsx"
      to: "D3 type definitions"
      via: "typed extent and scale functions"
      pattern: "extent.*Numeric.*accessor"
---

<objective>
Resolve critical TypeScript strict mode compilation failures that block production deployment

Purpose: Align TypeScript compilation with ESLint success to achieve genuine production readiness
Output: Production-ready codebase with zero TypeScript errors and successful build pipeline
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-foundation-cleanup/10-VERIFICATION.md
@.planning/COMPREHENSIVE-GAP-ANALYSIS.md

# TypeScript compilation showing 487 errors despite ESLint passing
# Critical disconnect between lint success and production build failure
# App Store submission blocked by build pipeline failures
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Import Wizard null/undefined Type Mismatches</name>
  <files>src/components/ImportWizard.tsx</files>
  <action>
    Resolve the 3 critical type errors in ImportWizard component:

    1. Fix folder property type mismatch (lines 25, 121):
       - Change `folder: string | null` to `folder: string | undefined`
       - Update all assignments to use undefined instead of null
       - Ensure OfficeImportOptions interface consistency

    2. Fix setState callback return type (line 183):
       - Align return type with OfficeImportOptions interface
       - Use undefined consistently for optional folder property
       - Maintain proper React setState type safety

    Reference existing patterns from other components that properly handle optional string properties. The goal is type consistency - if the interface uses `string | undefined`, all assignments must match.
  </action>
  <verify>npx tsc --noEmit src/components/ImportWizard.tsx</verify>
  <done>ImportWizard.tsx compiles without TypeScript errors and maintains proper null safety</done>
</task>

<task type="auto">
  <name>Task 2: Fix CaptureComponent DOM Property Access Errors</name>
  <files>src/components/notebook/CaptureComponent.tsx</files>
  <action>
    Resolve HTMLTextAreaElement property access errors (lines 54, 103):

    1. Fix 'textarea' property access:
       - Replace textareaRef.current.textarea with proper DOM property access
       - Use standard HTMLTextAreaElement properties (value, selectionStart, selectionEnd)
       - Add proper null checking for ref.current

    2. Update textarea manipulation to use standard DOM APIs:
       - For cursor position: use selectionStart, selectionEnd
       - For content: use value property
       - For focus: use focus() method

    Check React documentation patterns for proper textarea ref usage and ensure all DOM interactions follow standard HTMLTextAreaElement interface.
  </action>
  <verify>npx tsc --noEmit src/components/notebook/CaptureComponent.tsx</verify>
  <done>CaptureComponent.tsx compiles without errors and properly accesses textarea DOM properties</done>
</task>

<task type="auto">
  <name>Task 3: Complete D3 Visualization Type Safety</name>
  <files>src/components/notebook/D3VisualizationRenderer.tsx</files>
  <action>
    Resolve the extensive D3 type errors (~50+ errors) systematically:

    1. Fix extent function null safety (lines 299, 305, 308):
       - Add proper null checks before extent function usage
       - Use type guards for aVal/bVal before comparison operations
       - Handle undefined extent results with fallback defaults

    2. Fix D3 extent/scale type assertions (lines 305, 308):
       - Properly type the extent accessor function for Date/number types
       - Use proper D3 type constraints (Numeric for numeric data, Date for temporal)
       - Add explicit type annotations to resolve overload conflicts

    3. Complete ChartDatum interface type safety:
       - Define proper types for mixed data values (string | number | boolean | Date)
       - Create type guards to narrow types before D3 operations
       - Ensure all D3 functions receive properly typed data

    Reference D3 v7 TypeScript patterns and ensure all scale, extent, and accessor functions have explicit type constraints matching the data being processed.
  </action>
  <verify>npx tsc --noEmit src/components/notebook/D3VisualizationRenderer.tsx</verify>
  <done>D3VisualizationRenderer.tsx compiles with complete type safety and proper D3 type constraints</done>
</task>

<task type="auto">
  <name>Task 4: Fix WebView Bridge and Sync Manager Type Safety</name>
  <files>src/utils/webview-bridge.ts, src/utils/sync-manager.ts, src/utils/performance-benchmarks.ts</files>
  <action>
    Resolve utility type safety issues across multiple files:

    1. sync-manager.ts fixes:
       - Fix Environment type reference (line 30): change to `typeof Environment`
       - Remove unused variable declarations (_syncQueue, maxRetries)
       - Fix custom event type safety for window.addEventListener with proper SyncEvent interface
       - Add proper event.detail property access with type assertions

    2. webview-bridge.ts fixes:
       - Fix generic type constraints for promise resolution callbacks
       - Add proper type assertions for unknown results from bridge communication
       - Define proper message interface for bridge communication
       - Handle unknown types from native bridge with proper runtime type checking

    3. performance-benchmarks.ts fixes:
       - Add missing 'stress' property to BridgePerformanceResults interface
       - Ensure all performance result properties are properly typed
       - Fix any type assertion issues in benchmark data collection

    Focus on maintaining runtime safety while satisfying TypeScript strict mode. Use proper type guards and runtime validation for data crossing system boundaries.
  </action>
  <verify>npx tsc --noEmit src/utils/sync-manager.ts src/utils/webview-bridge.ts src/utils/performance-benchmarks.ts</verify>
  <done>All utility files compile without errors with proper type safety across system boundaries</done>
</task>

<task type="auto">
  <name>Task 5: Add Global Type Definitions for Browser Bridge</name>
  <files>src/types/browser-bridge.d.ts</files>
  <action>
    Create comprehensive type definitions to resolve remaining compilation errors:

    1. Define proper SyncEvent interface:
       - Extend CustomEvent with proper detail typing
       - Include payload and timestamp properties as mentioned in verification
       - Support for isometry-sync-update and isometry-sync-state event types

    2. Define WebView bridge message interfaces:
       - Proper message structure for native bridge communication
       - Type-safe response handling for unknown data from native
       - Error handling interface for bridge communication failures

    3. Add missing global type extensions:
       - Extend Window interface with custom event types
       - Add proper HTMLTextAreaElement extensions if needed
       - Define proper D3 module type extensions for custom usage

    4. Create environment-specific type definitions:
       - Distinguish between browser/Node.js environments
       - Support for native bridge vs development environment
       - Proper type definitions for performance monitoring interfaces

    This will resolve remaining global type issues and provide proper TypeScript definitions for all cross-system communication.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>All global type definitions properly support strict TypeScript compilation across entire codebase</done>
</task>

</tasks>

<verification>
# Comprehensive TypeScript Strict Mode Verification

## 1. TypeScript Compilation
npx tsc --strict --noEmit
# Should return exit code 0 with no output

## 2. Production Build Test
npm run build
# Should complete successfully with no TypeScript errors

## 3. Runtime Verification
npm run dev
# Should start without TypeScript compilation warnings
# Navigate to notebook interface, test D3 visualizations, verify import wizard

## 4. Type Safety Verification
grep -r "any\|unknown" src/ --include="*.ts" --include="*.tsx" | grep -v "// @ts-"
# Should show only intentional any/unknown usage with proper guards

## 5. ESLint Consistency Check
npm run lint
# Should maintain zero problems (no regression)
</verification>

<success_criteria>
1. TypeScript compiler produces zero errors with strict mode enabled
2. Production build pipeline (tsc && vite build) completes successfully
3. All 487 compilation errors resolved with proper type safety
4. ESLint continues to report zero problems (no regression)
5. D3 visualizations maintain runtime functionality with complete type safety
6. WebView bridge communication preserves type safety across system boundaries
7. Import wizard handles null/undefined boundaries correctly
8. All utility modules compile with strict mode compliance
</success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-cleanup/10-03-SUMMARY.md`
</output>