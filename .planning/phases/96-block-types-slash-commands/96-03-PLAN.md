---
phase: 96-block-types-slash-commands
plan: 03
type: execute
wave: 2
depends_on: [96-02]
files_modified:
  - src/components/notebook/editor/extensions/ToggleExtension.ts
  - src/components/notebook/editor/nodes/ToggleNode.tsx
  - src/components/notebook/editor/extensions/BookmarkExtension.ts
  - src/components/notebook/editor/nodes/BookmarkNode.tsx
  - src/components/notebook/editor/extensions/index.ts
  - src/hooks/ui/useTipTapEditor.ts
  - src/components/notebook/editor/extensions/slash-commands.ts
  - src/index.css
autonomous: true

must_haves:
  truths:
    - "User can type /toggle and see collapsible section inserted"
    - "User can click to expand/collapse the toggle section"
    - "User can type /bookmark and enter a URL"
    - "Bookmark shows URL metadata (title, description, favicon)"
  artifacts:
    - path: "src/components/notebook/editor/extensions/ToggleExtension.ts"
      provides: "TipTap Node extension for collapsible toggles"
      exports: ["ToggleExtension"]
    - path: "src/components/notebook/editor/nodes/ToggleNode.tsx"
      provides: "React component for toggle blocks"
      exports: ["ToggleNode"]
    - path: "src/components/notebook/editor/extensions/BookmarkExtension.ts"
      provides: "TipTap Node extension for URL bookmarks"
      exports: ["BookmarkExtension"]
    - path: "src/components/notebook/editor/nodes/BookmarkNode.tsx"
      provides: "React component for bookmark preview"
      exports: ["BookmarkNode"]
  key_links:
    - from: "useTipTapEditor.ts"
      to: "ToggleExtension"
      via: "extensions array import"
      pattern: "ToggleExtension"
    - from: "useTipTapEditor.ts"
      to: "BookmarkExtension"
      via: "extensions array import"
      pattern: "BookmarkExtension"
---

<objective>
Create Toggle (collapsible) and Bookmark (URL preview) block types with TipTap extensions

Purpose: Enable collapsible content sections and rich URL previews
Output: ToggleExtension, ToggleNode, BookmarkExtension, BookmarkNode + slash commands
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/96-block-types-slash-commands/96-RESEARCH.md
@.planning/phases/96-block-types-slash-commands/96-02-PLAN.md
@src/components/notebook/editor/extensions/CalloutExtension.ts
@src/hooks/ui/useTipTapEditor.ts

Key patterns from Phase 96-02:
- Node.create() with ReactNodeViewRenderer for custom blocks
- NodeViewWrapper + NodeViewContent for React components
- Module augmentation for TypeScript commands
- Theme-aware CSS via custom properties
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ToggleExtension TipTap node</name>
  <files>src/components/notebook/editor/extensions/ToggleExtension.ts</files>
  <action>
Create ToggleExtension.ts that defines a custom collapsible toggle block.

NOTE: TipTap Pro's Details extension is NOT available (requires paid license). We'll build a simple custom toggle instead.

```typescript
import { Node, mergeAttributes } from '@tiptap/core';
import { ReactNodeViewRenderer } from '@tiptap/react';
import { ToggleNode } from '../nodes/ToggleNode';

export interface ToggleAttributes {
  title: string;
  open: boolean;
}

declare module '@tiptap/core' {
  interface Commands<ReturnType> {
    toggle: {
      setToggle: (attributes?: Partial<ToggleAttributes>) => ReturnType;
    };
  }
}

export const ToggleExtension = Node.create({
  name: 'toggle',
  group: 'block',
  content: 'block+',

  addAttributes() {
    return {
      title: {
        default: 'Toggle section',
        parseHTML: (element) => element.getAttribute('data-title') || 'Toggle section',
        renderHTML: (attributes) => ({ 'data-title': attributes.title }),
      },
      open: {
        default: false,
        parseHTML: (element) => element.getAttribute('data-open') === 'true',
        renderHTML: (attributes) => ({ 'data-open': String(attributes.open) }),
      },
    };
  },

  parseHTML() {
    return [{ tag: 'div[data-toggle]' }];
  },

  renderHTML({ HTMLAttributes }) {
    return ['div', mergeAttributes(HTMLAttributes, { 'data-toggle': '' }), 0];
  },

  addNodeView() {
    return ReactNodeViewRenderer(ToggleNode);
  },

  addCommands() {
    return {
      setToggle: (attributes = {}) => ({ commands }) => {
        return commands.insertContent({
          type: this.name,
          attrs: { title: 'Toggle section', open: true, ...attributes },
          content: [{ type: 'paragraph' }],
        });
      },
    };
  },
});
```

Key notes:
- `open` attribute stored but UI state managed in React component (local)
- `title` is editable via the header input
- Start expanded (open: true) for better UX when inserting
  </action>
  <verify>
File exists and has correct Node.create structure
  </verify>
  <done>
ToggleExtension.ts created with title and open attributes, ReactNodeViewRenderer binding
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ToggleNode React component</name>
  <files>src/components/notebook/editor/nodes/ToggleNode.tsx</files>
  <action>
Create ToggleNode.tsx with expand/collapse functionality:

```tsx
import { useState } from 'react';
import { NodeViewWrapper, NodeViewContent, NodeViewProps } from '@tiptap/react';

export function ToggleNode({ node, updateAttributes }: NodeViewProps) {
  const [isOpen, setIsOpen] = useState<boolean>(node.attrs.open ?? true);
  const title = node.attrs.title || 'Toggle section';

  const handleToggle = () => {
    const newState = !isOpen;
    setIsOpen(newState);
    updateAttributes({ open: newState });
  };

  return (
    <NodeViewWrapper className={`toggle ${isOpen ? 'toggle--open' : ''}`}>
      <div className="toggle__header" onClick={handleToggle}>
        <span className="toggle__icon" contentEditable={false}>
          {isOpen ? '\u25BC' : '\u25B6'}
        </span>
        <input
          type="text"
          className="toggle__title"
          value={title}
          onChange={(e) => updateAttributes({ title: e.target.value })}
          onClick={(e) => e.stopPropagation()}
          placeholder="Toggle title..."
        />
      </div>
      {isOpen && (
        <NodeViewContent className="toggle__content" />
      )}
    </NodeViewWrapper>
  );
}
```

Key notes:
- Local state for isOpen to avoid re-renders from attribute changes
- updateAttributes syncs state back to node for persistence
- Click on header toggles, but clicking input stops propagation
- Content hidden when collapsed (not rendered)
- Unicode triangles: \u25BC (down), \u25B6 (right)
  </action>
  <verify>
File exists with useState for collapse state
  </verify>
  <done>
ToggleNode.tsx created with collapsible behavior and editable title
  </done>
</task>

<task type="auto">
  <name>Task 3: Create BookmarkExtension TipTap node</name>
  <files>src/components/notebook/editor/extensions/BookmarkExtension.ts</files>
  <action>
Create BookmarkExtension.ts for URL preview blocks.

NOTE: Server-side unfurling not available. We'll use a simple approach that:
1. Stores URL in node attributes
2. BookmarkNode displays URL with simple favicon from Google favicon service
3. No external metadata fetching (deferred to future enhancement)

```typescript
import { Node, mergeAttributes } from '@tiptap/core';
import { ReactNodeViewRenderer } from '@tiptap/react';
import { BookmarkNode } from '../nodes/BookmarkNode';

export interface BookmarkAttributes {
  url: string;
  title: string;
  description: string;
}

declare module '@tiptap/core' {
  interface Commands<ReturnType> {
    bookmark: {
      setBookmark: (url?: string) => ReturnType;
    };
  }
}

export const BookmarkExtension = Node.create({
  name: 'bookmark',
  group: 'block',
  atom: true, // Non-editable inline content

  addAttributes() {
    return {
      url: {
        default: '',
        parseHTML: (element) => element.getAttribute('data-url') || '',
        renderHTML: (attributes) => ({ 'data-url': attributes.url }),
      },
      title: {
        default: '',
        parseHTML: (element) => element.getAttribute('data-title') || '',
        renderHTML: (attributes) => ({ 'data-title': attributes.title }),
      },
      description: {
        default: '',
        parseHTML: (element) => element.getAttribute('data-description') || '',
        renderHTML: (attributes) => ({ 'data-description': attributes.description }),
      },
    };
  },

  parseHTML() {
    return [{ tag: 'div[data-bookmark]' }];
  },

  renderHTML({ HTMLAttributes }) {
    return ['div', mergeAttributes(HTMLAttributes, { 'data-bookmark': '' })];
  },

  addNodeView() {
    return ReactNodeViewRenderer(BookmarkNode);
  },

  addCommands() {
    return {
      setBookmark: (url = '') => ({ commands }) => {
        return commands.insertContent({
          type: this.name,
          attrs: { url, title: '', description: '' },
        });
      },
    };
  },
});
```

Key notes:
- `atom: true` means no editable content inside (URL is the content)
- Title and description stored for future server-side fetching
- Simple MVP: just URL display with favicon
  </action>
  <verify>
File exists with atom: true and url attribute
  </verify>
  <done>
BookmarkExtension.ts created with URL, title, description attributes
  </done>
</task>

<task type="auto">
  <name>Task 4: Create BookmarkNode React component</name>
  <files>src/components/notebook/editor/nodes/BookmarkNode.tsx</files>
  <action>
Create BookmarkNode.tsx with URL display and edit mode:

```tsx
import { useState, useMemo } from 'react';
import { NodeViewWrapper, NodeViewProps } from '@tiptap/react';

export function BookmarkNode({ node, updateAttributes }: NodeViewProps) {
  const [isEditing, setIsEditing] = useState(!node.attrs.url);
  const [inputUrl, setInputUrl] = useState(node.attrs.url || '');

  const hostname = useMemo(() => {
    try {
      return new URL(node.attrs.url).hostname;
    } catch {
      return '';
    }
  }, [node.attrs.url]);

  const faviconUrl = hostname
    ? `https://www.google.com/s2/favicons?domain=${hostname}&sz=32`
    : '';

  const handleSave = () => {
    if (inputUrl.trim()) {
      // Auto-add https:// if missing
      let finalUrl = inputUrl.trim();
      if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) {
        finalUrl = 'https://' + finalUrl;
      }
      updateAttributes({ url: finalUrl });
      setInputUrl(finalUrl);
    }
    setIsEditing(false);
  };

  if (isEditing || !node.attrs.url) {
    return (
      <NodeViewWrapper className="bookmark bookmark--editing">
        <input
          type="url"
          className="bookmark__input"
          placeholder="Paste URL and press Enter..."
          value={inputUrl}
          onChange={(e) => setInputUrl(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              handleSave();
            }
            if (e.key === 'Escape') {
              setIsEditing(false);
            }
          }}
          onBlur={handleSave}
          autoFocus
        />
      </NodeViewWrapper>
    );
  }

  return (
    <NodeViewWrapper className="bookmark">
      <a
        href={node.attrs.url}
        target="_blank"
        rel="noopener noreferrer"
        className="bookmark__link"
        onClick={(e) => e.stopPropagation()}
      >
        {faviconUrl && (
          <img
            src={faviconUrl}
            alt=""
            className="bookmark__favicon"
            onError={(e) => {
              (e.target as HTMLImageElement).style.display = 'none';
            }}
          />
        )}
        <div className="bookmark__content">
          <span className="bookmark__title">
            {node.attrs.title || hostname || node.attrs.url}
          </span>
          {node.attrs.description && (
            <span className="bookmark__description">{node.attrs.description}</span>
          )}
          <span className="bookmark__url">{node.attrs.url}</span>
        </div>
      </a>
      <button
        className="bookmark__edit"
        onClick={(e) => {
          e.stopPropagation();
          setIsEditing(true);
        }}
        contentEditable={false}
      >
        Edit
      </button>
    </NodeViewWrapper>
  );
}
```

Key notes:
- Auto-adds https:// if user forgets protocol
- Uses Google favicon service for simple icon
- Shows hostname as fallback title
- Edit button allows URL correction
- No external metadata fetching (future enhancement)
  </action>
  <verify>
File exists with edit mode toggle and favicon display
  </verify>
  <done>
BookmarkNode.tsx created with URL input, favicon display, edit mode
  </done>
</task>

<task type="auto">
  <name>Task 5: Wire extensions into editor and add slash commands</name>
  <files>
src/components/notebook/editor/extensions/index.ts
src/hooks/ui/useTipTapEditor.ts
src/components/notebook/editor/extensions/slash-commands.ts
  </files>
  <action>
1. Update src/components/notebook/editor/extensions/index.ts:
   - Add exports:
     ```typescript
     export { ToggleExtension, type ToggleAttributes } from './ToggleExtension';
     export { BookmarkExtension, type BookmarkAttributes } from './BookmarkExtension';
     ```

2. Update src/hooks/ui/useTipTapEditor.ts:
   - Add imports: `ToggleExtension, BookmarkExtension` from extensions
   - Add both to extensions array (after CalloutExtension)

3. Update src/components/notebook/editor/extensions/slash-commands.ts:
   - Add toggle command:
     ```typescript
     {
       id: 'toggle',
       label: 'Toggle',
       description: 'Collapsible section',
       category: 'format',
       shortcut: 'toggle',
       action: ({ editor, range }) => {
         editor.chain().focus().deleteRange(range).setToggle().run();
       },
     },
     ```
   - Add bookmark command:
     ```typescript
     {
       id: 'bookmark',
       label: 'Bookmark',
       description: 'Add URL preview',
       category: 'format',
       shortcut: 'bookmark',
       action: ({ editor, range }) => {
         editor.chain().focus().deleteRange(range).setBookmark().run();
       },
     },
     ```
  </action>
  <verify>
Run `npm run check:types` - passes with zero errors
Grep for 'ToggleExtension' in useTipTapEditor.ts
Grep for 'setToggle' in slash-commands.ts
Grep for 'setBookmark' in slash-commands.ts
  </verify>
  <done>
ToggleExtension and BookmarkExtension registered, slash commands functional
  </done>
</task>

<task type="auto">
  <name>Task 6: Add toggle and bookmark CSS styling</name>
  <files>src/index.css</files>
  <action>
Add styling for toggle and bookmark blocks to src/index.css (after the callout styles):

```css
/* Toggle block styles */
.toggle {
  border: 1px solid hsl(var(--border));
  background: hsl(var(--card));
  border-radius: 0.5rem;
  margin: 1rem 0;
  overflow: hidden;
  box-shadow: var(--shadow-raised, none);
}

.toggle__header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  cursor: pointer;
  user-select: none;
  background: hsl(var(--muted) / 0.5);
}

.toggle__header:hover {
  background: hsl(var(--muted));
}

.toggle__icon {
  font-size: 0.75rem;
  width: 1rem;
  text-align: center;
  color: hsl(var(--muted-foreground));
}

.toggle__title {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 0.875rem;
  font-weight: 500;
  color: hsl(var(--foreground));
  outline: none;
}

.toggle__title::placeholder {
  color: hsl(var(--muted-foreground));
}

.toggle__content {
  padding: 1rem;
  border-top: 1px solid hsl(var(--border));
}

.toggle__content > *:first-child {
  margin-top: 0;
}

.toggle__content > *:last-child {
  margin-bottom: 0;
}

/* Bookmark block styles */
.bookmark {
  border: 1px solid hsl(var(--border));
  background: hsl(var(--card));
  border-radius: 0.5rem;
  margin: 1rem 0;
  overflow: hidden;
  box-shadow: var(--shadow-raised, none);
  position: relative;
}

.bookmark--editing {
  padding: 1rem;
}

.bookmark__input {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid hsl(var(--border));
  border-radius: 0.25rem;
  background: hsl(var(--background));
  color: hsl(var(--foreground));
  font-size: 0.875rem;
  outline: none;
}

.bookmark__input:focus {
  border-color: hsl(var(--primary));
}

.bookmark__link {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1rem;
  text-decoration: none;
  color: inherit;
}

.bookmark__link:hover {
  background: hsl(var(--muted) / 0.5);
}

.bookmark__favicon {
  width: 32px;
  height: 32px;
  flex-shrink: 0;
  border-radius: 0.25rem;
}

.bookmark__content {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.bookmark__title {
  font-size: 0.875rem;
  font-weight: 500;
  color: hsl(var(--foreground));
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.bookmark__description {
  font-size: 0.75rem;
  color: hsl(var(--muted-foreground));
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.bookmark__url {
  font-size: 0.75rem;
  color: hsl(var(--muted-foreground));
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.bookmark__edit {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  border: 1px solid hsl(var(--border));
  border-radius: 0.25rem;
  background: hsl(var(--background));
  color: hsl(var(--muted-foreground));
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
}

.bookmark:hover .bookmark__edit {
  opacity: 1;
}

.bookmark__edit:hover {
  background: hsl(var(--muted));
  color: hsl(var(--foreground));
}
```

These styles:
- Match the callout block aesthetic
- Theme-aware via CSS custom properties
- Edit button appears on hover
- Proper overflow handling for long URLs
  </action>
  <verify>
Grep for '.toggle__header' in src/index.css
Grep for '.bookmark__link' in src/index.css
Run `npm run check:types` - should still pass
  </verify>
  <done>
Toggle and bookmark CSS added with theme-aware styling
  </done>
</task>

</tasks>

<verification>
1. Run `npm run check:types` - passes with zero errors
2. Run `npm run check:lint` - no new lint errors
3. Grep for 'ToggleExtension' in useTipTapEditor.ts - confirms extension registered
4. Grep for 'BookmarkExtension' in useTipTapEditor.ts - confirms extension registered
5. Grep for 'setToggle' in slash-commands.ts - confirms slash command added
6. Grep for 'setBookmark' in slash-commands.ts - confirms slash command added
7. Grep for '.toggle__header' in src/index.css - confirms styling added
8. Grep for '.bookmark__link' in src/index.css - confirms styling added
</verification>

<success_criteria>
- ToggleExtension defines collapsible block with title/open attributes
- ToggleNode renders with expand/collapse toggle and editable title
- BookmarkExtension defines URL preview block with url/title/description
- BookmarkNode renders with favicon, URL, and edit mode
- /toggle and /bookmark slash commands insert respective blocks
- CSS styling applied with theme-aware custom properties
- All new blocks match existing UI aesthetic
</success_criteria>

<output>
After completion, create `.planning/phases/96-block-types-slash-commands/96-03-SUMMARY.md`
</output>
