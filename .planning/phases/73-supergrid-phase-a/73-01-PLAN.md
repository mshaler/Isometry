# Plan 73-01: SuperStack Multi-Level Headers

**Phase:** 73 (SuperGrid Phase A)
**Plan:** 01 of 04
**Status:** READY
**Priority:** P0 — Critical path, blocks all other features
**Estimated Effort:** 1-2 days

## Goal

Implement multi-level nested headers with visual spanning. Currently `HeaderManager.generateHeaderTree()` returns flat, single-level headers. The spec requires nested headers where parent headers visually span their children.

## Requirements Covered

- STACK-01: Build header hierarchy tree from PAFV coordinates
- STACK-02: Calculate visual spans for nested headers
- STACK-03: Render headers as nested SVG groups with D3
- STACK-04: Click parent header selects all children

## Current State

`src/d3/SuperGridEngine/HeaderManager.ts` line 88-91:
```typescript
return {
  columns,
  rows,
  maxColumnLevels: 1,  // ← HARDCODED
  maxRowLevels: 1      // ← HARDCODED
};
```

## Target State

```
┌────────┬────────┬────────┐
│   Q1   │  Jan   │ Week 1 │  ← 3 levels deep
│        │        │ Week 2 │
│        │  Feb   │ Week 1 │
└────────┴────────┴────────┘
```

## Tasks

### Task 1: Add HeaderNode Type and Build Hierarchy Algorithm

**Files:** `src/d3/SuperGridEngine/types.ts`, `src/d3/SuperGridEngine/HeaderManager.ts`

**Implementation:**

```typescript
// In types.ts
interface HeaderNode {
  value: string;
  level: number;
  span: number;
  children: HeaderNode[];
  startIndex: number;
  endIndex: number;
  isCollapsed: boolean;
}

// In HeaderManager.ts
function buildHeaderHierarchy(
  cells: CellDescriptor[],
  axisValues: string[][]
): HeaderNode[]
```

**TDD:**
1. Write test: `buildHeaderHierarchy` with 3-level input returns correct tree
2. Implement algorithm from Implementation Plan Task 1.2
3. Verify spans sum to total cell count

### Task 2: Calculate Visual Dimensions

**Files:** `src/d3/SuperGridEngine/HeaderManager.ts`

**Implementation:**

```typescript
function calculateHeaderDimensions(
  headers: HeaderNode[],
  cellSize: number,
  headerDepth: number,
  orientation: 'column' | 'row'
): HeaderDescriptor[]
```

**TDD:**
1. Write test: Dimensions have correct pixel positions
2. Implement traversal with offset tracking
3. Verify positions match expected layout

### Task 3: Render Nested Headers in D3

**Files:** `src/d3/SuperGridEngine/Renderer.ts`

**Implementation:**

```typescript
function renderHeaders(
  svg: d3.Selection<SVGGElement, unknown, null, undefined>,
  headers: HeaderDescriptor[],
  config: { headerHeight: number, orientation: 'column' | 'row' }
)
```

**TDD:**
1. Write test: SVG groups created with correct class names
2. Implement using `.join()` with key function
3. Visual verification: Q1 spans Jan/Feb/Mar

### Task 4: Wire Parent Click to Select Children

**Files:** `src/d3/SuperGridEngine/Renderer.ts`, `src/d3/SuperGridEngine/index.ts`

**Implementation:**
- Add click handler to parent label zone
- Call `engine.selectHeaderChildren(headerId)`
- Update SelectionContext with descendant IDs

**TDD:**
1. Write test: Click parent header, selection includes all children
2. Implement handler with descendant traversal
3. Verify SelectionContext updated correctly

## Verification Gates

| Test | Command | Pass Criteria |
|------|---------|---------------|
| Unit: buildHeaderHierarchy | `npm run test -- HeaderManager` | Returns correct tree for 3-level input |
| Unit: calculateHeaderDimensions | `npm run test -- HeaderManager` | Spans sum to total cell count |
| Visual: 2-level render | Manual inspection | Q1 header spans Jan/Feb/Mar |
| Visual: 3-level render | Manual inspection | Year → Quarter → Month all span correctly |
| Integration: click parent | Click Q1 | All Q1 children selected |

## Commit Sequence

```bash
# Commit 1: Types and algorithm
feat(supergrid): add multi-level header tree building algorithm

# Commit 2: Rendering
feat(supergrid): render nested headers with visual spanning

# Commit 3: Interaction
feat(supergrid): wire header click to select children
```

## Files Modified

- `src/d3/SuperGridEngine/types.ts` — Add HeaderNode interface
- `src/d3/SuperGridEngine/HeaderManager.ts` — Implement hierarchy building
- `src/d3/SuperGridEngine/Renderer.ts` — Render nested headers
- `src/d3/SuperGridEngine/index.ts` — Expose selectHeaderChildren API
- `src/d3/SuperGridEngine/__tests__/HeaderManager.test.ts` — Unit tests
