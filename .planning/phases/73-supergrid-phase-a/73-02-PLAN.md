# Plan 73-02: SuperDensity Controls

**Phase:** 73 (SuperGrid Phase A)
**Plan:** 02 of 04
**Status:** READY
**Priority:** P0 — Core differentiator
**Estimated Effort:** 1 day

## Goal

Implement the Janus density model with two orthogonal controls:
- **Value Density (Zoom):** Collapse leaf values into parents via SQL GROUP BY
- **Extent Density (Pan):** Hide/show empty cells

## Requirements Covered

- DENS-01: Value density generates SQL GROUP BY
- DENS-02: Extent density filters empty cells
- DENS-03: DensityControls React component

## Current State

Types exist (`JanusDensityState`), no implementation. DataManager has placeholder SQL generation.

## Target State

Value slider collapses: Jan, Feb, Mar → Q1
Extent toggle: dense (populated only) ↔ sparse (all cells)

## Tasks

### Task 1: Value Density SQL Generation

**Files:** `src/d3/SuperGridEngine/DataManager.ts`

**Implementation:**

```typescript
function generateDensityQuery(
  baseQuery: string,
  densityLevel: number,
  axisHierarchy: string[]
): string
```

**TDD:**
1. Write test: Level 0 returns original query
2. Write test: Level 1 adds GROUP BY for parent level
3. Implement GROUP BY generation with aggregations

### Task 2: Extent Density Filtering

**Files:** `src/d3/SuperGridEngine/DataManager.ts`

**Implementation:**

```typescript
type ExtentMode = 'dense' | 'sparse' | 'ultra-sparse';

function filterEmptyCells(
  cells: CellDescriptor[],
  mode: ExtentMode
): CellDescriptor[]
```

**TDD:**
1. Write test: `dense` returns only populated cells
2. Write test: `sparse` includes neighbors
3. Write test: `ultra-sparse` returns all cells

### Task 3: DensityControls React Component

**Files:** `src/components/supergrid/DensityControls.tsx` (NEW)

**Implementation:**
- Value slider: 0 to maxValueLevel
- Extent toggle: dense | sparse | ultra-sparse
- Wire to PAFVContext or SuperGrid callbacks

**TDD:**
1. Write test: Component renders with both controls
2. Write test: Value slider calls onValueDensityChange
3. Write test: Extent buttons call onExtentDensityChange

### Task 4: Wire Controls to SuperGrid

**Files:** `src/components/supergrid/SuperGrid.tsx`

**Implementation:**
- Add DensityControls to SuperGrid layout
- Connect callbacks to DataManager
- Trigger re-render on density change

## Verification Gates

| Test | Command | Pass Criteria |
|------|---------|---------------|
| Unit: generateDensityQuery | `npm run test -- DataManager` | Level 1 query has correct GROUP BY |
| Unit: filterEmptyCells dense | `npm run test -- DataManager` | Only populated cells returned |
| Visual: Value slider | Slide to level 1 | Grid collapses from weeks to months |
| Visual: Extent toggle | Click "Dense" | Empty cells disappear |
| Integration: Both controls | Value=1, Extent=dense | Collapsed AND filtered |

## Commit Sequence

```bash
# Commit 1: Value density SQL generation
feat(supergrid): implement value density GROUP BY generation

# Commit 2: Extent density filtering
feat(supergrid): implement extent density cell filtering

# Commit 3: React controls
feat(supergrid): add DensityControls component with sliders
```

## Files Modified

- `src/d3/SuperGridEngine/DataManager.ts` — SQL generation and filtering
- `src/components/supergrid/DensityControls.tsx` — NEW React component
- `src/components/supergrid/SuperGrid.tsx` — Wire controls
- `src/d3/SuperGridEngine/__tests__/DataManager.test.ts` — Unit tests
