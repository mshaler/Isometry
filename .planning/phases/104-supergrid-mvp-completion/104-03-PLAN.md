# Phase 104 Plan 03: Tier 2 State Verification

**Plan:** 104-03
**Priority:** P1 (Non-blocking but important)
**Requirements:** VERIFY-01
**Est. Duration:** ~30 minutes

## Objective

Add integration tests verifying Tier 2 view state persistence across LATCH family transitions.

## Context

Per SuperGrid spec Section 5, view state has three tiers:
- **Tier 1 (Global):** Filters, selection, search, density, sort — always persists ✅
- **Tier 2 (Family):** Axis assignments, header states, viewport — persists within LATCH/GRAPH families
- **Tier 3 (Ephemeral):** Pixel positions, hover, drag — always resets

Tier 2 persistence needs verification testing.

## Tasks

### Task 1: Create View Transitions Integration Test

**File:** `src/test/integration/view-transitions.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { renderHook, act } from '@testing-library/react';
import { usePAFV } from '@/hooks/usePAFV';

describe('View Transition State Machine', () => {
  describe('Tier 2: LATCH Family State', () => {
    it('preserves axis assignments across Grid → List → Grid', () => {
      const { result } = renderHook(() => usePAFV());
      
      // Set custom axis assignment
      act(() => {
        result.current.setMapping('x', 'time', 'created_at');
        result.current.setMapping('y', 'category', 'status');
      });
      
      // Verify initial state
      expect(result.current.getMappingForPlane('x')).toEqual({
        dimension: 'time',
        field: 'created_at',
        plane: 'x'
      });
      
      // Simulate view transition to List (within LATCH family)
      act(() => {
        result.current.setActiveView('list');
      });
      
      expect(result.current.activeView).toBe('list');
      
      // Simulate view transition back to Grid
      act(() => {
        result.current.setActiveView('grid');
      });
      
      // Verify axis assignments preserved
      expect(result.current.getMappingForPlane('x')).toEqual({
        dimension: 'time',
        field: 'created_at',
        plane: 'x'
      });
      expect(result.current.getMappingForPlane('y')).toEqual({
        dimension: 'category',
        field: 'status',
        plane: 'y'
      });
    });

    it('preserves density setting across view changes', () => {
      const { result } = renderHook(() => usePAFV());
      
      // Set custom density
      act(() => {
        result.current.setDensity(0.75);
      });
      
      expect(result.current.density).toBe(0.75);
      
      // Change view
      act(() => {
        result.current.setActiveView('kanban');
      });
      
      // Change back
      act(() => {
        result.current.setActiveView('grid');
      });
      
      // Density should persist
      expect(result.current.density).toBe(0.75);
    });

    it('preserves zoom level across view changes', () => {
      const { result } = renderHook(() => usePAFV());
      
      // Set custom zoom
      act(() => {
        result.current.setZoomLevel(2.5);
      });
      
      expect(result.current.zoomLevel).toBe(2.5);
      
      // Change view and back
      act(() => {
        result.current.setActiveView('timeline');
        result.current.setActiveView('grid');
      });
      
      // Zoom should persist
      expect(result.current.zoomLevel).toBe(2.5);
    });

    it('clamps zoom level to valid range', () => {
      const { result } = renderHook(() => usePAFV());
      
      // Try to set zoom out of range
      act(() => {
        result.current.setZoomLevel(100);
      });
      
      expect(result.current.zoomLevel).toBeLessThanOrEqual(10);
      
      act(() => {
        result.current.setZoomLevel(0.01);
      });
      
      expect(result.current.zoomLevel).toBeGreaterThanOrEqual(0.1);
    });

    it('resets state on explicit reset call', () => {
      const { result } = renderHook(() => usePAFV());
      
      // Customize state
      act(() => {
        result.current.setMapping('x', 'time', 'created_at');
        result.current.setDensity(0.8);
        result.current.setZoomLevel(3);
        result.current.setActiveView('kanban');
      });
      
      // Reset
      act(() => {
        result.current.reset();
      });
      
      // Verify defaults restored
      expect(result.current.activeView).toBe('grid');
      expect(result.current.zoomLevel).toBe(1);
      expect(result.current.density).toBe(0.5);
    });
  });

  describe('Axis Mapping Operations', () => {
    it('removes mapping when removeMapping called', () => {
      const { result } = renderHook(() => usePAFV());
      
      // Set mapping
      act(() => {
        result.current.setMapping('z', 'hierarchy', 'priority');
      });
      
      expect(result.current.getMappingForPlane('z')).not.toBeNull();
      
      // Remove it
      act(() => {
        result.current.removeMapping('z');
      });
      
      expect(result.current.getMappingForPlane('z')).toBeNull();
    });

    it('getPlaneForDimension returns correct plane', () => {
      const { result } = renderHook(() => usePAFV());
      
      act(() => {
        result.current.setMapping('x', 'time', 'created_at');
        result.current.setMapping('y', 'category', 'status');
      });
      
      expect(result.current.getPlaneForDimension('time')).toBe('x');
      expect(result.current.getPlaneForDimension('category')).toBe('y');
      expect(result.current.getPlaneForDimension('location')).toBeNull();
    });

    it('overwrites existing mapping for same plane', () => {
      const { result } = renderHook(() => usePAFV());
      
      // Set initial mapping
      act(() => {
        result.current.setMapping('x', 'time', 'created_at');
      });
      
      // Overwrite with new mapping
      act(() => {
        result.current.setMapping('x', 'category', 'status');
      });
      
      const mapping = result.current.getMappingForPlane('x');
      expect(mapping?.dimension).toBe('category');
      expect(mapping?.field).toBe('status');
    });
  });
});
```

### Task 2: Create SuperDynamic E2E Test (Skeleton)

**File:** `src/test/integration/superdynamic-e2e.test.ts`

```typescript
import { describe, it, expect } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
// Import SuperGrid with providers

describe('SuperDynamic End-to-End', () => {
  it.todo('renders SuperDynamic in MiniNav area when enableDragDrop=true');
  
  it.todo('dragging x-axis to y-axis slot triggers transpose');
  
  it.todo('dragging facet from available list to empty slot assigns it');
  
  it.todo('pressing Escape during drag cancels without state change');
  
  it.todo('grid reflows with animation after axis drop');
});

// Note: Full E2E tests require DOM setup with providers.
// These are marked .todo for now - implement after Plan 104-01 completes.
```

## Verification

```bash
# Run integration tests
npm run test:run -- --testPathPattern="view-transitions"

# Run all supergrid tests
npm run test:run -- --testPathPattern="supergrid|pafv"

# Type check
npm run check:types
```

## Acceptance Criteria

- [ ] All view-transitions.test.ts tests pass
- [ ] usePAFV hook maintains state across view changes
- [ ] Reset function restores defaults
- [ ] TypeScript compiles with zero errors
