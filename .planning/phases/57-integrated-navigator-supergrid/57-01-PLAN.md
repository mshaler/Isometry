# Plan 57-01: Integrated Layout + Density Slider + Quick Wins

## Summary

Implement the integrated Navigator + SuperGrid + Sliders layout based on Figma design review. This plan covers Phase 1 "Quick Wins" from FIGMA-REVIEW-PUNCHLIST.md plus foundational layout integration.

## Context

**Figma Export Review:**
- LatchNavigator: 85% complete, minor fixes needed
- PafvNavigator: 75% complete, needs Transpose button + density integration
- DensitySlider: 90% complete but orphaned (not wired into layout)
- SuperGrid: React placeholder (D3 rewrite done in Phase 56)
- LatchSliders: 40% complete (Phase 57-02 scope)

**Key Integration Points:**
- Existing: `src/components/Navigator.tsx` with PAFVContext, DraggableFacet, PlaneDropZone
- Existing: `src/state/PAFVContext.tsx` with URL persistence, view mode management
- Existing: `src/d3/SuperGrid.ts` with GridRenderingEngine (Phase 56)
- Figma: App.tsx state pattern, PafvNavigator 5-well layout, DensitySlider 4-notch design

## Scope

### In Scope
1. Create unified IntegratedLayout component matching Figma vertical stack
2. Port DensitySlider 4-notch design and wire into layout
3. Add Transpose button between X and Y wells
4. Extend PAFVContext with density level state
5. Wire density to SuperGrid rendering

### Out of Scope (Later Plans)
- LATCH Sliders (57-02)
- Color/Size encoding dropdowns (57-02)
- Within-well reorder (57-02)
- Non-contiguous selection (57-03)

## Tasks

### Task 1: Create IntegratedLayout Component
**File:** `src/components/IntegratedLayout.tsx` (NEW)

Create the unified vertical stack layout:
```
┌─────────────────────────────────────────────┐
│ Toolbar (existing Navigator row)            │
├─────────────────────────────────────────────┤
│ Navigator 1: LATCH×GRAPH Filter (existing)  │
├─────────────────────────────────────────────┤
│ Navigator 2: PAFV Projection (enhanced)     │
│ [Available][X][Y][Z-Controls][Density]      │
├─────────────────────────────────────────────┤
│ SuperGrid (D3 canvas)              │Density │
│                                    │Slider  │
├─────────────────────────────────────────────┤
│ LATCH Sliders (placeholder for 57-02)       │
├─────────────────────────────────────────────┤
│ Command Bar                                  │
└─────────────────────────────────────────────┘
```

**Acceptance:**
- Vertical flexbox layout
- SuperGrid takes flex-1 to fill remaining space
- Density slider positioned at right edge of SuperGrid area
- Theme-aware styling (NeXTSTEP dark)

### Task 2: Port DensitySlider Component
**File:** `src/components/DensitySlider.tsx` (NEW)

Port the Figma DensitySlider with modifications:
- Remove `fixed right-4 top-1/2` positioning (now inline in layout)
- Keep 4-notch semantic levels:
  1. Value Sparsity — Full Cartesian product
  2. Extent Density — Populated-only
  3. View Density — Matrix view
  4. Region Density — Mixed regions
- Preserve hover tooltips and animated active indicator
- Wire to PAFVContext density state

**Acceptance:**
- Vertical slider with 4 clickable notch positions
- Tooltips with level name + description
- Animated blue ring on active level
- Sparse/Dense labels with icons

### Task 3: Extend PAFVContext with Density
**Files:**
- `src/types/pafv.ts` — Add density level to PAFVState
- `src/state/PAFVContext.tsx` — Add setDensityLevel action
- `src/utils/pafv-serialization.ts` — Include density in URL serialization

**Type additions:**
```typescript
interface PAFVState {
  viewMode: 'grid' | 'list';
  mappings: AxisMapping[];
  densityLevel: 1 | 2 | 3 | 4;  // NEW
}

interface PAFVContextValue {
  // ...existing
  setDensityLevel: (level: 1 | 2 | 3 | 4) => void;  // NEW
}
```

**Acceptance:**
- Density level persists in URL (e.g., `?pafv=...&density=2`)
- Default density: 2 (Extent Density)
- Context provides getter and setter

### Task 4: Add Transpose Button
**Files:**
- `src/components/navigator/PlaneDropZone.tsx` or new TransposeButton.tsx
- `src/components/Navigator.tsx` — Position between X and Y wells

**Implementation:**
```tsx
<TransposeButton onClick={handleTranspose} />
// Handler swaps x and y mappings in PAFVContext
```

**Visual spec:**
- 24×24px button
- ArrowLeftRight icon from lucide-react
- bg-[#2D2D2D], hover:bg-[#4A90D9], rounded
- Positioned between X-Plane and Y-Plane wells

**Acceptance:**
- Button visible between X and Y wells
- Click swaps x/y mappings in PAFVContext
- SuperGrid re-renders with transposed axes

### Task 5: Wire Density to SuperGrid
**Files:**
- `src/d3/SuperGrid.ts` — Add density level to config
- `src/d3/grid-rendering/GridRenderingEngine.ts` — Filter/aggregate based on density

**Behavior by level:**
1. Value Sparsity: Show all intersections (full Cartesian)
2. Extent Density: Hide empty rows/columns
3. View Density: Aggregate multiple cards per cell
4. Region Density: Mixed (future implementation)

**Acceptance:**
- GridRenderingEngine receives density level
- Level 1-2 implemented (sparse vs populated-only)
- Levels 3-4 stubbed with console.log for 57-02

### Task 6: Test Route Integration
**File:** `src/App.tsx`

Add test route: `?test=integrated`

**Acceptance:**
- Route renders IntegratedLayout
- Navigator, SuperGrid, DensitySlider all visible
- Drag-drop facets to axes works
- Transpose button works
- Density slider changes propagate

## Verification

```bash
# Type check
npm run typecheck

# Test
npm run test

# Manual verification
npm run dev
# Navigate to /?test=integrated
# Verify:
# 1. Layout matches Figma vertical stack
# 2. DensitySlider appears at right edge
# 3. Transpose button visible between X/Y wells
# 4. Dragging facets to wells updates SuperGrid
# 5. Changing density level affects grid rendering
```

## Files Changed

| File | Action | Description |
|------|--------|-------------|
| `src/components/IntegratedLayout.tsx` | CREATE | Unified layout component |
| `src/components/DensitySlider.tsx` | CREATE | 4-notch vertical density slider |
| `src/types/pafv.ts` | MODIFY | Add densityLevel to PAFVState |
| `src/state/PAFVContext.tsx` | MODIFY | Add setDensityLevel action |
| `src/utils/pafv-serialization.ts` | MODIFY | Serialize density in URL |
| `src/components/Navigator.tsx` | MODIFY | Add TransposeButton |
| `src/d3/SuperGrid.ts` | MODIFY | Accept density level |
| `src/d3/grid-rendering/GridRenderingEngine.ts` | MODIFY | Implement density filtering |
| `src/App.tsx` | MODIFY | Add `?test=integrated` route |

## Dependencies

- Phase 56 complete (SuperGrid PAFV projection)
- react-dnd already in project
- lucide-react for ArrowLeftRight icon

## Estimated Complexity

Medium — Integration of existing components with new layout and state wiring.

---

*Plan: 57-01*
*Phase: 57 - Integrated Navigator + SuperGrid + Sliders*
*Status: READY FOR EXECUTION*
