# Plan 57-03: Color/Size Encoding + Within-Well Reorder

## Summary

Implement visual encoding controls (Color and Size dropdowns) and within-well chip reordering for the PAFV Navigator. Based on P2 items from FIGMA-REVIEW-PUNCHLIST.md Component 2.

## Context

**Current State:**
- PlaneDropZone supports x, y, color planes (basic drop zone)
- PAFVState types already include 'color' and 'size' planes
- No encoding configuration (gradient, scale, etc.)
- No within-well reordering (only cross-well drops)
- Fixed well heights

**Priority per Punchlist:**
- P2: Color Encoding dropdown (property → color gradient)
- P2: Size Encoding dropdown (numeric property → card size)
- P2: Within-well reorder (drag to reorder chips)
- P2: Flexible well height (min-h-48 max-h-72)

## Scope

### In Scope
1. Create EncodingConfig type for color/size encoding
2. Add Color Encoding dropdown to Navigator
3. Add Size Encoding dropdown to Navigator
4. Implement within-well reorder via drag
5. Wire encoding to SuperGrid rendering
6. Make well heights flexible

### Out of Scope (Phase 58+)
- Drop animations (P3)
- Invalid drop indicator red border (P3)
- CSS transitions on chip movement (P3)

## Tasks

### Task 1: Add Encoding Types to PAFV
**File:** `src/types/pafv.ts` (MODIFY)

Add encoding configuration types:

```typescript
// Encoding type for visual properties (color, size)
export interface EncodingConfig {
  property: string | null;     // Property to encode
  type: 'categorical' | 'numeric' | 'ordinal';
  scale?: {
    domain?: unknown[];        // Input domain
    range?: string[] | number[]; // Output range (colors or sizes)
  };
}

// Extended PAFV state with encodings
export interface PAFVState {
  mappings: AxisMapping[];
  viewMode: 'grid' | 'list';
  densityLevel: DensityLevel;
  colorEncoding: EncodingConfig | null;
  sizeEncoding: EncodingConfig | null;
}
```

### Task 2: Update PAFVContext with Encoding Actions
**File:** `src/state/PAFVContext.tsx` (MODIFY)

Add actions for encoding:

```typescript
// New actions
type PAFVAction =
  | { type: 'SET_MAPPING'; payload: AxisMapping }
  | { type: 'REMOVE_MAPPING'; payload: Plane }
  | { type: 'SET_VIEW_MODE'; payload: 'grid' | 'list' }
  | { type: 'SET_DENSITY_LEVEL'; payload: DensityLevel }
  | { type: 'SET_COLOR_ENCODING'; payload: EncodingConfig | null }
  | { type: 'SET_SIZE_ENCODING'; payload: EncodingConfig | null }
  | { type: 'TRANSPOSE'; payload: undefined }
  | { type: 'RESET'; payload: undefined };
```

### Task 3: Create EncodingDropdown Component
**File:** `src/components/navigator/EncodingDropdown.tsx` (NEW)

Reusable dropdown for color/size encoding:

```typescript
interface EncodingDropdownProps {
  label: string;                    // "Color" or "Size"
  value: EncodingConfig | null;
  availableProperties: ClassifiedProperty[];
  onChange: (config: EncodingConfig | null) => void;
  encodingType: 'color' | 'size';
}
```

**Features:**
- Dropdown with "None" + available properties
- Color mode: shows gradient preview (blue→red for numeric, distinct hues for categorical)
- Size mode: only shows numeric properties
- Chip-style appearance matching Z-plane controls

### Task 4: Add Encoding Dropdowns to Navigator
**File:** `src/components/Navigator.tsx` (MODIFY)

Add Color and Size encoding dropdowns after Y-Plane:

```tsx
{/* Y-Plane (Rows) */}
<PlaneDropZone plane="y" currentMapping={getCurrentMapping('y')} />

{/* Encoding Controls */}
<div className="border-t border-gray-300 pt-2 mt-2 space-y-2">
  <EncodingDropdown
    label="Color"
    value={state.colorEncoding}
    availableProperties={allProperties}
    onChange={setColorEncoding}
    encodingType="color"
  />
  <EncodingDropdown
    label="Size"
    value={state.sizeEncoding}
    availableProperties={numericProperties}
    onChange={setSizeEncoding}
    encodingType="size"
  />
</div>
```

### Task 5: Implement Within-Well Reorder
**File:** `src/components/navigator/PlaneDropZone.tsx` (MODIFY)

Support reordering when multiple chips are stacked in a well:

**Changes:**
1. Track drop index within well
2. Show insertion indicator at drop position
3. Update array order on same-well drop
4. Support multiple chips per well (for future stacked axes)

```typescript
// Add to PlaneDropZone
const [{ isOver, canDrop, dropIndex }, drop] = useDrop({
  // ... existing drop logic
  hover: (item, monitor) => {
    // Calculate drop index based on cursor position
    const dropPosition = monitor.getClientOffset();
    // Set insertion indicator position
  },
});
```

### Task 6: Wire Encoding to SuperGrid
**Files:**
- `src/d3/SuperGrid.ts` (MODIFY)
- `src/d3/grid-rendering/GridRenderingEngine.ts` (MODIFY)
- `src/components/IntegratedLayout.tsx` (MODIFY)

**SuperGrid changes:**
```typescript
public setColorEncoding(encoding: EncodingConfig | null): void {
  this.colorEncoding = encoding;
  this.requestRender();
}

public setSizeEncoding(encoding: EncodingConfig | null): void {
  this.sizeEncoding = encoding;
  this.requestRender();
}
```

**GridRenderingEngine changes:**
- Apply color scale to card background based on property value
- Apply size scale to card dimensions within cell

**IntegratedLayout changes:**
- Sync colorEncoding and sizeEncoding from PAFVContext to SuperGrid

### Task 7: Make Well Heights Flexible
**File:** `src/components/navigator/PlaneDropZone.tsx` (MODIFY)

Change from fixed h-[80px] to flexible:

```tsx
// From:
min-h-[80px]

// To:
min-h-12 max-h-72 flex-grow
```

Also update the container to use flex layout for proper sizing.

## Verification

```bash
npm run typecheck
npm run test
npm run dev
# Navigate to /?test=integrated
# Verify:
# 1. Color dropdown appears below Y-Plane
# 2. Selecting a property shows gradient preview
# 3. Size dropdown shows only numeric properties
# 4. Card colors change based on color encoding
# 5. Card sizes change based on size encoding
# 6. Wells flex to accommodate content
```

## Files Changed

| File | Action | Description |
|------|--------|-------------|
| `src/types/pafv.ts` | MODIFY | Add EncodingConfig type |
| `src/state/PAFVContext.tsx` | MODIFY | Add encoding actions |
| `src/components/navigator/EncodingDropdown.tsx` | CREATE | Encoding dropdown component |
| `src/components/Navigator.tsx` | MODIFY | Add encoding dropdowns |
| `src/components/navigator/PlaneDropZone.tsx` | MODIFY | Flexible height, reorder support |
| `src/d3/SuperGrid.ts` | MODIFY | Add encoding methods |
| `src/d3/grid-rendering/GridRenderingEngine.ts` | MODIFY | Apply encoding to cards |
| `src/components/IntegratedLayout.tsx` | MODIFY | Sync encoding state |
| `src/hooks/index.ts` | MODIFY | Export any new hooks |

## Dependencies

- PAFVContext already has reducer pattern
- PlaneDropZone already uses react-dnd
- D3.js color scales available (d3-scale-chromatic)

## Estimated Complexity

Medium — Encoding state and rendering, plus within-well reorder DnD.

---

*Plan: 57-03*
*Phase: 57 - Integrated Navigator + SuperGrid + Sliders*
*Status: ✅ COMPLETED 2026-02-11*

## Completion Summary

All 7 tasks completed:
- ✅ Task 1: Added EncodingConfig/EncodingType to `src/types/pafv.ts`
- ✅ Task 2: Added setColorEncoding/setSizeEncoding to PAFVContext
- ✅ Task 3: Created EncodingDropdown component with gradient preview
- ✅ Task 4: Integrated encoding dropdowns into Navigator
- ✅ Task 5: Implemented within-well reorder with drag-and-drop
- ✅ Task 6: Wired encoding to SuperGrid (color scale applied to cards)
- ✅ Task 7: Made well heights flexible (min-h-12 max-h-72)
