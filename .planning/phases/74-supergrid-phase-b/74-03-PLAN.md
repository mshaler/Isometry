# Plan 74-03: SuperSelect — Z-Axis Aware Selection

**Phase:** 74 (SuperGrid Phase B)
**Plan:** 03 of 04
**Status:** READY
**Priority:** P0 — Core interaction
**Estimated Effort:** 1 day

## Goal

Implement full selection model: single-click, Cmd+click multi-select, Shift+click range select, header-click group select, and lasso select — all z-layer aware.

## Requirements Covered

- SEL-01: Click data cell selects that card (checkbox toggle)
- SEL-02: Click parent header selects all children at that level
- SEL-03: Cmd+click for multi-select
- SEL-04: Shift+click for range select
- SEL-05: Lasso select respects current z-level
- SEL-06: Every card has selection checkbox
- SEL-07: Selection survives view transitions (Tier 1)

## Current State

SelectionContext exists but only basic single-click. No multi-select, range, or lasso.

## Target State

```
Selection modes:
┌─────────────────────────────────────┐
│ Single click: Toggle one card       │
│ Cmd+click: Add/remove from set      │
│ Shift+click: Rectangular range      │
│ Header click: All cards in group    │
│ Lasso: Draw selection rectangle     │
└─────────────────────────────────────┘
```

## Tasks

### Task 1: Enhance SelectionContext

**Files:** `src/contexts/SelectionContext.tsx`

**Implementation:**

```typescript
interface SelectionState {
  selectedIds: Set<string>;
  lastSelectedId: string | null;    // For Shift+click range
  anchorId: string | null;          // For Shift+click anchor
  selectionMode: 'replace' | 'add' | 'toggle' | 'range';
}

interface SelectionActions {
  selectSingle(id: string): void;           // Replace selection
  toggleSelection(id: string): void;        // Cmd+click
  selectRange(toId: string): void;          // Shift+click
  selectMultiple(ids: string[]): void;      // Header click / lasso
  clearSelection(): void;
  isSelected(id: string): boolean;
}
```

**TDD:**
- Test: selectSingle replaces selection
- Test: toggleSelection adds if not present, removes if present
- Test: selectRange creates rectangular selection
- Test: Selection state is immutable Set

### Task 2: Implement Range Selection Algorithm

**Files:** `src/d3/SuperGridEngine/SelectManager.ts` (NEW)

**Implementation:**

```typescript
function calculateRangeSelection(
  anchorCell: CellDescriptor,
  targetCell: CellDescriptor,
  allCells: CellDescriptor[]
): string[] {
  const minX = Math.min(anchorCell.gridX, targetCell.gridX);
  const maxX = Math.max(anchorCell.gridX, targetCell.gridX);
  const minY = Math.min(anchorCell.gridY, targetCell.gridY);
  const maxY = Math.max(anchorCell.gridY, targetCell.gridY);

  return allCells
    .filter(cell =>
      cell.gridX >= minX && cell.gridX <= maxX &&
      cell.gridY >= minY && cell.gridY <= maxY
    )
    .map(cell => cell.id);
}
```

**TDD:**
- Test: Range from (0,0) to (2,2) returns 9 cells
- Test: Range from (2,2) to (0,0) returns same 9 cells (order independent)
- Test: Range on single cell returns 1 cell

### Task 3: Implement Lasso Selection

**Files:** `src/d3/SuperGridEngine/SelectManager.ts`

**Implementation:**

```typescript
interface LassoState {
  active: boolean;
  startPoint: { x: number; y: number };
  currentPoint: { x: number; y: number };
  previewIds: Set<string>;
}

class LassoSelector {
  startLasso(event: MouseEvent): void;
  updateLasso(event: MouseEvent): void;
  endLasso(): string[];

  private calculateLassoBounds(): DOMRect;
  private cellsInBounds(bounds: DOMRect, cells: CellDescriptor[]): string[];
}
```

**TDD:**
- Test: Lasso bounds calculated correctly
- Test: Only data cells returned (not headers)
- Test: Empty lasso returns empty array

### Task 4: Add Selection Checkboxes to Cards

**Files:** `src/d3/SuperGridEngine/Renderer.ts`

**Implementation:**

```typescript
function renderCardCheckbox(
  cardGroup: d3.Selection<SVGGElement, CellDescriptor, SVGGElement, unknown>,
  isSelected: (id: string) => boolean
) {
  const checkbox = cardGroup.selectAll('.card-checkbox')
    .data(d => [d])
    .join('g')
    .attr('class', 'card-checkbox')
    .attr('transform', 'translate(4, 4)');

  checkbox.selectAll('rect')
    .data(d => [d])
    .join('rect')
    .attr('width', 14)
    .attr('height', 14)
    .attr('rx', 2)
    .attr('fill', d => isSelected(d.id) ? '#4a90d9' : '#fff')
    .attr('stroke', '#999');

  checkbox.selectAll('path')
    .data(d => [d])
    .join('path')
    .attr('d', 'M3,7 L6,10 L11,4')
    .attr('stroke', '#fff')
    .attr('stroke-width', 2)
    .attr('fill', 'none')
    .style('opacity', d => isSelected(d.id) ? 1 : 0);
}
```

**TDD:**
- Test: Checkbox renders in each card
- Test: Selected cards show checkmark
- Test: Click checkbox toggles selection

### Task 5: Wire Click Handlers with Modifiers

**Files:** `src/d3/SuperGridEngine/Renderer.ts`

**Implementation:**

```typescript
function handleCellClick(
  event: MouseEvent,
  cell: CellDescriptor,
  selectionContext: SelectionActions
) {
  const { metaKey, ctrlKey, shiftKey } = event;
  const cmdKey = metaKey || ctrlKey; // macOS vs Windows

  if (shiftKey && selectionContext.anchorId) {
    selectionContext.selectRange(cell.id);
  } else if (cmdKey) {
    selectionContext.toggleSelection(cell.id);
  } else {
    selectionContext.selectSingle(cell.id);
  }
}
```

**TDD:**
- Test: Click alone calls selectSingle
- Test: Cmd+click calls toggleSelection
- Test: Shift+click calls selectRange

### Task 6: Ensure Tier 1 Persistence

**Files:** `src/contexts/SelectionContext.tsx`

**Implementation:**

Selection is already Tier 1 per spec, but verify:

```typescript
// Selection should NOT reset on view transition
// PAFVContext changes should NOT clear selection
useEffect(() => {
  // Do NOT reset selection when pafv changes
  // Selection persists across Grid → Kanban → Grid
}, []);
```

**TDD:**
- Test: Selection survives PAFVContext change
- Test: Selection survives view family switch
- Test: Selection serializes to SQLite view_state

## Files to Create/Modify

- `src/d3/SuperGridEngine/SelectManager.ts` — NEW
- `src/d3/SuperGridEngine/__tests__/SelectManager.test.ts` — NEW
- `src/contexts/SelectionContext.tsx` — Enhance with range/toggle
- `src/d3/SuperGridEngine/Renderer.ts` — Checkboxes, click handlers
- `src/d3/SuperGridEngine/index.ts` — Expose SelectManager

## Commit Sequence

```bash
# Commit 1: Enhanced selection state
feat(supergrid): enhance SelectionContext with range and toggle modes

# Commit 2: Range and lasso
feat(supergrid): implement Shift+click range and lasso selection

# Commit 3: Visual feedback
feat(supergrid): add selection checkboxes to cards

# Commit 4: Persistence
feat(supergrid): ensure selection survives view transitions
```

## Verification Gates

| Test | Action | Pass Criteria |
|------|--------|---------------|
| Single select | Click cell | Only that cell selected |
| Multi-select | Cmd+click 3 cells | All 3 selected |
| Range select | Click A, Shift+click B | Rectangle A-B selected |
| Header select | Click "Q1" header | All Q1 cells selected |
| Lasso | Drag rectangle over cells | Cells in rectangle selected |
| Checkbox | Click checkbox | Toggles that card only |
| Persistence | Select, switch view, return | Same selection |
