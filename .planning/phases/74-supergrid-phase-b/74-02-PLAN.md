# Plan 74-02: SuperSize — Cell & Header Resize

**Phase:** 74 (SuperGrid Phase B)
**Plan:** 02 of 04
**Status:** READY
**Priority:** P1 — Essential UX
**Estimated Effort:** 0.5 day

## Goal

Enable direct manipulation resize of columns and rows via drag handles. Shift+drag for bulk resize. Double-click to auto-fit.

## Requirements Covered

- SIZE-01: Drag right edge of header to resize single column/row
- SIZE-02: Shift+drag resizes all sibling cells proportionally
- SIZE-03: Minimum cell dimensions enforced (40px)
- SIZE-04: Sizes persist per-dataset
- SIZE-05: Double-click resize edge auto-fits to content

## Current State

ClickZoneManager detects `resize-edge` zone but no resize behavior is implemented.

## Target State

```
Before resize:           During resize:          After resize:
┌────┬────┬────┐        ┌────┬──|──┬────┐       ┌────┬────────┬────┐
│ A  │ B  │ C  │        │ A  │ B |  │ C  │       │ A  │   B    │ C  │
├────┼────┼────┤        ├────┼──|──┼────┤       ├────┼────────┼────┤
│    │    │    │        │    │   |  │    │       │    │        │    │
└────┴────┴────┘        └────┴──|──┴────┘       └────┴────────┴────┘
                             cursor
```

## Tasks

### Task 1: Create ResizeManager

**Files:** `src/d3/SuperGridEngine/ResizeManager.ts` (NEW)

**Implementation:**

```typescript
interface ResizeState {
  header: HeaderDescriptor;
  orientation: 'column' | 'row';
  startWidth: number;
  startX: number;
  isShiftHeld: boolean;
}

class ResizeManager {
  private state: ResizeState | null = null;
  private minSize = 40;

  startResize(header: HeaderDescriptor, event: MouseEvent): void;
  updateResize(event: MouseEvent): number; // returns new width
  endResize(): { headerId: string; newWidth: number };
  constrainSize(width: number): number;
}
```

**TDD:**
- Test: startResize captures initial state
- Test: updateResize returns delta applied to width
- Test: constrainSize enforces minimum 40px
- Test: endResize returns final dimensions

### Task 2: Implement Bulk Resize (Shift+drag)

**Files:** `src/d3/SuperGridEngine/ResizeManager.ts`

**Implementation:**

```typescript
function resizeSiblings(
  headers: HeaderDescriptor[],
  targetHeader: HeaderDescriptor,
  deltaRatio: number
): Map<string, number> {
  const siblings = headers.filter(h => h.level === targetHeader.level);
  const newWidths = new Map<string, number>();

  for (const sibling of siblings) {
    const newWidth = Math.max(
      this.minSize,
      sibling.position.width * deltaRatio
    );
    newWidths.set(sibling.id, newWidth);
  }

  return newWidths;
}
```

**TDD:**
- Test: Shift+drag applies ratio to all siblings
- Test: Minimum enforced on all siblings
- Test: Non-siblings unchanged

### Task 3: Implement Auto-Fit on Double-Click

**Files:** `src/d3/SuperGridEngine/ResizeManager.ts`

**Implementation:**

```typescript
function calculateAutoFitWidth(
  header: HeaderDescriptor,
  cells: CellDescriptor[],
  measureText: (text: string) => number
): number {
  // Find cells in this column
  const columnCells = cells.filter(c =>
    c.gridX >= header.startIndex && c.gridX <= header.endIndex
  );

  // Measure max content width
  let maxWidth = measureText(header.value) + 16; // padding

  for (const cell of columnCells) {
    const contentWidth = measureText(cell.primaryText || '') + 16;
    maxWidth = Math.max(maxWidth, contentWidth);
  }

  return Math.max(this.minSize, maxWidth);
}
```

**TDD:**
- Test: Auto-fit returns width that fits header text
- Test: Auto-fit considers cell content
- Test: Auto-fit respects minimum

### Task 4: Persist Sizes to SQLite

**Files:** `src/d3/SuperGridEngine/ResizeManager.ts`, `src/db/queries.ts`

**Implementation:**

```typescript
// Schema: view_state table (already exists per Spec Section 5)
// Add column_widths JSON field

interface ColumnWidths {
  [headerId: string]: number;
}

async function persistColumnWidths(
  db: Database,
  datasetId: string,
  widths: ColumnWidths
): Promise<void> {
  const state = await getViewState(db, datasetId, 'LATCH');
  state.columnWidths = widths;
  await saveViewState(db, datasetId, 'LATCH', state);
}

async function loadColumnWidths(
  db: Database,
  datasetId: string
): Promise<ColumnWidths> {
  const state = await getViewState(db, datasetId, 'LATCH');
  return state.columnWidths || {};
}
```

**TDD:**
- Test: persistColumnWidths saves to SQLite
- Test: loadColumnWidths retrieves saved widths
- Test: Resize → persist → reload → same width

### Task 5: Wire to Renderer

**Files:** `src/d3/SuperGridEngine/Renderer.ts`

**Implementation:**

```typescript
// In renderHeaders, add resize behavior
headerGroup.select('.header-bg')
  .on('mousedown', (event, d) => {
    const zone = this.clickZoneManager.hitTest(event);
    if (zone.zone === 'resize-edge') {
      this.resizeManager.startResize(d, event);
      event.stopPropagation();
    }
  })
  .on('dblclick', (event, d) => {
    const zone = this.clickZoneManager.hitTest(event);
    if (zone.zone === 'resize-edge') {
      const newWidth = this.resizeManager.calculateAutoFitWidth(d, this.cells);
      this.applyWidth(d.id, newWidth);
    }
  });
```

## Files to Create/Modify

- `src/d3/SuperGridEngine/ResizeManager.ts` — NEW
- `src/d3/SuperGridEngine/__tests__/ResizeManager.test.ts` — NEW
- `src/d3/SuperGridEngine/Renderer.ts` — Wire resize behavior
- `src/d3/SuperGridEngine/index.ts` — Expose ResizeManager
- `src/db/queries.ts` — Add width persistence queries

## Commit Sequence

```bash
# Commit 1: Core resize
feat(supergrid): add ResizeManager with drag-to-resize

# Commit 2: Bulk and auto-fit
feat(supergrid): implement Shift+drag bulk resize and double-click auto-fit

# Commit 3: Persistence
feat(supergrid): persist column widths to SQLite
```

## Verification Gates

| Test | Action | Pass Criteria |
|------|--------|---------------|
| Single resize | Drag right edge | Column widens/narrows smoothly |
| Bulk resize | Shift+drag any header | All same-level headers resize |
| Minimum | Resize to < 40px | Stops at 40px |
| Auto-fit | Double-click edge | Width fits longest content |
| Persist | Resize, reload page | Same width restored |
