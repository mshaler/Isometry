---
phase: 35-pafv-grid-core
plan: 02
type: execute
wave: 2
depends_on: ["35-01"]
files_modified: [
  "src/d3/SuperGrid.ts",
  "src/services/LATCHFilterService.ts",
  "src/components/SuperGridDemo.tsx"
]
autonomous: true

must_haves:
  truths:
    - "User can click row headers to filter grid by that folder/category"
    - "User can click column headers to filter grid by that status/priority"
    - "Grid updates immediately with filtered data using SQL WHERE clauses"
    - "Filter state is visible in UI with active filter indicators"
  artifacts:
    - path: "src/services/LATCHFilterService.ts"
      provides: "LATCH filter compilation service"
      min_lines: 80
      exports: ["LATCHFilterService", "LATCHFilter"]
    - path: "src/d3/SuperGrid.ts"
      provides: "SuperGrid with header click filtering"
      contains: "onHeaderClick.*filter"
    - path: "src/components/SuperGridDemo.tsx"
      provides: "Demo with active filter indicators"
      contains: "activeFilters.*state"
  key_links:
    - from: "SuperGrid header clicks"
      to: "LATCHFilterService"
      via: "filter compilation"
      pattern: "compileFilters.*SQL.*WHERE"
    - from: "LATCHFilterService"
      to: "sql.js database"
      via: "filtered query execution"
      pattern: "db\\.query.*WHERE.*filters"
---

<objective>
Implement header click filtering to enable dynamic LATCH-based data filtering via SuperGrid headers

Purpose: Transform static headers into interactive filters that enable users to drill down into data subsets using the LATCH framework
Output: Working header-based filtering with visual feedback and immediate grid updates
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-pafv-grid-core/35-01-SUMMARY.md
@src/d3/SuperGrid.ts
@src/components/SuperGridDemo.tsx
@src/state/PAFVContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LATCHFilterService</name>
  <files>src/services/LATCHFilterService.ts</files>
  <action>
    Create a comprehensive LATCH filter service that handles filter compilation and state management:

    1. Define LATCHFilter interface with axis (L/A/T/C/H), facet, operator, and value
    2. Create LATCHFilterService class with methods:
       - addFilter(axis, facet, operator, value) - add new filter
       - removeFilter(filterId) - remove specific filter
       - clearFilters(axis?) - clear all or axis-specific filters
       - compileToSQL() - generate SQL WHERE clause from active filters
       - getActiveFilters() - return current filter state
    3. Implement proper SQL injection prevention using parameterized queries
    4. Handle multiple filters on same axis with AND/OR logic
    5. Support common operators: equals, not_equals, contains, starts_with, in_list
    6. Add location filters (latitude/longitude ranges, location_name)
    7. Add time filters (date ranges, relative dates like "last 30 days")
    8. Add category filters (folder exact match, tag contains, status equals)
    9. Add hierarchy filters (priority ranges, importance levels)
    10. Export proper TypeScript types for integration

    Follow CLAUDE.md patterns - use strict TypeScript, no any types, comprehensive error handling.
  </action>
  <verify>npm run typecheck passes, LATCHFilterService exports correct types and methods</verify>
  <done>LATCHFilterService provides complete filter compilation with SQL WHERE clause generation</done>
</task>

<task type="auto">
  <name>Task 2: Implement Header Click Filtering in SuperGrid</name>
  <files>src/d3/SuperGrid.ts</files>
  <action>
    Update SuperGrid to handle header clicks and trigger LATCH filtering:

    1. Import LATCHFilterService and initialize instance in constructor
    2. Replace console.log header click handlers with actual filtering logic
    3. Implement handleRowHeaderClick:
       - Extract folder/category from clicked header
       - Add filter to LATCHFilterService (axis='category', facet='folder', operator='equals', value)
       - Compile filters to SQL and re-render grid with filtered query
    4. Implement handleColumnHeaderClick:
       - Extract status/priority from clicked header
       - Add filter to LATCHFilterService (axis='category', facet='status', operator='equals', value)
       - Compile filters and re-render grid
    5. Add visual feedback for active filters:
       - Highlight active header backgrounds with different color
       - Add filter removal icons to active headers
       - Show filter count badges on headers
    6. Add filter clearing mechanism (right-click or double-click to clear)
    7. Ensure onHeaderClick callback includes filter state for external components
    8. Handle multiple filters gracefully (additive filtering)
    9. Update renderWithFilters method to use LATCHFilterService instead of manual filter object

    Maintain existing CLAUDE.md D3.js patterns, use proper key functions and .join() methods.
  </action>
  <verify>Header clicks add filters, grid updates with filtered data, active headers show visual feedback</verify>
  <done>SuperGrid headers are fully interactive with LATCH-based filtering and visual feedback</done>
</task>

<task type="auto">
  <name>Task 3: Add Filter Management UI to SuperGridDemo</name>
  <files>src/components/SuperGridDemo.tsx</files>
  <action>
    Enhance SuperGridDemo to display and manage active filters:

    1. Add activeFilters state to component (sync with SuperGrid filter service)
    2. Create filter indicator panel showing current active filters:
       - Display each filter as a removable chip/badge
       - Include filter axis, facet, and value (e.g., "Folder: work", "Status: active")
       - Add remove button (Ã—) for each filter chip
    3. Add "Clear All Filters" button to reset grid to unfiltered state
    4. Implement filter chip removal that updates SuperGrid filter service
    5. Add filter count to performance monitor panel
    6. Add keyboard shortcuts for common filters:
       - 1-5 keys for priority filtering
       - F key to focus on folder filter
       - S key to focus on status filter
       - Escape key to clear all filters
    7. Update handleHeaderClick callback to sync filter state with UI
    8. Add filter history/breadcrumb showing filter sequence
    9. Add quick filter buttons for common combinations ("Work + Active", "High Priority", etc.)
    10. Ensure filter UI is accessible with proper labels and keyboard navigation

    Use existing UI patterns from the demo, maintain consistent styling with performance monitor.
  </action>
  <verify>Filter chips appear when headers clicked, chips can be removed, clear all works, keyboard shortcuts functional</verify>
  <done>SuperGridDemo provides comprehensive filter management UI with chips, shortcuts, and clear functionality</done>
</task>

</tasks>

<verification>
1. Click folder header - grid filters to show only cards in that folder
2. Click status header - grid filters additionally by status (additive)
3. Filter chips appear showing active filters
4. Remove filter chip - grid updates to remove that filter
5. Clear All Filters button - grid shows all cards
6. Keyboard shortcuts work for common filters
7. Performance monitor shows filter count
8. TypeScript compilation succeeds with zero errors
</verification>

<success_criteria>
- Header clicks immediately filter grid data using SQL WHERE clauses
- Multiple filters work additively (folder AND status filtering)
- Visual feedback clearly shows which filters are active
- Filter management UI allows easy removal of individual or all filters
- Keyboard shortcuts provide power-user filter access
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/35-pafv-grid-core/35-02-SUMMARY.md`
</output>