---
phase: 35-pafv-grid-core
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [
  "src/d3/SuperGrid.ts",
  "src/components/SuperGridDemo.tsx"
]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can click headers to apply LATCH filters with visual feedback"
    - "Header clicks integrate with LATCHFilterService for SQL compilation"
    - "Active filter state shows visually on headers"
    - "Filtered data updates grid display immediately"
  artifacts:
    - path: "src/d3/SuperGrid.ts"
      provides: "Header click handlers with LATCH filter integration"
      contains: "headerClickCallback.*LATCHFilterService"
    - path: "src/components/SuperGridDemo.tsx"
      provides: "LATCHFilterService integration and filter management"
      exports: ["SuperGridDemo with filter state"]
  key_links:
    - from: "SuperGrid.renderHeaders()"
      to: "headerClickCallback"
      via: "click event handler"
      pattern: "\\.on\\('click'.*headerClick"
    - from: "SuperGridDemo"
      to: "LATCHFilterService.addFilter()"
      via: "header click callback"
      pattern: "filterService\\.addFilter"
    - from: "SuperGrid.query()"
      to: "LATCHFilterService.compileToSQL()"
      via: "filter compilation"
      pattern: "filterService\\.compileToSQL"
---

<objective>
Wire header click functionality to LATCH filtering system to close the gap in Phase 35 verification.

Purpose: Enable dynamic LATCH filtering through header interactions, completing the SuperGrid core interaction system
Output: Functional header filtering with visual feedback and database integration
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-pafv-grid-core/35-VERIFICATION.md
@.planning/phases/35-pafv-grid-core/35-03-SUMMARY.md
@src/services/LATCHFilterService.ts
@src/d3/SuperGrid.ts
</context>

<tasks>

<task type="auto">
  <name>Add header click handlers to SuperGrid</name>
  <files>src/d3/SuperGrid.ts</files>
  <action>
    Add headerClickCallback parameter to SuperGrid constructor callbacks.

    In renderHeaders() method:
    - Add click event handler to header elements (both rect and text)
    - Extract filter information from header data (axis, facet, value)
    - Call headerClickCallback with filter parameters
    - Add visual feedback for clickable headers (cursor pointer, hover effects)
    - Add active state styling for headers with active filters

    Update query() method:
    - Accept filterCompilationResult parameter instead of manual filter object
    - Replace hardcoded SQL construction with filterCompilationResult.whereClause
    - Use filterCompilationResult.parameters for query parameters
    - Remove manual filter logic (folder, status, priority checks)

    Gap reason: Headers created in renderHeaders() but no click event handlers attached
    Reference existing code: Multi-select and keyboard navigation patterns from Phase 35-03
  </action>
  <verify>Check that renderHeaders() creates clickable elements with event handlers</verify>
  <done>Headers are clickable and call headerClickCallback with filter data</done>
</task>

<task type="auto">
  <name>Integrate LATCHFilterService in SuperGridDemo</name>
  <files>src/components/SuperGridDemo.tsx</files>
  <action>
    Import and initialize LATCHFilterService:
    - Create filterService instance in SuperGridDemo
    - Add filterService state management for active filters
    - Add headerClickCallback handler that calls filterService.addFilter()

    Connect filter service to SuperGrid:
    - Generate filterCompilationResult from filterService.compileToSQL()
    - Pass compiled filters to SuperGrid.query() calls
    - Add filter change listener to trigger grid refresh
    - Add UI for displaying active filters with remove capability

    Maintain existing functionality:
    - Keep existing multi-select, card modal, bulk operations
    - Ensure all existing callbacks still work
    - Preserve selection state during filtering

    Gap reason: LATCHFilterService exists with compileToSQL() but not integrated with SuperGrid
    Missing integration between header clicks and LATCHFilterService.addFilter()
  </action>
  <verify>Check that clicking headers adds filters and updates grid display</verify>
  <done>Header clicks create LATCH filters and filter the grid data</done>
</task>

<task type="auto">
  <name>Add visual feedback for active filter state</name>
  <files>src/d3/SuperGrid.ts</files>
  <action>
    Enhance header rendering with filter state awareness:
    - Add activeFilters parameter to renderHeaders()
    - Apply active styling to headers with matching filters
    - Add distinct colors/borders for filtered vs unfiltered headers
    - Add hover states for better click affordance
    - Add filter count badges if multiple values per header

    Update visual styling:
    - Active headers: darker background, accent border
    - Hover states: subtle highlighting for interactive feedback
    - Clickable cursor: pointer cursor on header elements
    - Filter badges: small indicators showing filter count

    Connect visual updates to filter changes:
    - Accept currentFilters in render cycle
    - Update header styling based on active filter matching
    - Maintain performance with efficient visual updates

    Gap reason: UI updates to show active filter state on headers missing
    Connection between LATCHFilterService.compileToSQL() and SuperGrid.query() needed
  </action>
  <verify>Check that headers show visual feedback for active filter state</verify>
  <done>Headers display active state when filters are applied</done>
</task>

</tasks>

<verification>
Test header clicking functionality:
1. Click on different headers in SuperGrid
2. Verify filters are added to LATCHFilterService
3. Confirm grid data updates to show filtered results
4. Check visual feedback shows active filter state
5. Test filter removal and grid refresh
</verification>

<success_criteria>
- Headers are clickable and trigger LATCH filter addition
- Grid updates immediately when filters are applied
- Visual feedback shows which headers have active filters
- LATCHFilterService.compileToSQL() drives all SuperGrid.query() calls
- All existing SuperGrid functionality (multi-select, drag, modal) still works
- Phase 35 verification gap is closed
</success_criteria>

<output>
After completion, create `.planning/phases/35-pafv-grid-core/35-05-SUMMARY.md`
</output>