---
phase: 35-pafv-grid-core
plan: 04
type: execute
wave: 3
depends_on: ["35-02", "35-03"]
files_modified: [
  "src/d3/SuperGrid.ts",
  "src/db/DatabaseService.ts"
]
autonomous: true

must_haves:
  truths:
    - "User can drag cards to new positions in SuperGrid"
    - "Card position changes persist to database immediately"
    - "Drag operations provide smooth visual feedback during interaction"
    - "Grid maintains layout consistency after drag operations"
  artifacts:
    - path: "src/d3/SuperGrid.ts"
      provides: "SuperGrid with drag & drop functionality"
      min_lines: 900
      contains: "d3.drag.*dragstarted.*dragged.*dragended"
    - path: "src/db/DatabaseService.ts"
      provides: "DatabaseService with position update methods"
      contains: "updateCardPosition.*x.*y.*coordinates"
  key_links:
    - from: "D3.js drag events"
      to: "card position updates"
      via: "drag coordinate translation"
      pattern: "transform.*translate.*x.*y"
    - from: "drag end events"
      to: "DatabaseService position persistence"
      via: "updateCardPosition calls"
      pattern: "updateCardPosition.*dragended"
---

<objective>
Implement drag & drop functionality with database persistence for SuperGrid card repositioning

Purpose: Enable direct manipulation of card positions with immediate persistence, completing the interactive SuperGrid feature set
Output: Working drag & drop with smooth animations, collision detection, and database position updates
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-pafv-grid-core/35-02-SUMMARY.md
@.planning/phases/35-pafv-grid-core/35-03-SUMMARY.md
@src/d3/SuperGrid.ts
@src/db/DatabaseService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Drag & Drop in SuperGrid</name>
  <files>src/d3/SuperGrid.ts</files>
  <action>
    Add comprehensive drag & drop functionality to SuperGrid cards:

    1. Import d3.drag and configure drag behavior in constructor
    2. Add drag state management:
       - isDragging flag to prevent unwanted interactions during drag
       - dragStartPosition to track original coordinates
       - draggedCard reference to track which card is being moved
    3. Implement dragstarted handler:
       - Store original position and card reference
       - Add dragging CSS class for visual feedback
       - Raise dragged card z-index to appear on top
       - Disable text selection during drag
       - Prevent card click events while dragging
    4. Implement dragged handler:
       - Update card position based on drag delta
       - Apply constraints to keep card within grid bounds
       - Add snap-to-grid functionality (optional, configurable)
       - Provide real-time visual feedback during drag
       - Show drop zones or grid guidelines
    5. Implement dragended handler:
       - Calculate final position from drag transform
       - Reset visual state (remove drag classes, restore z-index)
       - Call onCardUpdate callback with new position
       - Re-enable normal interactions
       - Trigger position persistence to database
    6. Add drag visual enhancements:
       - Semi-transparent dragged card appearance
       - Drop shadow during drag for elevation effect
       - Smooth transitions when drag ends
       - Collision detection with other cards (optional push-aside)
    7. Integrate drag with existing selection system:
       - Allow dragging multiple selected cards together
       - Maintain relative positions during multi-card drag
       - Update all selected card positions proportionally
    8. Handle edge cases:
       - Prevent drag outside valid drop areas
       - Handle rapid mouse movements and drag escape
       - Manage drag interactions with zoom/pan (if implemented)
    9. Add accessibility support:
       - Keyboard-based card moving (arrow keys with modifier)
       - Screen reader announcements for position changes
    10. Ensure drag doesn't interfere with existing interactions (clicks, selection, modal)

    Follow CLAUDE.md D3.js patterns, use proper event handling, maintain performance during drag operations.
  </action>
  <verify>Cards can be dragged smoothly with visual feedback, positions update during drag, dragended calls position persistence</verify>
  <done>SuperGrid cards support full drag & drop functionality with visual feedback and position constraints</done>
</task>

<task type="auto">
  <name>Task 2: Add Position Persistence to DatabaseService</name>
  <files>src/db/DatabaseService.ts</files>
  <action>
    Extend DatabaseService to handle card position updates with efficient persistence:

    1. Add updateCardPosition method:
       - Accept cardId, x, y coordinates as parameters
       - Execute UPDATE SQL to modify node position in database
       - Include modified_at timestamp update
       - Handle database errors gracefully with proper error types
       - Return success/failure status for caller feedback
    2. Add bulk position update method (updateCardPositions):
       - Accept array of {cardId, x, y} position updates
       - Use SQL transaction for atomic bulk updates
       - Optimize with single multi-row UPDATE or batched statements
       - Handle partial failures in bulk operations
    3. Add position validation:
       - Validate coordinate ranges (prevent negative or extreme values)
       - Check card existence before position update
       - Handle floating-point precision for coordinates
    4. Add position querying methods:
       - getCardPosition(cardId) - retrieve current coordinates
       - getCardsInRegion(x1, y1, x2, y2) - spatial queries for region selection
       - getCardsByDistance(centerX, centerY, radius) - proximity queries
    5. Add position-related database optimizations:
       - Consider adding spatial indexes if performance is needed
       - Implement position change debouncing to reduce database writes
       - Add position history tracking (optional for undo functionality)
    6. Integrate with existing query methods:
       - Ensure position data is returned in standard card queries
       - Update schema verification to include position columns
       - Handle migration of existing cards without positions (set defaults)
    7. Add position-related error handling:
       - Custom error types for position update failures
       - Retry logic for transient database errors
       - Logging for position update operations
    8. Ensure compatibility with existing DatabaseService patterns:
       - Match existing method signatures and error handling
       - Maintain transaction consistency with other operations
       - Follow existing TypeScript typing patterns

    Follow existing DatabaseService patterns, use parameterized queries, handle errors properly.
  </action>
  <verify>updateCardPosition method exists and works, position updates persist across page refresh</verify>
  <done>DatabaseService supports efficient card position persistence with proper error handling and validation</done>
</task>

</tasks>

<verification>
1. Drag a card to new position - smooth visual feedback during drag
2. Drop card - position persists and card stays in new location
3. Refresh page - card remains in dragged position (database persistence verified)
4. Drag multiple selected cards - all move together maintaining relative positions
5. Drag card near edge - position constraints prevent dragging outside grid
6. Check database - x, y coordinates updated correctly with modified_at timestamp
7. TypeScript compilation succeeds with zero errors
</verification>

<success_criteria>
- Cards can be dragged smoothly with real-time visual feedback
- Drag operations feel responsive and natural with proper constraints
- Position changes persist immediately to database without delay
- Multi-select drag works correctly moving all selected cards
- Grid layout remains consistent after drag operations
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/35-pafv-grid-core/35-04-SUMMARY.md`
</output>