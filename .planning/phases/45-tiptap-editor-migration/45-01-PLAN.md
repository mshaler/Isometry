---
phase: 45-tiptap-editor-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/notebook/editor/TipTapEditor.tsx
  - src/components/notebook/editor/EditorToolbar.tsx
  - src/hooks/ui/useTipTapEditor.ts
  - src/components/notebook/CaptureComponent.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "User edits Markdown content via TipTap editor"
    - "User sees content load from activeCard.markdownContent"
    - "User content auto-saves to sql.js after 2 second debounce"
    - "User experiences no lag on 10,000+ character documents"
  artifacts:
    - path: "src/components/notebook/editor/TipTapEditor.tsx"
      provides: "TipTap editor component with performance config"
      exports: ["TipTapEditor"]
    - path: "src/hooks/ui/useTipTapEditor.ts"
      provides: "TipTap hook with auto-save and Markdown persistence"
      exports: ["useTipTapEditor"]
    - path: "src/components/notebook/editor/EditorToolbar.tsx"
      provides: "Toolbar using useEditorState selector"
      exports: ["EditorToolbar"]
  key_links:
    - from: "src/components/notebook/CaptureComponent.tsx"
      to: "src/components/notebook/editor/TipTapEditor.tsx"
      via: "component import and render"
      pattern: "import.*TipTapEditor"
    - from: "src/hooks/ui/useTipTapEditor.ts"
      to: "src/contexts/NotebookContext.tsx"
      via: "useNotebook hook for updateCard"
      pattern: "useNotebook.*updateCard"
    - from: "src/components/notebook/editor/TipTapEditor.tsx"
      to: "@tiptap/extension-markdown"
      via: "Markdown storage persistence"
      pattern: "editor.storage.markdown.getMarkdown"
---

<objective>
Install TipTap packages and build core editor component with performance optimizations for 10,000+ character documents.

Purpose: Replace MDEditor with TipTap foundation that enables future extensions (slash commands, wiki links) while maintaining existing auto-save logic.
Output: Working TipTap editor in CaptureComponent with Markdown round-trip persistence to sql.js.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-tiptap-editor-migration/45-RESEARCH.md

@src/components/notebook/CaptureComponent.tsx
@src/hooks/ui/useMarkdownEditor.ts
@src/contexts/NotebookContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install TipTap packages and create editor component</name>
  <files>
    package.json
    src/components/notebook/editor/TipTapEditor.tsx
    src/components/notebook/editor/EditorToolbar.tsx
    src/components/notebook/editor/index.ts
  </files>
  <action>
1. Install TipTap packages:
```bash
npm install @tiptap/react @tiptap/pm @tiptap/starter-kit @tiptap/extension-markdown @tiptap/extension-link @tiptap/extension-placeholder
```

2. Create `src/components/notebook/editor/TipTapEditor.tsx`:
- Import useEditor, EditorContent from @tiptap/react
- Import useEditorState from @tiptap/react (for toolbar state)
- Configure editor with CRITICAL performance settings:
  - `immediatelyRender: true`
  - `shouldRerenderOnTransaction: false`
- Include StarterKit, Markdown, Link, Placeholder extensions
- Placeholder text: "Type / for commands..."
- Accept props: initialContent, onUpdate, className
- onUpdate callback receives Markdown string (not ProseMirror JSON)

3. Create `src/components/notebook/editor/EditorToolbar.tsx`:
- Use useEditorState with selector for isBold, isItalic, isHeading, canUndo, canRedo
- This is how toolbar updates without re-rendering entire editor
- Buttons: Bold, Italic, Heading 1/2/3, Undo, Redo
- Style with existing theme patterns (check theme context)

4. Create `src/components/notebook/editor/index.ts` barrel export

CRITICAL: The `shouldRerenderOnTransaction: false` setting is non-negotiable for performance. Without it, 10,000+ character documents will lag noticeably.
  </action>
  <verify>
- `npm run typecheck` passes
- New files exist in src/components/notebook/editor/
- No TypeScript errors in TipTapEditor.tsx
  </verify>
  <done>TipTapEditor component exists with performance config and toolbar uses selector pattern</done>
</task>

<task type="auto">
  <name>Task 2: Create useTipTapEditor hook with Markdown persistence</name>
  <files>
    src/hooks/ui/useTipTapEditor.ts
    src/hooks/index.ts
  </files>
  <action>
1. Create `src/hooks/ui/useTipTapEditor.ts`:
- Adapt existing useMarkdownEditor.ts logic for TipTap
- Use useEditor with extensions array:
  - StarterKit (basic formatting)
  - Markdown (import from @tiptap/extension-markdown)
  - Placeholder.configure({ placeholder: 'Type / for commands...' })
- Configure performance: immediatelyRender: true, shouldRerenderOnTransaction: false
- Implement onUpdate handler:
  - Extract Markdown via `editor.storage.markdown.getMarkdown()`
  - Set isDirty = true
  - Trigger debouncedSave
- Implement debouncedSave (keep existing 2000ms delay):
  - Call updateCard(cardId, { markdownContent: markdown })
- Implement saveNow for manual save (Ctrl+S)
- Sync with activeCard changes:
  - When activeCard.id changes, call `editor.commands.setContent(activeCard.markdownContent)`
  - Reset isDirty = false
- Return: { editor, isDirty, isSaving, saveNow, activeCard }

2. Update `src/hooks/index.ts` to export useTipTapEditor

IMPORTANT: Store MARKDOWN in sql.js (markdownContent column), NOT ProseMirror JSON. TipTap JSON is ephemeral.
  </action>
  <verify>
- `npm run typecheck` passes
- useTipTapEditor exports correctly from hooks/index.ts
- Hook signature matches: { editor, isDirty, isSaving, saveNow, activeCard }
  </verify>
  <done>useTipTapEditor hook provides Markdown persistence with auto-save and performance optimization</done>
</task>

<task type="auto">
  <name>Task 3: Replace MDEditor with TipTap in CaptureComponent</name>
  <files>
    src/components/notebook/CaptureComponent.tsx
  </files>
  <action>
1. Update imports in CaptureComponent.tsx:
- Remove: `import MDEditor from '@uiw/react-md-editor'`
- Remove: `import { useMarkdownEditor } from '@/hooks'`
- Add: `import { TipTapEditor, EditorToolbar } from './editor'`
- Add: `import { useTipTapEditor } from '@/hooks'`

2. Replace useMarkdownEditor with useTipTapEditor:
```typescript
const { editor, isDirty, isSaving, saveNow, activeCard } = useTipTapEditor({
  autoSaveDelay: 2000,
  enableAutoSave: true
});
```

3. Replace MDEditor component with TipTapEditor:
```typescript
<EditorToolbar editor={editor} />
<TipTapEditor editor={editor} className="flex-1" />
```

4. Update handleEditorKeyDown:
- TipTap handles its own keyboard events via ProseMirror
- Keep only manual save shortcut (Cmd+S):
```typescript
const handleManualSave = useCallback(async (e: React.KeyboardEvent) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 's') {
    e.preventDefault();
    await saveNow();
  }
}, [saveNow]);
```

5. Remove content/setContent state - TipTap manages its own state

6. Keep existing SlashCommandMenu - will be replaced in 45-02-PLAN.md

7. Remove editorRef - TipTap doesn't need textarea ref

8. Keep PropertyEditor section unchanged

9. IMPORTANT: Do NOT remove @uiw/react-md-editor from package.json yet - other components may still use it. Just stop using it in CaptureComponent.
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run dev` starts without errors
- CaptureComponent renders TipTap editor
- Typing in editor works (characters appear)
- Save button indicator shows isDirty state
  </verify>
  <done>CaptureComponent uses TipTap instead of MDEditor with preserved auto-save functionality</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Type check: `npm run typecheck` - zero errors
2. Dev server: `npm run dev` - starts without errors
3. Manual test:
   - Navigate to Capture pane
   - Type text - should appear without lag
   - Wait 2 seconds - should auto-save (dirty indicator clears)
   - Press Cmd+S - should save immediately
   - Paste large text (>10,000 chars) - should remain responsive
   - Close and reopen card - content should persist
</verification>

<success_criteria>
- TipTap editor renders in CaptureComponent
- Performance optimization applied (shouldRerenderOnTransaction: false)
- Auto-save works with 2-second debounce
- Manual save works with Cmd+S
- Content persists to sql.js as Markdown
- No TypeScript errors
- No console errors during editing
</success_criteria>

<output>
After completion, create `.planning/phases/45-tiptap-editor-migration/45-01-SUMMARY.md`
</output>
