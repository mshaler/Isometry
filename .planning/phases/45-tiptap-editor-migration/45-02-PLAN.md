---
phase: 45-tiptap-editor-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/notebook/editor/extensions/slash-commands.ts
  - src/components/notebook/editor/SlashCommandMenu.tsx
  - src/components/notebook/editor/TipTapEditor.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "User types / and sees command menu appear"
    - "User can filter commands by typing after /"
    - "User can navigate menu with arrow keys and select with Enter"
    - "User can execute /save-card command to save current content"
    - "User can execute /send-to-shell command to send content to shell"
  artifacts:
    - path: "src/components/notebook/editor/extensions/slash-commands.ts"
      provides: "TipTap extension for slash command trigger and handling"
      exports: ["SlashCommands", "slashCommandSuggestion"]
    - path: "src/components/notebook/editor/SlashCommandMenu.tsx"
      provides: "React component for slash command popup menu"
      exports: ["SlashCommandMenu"]
  key_links:
    - from: "src/components/notebook/editor/extensions/slash-commands.ts"
      to: "@tiptap/suggestion"
      via: "Suggestion utility for autocomplete"
      pattern: "Suggestion\\("
    - from: "src/components/notebook/editor/TipTapEditor.tsx"
      to: "src/components/notebook/editor/extensions/slash-commands.ts"
      via: "extension registration"
      pattern: "SlashCommands"
---

<objective>
Implement Notion-style slash commands using @tiptap/suggestion for card operations (/save-card, /send-to-shell, templates).

Purpose: Port existing useSlashCommands.ts command registry to TipTap extension architecture for seamless in-editor command invocation.
Output: Slash command extension that triggers menu on "/" with filtered commands and keyboard navigation.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-tiptap-editor-migration/45-RESEARCH.md

@src/hooks/ui/useSlashCommands.ts
@src/components/notebook/CaptureComponent.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install tippy.js and create slash commands extension</name>
  <files>
    package.json
    src/components/notebook/editor/extensions/slash-commands.ts
    src/components/notebook/editor/extensions/index.ts
  </files>
  <action>
1. Install tippy.js for popup positioning:
```bash
npm install tippy.js
```

2. Create `src/components/notebook/editor/extensions/slash-commands.ts`:

```typescript
import { Extension } from '@tiptap/core';
import Suggestion, { SuggestionOptions, SuggestionProps } from '@tiptap/suggestion';
import { Editor, Range } from '@tiptap/core';

export interface SlashCommand {
  id: string;
  label: string;
  description: string;
  category: 'isometry' | 'template' | 'format';
  shortcut?: string;
  action: (params: { editor: Editor; range: Range }) => void;
}

// Command registry - adapted from useSlashCommands.ts
export const SLASH_COMMANDS: SlashCommand[] = [
  {
    id: 'save-card',
    label: 'Save Card',
    description: 'Save current content as new card',
    category: 'isometry',
    shortcut: 'save',
    action: ({ editor, range }) => {
      editor.chain().focus().deleteRange(range).run();
      // Dispatch custom event for CaptureComponent to handle
      window.dispatchEvent(new CustomEvent('isometry:save-card', {
        detail: { markdown: editor.storage.markdown?.getMarkdown() || '' }
      }));
    },
  },
  {
    id: 'send-to-shell',
    label: 'Send to Shell',
    description: 'Send content or command to shell',
    category: 'isometry',
    shortcut: 'shell',
    action: ({ editor, range }) => {
      editor.chain().focus().deleteRange(range).run();
      window.dispatchEvent(new CustomEvent('isometry:send-to-shell', {
        detail: { content: editor.state.doc.textContent }
      }));
    },
  },
  {
    id: 'pafv-query',
    label: 'PAFV Query',
    description: 'Insert PAFV projection pattern',
    category: 'isometry',
    shortcut: 'pafv',
    action: ({ editor, range }) => {
      editor.chain().focus().deleteRange(range)
        .insertContent('```sql\n-- PAFV Query\nSELECT * FROM nodes\nWHERE plane = "?" AND axis = "?"\nORDER BY facet;\n```')
        .run();
    },
  },
  {
    id: 'latch-filter',
    label: 'LATCH Filter',
    description: 'Insert LATCH filter template',
    category: 'isometry',
    shortcut: 'latch',
    action: ({ editor, range }) => {
      editor.chain().focus().deleteRange(range)
        .insertContent('## Filter Criteria\n- **Location:** ?\n- **Alphabet:** ?\n- **Time:** ?\n- **Category:** ?\n- **Hierarchy:** ?')
        .run();
    },
  },
  {
    id: 'graph-query',
    label: 'Graph Query',
    description: 'Insert graph traversal query',
    category: 'isometry',
    shortcut: 'graph',
    action: ({ editor, range }) => {
      editor.chain().focus().deleteRange(range)
        .insertContent('```sql\n-- Graph Traversal\nWITH RECURSIVE graph_walk AS (\n  SELECT ?, 0 as depth\n  UNION ALL\n  SELECT e.target_id, gw.depth + 1\n  FROM edges e\n  JOIN graph_walk gw ON e.source_id = gw.id\n  WHERE gw.depth < 5\n)\nSELECT n.* FROM nodes n\nJOIN graph_walk gw ON n.id = gw.id;\n```')
        .run();
    },
  },
  {
    id: 'meeting-template',
    label: 'Meeting Notes',
    description: 'Insert meeting notes template',
    category: 'template',
    shortcut: 'meeting',
    action: ({ editor, range }) => {
      const date = new Date().toLocaleDateString();
      editor.chain().focus().deleteRange(range)
        .insertContent(`# Meeting: [Title]\n\n**Date:** ${date}\n**Attendees:** \n**Duration:** \n\n## Agenda\n- [ ] \n\n## Discussion Notes\n\n\n## Action Items\n- [ ] **[Name]** - \n\n## Next Steps\n\n`)
        .run();
    },
  },
  {
    id: 'code-snippet',
    label: 'Code Snippet',
    description: 'Insert code block template',
    category: 'format',
    shortcut: 'code',
    action: ({ editor, range }) => {
      editor.chain().focus().deleteRange(range)
        .insertContent('```typescript\n// \n```')
        .run();
    },
  },
  {
    id: 'task-list',
    label: 'Task List',
    description: 'Insert checkbox task list',
    category: 'format',
    shortcut: 'tasks',
    action: ({ editor, range }) => {
      editor.chain().focus().deleteRange(range)
        .insertContent('## Tasks\n- [ ] \n- [ ] \n- [ ] ')
        .run();
    },
  },
  {
    id: 'table',
    label: 'Table',
    description: 'Insert markdown table',
    category: 'format',
    shortcut: 'table',
    action: ({ editor, range }) => {
      editor.chain().focus().deleteRange(range)
        .insertContent('| Column 1 | Column 2 | Column 3 |\n|----------|----------|----------|\n|          |          |          |')
        .run();
    },
  },
];

// Export suggestion config for use with ReactRenderer
export interface SlashCommandSuggestionProps extends SuggestionProps<SlashCommand> {
  // Additional props if needed
}

export function createSlashCommandSuggestion(
  renderConfig: Partial<SuggestionOptions<SlashCommand>['render']>
): Partial<SuggestionOptions<SlashCommand>> {
  return {
    char: '/',
    startOfLine: false,
    items: ({ query }) => {
      const q = query.toLowerCase();
      return SLASH_COMMANDS.filter(cmd =>
        cmd.label.toLowerCase().includes(q) ||
        cmd.description.toLowerCase().includes(q) ||
        (cmd.shortcut && cmd.shortcut.toLowerCase().includes(q))
      );
    },
    command: ({ editor, range, props }) => {
      props.action({ editor, range });
    },
    render: renderConfig,
  };
}

export const SlashCommands = Extension.create({
  name: 'slashCommands',

  addOptions() {
    return {
      suggestion: {} as Partial<SuggestionOptions<SlashCommand>>,
    };
  },

  addProseMirrorPlugins() {
    return [
      Suggestion({
        editor: this.editor,
        ...this.options.suggestion,
      }),
    ];
  },
});
```

3. Create `src/components/notebook/editor/extensions/index.ts`:
```typescript
export { SlashCommands, SLASH_COMMANDS, createSlashCommandSuggestion } from './slash-commands';
export type { SlashCommand, SlashCommandSuggestionProps } from './slash-commands';
```
  </action>
  <verify>
- `npm run typecheck` passes
- slash-commands.ts has no TypeScript errors
- Extension exports correctly
  </verify>
  <done>SlashCommands extension created with command registry and @tiptap/suggestion integration</done>
</task>

<task type="auto">
  <name>Task 2: Create SlashCommandMenu React component</name>
  <files>
    src/components/notebook/editor/SlashCommandMenu.tsx
  </files>
  <action>
Create `src/components/notebook/editor/SlashCommandMenu.tsx`:

```typescript
import React, { forwardRef, useEffect, useImperativeHandle, useState, useCallback } from 'react';
import { Hash, Edit3, Code } from 'lucide-react';
import { useTheme } from '@/contexts/ThemeContext';
import type { SlashCommand, SlashCommandSuggestionProps } from './extensions';

export interface SlashCommandMenuRef {
  onKeyDown: (props: { event: KeyboardEvent }) => boolean;
}

interface SlashCommandMenuProps {
  items: SlashCommand[];
  command: (item: SlashCommand) => void;
}

function getCommandIcon(category: SlashCommand['category']) {
  switch (category) {
    case 'isometry':
      return <Hash size={14} className="text-blue-500" />;
    case 'template':
      return <Edit3 size={14} className="text-green-500" />;
    case 'format':
      return <Code size={14} className="text-purple-500" />;
    default:
      return null;
  }
}

export const SlashCommandMenu = forwardRef<SlashCommandMenuRef, SlashCommandMenuProps>(
  ({ items, command }, ref) => {
    const { theme } = useTheme();
    const [selectedIndex, setSelectedIndex] = useState(0);

    // Reset selection when items change
    useEffect(() => {
      setSelectedIndex(0);
    }, [items]);

    const selectItem = useCallback((index: number) => {
      const item = items[index];
      if (item) {
        command(item);
      }
    }, [items, command]);

    // Keyboard navigation
    useImperativeHandle(ref, () => ({
      onKeyDown: ({ event }) => {
        if (event.key === 'ArrowUp') {
          setSelectedIndex((prev) => (prev <= 0 ? items.length - 1 : prev - 1));
          return true;
        }

        if (event.key === 'ArrowDown') {
          setSelectedIndex((prev) => (prev >= items.length - 1 ? 0 : prev + 1));
          return true;
        }

        if (event.key === 'Enter' || event.key === 'Tab') {
          selectItem(selectedIndex);
          return true;
        }

        return false;
      },
    }), [items.length, selectedIndex, selectItem]);

    if (items.length === 0) {
      return (
        <div className={`z-50 ${
          theme === 'NeXTSTEP'
            ? 'bg-[#c0c0c0] border-[#707070] shadow-md'
            : 'bg-white border-gray-300 shadow-lg'
        } border rounded-lg min-w-[300px] p-4 text-center text-gray-500 text-sm`}>
          <div className="mb-1">No commands found</div>
          <div className="text-xs">Try typing "pafv", "latch", or "meeting"</div>
        </div>
      );
    }

    return (
      <div className={`z-50 ${
        theme === 'NeXTSTEP'
          ? 'bg-[#c0c0c0] border-[#707070] shadow-md'
          : 'bg-white border-gray-300 shadow-lg'
      } border rounded-lg min-w-[300px] max-h-[300px] overflow-y-auto`}>
        <div className={`p-2 text-xs text-gray-500 border-b ${
          theme === 'NeXTSTEP' ? 'border-[#707070] bg-[#d4d4d4]' : 'border-gray-200 bg-gray-50'
        }`}>
          <div className="flex items-center gap-1">
            <span>Choose a command...</span>
          </div>
        </div>
        <div className="py-1">
          {items.map((item, index) => (
            <button
              key={item.id}
              onClick={() => selectItem(index)}
              className={`w-full text-left p-2 flex items-center gap-2 transition-colors ${
                index === selectedIndex
                  ? theme === 'NeXTSTEP' ? 'bg-[#0066cc] text-white' : 'bg-blue-500 text-white'
                  : `hover:${theme === 'NeXTSTEP' ? 'bg-[#b0b0b0]' : 'bg-gray-100'}`
              }`}
            >
              <div className="flex-shrink-0">
                {getCommandIcon(item.category)}
              </div>
              <div className="flex-1 min-w-0">
                <div className="font-medium text-sm truncate">{item.label}</div>
                <div className={`text-xs ${
                  index === selectedIndex ? 'text-white/80' : 'text-gray-500'
                } truncate`}>
                  {item.description}
                </div>
              </div>
              {item.shortcut && (
                <div className={`text-xs px-1 rounded ${
                  index === selectedIndex
                    ? 'bg-white/20'
                    : theme === 'NeXTSTEP' ? 'bg-[#d4d4d4]' : 'bg-gray-200'
                }`}>
                  /{item.shortcut}
                </div>
              )}
            </button>
          ))}
        </div>
        <div className={`p-2 text-xs text-gray-500 border-t ${
          theme === 'NeXTSTEP' ? 'border-[#707070] bg-[#d4d4d4]' : 'border-gray-200 bg-gray-50'
        }`}>
          <div className="flex justify-between">
            <span>Arrow keys: Navigate</span>
            <span>Enter: Select | Esc: Cancel</span>
          </div>
        </div>
      </div>
    );
  }
);

SlashCommandMenu.displayName = 'SlashCommandMenu';
```
  </action>
  <verify>
- `npm run typecheck` passes
- SlashCommandMenu.tsx has no TypeScript errors
- Component uses forwardRef for keyboard handling
  </verify>
  <done>SlashCommandMenu component with keyboard navigation and themed styling</done>
</task>

<task type="auto">
  <name>Task 3: Integrate slash commands into TipTapEditor</name>
  <files>
    src/components/notebook/editor/TipTapEditor.tsx
    src/components/notebook/editor/index.ts
    src/components/notebook/CaptureComponent.tsx
  </files>
  <action>
1. Update `src/components/notebook/editor/TipTapEditor.tsx` to include SlashCommands extension:

```typescript
import { useEditor, EditorContent, ReactRenderer } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import Placeholder from '@tiptap/extension-placeholder';
import { Markdown } from '@tiptap/extension-markdown';
import tippy, { Instance } from 'tippy.js';
import { SlashCommands, createSlashCommandSuggestion } from './extensions';
import { SlashCommandMenu, SlashCommandMenuRef } from './SlashCommandMenu';

// ... existing code ...

// Inside useEditor configuration, add SlashCommands to extensions:
const editor = useEditor({
  extensions: [
    StarterKit,
    Placeholder.configure({
      placeholder: 'Type / for commands...',
    }),
    Markdown,
    SlashCommands.configure({
      suggestion: createSlashCommandSuggestion({
        render: () => {
          let component: ReactRenderer<SlashCommandMenuRef>;
          let popup: Instance[];

          return {
            onStart: (props) => {
              component = new ReactRenderer(SlashCommandMenu, {
                props,
                editor: props.editor,
              });

              if (!props.clientRect) return;

              popup = tippy('body', {
                getReferenceClientRect: props.clientRect as () => DOMRect,
                appendTo: () => document.body,
                content: component.element,
                showOnCreate: true,
                interactive: true,
                trigger: 'manual',
                placement: 'bottom-start',
              });
            },

            onUpdate(props) {
              component.updateProps(props);

              if (!props.clientRect) return;

              popup[0]?.setProps({
                getReferenceClientRect: props.clientRect as () => DOMRect,
              });
            },

            onKeyDown(props) {
              if (props.event.key === 'Escape') {
                popup[0]?.hide();
                return true;
              }

              return component.ref?.onKeyDown(props) ?? false;
            },

            onExit() {
              popup[0]?.destroy();
              component.destroy();
            },
          };
        },
      }),
    }),
  ],
  // ... rest of config
});
```

2. Update `src/components/notebook/editor/index.ts` to export SlashCommandMenu:
```typescript
export { TipTapEditor } from './TipTapEditor';
export { EditorToolbar } from './EditorToolbar';
export { SlashCommandMenu } from './SlashCommandMenu';
export * from './extensions';
```

3. Update `src/components/notebook/CaptureComponent.tsx`:
- Remove old SlashCommandMenu component and its usage
- Remove useSlashCommands hook import and usage
- Add event listeners for custom events:

```typescript
useEffect(() => {
  const handleSaveCard = (e: CustomEvent<{ markdown: string }>) => {
    // Existing handleSaveCard logic with e.detail.markdown
    handleSaveCardFromEvent(e.detail.markdown);
  };

  const handleSendToShell = (e: CustomEvent<{ content: string }>) => {
    // Existing handleSendToShell logic with e.detail.content
    handleSendToShellFromEvent(e.detail.content);
  };

  window.addEventListener('isometry:save-card', handleSaveCard as EventListener);
  window.addEventListener('isometry:send-to-shell', handleSendToShell as EventListener);

  return () => {
    window.removeEventListener('isometry:save-card', handleSaveCard as EventListener);
    window.removeEventListener('isometry:send-to-shell', handleSendToShell as EventListener);
  };
}, [/* dependencies */]);
```
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run dev` starts without errors
- Typing "/" in editor shows command menu
- Filtering commands works (type "/pafv")
- Arrow keys navigate menu
- Enter/Tab executes selected command
- Escape closes menu
  </verify>
  <done>Slash commands fully integrated with TipTap using @tiptap/suggestion and tippy.js</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Type check: `npm run typecheck` - zero errors
2. Dev server: `npm run dev` - starts without errors
3. Manual tests:
   - Type "/" at start of line - menu appears
   - Type "/pafv" - filters to PAFV Query command
   - Arrow down/up - navigates menu
   - Press Enter - inserts selected command content
   - Press Escape - closes menu without action
   - Execute /save-card - triggers save card flow
   - Execute /send-to-shell - triggers send to shell flow
</verification>

<success_criteria>
- Slash command menu appears when typing "/"
- Commands filter based on typed text
- Keyboard navigation works (up/down arrows)
- Enter/Tab executes selected command
- Escape dismisses menu
- All existing commands ported from useSlashCommands.ts
- /save-card and /send-to-shell execute correct actions
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/45-tiptap-editor-migration/45-02-SUMMARY.md`
</output>
