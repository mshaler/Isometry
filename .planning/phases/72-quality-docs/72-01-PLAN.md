---
phase: 72-quality-docs
plan: 01
subsystem: etl-quality
tags: [test-coverage, schema-validation, error-handling, etl]

# Dependency graph
requires:
  - phase: 71
    provides: Complete Swift Bridge implementation
  - phase: 69-70
    provides: File importers and integration
provides:
  - Test coverage verification (>80% target)
  - Schema validation audit
  - Error handling consistency review
  - Missing test coverage identification
affects: [v4.8-completion, etl-module-quality]

# Tech tracking
tech-stack:
  existing: [vitest, zod, typescript]
  patterns: [tdd, schema-validation, error-boundaries]

key-files:
  audit:
    - src/etl/__tests__/* (existing tests)
    - src/etl/bridge/window-export.ts (needs tests)
    - src/etl/parsers/frontmatter.ts (needs tests)
    - src/etl/id-generation/deterministic.ts (needs tests)
    - src/etl/storage/property-storage.ts (needs tests)

---

# Phase 72-01: ETL Quality Audit & Test Coverage

**Goal:** Verify ETL module meets quality requirements (QUAL-01, QUAL-02, QUAL-03)

## Context

Phase 71 (Swift Bridge) is complete. Phase 72 focuses on quality assurance:
- QUAL-01: Test coverage >80% for ETL module
- QUAL-02: Schema validation at every import
- QUAL-03: Graceful failure with detailed error messages

## Current State Assessment

### Existing Test Coverage (11 test files, 179 tests)

| File | Test File | Status |
|------|-----------|--------|
| canonical.ts | canonical.test.ts | âœ… 14 tests |
| ImportCoordinator.ts | ImportCoordinator.test.ts | âœ… 18 tests |
| WordImporter.ts | WordImporter.test.ts | âœ… 12 tests |
| JsonImporter.ts | JsonImporter.test.ts | âœ… 20 tests |
| ExcelImporter.ts | ExcelImporter.test.ts | âœ… 21 tests |
| CsvImporter.ts | CsvImporter.test.ts | âœ… 13 tests |
| HtmlImporter.ts | HtmlImporter.test.ts | âœ… 16 tests |
| MarkdownImporter.ts | MarkdownImporter.test.ts | âœ… 25 tests |
| insertion.ts | insertion.test.ts | âœ… 10 tests |
| alto-importer.ts | alto-importer.test.ts | âœ… 29 tests |
| alto-notes-pipeline | e2e.test.ts | âœ… 1 test |

### Files Without Dedicated Tests

| File | Coverage Via | Action |
|------|--------------|--------|
| BaseImporter.ts | Subclass tests | âœ… Covered implicitly |
| index.ts | Re-export only | âœ… No tests needed |
| bridge/window-export.ts | Integration | ðŸ” Verify or add |
| alto-parser.ts | alto-importer.test.ts | âœ… Covered |
| parsers/frontmatter.ts | MarkdownImporter tests | ðŸ” Verify or add |
| id-generation/deterministic.ts | Integration | ðŸ” Verify or add |
| storage/property-storage.ts | insertion.test.ts | ðŸ” Verify or add |

## Tasks

### Task 1: Test Coverage Audit
Verify existing test coverage and identify gaps.

**Files:**
- Run test coverage analysis on ETL module
- Identify untested code paths
- Document coverage percentage

**Verification:**
- [ ] Coverage analysis complete
- [ ] Gaps identified and documented

### Task 2: Schema Validation Audit (QUAL-02)
Verify CanonicalNodeSchema.parse() is called in every import path.

**Check Points:**
- [ ] ImportCoordinator.importFile() validates output
- [ ] Each importer's import() returns validated nodes
- [ ] Alto-importer validates output
- [ ] Window export validates before returning

**Verification:**
- [ ] All import paths validate schema
- [ ] Invalid data throws ZodError

### Task 3: Error Handling Audit (QUAL-03)
Review error messages for user-friendliness and consistency.

**Check Points:**
- [ ] File not found errors include path
- [ ] Parse errors include line/position when possible
- [ ] Validation errors include field name and expected type
- [ ] Error messages are actionable

**Verification:**
- [ ] Error messages reviewed
- [ ] Inconsistencies documented

### Task 4: Add Missing Tests (if needed)
Based on audit results, add tests for uncovered code.

**Potential Files:**
- deterministic.ts (id generation edge cases)
- property-storage.ts (storage edge cases)
- frontmatter.ts (parsing edge cases)

**Verification:**
- [ ] Coverage gaps filled
- [ ] All new tests pass

## Acceptance Criteria

- [ ] Test coverage >80% for src/etl/**
- [ ] Schema validation confirmed at all entry points
- [ ] Error messages are clear and actionable
- [ ] No regressions in existing tests

## Estimated Duration
~30 minutes (audit + targeted test additions)
