---
phase: 25-live-query-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/context/LiveDataContext.tsx, src/utils/bridge-optimization/change-notifier.ts, native/Sources/Isometry/WebView/WebViewBridge.swift]
autonomous: true

must_haves:
  truths:
    - "useLiveQuery automatically starts GRDB ValueObservation when components mount"
    - "React components receive live database change notifications within 100ms"
    - "Change notifications properly trigger React re-renders with updated data"
    - "Live query subscriptions cleanup properly when components unmount"
    - "Integration maintains existing useLiveQuery API without breaking changes"
    - "Optimistic updates show immediate feedback while sync processes in background"
    - "Connection state changes affect live query behavior appropriately"
    - "Change events have proper correlation IDs for debugging and sequencing"
  artifacts:
    - path: "src/context/LiveDataContext.tsx"
      provides: "WebView bridge integration for live observations"
      pattern: "webViewBridge\\.liveData\\.startObservation"
    - path: "src/utils/bridge-optimization/change-notifier.ts"
      provides: "GRDB observation lifecycle management"
      pattern: "startNativeObservation.*observationId"
    - path: "native/Sources/Isometry/WebView/WebViewBridge.swift"
      provides: "liveData startObservation message handler"
      contains: "liveData.*startObservation"
  key_links:
    - from: "useLiveQuery.startLive()"
      to: "webViewBridge.liveData.startObservation"
      via: "LiveDataContext.subscribe chain"
      pattern: "subscribe.*startObservation"
    - from: "WebViewBridge.liveData handler"
      to: "GRDB ValueObservation.start"
      via: "ChangeNotificationBridge integration"
      pattern: "ValueObservation.*start.*in.*dbPool"
    - from: "GRDB change events"
      to: "React component re-renders"
      via: "WebView message bridge with correlation"
      pattern: "sendToWebView.*liveData.*change.*correlationId"
---

<objective>
Connect useLiveQuery hook to GRDB ValueObservation for real-time database change notifications with sync optimization

Purpose: Enable automatic React component updates when native SQLite data changes, completing the live database integration pipeline from Phase 19 GRDB infrastructure to React UI layer. Includes optimistic updates, connection state awareness, and proper change event correlation.
Output: Fully functional live query system with real-time change notifications flowing from GRDB → WebView Bridge → React components with sync enhancements
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-live-query-integration/25-RESEARCH.md
@.planning/phases/21-advanced-query-and-caching/21-05-SUMMARY.md
@.planning/phases/19-real-time-change-notifications/19-01-SUMMARY.md
@src/hooks/useLiveQuery.ts
@src/context/LiveDataContext.tsx
@src/utils/webview-bridge.ts
@native/Sources/Isometry/Bridge/RealTime/ChangeNotificationBridge.swift
@native/Sources/Isometry/WebView/WebViewBridge.swift
</context>

<tasks>

<task type="auto">
  <name>Connect LiveDataContext subscribe to WebView bridge startObservation with sync enhancements</name>
  <files>src/context/LiveDataContext.tsx, src/utils/bridge-optimization/change-notifier.ts</files>
  <action>
    Modify LiveDataContext.subscribe() to call webViewBridge.liveData.startObservation() after changeNotifier.subscribe(). Update changeNotifier.subscribe() to properly invoke the native observation start through the WebView bridge infrastructure.

    In LiveDataContext.tsx:
    - Import webViewBridge from '../utils/webview-bridge'
    - In subscribe callback, add webViewBridge.liveData.startObservation(subscriptionId, sql, params) call after changeNotifier.subscribe
    - Add error handling for startObservation failures
    - Update unsubscribe to call webViewBridge.liveData.stopObservation(subscriptionId)
    - Implement optimistic update handling (SYNC-02): Show immediate local updates while sync processes
    - Add connection state awareness (SYNC-04): Adjust behavior based on network conditions
    - Include correlation ID tracking (SYNC-05): Add correlationId to all change events for debugging

    In change-notifier.ts:
    - Update startNativeObservation() to use webViewBridge.liveData.startObservation instead of direct window._isometryBridge call
    - Import webViewBridge and use its liveData API consistently
    - Ensure observationId flows through to native properly
    - Add optimistic update queue for local changes awaiting sync
    - Implement connection state monitoring for adaptive sync behavior

    Preserve existing sequence tracking, error handling, and performance optimization patterns.
  </action>
  <verify>npm test && grep -q "startObservation.*observationId" src/context/LiveDataContext.tsx && grep -q "webViewBridge.liveData.startObservation" src/utils/bridge-optimization/change-notifier.ts && grep -q "optimistic.*update" src/context/LiveDataContext.tsx && grep -q "correlationId" src/utils/bridge-optimization/change-notifier.ts</verify>
  <done>LiveDataContext.subscribe() calls webViewBridge.liveData.startObservation() with optimistic updates, connection state awareness, and correlation ID tracking</done>
</task>

<task type="auto">
  <name>Implement native liveData message handler in WebViewBridge with correlation tracking</name>
  <files>native/Sources/Isometry/WebView/WebViewBridge.swift</files>
  <action>
    Add 'liveData' message handler to WebViewBridge.swift that routes startObservation and stopObservation methods to the ChangeNotificationBridge with proper correlation tracking.

    In WebViewBridge.swift:
    - Add liveData message handler method to the existing message handling infrastructure
    - Route 'startObservation' method to ChangeNotificationBridge.startObservation(observationId, sql, params, correlationId)
    - Route 'stopObservation' method to ChangeNotificationBridge.stopObservation(observationId, correlationId)
    - Follow existing patterns from other message handlers (database, transaction)
    - Include error handling with proper JSON response format
    - Add correlation ID tracking for debugging and sequencing (SYNC-05)
    - Implement connection state reporting (SYNC-04) to inform React of native connectivity
    - Add optimistic update acknowledgment mechanism (SYNC-02) for confirming local changes

    Ensure the ChangeNotificationBridge is accessible to WebViewBridge and properly integrated with the existing WebView infrastructure.
  </action>
  <verify>grep -q "liveData" native/Sources/Isometry/WebView/WebViewBridge.swift && grep -q "startObservation" native/Sources/Isometry/WebView/WebViewBridge.swift && grep -q "correlationId" native/Sources/Isometry/WebView/WebViewBridge.swift</verify>
  <done>WebViewBridge routes liveData messages to ChangeNotificationBridge with correlation tracking, connection state reporting, and optimistic update support</done>
</task>

<task type="auto">
  <name>Test live query integration with comprehensive database change verification</name>
  <files>src/components/test/LiveQueryTest.tsx</files>
  <action>
    Create a comprehensive test component that uses useLiveQuery to verify the complete integration pipeline works end-to-end, including actual database mutation testing.

    Create LiveQueryTest.tsx:
    - Import useLiveQuery hook
    - Query a simple table (e.g., "SELECT * FROM nodes LIMIT 5")
    - Display query results and live status
    - Include startLive/stopLive controls
    - Show connection status and metrics
    - Log change events to console for debugging
    - Use existing test patterns from the codebase

    Add database mutation testing:
    - Create test buttons that trigger database writes through bridge
    - Verify that writes trigger live query re-renders within 100ms
    - Test optimistic update behavior: show local changes immediately
    - Test connection state changes: simulate offline/online transitions
    - Verify correlation ID tracking: log correlation IDs of change events
    - Add error boundary and loading states
    - Include performance metrics: measure notification latency

    Add component to development route for manual testing during integration.
    Include automated verification that database changes trigger React re-renders.
  </action>
  <verify>test -f src/components/test/LiveQueryTest.tsx && grep -q "useLiveQuery" src/components/test/LiveQueryTest.tsx && grep -q "database.*mutation.*test" src/components/test/LiveQueryTest.tsx && grep -q "correlationId" src/components/test/LiveQueryTest.tsx && npm run build</verify>
  <done>LiveQueryTest component demonstrates working real-time database change notifications with optimistic updates, connection awareness, and correlation tracking verification</done>
</task>

<task type="auto">
  <name>Implement sync optimization features for live queries</name>
  <files>src/hooks/useLiveQuery.ts</files>
  <action>
    Enhance useLiveQuery hook to support optimistic updates (SYNC-02), connection state awareness (SYNC-04), and change event correlation (SYNC-05).

    Add optimistic updates:
    - Track pending optimistic changes in local state
    - Show optimistic results immediately while awaiting server confirmation
    - Resolve or rollback optimistic changes based on server response
    - Merge optimistic state with live query results appropriately

    Add connection state awareness:
    - Monitor network connection status using existing patterns
    - Adjust sync frequency based on connection quality (fast/slow/offline)
    - Queue changes when offline, sync when reconnected
    - Provide connection status to consuming components

    Add change event correlation:
    - Generate and track correlation IDs for all database operations
    - Match incoming change notifications with originating operations
    - Provide debugging information for change event sequences
    - Support hierarchical correlation IDs for complex operations

    Maintain backward compatibility with existing useLiveQuery API.
    Integrate with existing TanStack Query caching and invalidation strategies.
  </action>
  <verify>grep -q "optimistic.*update" src/hooks/useLiveQuery.ts && grep -q "connection.*state" src/hooks/useLiveQuery.ts && grep -q "correlationId" src/hooks/useLiveQuery.ts && npm test</verify>
  <done>useLiveQuery hook supports optimistic updates, connection state awareness, and change event correlation while maintaining API compatibility</done>
</task>

</tasks>

<verification>
1. useLiveQuery hook automatically calls webViewBridge.liveData.startObservation when startLive() is invoked
2. Native WebViewBridge properly routes liveData messages to ChangeNotificationBridge with correlation tracking
3. GRDB ValueObservation starts when React component mounts and calls startLive()
4. Database changes trigger WebView messages that update React component state within 100ms
5. LiveQueryTest component shows real-time updates when native database changes occur with verification of actual mutations
6. Optimistic updates show immediate feedback while sync processes in background (SYNC-02)
7. Connection state changes affect live query behavior appropriately (SYNC-04)
8. Change events have proper correlation IDs for debugging and sequencing (SYNC-05)
9. All existing API contracts maintained (no breaking changes to useLiveQuery interface)
</verification>

<success_criteria>
- useLiveQuery.startLive() initiates GRDB ValueObservation through WebView bridge with correlation tracking
- React components receive change notifications within 100ms of database updates
- Optimistic updates provide immediate feedback while background sync processes
- Connection state awareness adjusts sync behavior based on network conditions
- Change event correlation enables proper debugging and sequence tracking
- Live query subscriptions properly cleanup when components unmount
- Integration maintains backward compatibility with existing useLiveQuery API
- End-to-end test component demonstrates working real-time database synchronization with comprehensive mutation testing
</success_criteria>

<output>
After completion, create `.planning/phases/25-live-query-integration/25-01-SUMMARY.md`
</output>