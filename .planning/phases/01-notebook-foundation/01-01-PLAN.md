---
phase: 01-notebook-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  "src/db/schema.sql",
  "src/types/node.ts",
  "src/types/notebook.ts"
]
autonomous: true

must_haves:
  truths:
    - "SQLite schema supports notebook cards with markdown content"
    - "TypeScript interfaces define notebook card structure"
    - "Database maintains backward compatibility with main app"
  artifacts:
    - path: "src/db/schema.sql"
      provides: "notebook_cards table definition"
      contains: "CREATE TABLE notebook_cards"
    - path: "src/types/notebook.ts"
      provides: "Notebook TypeScript interfaces"
      exports: ["NotebookCard", "NotebookCardType"]
    - path: "src/types/node.ts"
      provides: "Extended NodeType with notebook"
      contains: "notebook"
  key_links:
    - from: "src/types/notebook.ts"
      to: "src/types/node.ts"
      via: "extends existing Node interface"
      pattern: "extends.*Node"
    - from: "src/db/schema.sql"
      to: "nodes table"
      via: "foreign key reference"
      pattern: "REFERENCES nodes"
---

<objective>
Extend SQLite schema and TypeScript definitions to support notebook cards while maintaining full backward compatibility with the main Isometry application.

Purpose: Establish the data foundation for notebook sidecar without breaking existing functionality
Output: Extended database schema and type definitions ready for notebook components
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/mshaler/Developer/Projects/Isometry/.planning/ROADMAP.md
@/Users/mshaler/Developer/Projects/Isometry/.planning/STATE.md
@/Users/mshaler/Developer/Projects/Isometry/src/db/schema.sql
@/Users/mshaler/Developer/Projects/Isometry/src/types/node.ts
@/Users/mshaler/Developer/Projects/Isometry/docs/notes/Isometry Notebook sidecar in React.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SQLite schema with notebook_cards table</name>
  <files>src/db/schema.sql</files>
  <action>
    Add notebook_cards table to schema.sql that extends the existing nodes table design:
    - id (TEXT PRIMARY KEY, UUID)
    - node_id (TEXT, REFERENCES nodes(id)) - links to main nodes table for seamless integration
    - markdown_content (TEXT) - raw markdown source
    - rendered_content (TEXT) - cached HTML render
    - properties (TEXT) - JSON object for custom properties panel
    - template_id (TEXT) - reference to card templates
    - card_type ('capture' | 'shell' | 'preview') - component type
    - layout_position (TEXT) - JSON object for component positioning
    - created_at, modified_at (TEXT) - timestamps

    Add indexes for performance:
    - idx_notebook_cards_node_id
    - idx_notebook_cards_type
    - idx_notebook_cards_modified

    Add FTS5 extension for notebook cards:
    - notebook_cards_fts virtual table
    - Triggers to maintain FTS sync

    Use ADDITIVE changes only - no modifications to existing tables.
  </action>
  <verify>
    Run `sqlite3 :memory: < src/db/schema.sql` to validate syntax.
    Confirm existing tables (nodes, edges, facets, settings) remain unchanged.
    Verify foreign key constraint on node_id.
  </verify>
  <done>SQLite schema includes notebook_cards table with full-text search and maintains backward compatibility</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript interfaces for notebook cards</name>
  <files>src/types/notebook.ts</files>
  <action>
    Create new file src/types/notebook.ts with comprehensive TypeScript interfaces:

    - NotebookCardType: 'capture' | 'shell' | 'preview'
    - NotebookCard interface with all fields matching database schema
    - NotebookCardProperties interface for properties panel structure
    - NotebookTemplate interface for card templates
    - LayoutPosition interface for component positioning
    - Export functions: rowToNotebookCard, notebookCardToRow (database converters)

    Follow existing patterns from src/types/node.ts:
    - Use same camelCase -> snake_case conversion patterns
    - Include null handling for optional fields
    - Provide type-safe JSON parsing for properties field
    - Include validation helpers for required fields
  </action>
  <verify>
    Run `npm run typecheck` to ensure no TypeScript errors.
    Verify interfaces match database schema field names and types.
    Check that converter functions handle null values correctly.
  </verify>
  <done>TypeScript interfaces provide type-safe access to notebook card data with database conversion utilities</done>
</task>

<task type="auto">
  <name>Task 3: Extend existing Node types to include notebook</name>
  <files>src/types/node.ts</files>
  <action>
    Extend the existing NodeType union type to include 'notebook':
    - Add 'notebook' to NodeType union: 'note' | 'task' | 'contact' | 'event' | 'project' | 'resource' | 'notebook'

    This enables notebook cards to appear in main app queries and filters while maintaining type safety.

    Do NOT modify other interfaces or functions - only add the notebook option to the existing type.
  </action>
  <verify>
    Run `npm run typecheck` to ensure no TypeScript errors.
    Search codebase for NodeType usage to ensure no breaking changes.
    Verify 'notebook' nodes can be created in existing database operations.
  </verify>
  <done>Main application can recognize and handle notebook node types without breaking changes</done>
</task>

</tasks>

<verification>
1. SQLite schema loads without errors and includes notebook_cards table
2. All TypeScript interfaces compile without errors
3. Backward compatibility maintained - existing queries still work
4. Foreign key relationship established between notebook_cards and nodes
5. Full-text search enabled for notebook content
</verification>

<success_criteria>
1. Database schema supports notebook cards with all required fields
2. TypeScript provides full type safety for notebook operations
3. Main Isometry app continues to function without any breaking changes
4. Foundation ready for notebook component implementation
</success_criteria>

<output>
After completion, create `.planning/phases/01-notebook-foundation/01-01-SUMMARY.md`
</output>