---
phase: 04-preview-integration-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/notebook/D3VisualizationRenderer.tsx
  - src/hooks/useD3Visualization.ts
  - src/components/notebook/PreviewComponent.tsx
  - src/utils/d3Parsers.ts
autonomous: true

must_haves:
  truths:
    - "User can see D3 charts render from JSON data in markdown"
    - "Visualizations update automatically when capture content changes"
    - "Multiple visualization types work (bar charts, line graphs, network graphs)"
    - "Visualizations handle 1000+ data points at 60fps"
  artifacts:
    - path: "src/hooks/useD3Visualization.ts"
      provides: "D3 integration with live data updates"
      exports: ["useD3Visualization"]
    - path: "src/components/notebook/D3VisualizationRenderer.tsx"
      provides: "D3 chart rendering component"
      min_lines: 150
    - path: "src/utils/d3Parsers.ts"
      provides: "Data parsing for D3 visualization types"
      exports: ["parseChartData", "detectVisualizationType"]
  key_links:
    - from: "src/hooks/useD3Visualization.ts"
      to: "NotebookContext.activeCard"
      via: "data source monitoring"
      pattern: "activeCard\\.content"
    - from: "src/components/notebook/D3VisualizationRenderer.tsx"
      to: "d3 library"
      via: "SVG rendering"
      pattern: "d3\\.select"
---

<objective>
Implement live D3.js visualizations that automatically update based on notebook card content, supporting multiple chart types with high performance.

Purpose: Enable users to see their data come to life through interactive visualizations that update in real-time as they edit, creating a powerful data exploration workflow.
Output: Working D3 visualization renderer with automatic data detection and live updates.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@src/components/notebook/PreviewComponent.tsx
@src/contexts/NotebookContext.tsx
@src/hooks/useD3.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Create D3 data parsers for visualization detection</name>
  <files>src/utils/d3Parsers.ts</files>
  <action>
    Build data parsing utilities for D3 visualizations:

    parseChartData(content: string):
    - Extract JSON data blocks from markdown (```json or ```data)
    - Parse CSV data embedded in markdown
    - Extract tabular data from markdown tables
    - Validate data structure for visualization compatibility
    - Return structured data with detected schema

    detectVisualizationType(data: any[]):
    - Analyze data structure to suggest visualization type
    - Support: bar charts (categorical + numeric), line charts (time series), scatter plots (x/y numeric), network graphs (nodes/edges), histograms (single numeric)
    - Return visualization config object with type and axis mappings
    - Handle common data formats (arrays of objects, nested JSON)

    extractVisualizationConfig(content: string):
    - Look for explicit visualization directives in markdown
    - Parse YAML frontmatter for chart configuration
    - Support format like: `<!-- d3:bar-chart,x=category,y=value -->`
    - Return parsed configuration or null if not found

    Use existing Isometry patterns for data processing where possible.
  </action>
  <verify>npm run typecheck passes, parsers handle empty/invalid data gracefully</verify>
  <done>Data parsers extract and validate visualization data from markdown content</done>
</task>

<task type="auto">
  <name>Create D3 visualization hook with live updates</name>
  <files>src/hooks/useD3Visualization.ts</files>
  <action>
    Build hook for D3 visualization management:

    useD3Visualization(contentRef: string, containerRef: RefObject<HTMLDivElement>):
    - Monitor NotebookContext activeCard content for changes
    - Parse content using d3Parsers utilities on content change
    - Detect visualization type and extract data automatically
    - Trigger D3 re-render when data changes (debounced to 200ms)
    - Handle cleanup of previous visualizations
    - Return: { data, vizType, isLoading, error, forceRefresh }

    Performance Optimizations:
    - Use useMemo for parsed data to prevent unnecessary re-parsing
    - Implement shallow comparison for data changes
    - Use useCallback for D3 render functions
    - Add cleanup function to remove SVG elements on unmount

    Integration with existing useD3 hook:
    - Leverage existing D3 container management if available
    - Follow same patterns as other Isometry D3 usage
    - Maintain consistency with existing visualization code

    Error Handling:
    - Graceful fallback for invalid JSON/data
    - Display helpful error messages for malformed data
    - Log parsing errors to console for debugging
  </action>
  <verify>Hook compiles without errors, returns expected interface</verify>
  <done>D3 visualization hook provides live data updates with performance optimization</done>
</task>

<task type="auto">
  <name>Create D3 visualization renderer component</name>
  <files>src/components/notebook/D3VisualizationRenderer.tsx</files>
  <action>
    Build dedicated D3 visualization component:

    Component Interface:
    - Accept data, vizType, width, height as props
    - Use useD3Visualization hook for data management
    - Render appropriate D3 visualization based on detected type
    - Handle responsive sizing for parent container

    Supported Visualization Types:
    1. Bar Chart: d3.scaleBand + d3.scaleLinear for categorical data
    2. Line Chart: d3.scaleTime + d3.scaleLinear for time series
    3. Scatter Plot: d3.scaleLinear x/y for numeric correlation
    4. Network Graph: d3.forceSimulation for node-link data
    5. Histogram: d3.histogram + d3.scaleLinear for distribution

    D3 Implementation:
    - Use SVG rendering with proper margins and axes
    - Add interactive hover effects where appropriate
    - Include axis labels and legends for clarity
    - Apply current theme colors (NeXTSTEP vs Modern)
    - Animate transitions between data updates (300ms duration)

    Performance Features:
    - Implement canvas fallback for large datasets (>1000 points)
    - Use d3.quadtree for efficient mouse interaction
    - Add virtual scrolling for large categorical data
    - Optimize re-render to only update changed elements

    Integration:
    - Update PreviewComponent to use D3VisualizationRenderer
    - Add visualization mode toggle in preview header
    - Show data point count and visualization type in status bar
  </action>
  <verify>Component renders without errors, displays placeholder when no data</verify>
  <done>D3 visualization renderer supports multiple chart types with live updates and theme integration</done>
</task>

</tasks>

<verification>
- Create notebook card with JSON data (bar chart format)
- Verify visualization renders automatically in preview component
- Edit data in capture component and confirm chart updates
- Test multiple visualization types (bar, line, scatter)
- Verify performance with large dataset (1000+ points)
- Test theme switching affects visualization colors
- Confirm hover interactions and animations work smoothly
</verification>

<success_criteria>
- User sees D3 visualizations render automatically from markdown data
- Charts update within 200ms when capture content changes
- Multiple visualization types work correctly with appropriate data
- Performance target of 60fps maintained with large datasets
- Visualizations respect current theme color scheme
</success_criteria>

<output>
After completion, create `.planning/phases/04-preview-integration-polish/04-02-SUMMARY.md`
</output>