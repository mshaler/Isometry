---
phase: 04-preview-integration-polish
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - src/components/notebook/NotebookLayout.tsx
  - src/contexts/NotebookContext.tsx
  - src/hooks/useNotebookIntegration.ts
  - src/hooks/useNotebookPerformance.ts
autonomous: false

must_haves:
  truths:
    - "Notebook cards appear automatically in main app filters and searches"
    - "Changes in main app reflect immediately in open notebook cards"
    - "Component updates maintain 60fps performance with large datasets"
    - "All components respect theme changes instantly"
  artifacts:
    - path: "src/hooks/useNotebookIntegration.ts"
      provides: "Bidirectional sync with main Isometry app"
      exports: ["useNotebookIntegration"]
    - path: "src/hooks/useNotebookPerformance.ts"
      provides: "Performance monitoring and optimization"
      exports: ["useNotebookPerformance"]
    - path: "src/contexts/NotebookContext.tsx"
      provides: "Enhanced context with integration features"
      min_lines: 300
  key_links:
    - from: "src/hooks/useNotebookIntegration.ts"
      to: "FilterContext"
      via: "query synchronization"
      pattern: "useFilter\\(.*\\)"
    - from: "src/hooks/useNotebookPerformance.ts"
      to: "React.Profiler"
      via: "performance monitoring"
      pattern: "onRender.*callback"
---

<objective>
Implement seamless integration between notebook components and main Isometry application while ensuring optimal performance and consistent theming across all components.

Purpose: Complete the notebook sidecar by ensuring it functions as a natural extension of Isometry with perfect data synchronization and performance characteristics.
Output: Fully integrated notebook system with bidirectional data sync and performance monitoring.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@src/contexts/NotebookContext.tsx
@src/contexts/FilterContext.tsx
@src/contexts/PAFVContext.tsx
@src/contexts/ThemeContext.tsx
@src/components/notebook/NotebookLayout.tsx
@.planning/phases/04-preview-integration-polish/04-01-SUMMARY.md
@.planning/phases/04-preview-integration-polish/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create notebook integration hook for bidirectional sync</name>
  <files>src/hooks/useNotebookIntegration.ts</files>
  <action>
    Build comprehensive integration hook for main app synchronization:

    useNotebookIntegration():
    - Subscribe to FilterContext changes and update notebook queries
    - Listen for PAFVContext updates and refresh visualization data
    - Monitor main app node changes that affect notebook cards
    - Provide syncToMainApp() method for immediate synchronization
    - Handle conflict resolution when same card edited in both places

    Query Integration:
    - Ensure notebook_cards participate in main app LATCH filters
    - Update notebook card visibility based on active filters
    - Include notebook data in PAFV projections automatically
    - Cache query results to avoid duplicate database calls

    Data Flow Management:
    - Listen for changes in main app database (nodes table)
    - Propagate notebook card changes to main app state
    - Handle real-time updates without losing user input focus
    - Debounce bidirectional updates to prevent infinite loops (500ms)

    State Synchronization:
    - Sync selection state between notebook and main app
    - Update theme changes instantly across all notebook components
    - Maintain layout state consistency across browser sessions
    - Handle offline state gracefully with pending sync queue

    Return: { isMainAppConnected, lastSyncTime, pendingChanges, forcSync }
  </action>
  <verify>Hook compiles correctly, no infinite update loops in development</verify>
  <done>Notebook integration hook provides seamless bidirectional sync with main Isometry app</done>
</task>

<task type="auto">
  <name>Create performance monitoring hook for 60fps target</name>
  <files>src/hooks/useNotebookPerformance.ts</files>
  <action>
    Build performance monitoring and optimization hook:

    useNotebookPerformance(componentName: string):
    - Measure render times using React.Profiler
    - Track memory usage for component instances
    - Monitor database query performance (target: <100ms)
    - Detect performance bottlenecks and warn in development

    Performance Metrics:
    - Component render duration (target: <16ms for 60fps)
    - Memory usage per component (target: <50MB per component)
    - Database query times with automatic query plan analysis
    - Bundle size impact tracking for code-splitting decisions

    Optimization Features:
    - Automatic virtualization for large card lists (>50 items)
    - Debouncing for expensive operations (search, D3 rendering)
    - Memoization suggestions for expensive computations
    - Lazy loading for heavy components (D3 visualizations)

    Performance Alerts:
    - Console warnings when render times exceed 16ms
    - Memory leak detection for component unmounting
    - Database query slow warnings (>100ms)
    - Network request timeout handling (10s timeout)

    Integration with existing patterns:
    - Use same performance monitoring as main Isometry app
    - Report metrics to same logging infrastructure if available
    - Follow existing optimization patterns from SuperGrid implementation

    Return: { renderTime, memoryUsage, queryTime, optimizationSuggestions }
  </action>
  <verify>Hook provides performance metrics without impacting performance itself</verify>
  <done>Performance monitoring hook tracks 60fps target and provides optimization guidance</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Enhanced NotebookContext with integration and performance features</what-built>
  <how-to-verify>
    1. Open notebook sidecar and main Isometry app side by side
    2. Create a notebook card and verify it appears in main app search
    3. Apply a filter in main app and confirm notebook cards respect it
    4. Change theme in main app and verify notebook components update immediately
    5. Open browser dev tools Performance tab
    6. Record while editing notebook content and verify 60fps maintained
    7. Check console for any performance warnings or errors
    8. Test with large dataset (import multiple cards) for performance validation
  </how-to-verify>
  <resume-signal>Type "verified" when integration and performance testing complete</resume-signal>
</task>

<task type="auto">
  <name>Enhance NotebookContext with integration features</name>
  <files>src/contexts/NotebookContext.tsx</files>
  <action>
    Enhance existing NotebookContext with integration and performance features:

    Add Integration Methods:
    - syncWithMainApp(): Force synchronization with main application
    - subscribeToMainAppChanges(): Listen for external node updates
    - updateFromMainApp(nodeId: string): Handle external updates gracefully
    - resolveConflicts(): Handle editing conflicts between notebook and main app

    Add Performance Monitoring:
    - Wrap all database operations with useNotebookPerformance tracking
    - Add virtualization support for large card collections
    - Implement optimistic updates for better perceived performance
    - Add loading states with proper error boundaries

    Enhanced State Management:
    - Add integration status to context state
    - Include performance metrics in context value
    - Add offline/online status tracking
    - Provide conflict resolution state and methods

    Memory Management:
    - Implement card cache with LRU eviction (max 100 cards)
    - Add cleanup methods for unmounted components
    - Optimize re-render patterns using React.memo
    - Add WeakMap for component instance tracking

    Updated Context Interface:
    - Add integrationStatus, performanceMetrics to context type
    - Include syncWithMainApp, resolveConflicts methods
    - Add isOffline, pendingChanges state
    - Provide performance monitoring toggle for development

    Maintain backward compatibility with existing code.
    Use existing NotebookCard and template interfaces.
    Keep all current methods and state properties intact.
  </action>
  <verify>Context compiles without errors, existing components still work</verify>
  <done>NotebookContext enhanced with integration and performance features while maintaining compatibility</done>
</task>

</tasks>

<verification>
- Open notebook sidecar alongside main Isometry application
- Create notebook card and verify it appears in main app search results
- Apply filters in main app and confirm notebook respects them
- Switch themes and verify instant updates across all notebook components
- Monitor performance in browser dev tools during heavy usage
- Test with large dataset to verify 60fps performance target
- Verify no memory leaks after extended usage session
</verification>

<success_criteria>
- Notebook cards automatically appear in main Isometry app queries and filters
- Changes in main app reflect instantly in open notebook cards
- All components maintain 60fps performance with large datasets
- Theme switching updates all notebook components immediately
- System handles conflicts gracefully when editing same content
</success_criteria>

<output>
After completion, create `.planning/phases/04-preview-integration-polish/04-03-SUMMARY.md`
</output>