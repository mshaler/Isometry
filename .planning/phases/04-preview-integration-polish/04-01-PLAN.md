---
phase: 04-preview-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/notebook/PreviewComponent.tsx
  - src/hooks/useWebPreview.ts
  - src/utils/exportUtils.ts
autonomous: true

must_haves:
  truths:
    - "User can view web content in iframe with security restrictions"
    - "User can preview local markdown files with proper styling"
    - "User can view PDF files with zoom and scroll controls"
    - "User can export current notebook content as PDF or HTML"
  artifacts:
    - path: "src/hooks/useWebPreview.ts"
      provides: "Web content rendering with security"
      exports: ["useWebPreview"]
    - path: "src/utils/exportUtils.ts"
      provides: "Export functionality for multiple formats"
      exports: ["exportToPDF", "exportToHTML", "exportToJSON"]
    - path: "src/components/notebook/PreviewComponent.tsx"
      provides: "Universal content preview component"
      min_lines: 200
  key_links:
    - from: "src/components/notebook/PreviewComponent.tsx"
      to: "useWebPreview hook"
      via: "content rendering"
      pattern: "useWebPreview\\(.*\\)"
    - from: "src/utils/exportUtils.ts"
      to: "NotebookContext"
      via: "data export"
      pattern: "activeCard\\.content"
---

<objective>
Implement universal content preview and export functionality that handles web pages, documents, and file exports while maintaining security boundaries.

Purpose: Enable users to preview any content type and export their work in multiple formats, completing the preview component's core functionality.
Output: Working preview component with web/PDF viewing and multi-format export capabilities.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/NOTEBOOK-STATE.md
@.planning/REQUIREMENTS.md
@src/components/notebook/PreviewComponent.tsx
@src/contexts/NotebookContext.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Create web preview hook with security controls</name>
  <files>src/hooks/useWebPreview.ts</files>
  <action>
    Create useWebPreview hook that manages iframe content rendering:
    - URL validation and sanitization (prevent javascript:, data: schemes)
    - CSP headers for iframe security (sandbox="allow-scripts allow-same-origin")
    - Loading states with error handling
    - Support for local file:// URLs for markdown preview
    - PDF.js integration for PDF viewing with zoom/scroll controls
    - Image preview with proper sizing and zoom
    - Loading progress indicator for web content

    Return interface: { content, contentType, isLoading, error, loadUrl, setZoom, zoom }
  </action>
  <verify>npm run typecheck passes, hook exports correct interface</verify>
  <done>useWebPreview hook exists with URL validation, iframe management, and PDF support</done>
</task>

<task type="auto">
  <name>Create export utilities for multiple formats</name>
  <files>src/utils/exportUtils.ts</files>
  <action>
    Implement export functions for notebook content:

    exportToPDF(card: NotebookCard, options?: PDFOptions):
    - Use html2pdf library (add to package.json)
    - Render markdown as HTML with current theme CSS
    - Include card properties as metadata
    - Support custom page sizing and margins
    - Handle images and code blocks properly

    exportToHTML(card: NotebookCard, options?: HTMLOptions):
    - Generate standalone HTML with embedded CSS
    - Include theme styles for consistent appearance
    - Add navigation for multi-card exports
    - Preserve syntax highlighting for code

    exportToJSON(card: NotebookCard | NotebookCard[]):
    - Structured data export with full metadata
    - Include creation/modification timestamps
    - Support single card or bulk export
    - Follow existing NotebookCard interface structure

    Add html2pdf dependency to package.json if not present.
  </action>
  <verify>npm install runs successfully, functions export correctly typed</verify>
  <done>Export utilities exist supporting PDF, HTML, and JSON formats with proper error handling</done>
</task>

<task type="auto">
  <name>Implement universal preview component functionality</name>
  <files>src/components/notebook/PreviewComponent.tsx</files>
  <action>
    Replace preview component shell with working implementation:

    Content Type Detection:
    - Add previewUrl state and setPreviewUrl method
    - Detect content type from URL/file extension
    - Support web URLs (http/https), local files, and data URLs

    Rendering Engine:
    - Use useWebPreview hook for iframe content
    - Add PDF viewer with zoom controls (+/- buttons in header)
    - Image preview with fit/actual size toggle
    - Markdown preview using existing @uiw/react-md-editor viewer

    Export Functionality:
    - Add export dropdown in header with PDF/HTML/JSON options
    - Use NotebookContext activeCard for export source
    - Show progress indicator during export
    - Download files with appropriate names (card-title.pdf)

    Address Bar:
    - Make URL editable with onChange handler
    - Add refresh button functionality
    - Show loading indicator in address bar

    Keep existing minimize/maximize/theme functionality.
    Preserve NeXTSTEP theme styling patterns.
  </action>
  <verify>Component renders without errors, export buttons appear, URL bar is editable</verify>
  <done>PreviewComponent handles multiple content types, exports work, and maintains theme consistency</done>
</task>

</tasks>

<verification>
- Navigate to notebook sidecar and test preview component
- Load web URL (https://example.com) and verify iframe renders
- Test PDF viewing with zoom controls
- Export current notebook card as PDF and HTML
- Verify exported files contain correct content and styling
- Test address bar editing and refresh functionality
- Confirm component respects both NeXTSTEP and Modern themes
</verification>

<success_criteria>
- User can preview web content with secure iframe rendering
- User can view PDF files with working zoom and navigation
- User can export notebook cards in PDF, HTML, and JSON formats
- Export files maintain theme styling and proper formatting
- Component UI is polished and responsive to theme changes
</success_criteria>

<output>
After completion, create `.planning/phases/04-preview-integration-polish/04-01-SUMMARY.md`
</output>