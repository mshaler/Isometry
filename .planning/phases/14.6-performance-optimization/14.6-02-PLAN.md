---
phase: 14.6-performance-optimization
plan: 02
type: execute
wave: 1
depends_on: ["14.6-01"]
gap_closure: true
files_modified: [
  native/Sources/Isometry/WebView/WebViewBridge.swift,
  native/Sources/Isometry/WebView/NotebookWebView.swift,
  native/Sources/Isometry/Views/macOS/MacOSContentView.swift
]
autonomous: true

must_haves:
  truths:
    - "D3 canvas and rendering optimization bridges are registered and available in WKWebView"
    - "CloudKit bridge is registered for React sync operations"
    - "Bridge initialization exposes d3canvas and d3rendering helpers for React runtime checks"
    - "Missing bridge handlers no longer block performance diagnostics"
  artifacts:
    - path: "native/Sources/Isometry/WebView/NotebookWebView.swift"
      provides: "WKWebView message handler registration for all bridge handlers"
      pattern: "add\\(bridge\\.(databaseHandler|fileSystemHandler|pafvHandler|filterHandler|d3canvasHandler|d3renderingHandler|cloudKitHandler)"
    - path: "native/Sources/Isometry/WebView/WebViewBridge.swift"
      provides: "Bridge initialization script exposes d3canvas/d3rendering helpers"
      pattern: "d3canvas|d3rendering"
  key_links:
    - from: "native/Sources/Isometry/WebView/NotebookWebView.swift"
      to: "src/utils/webview-bridge.ts"
      via: "WKWebView message handler registration"
      pattern: "messageHandlers\\.d3rendering|messageHandlers\\.cloudkit"
---

<objective>
Close the WebView bridge gaps that block the rendering optimization and CloudKit sync paths by registering missing handlers and exposing bridge helpers expected by React runtime checks.

Purpose: Ensure React-side performance and sync tooling can detect and use native handlers that were added in Phase 14.5/14.6 but not wired into the WKWebView registration and bridge bootstrap script.
Output: Fully registered d3canvas, d3rendering, and cloudkit handlers with bridge helpers available at runtime.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@native/Sources/Isometry/WebView/WebViewBridge.swift
@native/Sources/Isometry/WebView/NotebookWebView.swift
@src/utils/webview-bridge.ts
@src/utils/rendering-performance.ts
@src/services/CloudKitSyncAdapter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register missing native message handlers</name>
  <files>
    native/Sources/Isometry/WebView/WebViewBridge.swift
    native/Sources/Isometry/WebView/NotebookWebView.swift
    native/Sources/Isometry/Views/macOS/MacOSContentView.swift
  </files>
  <action>
    Wire the missing WebView bridge handlers into the native WebView configuration:

    1. Add D3 rendering and CloudKit handler instances to WebViewBridge.
    2. Register d3canvas, d3rendering, and cloudkit handlers in NotebookWebView's WKUserContentController.
    3. Ensure AppState is passed to CloudKitMessageHandler so sync operations have database context.

    Keep existing handlers intact and maintain backwards compatibility.
  </action>
  <verify>
    - NotebookWebView registers database, filesystem, pafv, filters, d3canvas, d3rendering, cloudkit
    - CloudKitMessageHandler is instantiated with AppState when available
  </verify>
  <done>All required WebView message handlers are registered and available at runtime</done>
</task>

<task type="auto">
  <name>Task 2: Expose bridge helpers expected by React runtime checks</name>
  <files>
    native/Sources/Isometry/WebView/WebViewBridge.swift
  </files>
  <action>
    Extend the bridge initialization script to expose helper proxies for d3canvas and d3rendering
    (and cloudkit if applicable) so React code can reliably detect bridge availability.

    Ensure no breaking changes to existing database/filesystem helpers.
  </action>
  <verify>
    - window._isometryBridge.d3canvas exists when d3canvas handler is registered
    - window._isometryBridge.d3rendering exists when d3rendering handler is registered
  </verify>
  <done>Bridge helpers align with React-side availability checks</done>
</task>

</tasks>
