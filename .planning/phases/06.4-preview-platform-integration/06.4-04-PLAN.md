---
phase: 06.4-preview-platform-integration
plan: 04
type: execute
wave: 2
depends_on: ["06.4-01", "06.4-02"]
files_modified:
  - native/Sources/Isometry/Platform/macOS/WindowManager.swift
  - native/Sources/Isometry/Platform/macOS/MenuBarIntegration.swift
  - native/Sources/Isometry/Platform/AppStore/ComplianceValidator.swift
autonomous: false

must_haves:
  truths:
    - "User can open multiple notebook windows on macOS"
    - "Menu bar provides standard macOS commands and shortcuts"
    - "Trackpad gestures enhance navigation and interaction"
    - "App complies with App Store review guidelines"
  artifacts:
    - path: "native/Sources/Isometry/Platform/macOS/WindowManager.swift"
      provides: "Multiple window support for macOS"
      min_lines: 200
    - path: "native/Sources/Isometry/Platform/macOS/MenuBarIntegration.swift"
      provides: "Native macOS menu bar integration"
      min_lines: 150
    - path: "native/Sources/Isometry/Platform/AppStore/ComplianceValidator.swift"
      provides: "App Store compliance verification"
      min_lines: 100
  key_links:
    - from: "WindowManager.swift"
      to: "NSDocument/DocumentGroup"
      via: "document-based app architecture"
      pattern: "NSDocument|DocumentGroup"
    - from: "MenuBarIntegration.swift"
      to: "SwiftUI CommandGroup"
      via: "native menu integration"
      pattern: "CommandGroup|MenuBarExtra"
    - from: "ComplianceValidator.swift"
      to: "App Sandbox APIs"
      via: "entitlement and API validation"
      pattern: "Sandbox|Entitlement"
---

<objective>
Implement macOS-specific features including multiple windows, menu bar integration, trackpad optimizations, and ensure complete App Store compliance.

Purpose: Provide native macOS experience with desktop workflow optimizations, standard menu commands, and ensure production readiness for App Store submission
Output: macOS-optimized notebook interface with multiple window support and verified App Store compliance
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prerequisites from Wave 1 - Canvas and WebView integration
# These provide the preview system that needs macOS optimization
@.planning/phases/06.4-preview-platform-integration/06.4-01-PLAN.md
@.planning/phases/06.4-preview-platform-integration/06.4-02-PLAN.md

# Current macOS app structure
@native/IsometrymacOS/IsometrymacOSApp.swift

# Existing security patterns to validate
@native/Sources/Isometry/Security/SandboxExecutor.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement macOS window management and document architecture</name>
  <files>native/Sources/Isometry/Platform/macOS/WindowManager.swift</files>
  <action>
    Create WindowManager providing comprehensive macOS window management for notebook workflow:

    1. **Multiple Window Support**:
       - Implement document-based app architecture using SwiftUI DocumentGroup
       - Support opening multiple notebook windows with independent contexts
       - Window state restoration across app launches
       - Proper window titles reflecting current notebook content

    2. **Window Management**:
       - Standard macOS window behaviors (minimize, zoom, close)
       - Window cascading for new notebook windows
       - Full-screen mode support with proper toolbar hiding
       - Window tabbing support for related notebook sessions

    3. **Document Integration**:
       - Connect each window to specific notebook context or card
       - Save/restore window state including layout and content
       - Handle window-specific undo/redo operations
       - Support drag-and-drop between windows for card transfer

    4. **Platform Integration**:
       - Integrate with macOS Spaces and Mission Control
       - Support external display configurations
       - Maintain window relationships for proper focus management
       - Handle system-level window switching and restoration

    Use SwiftUI DocumentGroup patterns and NSDocument architecture where appropriate. Ensure each window maintains independent notebook state while sharing underlying database.
  </action>
  <verify>Multiple notebook windows open and manage content independently</verify>
  <done>macOS window management provides native desktop notebook experience</done>
</task>

<task type="auto">
  <name>Task 2: Create native macOS menu bar integration</name>
  <files>native/Sources/Isometry/Platform/macOS/MenuBarIntegration.swift</files>
  <action>
    Create MenuBarIntegration providing comprehensive macOS menu bar support for notebook functionality:

    1. **Standard Menu Integration**:
       - File menu: New notebook, Open, Save, Export commands
       - Edit menu: Undo/Redo, Cut/Copy/Paste, Find operations
       - View menu: Component visibility, zoom controls, theme switching
       - Window menu: Standard window management commands

    2. **Notebook-Specific Menus**:
       - Notebook menu: Card operations, template access, property management
       - Shell menu: Command execution, history access, Claude integration
       - Preview menu: Visualization controls, export options

    3. **Keyboard Shortcuts**:
       - Standard macOS shortcuts (⌘N, ⌘S, ⌘F, etc.)
       - Notebook-specific shortcuts (⌘⇧N for new card, ⌘/ for slash commands)
       - Canvas navigation shortcuts (⌘+ for zoom, arrow keys for pan)
       - Shell shortcuts (⌘T for new shell, ⌘K for clear)

    4. **Menu State Management**:
       - Context-sensitive menu item enabling/disabling
       - Dynamic menu content based on current notebook state
       - Menu validation for available operations
       - First responder chain integration for proper command routing

    Use SwiftUI CommandGroup and MenuBarExtra APIs. Ensure menu commands integrate properly with Canvas from Plan 01 and WebView from Plan 02.
  </action>
  <verify>Menu bar provides complete notebook functionality with proper shortcuts</verify>
  <done>Menu bar integration provides standard macOS desktop experience</done>
</task>

<task type="auto">
  <name>Task 3: Implement App Store compliance validation</name>
  <files>native/Sources/Isometry/Platform/AppStore/ComplianceValidator.swift</files>
  <action>
    Create ComplianceValidator ensuring complete App Store compliance for both iOS and macOS versions:

    1. **API Usage Validation**:
       - Verify all APIs are public and documented
       - Check for usage of private frameworks or undocumented methods
       - Validate entitlements match actual API usage
       - Ensure proper usage of sandboxed APIs only

    2. **Content Policy Compliance**:
       - Review export functionality for content restrictions
       - Validate WKWebView content filtering from Plan 02
       - Ensure shell command restrictions prevent policy violations
       - Check that no inappropriate content can be generated or shared

    3. **Security Model Validation**:
       - Verify App Sandbox compliance throughout application
       - Validate file access patterns respect sandbox boundaries
       - Check network access is properly declared and restricted
       - Ensure user data protection and privacy compliance

    4. **Technical Requirements**:
       - Verify app works without network connectivity where appropriate
       - Check proper handling of system resources and memory
       - Validate accessibility compliance with VoiceOver and other assistive tech
       - Ensure proper app lifecycle handling for all scenarios

    Include automated checks that can be run during CI/CD to catch compliance issues early. Reference existing SandboxExecutor security patterns and shell restrictions from Phase 6.3.
  </action>
  <verify>ComplianceValidator passes all checks for App Store requirements</verify>
  <done>App Store compliance verification confirms production readiness</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete macOS native integration with compliance validation</what-built>
  <how-to-verify>
    Test macOS-specific functionality and verify App Store readiness:

    1. **Window Management Testing**:
       - Open multiple notebook windows and verify independent operation
       - Test window restoration after app restart
       - Verify full-screen mode and window tabbing work properly
       - Test with multiple displays and Spaces

    2. **Menu Bar Integration**:
       - Test all menu commands work properly
       - Verify keyboard shortcuts function correctly
       - Test context-sensitive menu enabling/disabling
       - Confirm standard macOS menu behavior

    3. **Trackpad and Input Testing**:
       - Test trackpad gestures for Canvas navigation
       - Verify scroll behavior in all components
       - Test keyboard navigation throughout interface
       - Confirm proper focus management

    4. **App Store Compliance**:
       - Run ComplianceValidator and verify all checks pass
       - Test app in most restrictive sandbox mode
       - Verify no private API usage or entitlement violations
       - Confirm export functionality meets content policies

    5. **Integration Verification**:
       - Test Canvas visualization from Plan 01 in macOS context
       - Verify WKWebView and export from Plan 02 work on macOS
       - Test complete workflow from capture to preview to export
       - Confirm CloudKit sync works properly across windows
  </how-to-verify>
  <resume-signal>Type "approved" if macOS features and compliance are complete, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Multiple notebook windows function independently on macOS
2. Menu bar provides complete functionality with standard shortcuts
3. Trackpad gestures enhance Canvas and general navigation
4. ComplianceValidator confirms App Store readiness
5. All platform features integrate seamlessly with Canvas and WebView
</verification>

<success_criteria>
- macOS supports multiple independent notebook windows with proper document architecture
- Menu bar integration provides comprehensive functionality with standard macOS shortcuts
- Trackpad gestures enhance navigation and interaction throughout the app
- App Store compliance validation passes all requirements for submission
- Complete v2.0 Native Integration milestone ready for production deployment
</success_criteria>

<output>
After completion, create `.planning/phases/06.4-preview-platform-integration/06.4-04-SUMMARY.md`
</output>