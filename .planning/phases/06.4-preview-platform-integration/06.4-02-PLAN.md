---
phase: 06.4-preview-platform-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - native/Sources/Isometry/Views/Notebook/PreviewWebView.swift
  - native/Sources/Isometry/Services/ExportManager.swift
  - native/Sources/Isometry/Views/Notebook/ExportShareView.swift
autonomous: true

must_haves:
  truths:
    - "User can view web content and local files in secure WKWebView"
    - "User can export notebook content in multiple formats"
    - "Native share sheet provides platform-appropriate sharing options"
    - "Export formats maintain visual fidelity with React prototype"
  artifacts:
    - path: "native/Sources/Isometry/Services/ExportManager.swift"
      provides: "Native export functionality"
      min_lines: 250
      exports: ["ExportManager", "ExportFormat", "ExportRequest"]
    - path: "native/Sources/Isometry/Views/Notebook/PreviewWebView.swift"
      provides: "Secure WKWebView integration"
      min_lines: 200
    - path: "native/Sources/Isometry/Views/Notebook/ExportShareView.swift"
      provides: "Export UI and share sheet"
      min_lines: 150
  key_links:
    - from: "ExportManager.swift"
      to: "notebook card data"
      via: "IsometryDatabase queries"
      pattern: "isometryDB\\."
    - from: "PreviewWebView.swift"
      to: "WKWebView"
      via: "secure web content rendering"
      pattern: "WKWebView\\("
    - from: "ExportShareView.swift"
      to: "platform share APIs"
      via: "UIActivityViewController/NSSharingServicePicker"
      pattern: "Activity.*Controller|Sharing.*Picker"
---

<objective>
Implement WKWebView integration for universal content preview and native export system with platform share sheet integration.

Purpose: Provide secure web content preview and comprehensive export capabilities that match React prototype functionality while leveraging native platform APIs
Output: Universal preview component with WKWebView security and native export system supporting multiple formats
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context - completed shell integration
@.planning/phases/06.3-shell-integration/PHASE-SUMMARY.md

# Existing security patterns for reference
@native/Sources/Isometry/Security/SandboxExecutor.swift

# Database integration for export data
@native/Sources/Isometry/Database/IsometryDatabase.swift

# Current preview placeholder to enhance
@native/Sources/Isometry/Views/Notebook/NotebookPreviewView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create secure PreviewWebView with WKWebView integration</name>
  <files>native/Sources/Isometry/Views/Notebook/PreviewWebView.swift</files>
  <action>
    Create PreviewWebView SwiftUI component wrapping WKWebView with security policies for universal content preview:

    1. **WKWebView Foundation**:
       - Implement WKWebView wrapper using UIViewRepresentable/NSViewRepresentable
       - Configure secure WKWebViewConfiguration with restricted policies
       - Set up content security policies preventing unauthorized network access
       - Add JavaScript injection prevention and sandbox restrictions

    2. **Content Loading**:
       - Support loading web URLs with user permission prompts
       - Load local files from app document directory securely
       - Render HTML content generated from notebook cards
       - Display PDF documents and image files natively

    3. **Security Framework**:
       - Implement content validation before loading
       - Block unauthorized external resources and scripts
       - Add URL allowlist for trusted domains only
       - Prevent file:// access outside app sandbox

    4. **Integration Features**:
       - JavaScript bridge for limited communication with notebook
       - Loading states with progress indicators
       - Error handling for blocked or failed content
       - Navigation controls (back, forward, refresh)

    Use SandboxExecutor patterns for security validation and ensure compliance with App Store guidelines. Support both iOS and macOS with conditional compilation.
  </action>
  <verify>PreviewWebView loads secure content and blocks unauthorized access</verify>
  <done>WKWebView component provides secure universal content preview</done>
</task>

<task type="auto">
  <name>Task 2: Implement ExportManager for multi-format content export</name>
  <files>native/Sources/Isometry/Services/ExportManager.swift</files>
  <action>
    Create ExportManager actor providing native export functionality for notebook content across multiple formats:

    1. **Export Foundation**:
       - Actor-based design for thread-safe export operations
       - Support export formats: PDF, HTML, Markdown, JSON data
       - Query IsometryDatabase for complete notebook card data
       - Include metadata, properties, and relationship information

    2. **Format Implementations**:
       - **PDF Export**: Use PDFKit for layout-rendered PDF generation
       - **HTML Export**: Generate styled HTML matching React prototype
       - **Markdown Export**: Clean markdown with frontmatter metadata
       - **Data Export**: JSON format for backup and interchange

    3. **Content Processing**:
       - Markdown rendering to HTML for PDF and web formats
       - Image embedding and reference handling
       - Template-based formatting for consistent output
       - Batch export for multiple cards with table of contents

    4. **Platform Integration**:
       - Use FileManager for temporary file creation
       - Support Document Provider for save-to-files functionality
       - Handle large export operations with progress reporting
       - Cleanup temporary files after export completion

    Reference existing database query patterns and ensure exported content maintains visual fidelity with React prototype output.
  </action>
  <verify>ExportManager generates PDF, HTML, and Markdown from test data</verify>
  <done>Export system provides multi-format content generation</done>
</task>

<task type="auto">
  <name>Task 3: Create ExportShareView with native share sheet integration</name>
  <files>native/Sources/Isometry/Views/Notebook/ExportShareView.swift</files>
  <action>
    Create ExportShareView providing export UI and native platform sharing integration:

    1. **Export Interface**:
       - Format selection picker (PDF, HTML, Markdown, Data)
       - Export options configuration (single card vs batch)
       - Progress indicator for export operations
       - Preview before sharing functionality

    2. **Platform Share Integration**:
       - iOS: UIActivityViewController with appropriate activity types
       - macOS: NSSharingServicePicker with system services
       - Support save-to-files, email, Messages, AirDrop sharing
       - Custom activities for notebook-specific workflows

    3. **Export Workflow**:
       - Connect to ExportManager for content generation
       - Handle export progress and error states
       - Temporary file management for sharing
       - Success/failure feedback to user

    4. **UI Polish**:
       - Native platform styling and animations
       - Adaptive layout for different screen sizes
       - Accessibility labels and VoiceOver support
       - Keyboard navigation and shortcuts

    Use conditional compilation for iOS/macOS platform differences. Integrate with NotebookPreviewView for export button functionality planned in Plan 01.
  </action>
  <verify>ExportShareView presents native share sheet with generated content</verify>
  <done>Export UI provides platform-native sharing experience</done>
</task>

</tasks>

<verification>
1. PreviewWebView displays web content securely without unauthorized access
2. ExportManager generates proper PDF, HTML, Markdown output from notebook data
3. Native share sheet appears with appropriate platform sharing options
4. Export formats maintain visual quality matching React prototype
5. File operations respect App Sandbox restrictions
</verification>

<success_criteria>
- WKWebView provides secure universal content preview with proper restrictions
- Export system generates multiple formats (PDF, HTML, Markdown, JSON) from notebook data
- Native share sheet integration provides platform-appropriate sharing options
- Export output maintains visual fidelity with React prototype standards
- All functionality complies with App Sandbox and App Store requirements
</success_criteria>

<output>
After completion, create `.planning/phases/06.4-preview-platform-integration/06.4-02-SUMMARY.md`
</output>