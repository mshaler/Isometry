---
phase: 06.4-preview-platform-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - native/Sources/Isometry/Views/Notebook/VisualizationCanvas.swift
  - native/Sources/Isometry/Views/Notebook/NotebookPreviewView.swift
  - native/Sources/Isometry/Views/SuperGrid/CanvasDataAdapter.swift
autonomous: true

must_haves:
  truths:
    - "User can view real-time Canvas visualizations of notebook data"
    - "Canvas renders faster than D3.js with 60fps performance"
    - "Touch/trackpad gestures provide smooth pan and zoom"
    - "Visualization updates automatically when data changes"
  artifacts:
    - path: "native/Sources/Isometry/Views/Notebook/VisualizationCanvas.swift"
      provides: "Native Canvas visualization component"
      min_lines: 200
    - path: "native/Sources/Isometry/Views/SuperGrid/CanvasDataAdapter.swift"
      provides: "Data transformation for visualization"
      min_lines: 150
    - path: "native/Sources/Isometry/Views/Notebook/NotebookPreviewView.swift"
      provides: "Updated preview container"
      contains: "VisualizationCanvas"
  key_links:
    - from: "VisualizationCanvas.swift"
      to: "SuperGridView patterns"
      via: "Canvas drawing and gesture handling"
      pattern: "Canvas\\("
    - from: "CanvasDataAdapter.swift"
      to: "notebook card data"
      via: "SQLite query and transformation"
      pattern: "isometryDB\\."
    - from: "NotebookPreviewView.swift"
      to: "VisualizationCanvas"
      via: "SwiftUI composition"
      pattern: "VisualizationCanvas\\("
---

<objective>
Implement native Canvas visualization using existing SuperGrid patterns to provide high-performance data rendering that exceeds React D3.js capabilities.

Purpose: Replace React D3.js preview with native Canvas that leverages existing SuperGrid infrastructure for superior performance and platform integration
Output: Native Canvas visualization component integrated into notebook preview with 60fps performance and gesture support
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase context - native integration infrastructure
@.planning/phases/06.3-shell-integration/PHASE-SUMMARY.md

# Existing Canvas infrastructure to leverage
@native/Sources/Isometry/Views/SuperGridView.swift
@native/Sources/Isometry/Views/SuperGridViewModel.swift
@native/Sources/Isometry/Views/SuperGrid/

# Current notebook preview placeholder
@native/Sources/Isometry/Views/Notebook/NotebookPreviewView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create VisualizationCanvas component using SuperGrid patterns</name>
  <files>native/Sources/Isometry/Views/Notebook/VisualizationCanvas.swift</files>
  <action>
    Create VisualizationCanvas SwiftUI view that adapts SuperGrid Canvas patterns for notebook data visualization:

    1. **Canvas Foundation**:
       - Import SuperGrid Canvas optimization patterns from SuperGridView.swift
       - Implement SwiftUI Canvas view with platform-specific performance optimizations
       - Add OSSignpost performance monitoring matching SuperGrid patterns
       - Support both iOS and macOS with conditional compilation

    2. **Data Visualization**:
       - Render notebook cards as connected nodes using existing Node/Edge patterns
       - Use Canvas drawing APIs for high-performance node/edge rendering
       - Implement force-directed layout algorithm optimized for Canvas
       - Support multiple chart types: network, timeline, hierarchy

    3. **Gesture Integration**:
       - Port touch/trackpad gestures from SuperGrid for pan/zoom
       - Implement smooth animation using DisplayLink/CADisplayLink
       - Add selection handling with highlight states
       - Support accessibility through semantic Canvas regions

    4. **Performance Optimization**:
       - Use Canvas GraphicsContext for optimal drawing performance
       - Implement view culling for large datasets (1000+ cards)
       - Add background rendering queue for complex calculations
       - Target 60fps performance with performance monitoring

    Reference SuperGridView architecture but simplify for notebook card data instead of full PAFV hierarchy. Use existing Canvas patterns but adapt for time-series and network visualizations common in notebooks.
  </action>
  <verify>Build succeeds and VisualizationCanvas displays basic test data</verify>
  <done>VisualizationCanvas component renders notebook cards as interactive visualization</done>
</task>

<task type="auto">
  <name>Task 2: Create CanvasDataAdapter for notebook data transformation</name>
  <files>native/Sources/Isometry/Views/SuperGrid/CanvasDataAdapter.swift</files>
  <action>
    Create CanvasDataAdapter actor to transform notebook card data into Canvas-ready visualization format:

    1. **Data Layer Integration**:
       - Actor-based design for thread-safe data processing
       - Query IsometryDatabase for notebook cards with relationships
       - Transform notebook_cards table data into Node/Edge format
       - Support real-time data updates through Combine publishers

    2. **Visualization Transforms**:
       - Convert markdown content to visual summaries (word count, type detection)
       - Extract tag relationships for network visualization
       - Create time-series data from creation/modification timestamps
       - Generate hierarchy from card references and links

    3. **Performance Optimization**:
       - Batch data processing for large card sets
       - Cache computed layouts to avoid recalculation
       - Implement incremental updates for data changes
       - Use background queues for expensive transformations

    4. **Format Support**:
       - Output format compatible with Canvas GraphicsContext
       - Support different chart types through layout adapters
       - Provide metadata for interactive features (tooltips, selection)
       - Include performance metrics for monitoring

    Interface should match SuperGrid data patterns but focus on notebook card relationships rather than full knowledge graph complexity.
  </action>
  <verify>CanvasDataAdapter successfully queries and transforms test notebook data</verify>
  <done>Data adapter provides Canvas-ready visualization data from notebook cards</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Canvas visualization into NotebookPreviewView</name>
  <files>native/Sources/Isometry/Views/Notebook/NotebookPreviewView.swift</files>
  <action>
    Replace placeholder NotebookPreviewView with integrated Canvas visualization and preview controls:

    1. **Canvas Integration**:
       - Replace placeholder content with VisualizationCanvas component
       - Add CanvasDataAdapter as StateObject for data management
       - Implement preview mode switching (Canvas, Web, Document)
       - Connect to notebook state for real-time updates

    2. **UI Controls**:
       - Add visualization type picker (network, timeline, hierarchy)
       - Implement zoom controls and fit-to-content button
       - Add export button preparation for Plan 02 WKWebView integration
       - Include performance indicator showing fps/render time

    3. **State Management**:
       - Connect to NotebookContext for current card awareness
       - Update visualization when active card changes
       - Preserve view state (zoom, position) across card switches
       - Handle loading states and error conditions gracefully

    4. **Responsive Design**:
       - Adaptive layout for iOS/macOS screen sizes
       - Proper spacing and component sizing
       - Support for landscape/portrait orientation changes
       - Maintain visual hierarchy with existing notebook components

    Result should feel like native replacement for React D3.js preview with superior performance and platform integration.
  </action>
  <verify>NotebookPreviewView displays Canvas visualization with smooth 60fps rendering</verify>
  <done>Preview component shows native Canvas visualization with interactive controls</done>
</task>

</tasks>

<verification>
1. Build native projects without errors
2. VisualizationCanvas renders test data with 60fps performance
3. Canvas responds to touch/trackpad gestures smoothly
4. Data updates trigger automatic visualization refresh
5. Performance monitoring shows Canvas exceeds D3.js benchmarks
</verification>

<success_criteria>
- Native Canvas visualization component integrated into notebook preview
- Performance monitoring shows 60fps with 1000+ cards (exceeding D3.js)
- Touch/trackpad gestures provide smooth pan/zoom interaction
- Real-time data updates reflected immediately in visualization
- Foundation ready for WKWebView and export integration in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/06.4-preview-platform-integration/06.4-01-SUMMARY.md`
</output>