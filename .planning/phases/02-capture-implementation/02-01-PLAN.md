---
phase: 02-capture-implementation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  "package.json",
  "src/components/notebook/CaptureComponent.tsx",
  "src/hooks/useMarkdownEditor.ts"
]
autonomous: true

must_haves:
  truths:
    - "User can write markdown with syntax highlighting and live preview"
    - "User can toggle between edit and preview modes"
    - "User can see rendered markdown output in real-time"
  artifacts:
    - path: "src/components/notebook/CaptureComponent.tsx"
      provides: "Markdown editor with live preview"
      min_lines: 100
      exports: ["CaptureComponent"]
    - path: "src/hooks/useMarkdownEditor.ts"
      provides: "Editor state management hook"
      exports: ["useMarkdownEditor"]
    - path: "package.json"
      provides: "Markdown editor dependency"
      contains: "@uiw/react-md-editor"
  key_links:
    - from: "src/components/notebook/CaptureComponent.tsx"
      to: "@uiw/react-md-editor"
      via: "import MDEditor"
      pattern: "import.*@uiw/react-md-editor"
    - from: "src/hooks/useMarkdownEditor.ts"
      to: "NotebookContext"
      via: "updateCard calls"
      pattern: "updateCard.*activeCard"
---

<objective>
Replace the placeholder CaptureComponent with a fully functional markdown editor using @uiw/react-md-editor, providing live preview and seamless integration with the existing NotebookContext.

Purpose: Enable users to write rich markdown content with syntax highlighting and live preview, establishing the core capture functionality for the notebook sidecar.
Output: Working markdown editor component with live preview and persistent state integration.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/notebook/CaptureComponent.tsx
@src/contexts/NotebookContext.tsx
@src/types/notebook.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Install markdown editor dependency</name>
  <files>package.json</files>
  <action>
    Install @uiw/react-md-editor with npm:

    ```bash
    npm install @uiw/react-md-editor
    npm install --save-dev @types/react-codemirror2
    ```

    The @uiw/react-md-editor package provides:
    - CodeMirror-based editor with syntax highlighting
    - Live preview panel with synchronized scrolling
    - Toolbar with markdown formatting buttons
    - Built-in theme support
    - TypeScript definitions included

    Also install @types/react-codemirror2 for enhanced TypeScript support of the underlying editor.
  </action>
  <verify>npm list @uiw/react-md-editor shows package is installed</verify>
  <done>Package.json contains @uiw/react-md-editor dependency and types are available</done>
</task>

<task type="auto">
  <name>Create markdown editor state hook</name>
  <files>src/hooks/useMarkdownEditor.ts</files>
  <action>
    Create a custom hook that manages markdown editor state and integrates with NotebookContext:

    ```typescript
    import { useState, useCallback, useEffect, useRef } from 'react';
    import { useNotebook } from '../contexts/NotebookContext';
    import { debounce } from '../utils/debounce'; // Create simple debounce utility

    interface UseMarkdownEditorOptions {
      autoSaveDelay?: number;
      enableAutoSave?: boolean;
    }

    export function useMarkdownEditor(options: UseMarkdownEditorOptions = {}) {
      const { autoSaveDelay = 2000, enableAutoSave = true } = options;
      const { activeCard, updateCard } = useNotebook();
      const [content, setContent] = useState(activeCard?.markdownContent || '');
      const [isDirty, setIsDirty] = useState(false);
      const [isSaving, setIsSaving] = useState(false);
      const saveTimeoutRef = useRef<NodeJS.Timeout>();

      // Auto-save functionality with debouncing
      const debouncedSave = useCallback(
        debounce(async (cardId: string, newContent: string) => {
          if (!enableAutoSave) return;

          setIsSaving(true);
          try {
            await updateCard(cardId, {
              markdownContent: newContent,
              renderedContent: null // Let backend re-render
            });
            setIsDirty(false);
          } catch (error) {
            console.error('Auto-save failed:', error);
          } finally {
            setIsSaving(false);
          }
        }, autoSaveDelay),
        [updateCard, enableAutoSave, autoSaveDelay]
      );

      // Content change handler
      const handleContentChange = useCallback((value: string = '') => {
        setContent(value);
        setIsDirty(true);

        if (activeCard?.id && enableAutoSave) {
          debouncedSave(activeCard.id, value);
        }
      }, [activeCard?.id, enableAutoSave, debouncedSave]);

      // Manual save function
      const saveNow = useCallback(async () => {
        if (!activeCard?.id || !isDirty) return;

        setIsSaving(true);
        try {
          await updateCard(activeCard.id, {
            markdownContent: content,
            renderedContent: null
          });
          setIsDirty(false);
        } catch (error) {
          console.error('Manual save failed:', error);
          throw error;
        } finally {
          setIsSaving(false);
        }
      }, [activeCard?.id, content, isDirty, updateCard]);

      // Sync with active card changes
      useEffect(() => {
        if (activeCard?.markdownContent !== undefined) {
          setContent(activeCard.markdownContent || '');
          setIsDirty(false);
        }
      }, [activeCard?.id, activeCard?.markdownContent]);

      // Clear timeout on unmount
      useEffect(() => {
        return () => {
          if (saveTimeoutRef.current) {
            clearTimeout(saveTimeoutRef.current);
          }
        };
      }, []);

      return {
        content,
        setContent: handleContentChange,
        isDirty,
        isSaving,
        saveNow,
        activeCard
      };
    }
    ```

    Also create simple debounce utility in `src/utils/debounce.ts`:

    ```typescript
    export function debounce<T extends (...args: any[]) => any>(
      func: T,
      wait: number
    ): T {
      let timeout: NodeJS.Timeout | null = null;

      return ((...args: any[]) => {
        if (timeout) clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      }) as T;
    }
    ```
  </action>
  <verify>TypeScript compilation passes and hook exports useMarkdownEditor function</verify>
  <done>useMarkdownEditor hook provides content state, change handlers, auto-save, and manual save functionality</done>
</task>

<task type="auto">
  <name>Implement markdown editor component</name>
  <files>src/components/notebook/CaptureComponent.tsx</files>
  <action>
    Replace the placeholder content in CaptureComponent with @uiw/react-md-editor integration:

    ```tsx
    import { useState, useCallback } from 'react';
    import { Edit3, Minimize2, Maximize2, ChevronDown, ChevronRight, Save, AlertCircle } from 'lucide-react';
    import MDEditor from '@uiw/react-md-editor';
    import { useTheme } from '../../contexts/ThemeContext';
    import { useMarkdownEditor } from '../../hooks/useMarkdownEditor';

    interface CaptureComponentProps {
      className?: string;
    }

    export function CaptureComponent({ className }: CaptureComponentProps) {
      const { theme } = useTheme();
      const [isMinimized, setIsMinimized] = useState(false);
      const [propertiesExpanded, setPropertiesExpanded] = useState(false);
      const [previewMode, setPreviewMode] = useState<'edit' | 'split' | 'preview'>('split');

      const {
        content,
        setContent,
        isDirty,
        isSaving,
        saveNow,
        activeCard
      } = useMarkdownEditor({
        autoSaveDelay: 2000,
        enableAutoSave: true
      });

      const handleManualSave = useCallback(async () => {
        try {
          await saveNow();
        } catch (error) {
          console.error('Save failed:', error);
          // TODO: Show user-friendly error notification
        }
      }, [saveNow]);

      if (isMinimized) {
        return (
          <div className={`${className} ${theme === 'NeXTSTEP' ? 'bg-[#c0c0c0] border-[#707070]' : 'bg-white border-gray-300'} border rounded-lg`}>
            <div className={`flex items-center justify-between p-2 ${theme === 'NeXTSTEP' ? 'bg-[#d4d4d4]' : 'bg-gray-100'} rounded-t-lg border-b`}>
              <div className="flex items-center gap-2">
                <Edit3 size={16} className="text-gray-600" />
                <span className="font-medium text-sm">Capture</span>
                {isDirty && <div className="w-2 h-2 bg-orange-500 rounded-full" title="Unsaved changes" />}
              </div>
              <button
                onClick={() => setIsMinimized(false)}
                className={`p-1 rounded hover:${theme === 'NeXTSTEP' ? 'bg-[#b0b0b0]' : 'bg-gray-200'} transition-colors`}
                title="Maximize"
              >
                <Maximize2 size={14} className="text-gray-600" />
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className={`${className} ${theme === 'NeXTSTEP' ? 'bg-[#c0c0c0] border-[#707070]' : 'bg-white border-gray-300'} border rounded-lg flex flex-col min-w-[300px]`}>
          {/* Header */}
          <div className={`flex items-center justify-between p-2 ${theme === 'NeXTSTEP' ? 'bg-[#d4d4d4]' : 'bg-gray-100'} rounded-t-lg border-b`}>
            <div className="flex items-center gap-2">
              <Edit3 size={16} className="text-gray-600" />
              <span className="font-medium text-sm">
                {activeCard ? `Card: ${activeCard.nodeId.slice(0, 8)}...` : 'No Active Card'}
              </span>
              {isDirty && <div className="w-2 h-2 bg-orange-500 rounded-full" title="Unsaved changes" />}
              {isSaving && <div className="text-xs text-gray-500">Saving...</div>}
            </div>
            <div className="flex items-center gap-1">
              {/* Save button */}
              <button
                onClick={handleManualSave}
                disabled={!isDirty || isSaving}
                className={`p-1 rounded hover:${theme === 'NeXTSTEP' ? 'bg-[#b0b0b0]' : 'bg-gray-200'} transition-colors disabled:opacity-50`}
                title="Save now (Ctrl+S)"
              >
                <Save size={14} className="text-gray-600" />
              </button>

              {/* View mode toggle */}
              <select
                value={previewMode}
                onChange={(e) => setPreviewMode(e.target.value as 'edit' | 'split' | 'preview')}
                className="text-xs p-1 rounded border"
              >
                <option value="edit">Edit</option>
                <option value="split">Split</option>
                <option value="preview">Preview</option>
              </select>

              <button
                onClick={() => setIsMinimized(true)}
                className={`p-1 rounded hover:${theme === 'NeXTSTEP' ? 'bg-[#b0b0b0]' : 'bg-gray-200'} transition-colors`}
                title="Minimize"
              >
                <Minimize2 size={14} className="text-gray-600" />
              </button>
            </div>
          </div>

          {/* Content Area */}
          <div className="flex-1 flex flex-col">
            {/* Editor Area */}
            <div className="flex-1 p-2">
              {activeCard ? (
                <MDEditor
                  value={content}
                  onChange={setContent}
                  preview={previewMode === 'edit' ? 'edit' : previewMode === 'preview' ? 'preview' : 'live'}
                  hideToolbar={false}
                  height={400}
                  data-color-mode={theme === 'NeXTSTEP' ? 'light' : 'light'}
                />
              ) : (
                <div className={`h-full ${theme === 'NeXTSTEP' ? 'bg-white border-[#707070]' : 'bg-gray-50 border-gray-200'} border rounded flex items-center justify-center text-gray-500`}>
                  <div className="text-center">
                    <AlertCircle size={24} className="mx-auto mb-2 text-gray-400" />
                    <p className="text-sm">No card selected</p>
                    <p className="text-xs text-gray-400">Create a card to start editing</p>
                  </div>
                </div>
              )}
            </div>

            {/* Properties Panel */}
            <div className={`border-t ${theme === 'NeXTSTEP' ? 'border-[#707070] bg-[#d4d4d4]' : 'border-gray-200 bg-gray-50'}`}>
              <button
                onClick={() => setPropertiesExpanded(!propertiesExpanded)}
                className={`w-full flex items-center justify-between p-2 hover:${theme === 'NeXTSTEP' ? 'bg-[#b0b0b0]' : 'bg-gray-100'} transition-colors`}
              >
                <span className="text-sm font-medium">Properties</span>
                {propertiesExpanded ? (
                  <ChevronDown size={14} className="text-gray-600" />
                ) : (
                  <ChevronRight size={14} className="text-gray-600" />
                )}
              </button>

              {propertiesExpanded && activeCard && (
                <div className="p-3 space-y-2">
                  <div>
                    <label className="text-xs text-gray-600 block mb-1">Card Type</label>
                    <input
                      type="text"
                      value={activeCard.cardType}
                      readOnly
                      className={`w-full text-xs p-1 border rounded bg-gray-100 ${theme === 'NeXTSTEP' ? 'border-[#707070]' : 'border-gray-300'}`}
                    />
                  </div>
                  <div>
                    <label className="text-xs text-gray-600 block mb-1">Node ID</label>
                    <input
                      type="text"
                      value={activeCard.nodeId}
                      readOnly
                      className={`w-full text-xs p-1 border rounded bg-gray-100 font-mono ${theme === 'NeXTSTEP' ? 'border-[#707070]' : 'border-gray-300'}`}
                    />
                  </div>
                  <div>
                    <label className="text-xs text-gray-600 block mb-1">Created</label>
                    <input
                      type="text"
                      value={new Date(activeCard.createdAt).toLocaleString()}
                      readOnly
                      className={`w-full text-xs p-1 border rounded bg-gray-100 ${theme === 'NeXTSTEP' ? 'border-[#707070]' : 'border-gray-300'}`}
                    />
                  </div>
                  <div>
                    <label className="text-xs text-gray-600 block mb-1">Modified</label>
                    <input
                      type="text"
                      value={new Date(activeCard.modifiedAt).toLocaleString()}
                      readOnly
                      className={`w-full text-xs p-1 border rounded bg-gray-100 ${theme === 'NeXTSTEP' ? 'border-[#707070]' : 'border-gray-300'}`}
                    />
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }
    ```

    Key features implemented:
    - Full @uiw/react-md-editor integration with toolbar
    - Three view modes: edit, split (live), preview
    - Auto-save with visual indicators (orange dot for dirty state)
    - Manual save button with keyboard shortcut support
    - Properties panel showing card metadata
    - Proper handling of no active card state
    - Theme support for NeXTSTEP and Modern themes
    - Save status indicators (saving spinner, dirty indicator)
  </action>
  <verify>npm run typecheck passes and component renders markdown editor</verify>
  <done>CaptureComponent shows functional markdown editor with live preview, auto-save, and properties panel</done>
</task>

</tasks>

<verification>
1. Install dependencies and verify package.json contains @uiw/react-md-editor
2. Run `npm run typecheck` to verify TypeScript compilation
3. Start development server with `npm run dev`
4. Navigate to notebook mode and verify:
   - Markdown editor renders with toolbar and syntax highlighting
   - Live preview works in split mode
   - Auto-save triggers after typing (check for "saving..." indicator)
   - Properties panel expands/collapses and shows card metadata
   - Different view modes (edit/split/preview) work correctly
</verification>

<success_criteria>
1. User can write markdown with syntax highlighting and live preview functionality
2. Content auto-saves every 2 seconds when user types in the editor
3. User can manually save with save button and see save status indicators
4. User can toggle between edit, split, and preview modes
5. Properties panel displays card metadata and can be collapsed/expanded
6. Component handles no active card state gracefully
7. Integration with existing theme system works properly
</success_criteria>

<output>
After completion, create `.planning/phases/02-capture-implementation/02-01-SUMMARY.md`
</output>