---
phase: 60-supergrid-stacked-headers
plan: 03
type: execute
wave: 3
depends_on: ["60-02"]
files_modified:
  - src/d3/SuperGridHeaders.ts
  - src/d3/header-interaction/HeaderAnimationController.ts
  - src/state/PAFVContext.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a header cell triggers sorting by that level's facet"
    - "Sort direction toggles (asc -> desc -> none) on repeated clicks"
    - "Visual indicator shows current sort direction on header"
  artifacts:
    - path: "src/d3/SuperGridHeaders.ts"
      provides: "Header click handler that emits sort events with facet and level info"
      contains: "onHeaderSortClick"
    - path: "src/d3/header-interaction/HeaderAnimationController.ts"
      provides: "Sort indicator animation (arrow/chevron)"
      contains: "animateSortIndicator"
    - path: "src/state/PAFVContext.tsx"
      provides: "Sort state management (facet, direction)"
      contains: "setSortBy"
  key_links:
    - from: "src/d3/SuperGridHeaders.ts"
      to: "src/state/PAFVContext.tsx"
      via: "onHeaderClick callback -> setSortBy action"
      pattern: "setSortBy"
    - from: "src/d3/header-interaction/HeaderAnimationController.ts"
      to: "d3-transition"
      via: "transition().attr for sort indicator"
      pattern: "transition.*attr"
---

<objective>
Enable header click sorting at each level of the hierarchy.

Purpose: Users can click on any header cell (Year, Quarter, Month) to sort cards by that level. The sort applies to cards within the clicked subtree while preserving child ordering. Visual indicators show current sort state.

Output: Clickable headers with toggle sort (asc/desc/none), visual sort indicators, and PAFVContext sort state management.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-supergrid-stacked-headers/60-02-SUMMARY.md

Key files:
@src/d3/SuperGridHeaders.ts — Header orchestrator (add sort click handling)
@src/d3/header-interaction/HeaderAnimationController.ts — Animation utilities
@src/state/PAFVContext.tsx — State management (add sort state)
@src/types/pafv.ts — Types (add SortConfig)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sort state to PAFVContext</name>
  <files>src/types/pafv.ts, src/state/PAFVContext.tsx, src/hooks/data/usePAFV.ts</files>
  <action>
1. In `src/types/pafv.ts`, add sort-related types:

```typescript
/** Sort direction for grid sorting */
export type SortDirection = 'asc' | 'desc' | null;

/** Sort configuration for header-based sorting */
export interface SortConfig {
  /** Facet column to sort by (e.g., 'quarter', 'year') */
  facet: string;
  /** Sort direction */
  direction: SortDirection;
  /** Hierarchy level where sort was initiated (for visual indicator) */
  level: number;
}
```

2. Update PAFVState in `src/types/pafv.ts`:

```typescript
export interface PAFVState {
  mappings: AxisMapping[];
  viewMode: 'grid' | 'list';
  densityLevel: DensityLevel;
  colorEncoding: EncodingConfig | null;
  sizeEncoding: EncodingConfig | null;
  /** Current sort configuration (null = no sort applied) */
  sortConfig: SortConfig | null;
}
```

3. Update DEFAULT_PAFV:

```typescript
export const DEFAULT_PAFV: PAFVState = {
  // ... existing fields
  sortConfig: null,
};
```

4. In `src/state/PAFVContext.tsx`, add setSortBy action:

```typescript
// In the reducer
case 'SET_SORT_BY':
  return {
    ...state,
    sortConfig: action.payload
  };

// Add action creator in context value
const setSortBy = useCallback((sortConfig: SortConfig | null) => {
  dispatch({ type: 'SET_SORT_BY', payload: sortConfig });
}, []);

// Include in context value
const contextValue = useMemo(() => ({
  // ... existing values
  sortConfig: state.sortConfig,
  setSortBy,
}), [/* ... deps ... */, state.sortConfig, setSortBy]);
```

5. Update `src/hooks/data/usePAFV.ts` to expose sortConfig and setSortBy:

```typescript
export interface PAFVContextValue {
  // ... existing fields
  sortConfig: SortConfig | null;
  setSortBy: (config: SortConfig | null) => void;
}
```
  </action>
  <verify>
```bash
npm run typecheck
grep -n "SortConfig" src/types/pafv.ts
grep -n "setSortBy" src/state/PAFVContext.tsx
```
  </verify>
  <done>PAFVState has sortConfig field. setSortBy action exists in PAFVContext. Types compile.</done>
</task>

<task type="auto">
  <name>Task 2: Implement header click sorting in SuperGridHeaders</name>
  <files>src/d3/SuperGridHeaders.ts</files>
  <action>
Add sort click handling to SuperGridHeaders:

```typescript
// Add to interface/types
interface SortState {
  facet: string;
  direction: 'asc' | 'desc' | null;
  nodeId: string;
}

// Add to class
private currentSortState: SortState | null = null;

/**
 * Handle header click for sorting
 * Toggle through asc -> desc -> null cycle
 */
private handleHeaderSortClick(node: HeaderNode): void {
  const facet = node.facet || node.label;

  // Determine new sort direction
  let newDirection: 'asc' | 'desc' | null;
  if (this.currentSortState?.facet === facet) {
    // Toggle: asc -> desc -> null
    if (this.currentSortState.direction === 'asc') {
      newDirection = 'desc';
    } else if (this.currentSortState.direction === 'desc') {
      newDirection = null;
    } else {
      newDirection = 'asc';
    }
  } else {
    // New facet, start with ascending
    newDirection = 'asc';
  }

  // Update internal state
  if (newDirection === null) {
    this.currentSortState = null;
  } else {
    this.currentSortState = {
      facet,
      direction: newDirection,
      nodeId: node.id
    };
  }

  // Update visual indicator
  this.animationController.animateSortIndicator(
    node.id,
    newDirection
  );

  // Emit event for external handling
  if (this.callbacks?.onHeaderClick) {
    this.callbacks.onHeaderClick({
      nodeId: node.id,
      facet,
      value: node.label,
      level: node.level,
      sortDirection: newDirection,
      event: new MouseEvent('click') // Synthetic event
    });
  }

  superGridLogger.debug('Header sort clicked', {
    facet,
    direction: newDirection,
    level: node.level
  });
}

/**
 * Setup click interactions for stacked headers with sort behavior
 */
private setupStackedHeaderInteractions(hierarchy: HeaderHierarchy): void {
  const self = this;

  // Select all header nodes and attach click handler
  this.container
    .selectAll<SVGGElement, HeaderNode>('.header-node')
    .style('cursor', 'pointer')
    .on('click', function(event: MouseEvent, d: HeaderNode) {
      event.stopPropagation();
      self.handleHeaderSortClick(d);
    })
    .on('mouseenter', function() {
      d3.select(this).select('.header-bg')
        .transition()
        .duration(150)
        .attr('fill', '#e2e8f0'); // Hover highlight
    })
    .on('mouseleave', function(this: SVGGElement, _event: MouseEvent, d: HeaderNode) {
      const isSelected = self.currentSortState?.nodeId === d.id;
      d3.select(this).select('.header-bg')
        .transition()
        .duration(150)
        .attr('fill', isSelected ? '#dbeafe' : '#f8fafc');
    });
}
```

Update HeaderClickEvent interface (in header-types.ts or equivalent) to include sortDirection:

```typescript
export interface HeaderClickEvent {
  nodeId: string;
  facet: string;
  value: string;
  level: number;
  sortDirection?: 'asc' | 'desc' | null;
  event: MouseEvent;
}
```
  </action>
  <verify>
```bash
npm run typecheck
grep -n "handleHeaderSortClick" src/d3/SuperGridHeaders.ts
grep -n "sortDirection" src/d3/SuperGridHeaders.ts
```
  </verify>
  <done>SuperGridHeaders has handleHeaderSortClick method. Sort state toggles through asc/desc/null. Header click events include sortDirection.</done>
</task>

<task type="auto">
  <name>Task 3: Add sort indicator animation to HeaderAnimationController</name>
  <files>src/d3/header-interaction/HeaderAnimationController.ts</files>
  <action>
Add sort indicator visualization and animation:

```typescript
/**
 * Animate sort indicator on header cell
 * Shows chevron/arrow indicating sort direction
 *
 * @param nodeId - ID of the header node
 * @param direction - Sort direction ('asc', 'desc', or null to remove)
 */
public animateSortIndicator(
  nodeId: string,
  direction: 'asc' | 'desc' | null
): void {
  const node = this.container.select(`[data-node-id="${nodeId}"]`);
  if (node.empty()) return;

  // Remove existing sort indicators from all headers
  this.container
    .selectAll('.sort-indicator')
    .transition()
    .duration(150)
    .attr('opacity', 0)
    .remove();

  // Remove selected state from all headers
  this.container
    .selectAll('.header-bg')
    .transition()
    .duration(150)
    .attr('fill', '#f8fafc');

  if (direction === null) {
    return; // Sort cleared, nothing more to do
  }

  // Highlight the sorted header
  node.select('.header-bg')
    .transition()
    .duration(200)
    .attr('fill', '#dbeafe'); // Light blue for selected

  // Get header dimensions for positioning
  const rect = node.select('.header-bg').node() as SVGRectElement | null;
  if (!rect) return;

  const width = parseFloat(rect.getAttribute('width') || '0');
  const height = parseFloat(rect.getAttribute('height') || '0');

  // Create sort indicator (triangle/chevron)
  const indicator = node.append('g')
    .attr('class', 'sort-indicator')
    .attr('transform', `translate(${width - 16}, ${height / 2})`)
    .attr('opacity', 0);

  // Triangle path: up for asc, down for desc
  const trianglePath = direction === 'asc'
    ? 'M0,4 L4,0 L8,4 Z'   // Up arrow
    : 'M0,0 L4,4 L8,0 Z';  // Down arrow

  indicator.append('path')
    .attr('d', trianglePath)
    .attr('fill', '#3b82f6')
    .attr('transform', 'translate(-4, -2)');

  // Animate in
  indicator
    .transition()
    .duration(200)
    .attr('opacity', 1);
}

/**
 * Clear all sort indicators
 */
public clearSortIndicators(): void {
  this.container
    .selectAll('.sort-indicator')
    .transition()
    .duration(150)
    .attr('opacity', 0)
    .remove();

  this.container
    .selectAll('.header-bg')
    .transition()
    .duration(150)
    .attr('fill', '#f8fafc');
}
```
  </action>
  <verify>
```bash
npm run typecheck
grep -n "animateSortIndicator" src/d3/header-interaction/HeaderAnimationController.ts
```
  </verify>
  <done>HeaderAnimationController has animateSortIndicator method. Sort direction visualized with triangle indicator. Selected header highlighted.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run typecheck` passes
2. Sort state in context: grep confirms SortConfig type and setSortBy action
3. Click handling wired: grep confirms handleHeaderSortClick in SuperGridHeaders
4. Visual indicator: grep confirms animateSortIndicator in HeaderAnimationController
5. Manual test: `npm run dev`, navigate to /?test=integrated, click headers to see sort toggle and visual indicator
</verification>

<success_criteria>
1. Clicking a header cell toggles sort: asc -> desc -> none
2. Sort direction shows visual indicator (triangle/chevron)
3. Selected header has visual highlight (blue background)
4. Sort state persisted in PAFVContext
5. Sort events emitted via onHeaderClick callback for external handling
</success_criteria>

<output>
After completion, create `.planning/phases/60-supergrid-stacked-headers/60-03-SUMMARY.md`
</output>
