---
phase: 87-gsd-file-synchronization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/gsd/gsdFileParser.ts
  - src/services/gsd/gsdTypes.ts
  - src/services/gsd/index.ts
  - src/services/gsd/__tests__/gsdFileParser.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "System can parse PLAN.md frontmatter into typed structure"
    - "System can extract task blocks from markdown content"
    - "System normalizes task status from markdown checkbox syntax"
  artifacts:
    - path: "src/services/gsd/gsdTypes.ts"
      provides: "TypeScript interfaces for GSD file parsing"
      exports: ["PlanFrontmatter", "GSDTask", "ParsedPlanFile", "TaskStatus"]
    - path: "src/services/gsd/gsdFileParser.ts"
      provides: "Markdown frontmatter and task block parsing"
      exports: ["parseGSDPlanFile", "extractTasks", "normalizeTaskStatus"]
  key_links:
    - from: "src/services/gsd/gsdFileParser.ts"
      to: "gray-matter"
      via: "import matter"
      pattern: "matter\\(fileContent\\)"
---

<objective>
Create GSD file parser that extracts frontmatter and task blocks from PLAN.md files using gray-matter.

Purpose: Foundation for file-based GSD synchronization - need to read structured data from markdown files before we can sync state bidirectionally.

Output: `gsdFileParser.ts` module with typed interfaces and parsing functions.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/87-gsd-file-synchronization/87-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSD types and file parser with gray-matter</name>
  <files>
    src/services/gsd/gsdTypes.ts
    src/services/gsd/gsdFileParser.ts
    src/services/gsd/index.ts
  </files>
  <action>
Install gray-matter package (npm install gray-matter).

Create `gsdTypes.ts` with interfaces:
- `PlanFrontmatter`: phase, plan, type, wave, depends_on (string[]), files_modified (string[]), autonomous (boolean), user_setup? (array), must_haves? (object)
- `TaskStatus`: 'pending' | 'in_progress' | 'complete'
- `GSDTask`: name, type ('auto' | 'checkpoint:*'), files (string[]), action (string), verify (string), done (string), status (TaskStatus)
- `ParsedPlanFile`: frontmatter (PlanFrontmatter), tasks (GSDTask[]), rawContent (string), filePath (string)

Create `gsdFileParser.ts` with functions:
1. `parseGSDPlanFile(filePath: string): Promise<ParsedPlanFile>` - reads file, parses frontmatter with gray-matter, extracts tasks
2. `extractTasks(content: string): GSDTask[]` - regex extraction of `<task type="...">...</task>` blocks, parses internal `<name>`, `<files>`, `<action>`, `<verify>`, `<done>` elements
3. `normalizeTaskStatus(task: GSDTask): TaskStatus` - if `<done>` has content, task is 'complete'; otherwise 'pending'

Important: Use `fs/promises` for async file reads. Handle malformed XML gracefully with defaults.

Create `index.ts` barrel export.
  </action>
  <verify>
Run `npm run typecheck` - no errors in gsd/ directory.
Import test: `import { parseGSDPlanFile } from './services/gsd'` compiles.
  </verify>
  <done>gray-matter installed, types defined, parser functions implemented with proper error handling</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for GSD file parser</name>
  <files>
    src/services/gsd/__tests__/gsdFileParser.test.ts
  </files>
  <action>
Create unit tests using Vitest with test fixtures:

1. **Test frontmatter parsing:**
   - Valid PLAN.md with full frontmatter extracts all fields correctly
   - Missing optional fields (user_setup, must_haves) use defaults
   - Array fields (depends_on, files_modified) normalize single values to arrays

2. **Test task extraction:**
   - Single task block extracts name, type, files, action, verify, done
   - Multiple task blocks extracted in order
   - Task with checkpoint:* types parsed correctly
   - Missing `<done>` element results in status='pending'
   - Present `<done>` element results in status='complete'

3. **Test edge cases:**
   - Empty file returns empty tasks array with minimal frontmatter
   - File with frontmatter but no tasks returns empty tasks array
   - Malformed task XML skipped gracefully (no crash)

Use inline fixture strings, not file I/O, for fast tests.
  </action>
  <verify>
Run `npm run test -- src/services/gsd` - all tests pass.
  </verify>
  <done>Unit tests pass covering frontmatter parsing, task extraction, and edge cases</done>
</task>

</tasks>

<verification>
- [ ] gray-matter package installed in package.json
- [ ] gsdTypes.ts exports all interfaces
- [ ] gsdFileParser.ts exports parsing functions
- [ ] Unit tests pass for all parsing scenarios
- [ ] `npm run typecheck` passes
</verification>

<success_criteria>
- System can parse real PLAN.md files from `.planning/phases/` directory
- Task status correctly inferred from `<done>` element presence
- All unit tests green
</success_criteria>

<output>
After completion, create `.planning/phases/87-gsd-file-synchronization/87-01-SUMMARY.md`
</output>
