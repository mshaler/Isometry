---
phase: 86-claude-ai-integration
plan: 01
type: execute
wave: 1
depends_on: [85-05]
files_modified:
  - src/components/notebook/ShellComponent.tsx
  - src/components/claude-ai/ClaudeAIChat.tsx
  - src/hooks/useClaudeAI.ts
  - src/services/claude-ai/claudeService.ts
autonomous: true

must_haves:
  truths:
    - "Claude AI tab shows a functional chat interface"
    - "User can send messages and receive streaming responses"
    - "Chat history persists during session"
  artifacts:
    - path: "src/components/claude-ai/ClaudeAIChat.tsx"
      provides: "Chat UI component"
      contains: "MessageInput"
    - path: "src/hooks/useClaudeAI.ts"
      provides: "Claude API hook"
      contains: "sendMessage"
  key_links:
    - from: "src/components/notebook/ShellComponent.tsx"
      to: "ClaudeAIChat"
      via: "component import"
      pattern: "ClaudeAIChat"
---

<objective>
Build basic chat interface for Claude AI tab with Anthropic API integration.

Purpose: Replace placeholder "Coming soon" with a functional chat interface that connects to Claude API. This is the foundation for all subsequent Claude AI features.

Output:
- ClaudeAIChat component with message input and display
- useClaudeAI hook for API communication
- claudeService for Anthropic API calls
- Streaming response support
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/85-backend-terminal/85-05-SUMMARY.md
@src/components/notebook/ShellComponent.tsx
@src/config/environment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Anthropic SDK and create service</name>
  <files>
    package.json
    src/services/claude-ai/claudeService.ts
    src/services/claude-ai/index.ts
  </files>
  <action>
Install the Anthropic SDK and create the Claude service.

```bash
npm install @anthropic-ai/sdk
```

**Create src/services/claude-ai/claudeService.ts:**
```typescript
import Anthropic from '@anthropic-ai/sdk';
import { devLogger } from '@/utils/logging';

export interface ChatMessage {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
}

export interface StreamCallbacks {
  onText: (text: string) => void;
  onComplete: () => void;
  onError: (error: Error) => void;
}

/**
 * Claude AI Service - handles Anthropic API communication
 *
 * Note: API key should be set via ANTHROPIC_API_KEY environment variable
 * or passed explicitly. For browser usage, requests should proxy through
 * a backend to protect the API key.
 */
class ClaudeService {
  private client: Anthropic | null = null;
  private model = 'claude-sonnet-4-20250514';

  constructor() {
    // Initialize client lazily when API key is available
  }

  private getClient(): Anthropic {
    if (!this.client) {
      const apiKey = import.meta.env.VITE_ANTHROPIC_API_KEY;
      if (!apiKey) {
        throw new Error('ANTHROPIC_API_KEY not configured. Set VITE_ANTHROPIC_API_KEY in .env');
      }
      this.client = new Anthropic({
        apiKey,
        dangerouslyAllowBrowser: true // Enable browser usage (dev only)
      });
    }
    return this.client;
  }

  /**
   * Check if API key is configured
   */
  isConfigured(): boolean {
    return !!import.meta.env.VITE_ANTHROPIC_API_KEY;
  }

  /**
   * Send a message and stream the response
   */
  async sendMessageStreaming(
    messages: Array<{ role: 'user' | 'assistant'; content: string }>,
    callbacks: StreamCallbacks,
    systemPrompt?: string
  ): Promise<void> {
    try {
      const client = this.getClient();

      const stream = await client.messages.stream({
        model: this.model,
        max_tokens: 4096,
        system: systemPrompt || 'You are a helpful AI assistant integrated into Isometry, a knowledge management application.',
        messages: messages.map(m => ({
          role: m.role,
          content: m.content
        }))
      });

      for await (const event of stream) {
        if (event.type === 'content_block_delta' && event.delta.type === 'text_delta') {
          callbacks.onText(event.delta.text);
        }
      }

      callbacks.onComplete();
    } catch (error) {
      devLogger.error('Claude API error', { component: 'ClaudeService', error });
      callbacks.onError(error instanceof Error ? error : new Error(String(error)));
    }
  }

  /**
   * Send a message and wait for complete response
   */
  async sendMessage(
    messages: Array<{ role: 'user' | 'assistant'; content: string }>,
    systemPrompt?: string
  ): Promise<string> {
    const client = this.getClient();

    const response = await client.messages.create({
      model: this.model,
      max_tokens: 4096,
      system: systemPrompt || 'You are a helpful AI assistant integrated into Isometry, a knowledge management application.',
      messages: messages.map(m => ({
        role: m.role,
        content: m.content
      }))
    });

    const textContent = response.content.find(c => c.type === 'text');
    return textContent?.text || '';
  }
}

export const claudeService = new ClaudeService();
```

**Create src/services/claude-ai/index.ts:**
```typescript
export { claudeService, type ChatMessage, type StreamCallbacks } from './claudeService';
```
  </action>
  <verify>
    `npm run typecheck` passes.
    @anthropic-ai/sdk is in package.json dependencies.
    claudeService.ts exports claudeService instance.
  </verify>
  <done>
    Anthropic SDK installed.
    ClaudeService created with streaming support.
    API key configuration via VITE_ANTHROPIC_API_KEY.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useClaudeAI hook</name>
  <files>
    src/hooks/useClaudeAI.ts
    src/hooks/index.ts
  </files>
  <action>
Create a React hook to manage Claude AI chat state.

**Create src/hooks/useClaudeAI.ts:**
```typescript
import { useState, useCallback, useRef } from 'react';
import { claudeService, type ChatMessage } from '@/services/claude-ai';
import { devLogger } from '@/utils/logging';

interface UseClaudeAIOptions {
  systemPrompt?: string;
}

export function useClaudeAI(options: UseClaudeAIOptions = {}) {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [streamingContent, setStreamingContent] = useState('');
  const abortRef = useRef(false);

  const isConfigured = claudeService.isConfigured();

  /**
   * Generate unique message ID
   */
  const generateId = () => `msg-${Date.now()}-${Math.random().toString(36).slice(2, 9)}`;

  /**
   * Send a message to Claude
   */
  const sendMessage = useCallback(async (content: string) => {
    if (!content.trim() || isLoading) return;

    setError(null);
    abortRef.current = false;

    // Add user message
    const userMessage: ChatMessage = {
      id: generateId(),
      role: 'user',
      content: content.trim(),
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    setIsLoading(true);
    setStreamingContent('');

    // Prepare messages for API (exclude IDs and timestamps)
    const apiMessages = [...messages, userMessage].map(m => ({
      role: m.role,
      content: m.content
    }));

    try {
      let fullResponse = '';

      await claudeService.sendMessageStreaming(
        apiMessages,
        {
          onText: (text) => {
            if (abortRef.current) return;
            fullResponse += text;
            setStreamingContent(fullResponse);
          },
          onComplete: () => {
            if (abortRef.current) return;

            const assistantMessage: ChatMessage = {
              id: generateId(),
              role: 'assistant',
              content: fullResponse,
              timestamp: new Date()
            };

            setMessages(prev => [...prev, assistantMessage]);
            setStreamingContent('');
            setIsLoading(false);
          },
          onError: (err) => {
            devLogger.error('Claude chat error', { component: 'useClaudeAI', error: err });
            setError(err.message);
            setIsLoading(false);
            setStreamingContent('');
          }
        },
        options.systemPrompt
      );
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Unknown error';
      setError(errorMessage);
      setIsLoading(false);
      setStreamingContent('');
    }
  }, [messages, isLoading, options.systemPrompt]);

  /**
   * Clear chat history
   */
  const clearMessages = useCallback(() => {
    setMessages([]);
    setStreamingContent('');
    setError(null);
  }, []);

  /**
   * Stop current generation
   */
  const stopGeneration = useCallback(() => {
    abortRef.current = true;
    setIsLoading(false);

    // If there's partial content, save it as a message
    if (streamingContent) {
      const partialMessage: ChatMessage = {
        id: generateId(),
        role: 'assistant',
        content: streamingContent + '\n\n[Generation stopped]',
        timestamp: new Date()
      };
      setMessages(prev => [...prev, partialMessage]);
      setStreamingContent('');
    }
  }, [streamingContent]);

  return {
    messages,
    isLoading,
    error,
    streamingContent,
    isConfigured,
    sendMessage,
    clearMessages,
    stopGeneration
  };
}
```

**Update src/hooks/index.ts to export:**
```typescript
export { useClaudeAI } from './useClaudeAI';
```
  </action>
  <verify>
    `npm run typecheck` passes.
    useClaudeAI exported from hooks/index.ts.
    Hook returns messages, sendMessage, isLoading, etc.
  </verify>
  <done>
    useClaudeAI hook created with full chat state management.
    Streaming support with partial content display.
    Stop generation and clear messages functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ClaudeAIChat component</name>
  <files>
    src/components/claude-ai/ClaudeAIChat.tsx
    src/components/claude-ai/index.ts
  </files>
  <action>
Create the chat UI component with message display and input.

**Create src/components/claude-ai/ClaudeAIChat.tsx:**
```typescript
import { useState, useRef, useEffect, useCallback, KeyboardEvent } from 'react';
import { Send, Square, Trash2, AlertCircle, Bot, User } from 'lucide-react';
import { useClaudeAI } from '@/hooks';
import { cn } from '@/lib/utils';

interface ClaudeAIChatProps {
  className?: string;
  systemPrompt?: string;
}

/**
 * ClaudeAIChat - Chat interface for Claude AI assistant
 *
 * Features:
 * - Message input with Enter to send
 * - Streaming response display
 * - Message history with user/assistant distinction
 * - Stop generation button
 * - Clear chat button
 */
export function ClaudeAIChat({ className, systemPrompt }: ClaudeAIChatProps) {
  const [input, setInput] = useState('');
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const inputRef = useRef<HTMLTextAreaElement>(null);

  const {
    messages,
    isLoading,
    error,
    streamingContent,
    isConfigured,
    sendMessage,
    clearMessages,
    stopGeneration
  } = useClaudeAI({ systemPrompt });

  // Auto-scroll to bottom on new messages
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, streamingContent]);

  // Focus input on mount
  useEffect(() => {
    inputRef.current?.focus();
  }, []);

  const handleSend = useCallback(() => {
    if (input.trim() && !isLoading) {
      sendMessage(input);
      setInput('');
    }
  }, [input, isLoading, sendMessage]);

  const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  // Not configured state
  if (!isConfigured) {
    return (
      <div className={cn('flex flex-col h-full bg-gray-900', className)}>
        <div className="flex-1 flex items-center justify-center p-4">
          <div className="text-center max-w-md">
            <AlertCircle size={48} className="mx-auto mb-4 text-yellow-500" />
            <h3 className="text-lg font-medium text-gray-200 mb-2">API Key Required</h3>
            <p className="text-sm text-gray-400 mb-4">
              To use Claude AI, add your Anthropic API key to the environment:
            </p>
            <code className="block bg-gray-800 p-3 rounded text-xs text-green-400 font-mono">
              VITE_ANTHROPIC_API_KEY=sk-ant-...
            </code>
            <p className="text-xs text-gray-500 mt-4">
              Add this to your .env file and restart the dev server.
            </p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className={cn('flex flex-col h-full bg-gray-900', className)}>
      {/* Messages Area */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.length === 0 && !streamingContent && (
          <div className="flex items-center justify-center h-full text-gray-500">
            <div className="text-center">
              <Bot size={48} className="mx-auto mb-3 text-gray-600" />
              <p className="text-sm">Start a conversation with Claude</p>
              <p className="text-xs mt-1 text-gray-600">
                Type a message below and press Enter
              </p>
            </div>
          </div>
        )}

        {messages.map((message) => (
          <div
            key={message.id}
            className={cn(
              'flex gap-3',
              message.role === 'user' ? 'justify-end' : 'justify-start'
            )}
          >
            {message.role === 'assistant' && (
              <div className="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0">
                <Bot size={16} className="text-white" />
              </div>
            )}
            <div
              className={cn(
                'max-w-[80%] rounded-lg px-4 py-2 text-sm',
                message.role === 'user'
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-800 text-gray-200'
              )}
            >
              <pre className="whitespace-pre-wrap font-sans">{message.content}</pre>
            </div>
            {message.role === 'user' && (
              <div className="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0">
                <User size={16} className="text-gray-300" />
              </div>
            )}
          </div>
        ))}

        {/* Streaming response */}
        {streamingContent && (
          <div className="flex gap-3 justify-start">
            <div className="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0 animate-pulse">
              <Bot size={16} className="text-white" />
            </div>
            <div className="max-w-[80%] rounded-lg px-4 py-2 text-sm bg-gray-800 text-gray-200">
              <pre className="whitespace-pre-wrap font-sans">{streamingContent}</pre>
              <span className="inline-block w-2 h-4 bg-gray-400 animate-pulse ml-1" />
            </div>
          </div>
        )}

        {/* Error message */}
        {error && (
          <div className="flex items-center gap-2 p-3 bg-red-900/30 border border-red-700 rounded-lg text-red-400 text-sm">
            <AlertCircle size={16} />
            <span>{error}</span>
          </div>
        )}

        <div ref={messagesEndRef} />
      </div>

      {/* Input Area */}
      <div className="border-t border-gray-700 p-3">
        <div className="flex gap-2">
          <textarea
            ref={inputRef}
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="Type a message..."
            disabled={isLoading}
            rows={1}
            className={cn(
              'flex-1 resize-none bg-gray-800 border border-gray-700 rounded-lg px-3 py-2',
              'text-sm text-gray-200 placeholder-gray-500',
              'focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent',
              'disabled:opacity-50 disabled:cursor-not-allowed'
            )}
            style={{ minHeight: '40px', maxHeight: '120px' }}
          />

          <div className="flex flex-col gap-1">
            {isLoading ? (
              <button
                onClick={stopGeneration}
                className="p-2 bg-red-600 hover:bg-red-500 rounded-lg transition-colors"
                title="Stop generation"
              >
                <Square size={18} className="text-white" />
              </button>
            ) : (
              <button
                onClick={handleSend}
                disabled={!input.trim()}
                className={cn(
                  'p-2 rounded-lg transition-colors',
                  input.trim()
                    ? 'bg-blue-600 hover:bg-blue-500 text-white'
                    : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                )}
                title="Send message"
              >
                <Send size={18} />
              </button>
            )}

            {messages.length > 0 && (
              <button
                onClick={clearMessages}
                className="p-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
                title="Clear chat"
              >
                <Trash2 size={18} className="text-gray-400" />
              </button>
            )}
          </div>
        </div>

        <div className="text-xs text-gray-500 mt-2 flex items-center justify-between">
          <span>Press Enter to send, Shift+Enter for new line</span>
          <span>{messages.length} messages</span>
        </div>
      </div>
    </div>
  );
}
```

**Create src/components/claude-ai/index.ts:**
```typescript
export { ClaudeAIChat } from './ClaudeAIChat';
```
  </action>
  <verify>
    `npm run typecheck` passes.
    ClaudeAIChat renders message list and input.
    Streaming content displays with cursor animation.
  </verify>
  <done>
    ClaudeAIChat component complete with full UI.
    Message display with user/assistant styling.
    Input with keyboard shortcuts.
    Loading and error states handled.
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate ClaudeAIChat into ShellComponent</name>
  <files>
    src/components/notebook/ShellComponent.tsx
  </files>
  <action>
Replace the placeholder Claude AI tab content with the actual chat component.

**Update ShellComponent.tsx imports:**
```typescript
import { ClaudeAIChat } from '../claude-ai';
```

**Replace the Claude AI tab content section:**
Find this block:
```tsx
{/* Claude AI Tab - MCP Assistant */}
{activeTab === 'claude-ai' && (
  <div className="flex-1 flex items-center justify-center text-gray-400">
    <div className="text-center">
      <Bot size={48} className="mx-auto mb-3 text-gray-600" />
      <div className="font-medium mb-1 text-gray-300">Claude AI Assistant</div>
      <div className="text-sm mb-3">AI-powered assistance with MCP integration</div>
      <div className="text-xs">Coming soon: Direct AI conversation interface</div>
    </div>
  </div>
)}
```

Replace with:
```tsx
{/* Claude AI Tab - MCP Assistant */}
{activeTab === 'claude-ai' && (
  <ClaudeAIChat className="flex-1" />
)}
```

Also update the status bar Claude status to reflect actual configuration:
Replace the Claude status section that shows "configured"/"not-configured" to use the actual isConfigured state from useClaudeAI if needed, or leave as-is for now since the chat component handles this display.
  </action>
  <verify>
    `npm run typecheck` passes.
    Claude AI tab shows ClaudeAIChat component.
    Tab switching still works correctly.
  </verify>
  <done>
    ClaudeAIChat integrated into Shell.
    Placeholder replaced with functional chat.
    Terminal tab persistence still works.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. Claude AI tab shows chat interface (or API key required message)
3. Messages can be sent and responses stream in
4. Chat history maintained during session
5. Tab switching between Terminal/Claude AI/GSD works
</verification>

<success_criteria>
- CLAI-01: Chat UI renders in Claude AI tab
- CLAI-02: Messages display with user/assistant distinction
- CLAI-03: Streaming responses show incrementally
- CLAI-04: Stop generation works
- CLAI-05: Clear chat works
- CLAI-06: API key missing shows helpful error
- Human can chat with Claude in the app
</success_criteria>

<output>
After completion, create `.planning/phases/86-claude-ai-integration/86-01-SUMMARY.md`
</output>
