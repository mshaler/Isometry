---
phase: 86-claude-ai-integration
plan: 04
type: execute
wave: 4
depends_on: [86-03]
files_modified:
  - src/services/terminal/terminalPTYServer.ts
  - src/components/shell/Terminal.tsx
  - src/hooks/system/useTerminal.ts
autonomous: true

must_haves:
  truths:
    - "Claude Code mode auto-spawns claude CLI"
    - "Mode toggle switches between shell and claude without manual typing"
    - "Terminal UI indicates active mode clearly"
  artifacts:
    - path: "src/services/terminal/terminalPTYServer.ts"
      provides: "Auto-spawn claude CLI on mode switch"
      contains: "claude" spawn command
    - path: "src/components/shell/Terminal.tsx"
      provides: "Mode indicator UI enhancement"
      contains: "mode indicator"
  key_links:
    - from: "useTerminal"
      to: "terminalPTYServer"
      via: "WebSocket dispatcher"
      pattern: "terminal:switch-mode"
---

<objective>
Enhance Claude Code mode to auto-spawn the `claude` CLI when switching modes.

Purpose: Make the Terminal's Claude Code mode work seamlessly - when user toggles to Claude Code mode, the `claude` CLI starts automatically instead of requiring the user to type "claude" manually.

Output:
- Auto-spawn claude CLI on claude-code mode switch
- Clear mode indication in Terminal header
- Graceful fallback if claude CLI not found
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/86-claude-ai-integration/86-03-SUMMARY.md
@src/services/terminal/terminalPTYServer.ts
@src/hooks/system/useTerminal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-spawn claude CLI in claude-code mode</name>
  <files>
    src/services/terminal/terminalPTYServer.ts
  </files>
  <action>
Update `handleModeSwitch` to spawn `claude` directly in claude-code mode.

**Modify src/services/terminal/terminalPTYServer.ts:**

In the `handleModeSwitch` method, change the shell spawn logic for claude-code mode:

```typescript
// Around line 356, update the spawn logic:

// Determine command based on mode
let command: string;
let args: string[];

if (newMode === 'claude-code') {
  // Spawn claude CLI directly
  // The 'claude' command from @anthropic-ai/claude-code npm package
  command = 'claude';
  args = ['--continue']; // Continue from previous conversation if any
} else {
  // Shell mode - spawn user's preferred shell
  command = session.config.shell || '/bin/zsh';
  args = [];
}

try {
  const pty = spawn(command, args, {
    name: 'xterm-256color',
    cols: session.config.cols || 80,
    rows: session.config.rows || 24,
    cwd: currentCwd,
    env: {
      ...process.env,
      TERM: 'xterm-256color',
      COLORTERM: 'truecolor',
      ISOMETRY_TERMINAL_MODE: newMode
    }
  });
  // ... rest remains same
```

Also update `spawnSession` to handle initial spawn in claude-code mode:

```typescript
// Around line 104, update spawn logic:

// Determine command based on mode
let command: string;
let args: string[];

if (mode === 'claude-code') {
  command = 'claude';
  args = ['--continue'];
} else {
  command = shell;
  args = [];
}

const pty = spawn(command, args, {
  // ... existing config
});
```
  </action>
  <verify>
    `npm run typecheck` passes.
    Claude CLI spawns when mode is 'claude-code'.
    Shell spawns when mode is 'shell'.
  </verify>
  <done>
    PTY server spawns claude CLI for claude-code mode.
    Shell spawns for shell mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add fallback for missing claude CLI</name>
  <files>
    src/services/terminal/terminalPTYServer.ts
  </files>
  <action>
Add graceful fallback if claude CLI is not installed.

**Update the spawn error handling:**

```typescript
// Add helper to check if command exists
import { execSync } from 'child_process';

/**
 * Check if a command exists in PATH
 */
function commandExists(cmd: string): boolean {
  try {
    execSync(`which ${cmd}`, { stdio: 'ignore' });
    return true;
  } catch {
    return false;
  }
}

// In handleModeSwitch and spawnSession, before spawning:
if (newMode === 'claude-code' && !commandExists('claude')) {
  // Fallback: spawn shell with message
  const fallbackMessage =
    '\x1b[33mClaude CLI not found. Install with: npm install -g @anthropic-ai/claude-code\x1b[0m\r\n' +
    '\x1b[33mFalling back to shell mode.\x1b[0m\r\n';

  session.outputBuffer.append(fallbackMessage);
  this.broadcastToSession(sessionId, {
    type: 'terminal:output',
    sessionId,
    data: fallbackMessage
  });

  // Spawn shell instead
  command = session.config.shell || '/bin/zsh';
  args = [];
  session.mode = 'shell'; // Revert mode
}
```
  </action>
  <verify>
    When claude CLI is missing, shows helpful message.
    Falls back to shell mode gracefully.
  </verify>
  <done>
    Graceful fallback implemented.
    User sees installation instructions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhanced mode indicator in Terminal UI</name>
  <files>
    src/components/shell/Terminal.tsx
  </files>
  <action>
Add clearer mode indication with status.

**Update Terminal.tsx header section:**

```typescript
// Around line 148, enhance the mode toggle button:

{/* Mode Toggle with Status */}
<div className="flex items-center gap-2">
  <button
    onClick={handleModeToggle}
    className={`px-2 py-0.5 text-xs rounded transition-colors flex items-center gap-1 ${
      currentMode === 'claude-code'
        ? 'bg-purple-600 text-white'
        : 'bg-gray-600 text-gray-200 hover:bg-gray-500'
    }`}
    title={`Switch to ${currentMode === 'shell' ? 'Claude Code' : 'Shell'} mode`}
  >
    {currentMode === 'claude-code' ? (
      <>
        <span className="animate-pulse">ðŸ¤–</span>
        <span>Claude Code</span>
      </>
    ) : (
      <>
        <span>ðŸ’»</span>
        <span>Shell</span>
      </>
    )}
  </button>

  {/* Mode-specific hint */}
  <span className="text-[10px] text-gray-500">
    {currentMode === 'claude-code'
      ? 'AI-assisted mode'
      : 'Standard terminal'
    }
  </span>
</div>
```

Also update the footer to show mode more prominently:

```typescript
// Around line 184, update footer:

<div className="terminal-footer flex-shrink-0 h-6 bg-gray-700 flex items-center justify-between px-2 text-xs text-gray-300">
  <span>Shell: {shell}</span>
  <span className={`px-1.5 py-0.5 rounded text-[10px] ${
    currentMode === 'claude-code'
      ? 'bg-purple-700 text-purple-200'
      : 'bg-gray-600 text-gray-300'
  }`}>
    {currentMode === 'claude-code' ? 'Claude Code Active' : 'Shell Mode'}
  </span>
</div>
```
  </action>
  <verify>
    Mode toggle shows clear visual state.
    Footer shows active mode with color coding.
    Animation on Claude Code mode.
  </verify>
  <done>
    Enhanced mode indicator UI.
    Clear visual distinction between modes.
  </done>
</task>

<task type="auto">
  <name>Task 4: Add mode-switched callback handling</name>
  <files>
    src/hooks/system/useTerminal.ts
  </files>
  <action>
Handle the mode-switched callback from server.

**Update useTerminal.ts:**

Add handler for mode-switched event:

```typescript
// Add new callback handler after handleTerminalError:

/**
 * Handle mode switched event from server
 */
const handleTerminalModeSwitched = useCallback((
  sessionId: string,
  mode: 'shell' | 'claude-code',
  pid: number
) => {
  if (sessionId !== sessionIdRef.current) return;

  devLogger.debug('Terminal mode switched', {
    component: 'useTerminal',
    sessionId,
    mode,
    pid
  });

  setCurrentMode(mode);

  // Write mode switch confirmation to terminal
  const terminal = terminalRef.current;
  if (terminal) {
    terminal.write(`\r\n\x1b[36m[Switched to ${mode} mode]\x1b[0m\r\n`);
  }
}, []);

// Update initializeDispatcher to register the callback:
dispatcher.setTerminalCallbacks({
  onTerminalOutput: handleTerminalOutput,
  onTerminalSpawned: handleTerminalSpawned,
  onTerminalExit: handleTerminalExit,
  onTerminalError: handleTerminalError,
  onTerminalReplayData: handleTerminalReplayData,
  onTerminalModeSwitched: handleTerminalModeSwitched  // Add this
});
```
  </action>
  <verify>
    Mode switch callback registered.
    Terminal shows mode switch confirmation.
    State updates correctly.
  </verify>
  <done>
    Mode-switched event handling complete.
    Terminal confirms mode change.
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. Toggle to Claude Code mode spawns claude CLI automatically
3. Toggle back to Shell mode spawns user's shell
4. Missing claude CLI shows installation message and falls back to shell
5. UI clearly indicates current mode
</verification>

<success_criteria>
- CLAI-15: Claude Code mode auto-spawns claude CLI
- CLAI-16: Mode toggle works bidirectionally
- CLAI-17: Graceful fallback for missing CLI
- CLAI-18: Clear mode indication in UI
- User can switch between shell and claude-code seamlessly
</success_criteria>

<output>
After completion, create `.planning/phases/86-claude-ai-integration/86-04-SUMMARY.md`
</output>
