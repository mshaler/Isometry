---
phase: 80-notebook-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/components/IntegratedLayout.tsx
  - src/components/ui/collapsible.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees collapsed Notebook panel below Command Bar (default state)"
    - "User can click toggle to expand/collapse the panel"
    - "NotebookContext is available in the component tree"
    - "Collapsed state shows minimal header with expand indicator"
  artifacts:
    - path: "src/App.tsx"
      provides: "NotebookProvider wrapping IntegratedLayout"
      contains: "NotebookProvider"
    - path: "src/components/IntegratedLayout.tsx"
      provides: "Collapsible Notebook panel skeleton"
      contains: "isNotebookExpanded"
    - path: "src/components/ui/collapsible.tsx"
      provides: "Enhanced Collapsible with animation support"
      contains: "transition-all"
  key_links:
    - from: "src/App.tsx"
      to: "NotebookProvider"
      via: "context wrapping"
      pattern: "<NotebookProvider>"
    - from: "src/components/IntegratedLayout.tsx"
      to: "localStorage"
      via: "state persistence"
      pattern: "localStorage\\.getItem.*notebook_expanded"
---

<objective>
Add NotebookProvider context wiring to App.tsx and implement collapsible panel skeleton in IntegratedLayout.

Purpose: Enable Notebook state management across the app and create the collapsible UI container that will hold the full NotebookLayout in Plan 02.

Output:
- NotebookProvider wrapping IntegratedLayout in default app route
- Collapsible panel skeleton below Command Bar with expand/collapse toggle
- Panel state persisted to localStorage (collapsed by default)
- Theme-aware collapsed header styling
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/App.tsx
@src/components/IntegratedLayout.tsx
@src/contexts/NotebookContext.tsx
@src/components/ui/collapsible.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire NotebookProvider in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Add NotebookProvider wrapping to BOTH IntegratedLayout routes in App.tsx.

**Current state:** NotebookProvider is imported at line 8, but it is ONLY used in the `?test=three-canvas` route (lines 81-83). It is NOT used in:
- The `?test=integrated` route (lines 127-144)
- The default route (lines 149-165)

**Required changes:**

1. For the `?test=integrated` route (around lines 127-144), add NotebookProvider inside AppStateProvider:

```tsx
if (testMode === 'integrated') {
  return (
    <SQLiteProvider>
      <FilterProvider>
        <ThemeProvider>
          <PAFVProvider>
            <SelectionProvider>
              <AppStateProvider>
                <NotebookProvider>
                  <DeepLinkHandler>
                    <IntegratedLayout />
                  </DeepLinkHandler>
                </NotebookProvider>
              </AppStateProvider>
            </SelectionProvider>
          </PAFVProvider>
        </ThemeProvider>
      </FilterProvider>
    </SQLiteProvider>
  );
}
```

2. For the default route (around lines 149-165), add NotebookProvider inside AppStateProvider:

```tsx
return (
  <SQLiteProvider>
    <FilterProvider>
      <ThemeProvider>
        <PAFVProvider>
          <SelectionProvider>
            <AppStateProvider>
              <NotebookProvider>
                <DeepLinkHandler>
                  <IntegratedLayout />
                </DeepLinkHandler>
              </NotebookProvider>
            </AppStateProvider>
          </SelectionProvider>
        </PAFVProvider>
      </ThemeProvider>
    </FilterProvider>
  </SQLiteProvider>
);
```

No new imports needed - NotebookProvider is already imported at line 8.
  </action>
  <verify>
1. Run `npm run typecheck` - no errors related to NotebookProvider.
2. Run `npm run dev` and open localhost:5173 (default route) - no console errors about "useNotebook must be used within NotebookProvider".
3. Open localhost:5173/?test=integrated - same, no context errors.
4. **Context access test:** Add temporary verification in IntegratedLayout.tsx at the top of the component function:
   ```tsx
   // TEMP: Verify NotebookContext is available (remove after verification)
   const notebookContext = React.useContext(NotebookContext);
   console.log('NotebookContext available:', !!notebookContext);
   ```
   Open browser console - should see "NotebookContext available: true".
   Remove the temporary code after confirming.
  </verify>
  <done>
NotebookProvider wraps IntegratedLayout in BOTH routes:
- Default route (no ?test param)
- ?test=integrated route
Both routes have NotebookContext available for useNotebook() hook calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance Collapsible component with smooth animation</name>
  <files>src/components/ui/collapsible.tsx</files>
  <action>
Update CollapsibleContent to support smooth max-height animation using inline styles (NOT Tailwind arbitrary values in template literals, which don't work with JIT compilation).

Replace the current CollapsibleContent implementation:

```tsx
export function CollapsibleContent({
  children,
  open,
  className,
  maxHeight = '24rem', // Default ~384px, suitable for Notebook panel
  ...props
}: CollapsibleContentProps & { maxHeight?: string }) {
  return (
    <div
      style={{
        maxHeight: open ? maxHeight : '0',
        transition: 'max-height 300ms ease-in-out',
      }}
      className={`
        overflow-hidden
        ${className || ''}
      `}
      {...props}
    >
      {children}
    </div>
  );
}
```

Also update the CollapsibleContentProps interface to include maxHeight:

```tsx
export interface CollapsibleContentProps extends React.HTMLAttributes<HTMLDivElement> {
  children: React.ReactNode;
  open?: boolean;
  maxHeight?: string;
}
```

**Why inline style instead of Tailwind:**
Tailwind JIT compiler cannot detect classes inside template literals with dynamic values like `max-h-[${maxHeight}]`. Using inline style ensures the animation works correctly.
The 300ms duration matches existing view transition timing in the codebase.
  </action>
  <verify>
Inspect the Collapsible component in browser devtools - verify style attribute has maxHeight and transition.
Test expand/collapse - should animate smoothly over 300ms.
  </verify>
  <done>
CollapsibleContent supports smooth max-height animation with configurable maxHeight prop using inline styles.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add collapsible Notebook panel skeleton to IntegratedLayout</name>
  <files>src/components/IntegratedLayout.tsx</files>
  <action>
Add a collapsible panel section between the Command Bar and Dataset Switcher.

1. Add imports at top:
```tsx
import { ChevronDown, ChevronUp, BookOpen } from 'lucide-react';
```

2. Add state for panel expansion with localStorage persistence (after other useState calls, around line 106):
```tsx
// Notebook panel expand/collapse state with localStorage persistence
const [isNotebookExpanded, setIsNotebookExpanded] = useState(() => {
  try {
    return localStorage.getItem('notebook_expanded') === 'true';
  } catch {
    return false; // Collapsed by default
  }
});

// Persist notebook panel state to localStorage
useEffect(() => {
  try {
    localStorage.setItem('notebook_expanded', isNotebookExpanded.toString());
  } catch (err) {
    console.warn('Failed to persist notebook expanded state', err);
  }
}, [isNotebookExpanded]);
```

3. Add the collapsible panel UI between Command Bar and Dataset Switcher (after the Command Bar div, around line 485):
```tsx
{/* Collapsible Notebook Panel */}
<div className={`${panelBg} border-b ${borderColor}`}>
  {/* Collapsed Header - always visible */}
  <button
    type="button"
    onClick={() => setIsNotebookExpanded(prev => !prev)}
    className={`
      w-full h-8 px-4 flex items-center justify-between
      hover:bg-opacity-80 transition-colors
      ${isNeXTSTEP ? 'hover:bg-[#2D2D2D]' : 'hover:bg-gray-100'}
    `}
    aria-expanded={isNotebookExpanded}
    aria-controls="notebook-panel"
  >
    <div className="flex items-center gap-2">
      <BookOpen className={`w-4 h-4 ${mutedColor}`} />
      <span className={`text-xs font-medium ${textColor}`}>Notebook</span>
      <span className={`text-[10px] ${mutedColor}`}>
        {isNotebookExpanded ? '3 panes' : 'Capture / Shell / Preview'}
      </span>
    </div>
    {isNotebookExpanded ? (
      <ChevronUp className={`w-4 h-4 ${mutedColor}`} />
    ) : (
      <ChevronDown className={`w-4 h-4 ${mutedColor}`} />
    )}
  </button>

  {/* Expandable Content Area - placeholder for Plan 02 */}
  <div
    id="notebook-panel"
    style={{
      maxHeight: isNotebookExpanded ? '24rem' : '0',
      transition: 'max-height 300ms ease-in-out',
    }}
    className="overflow-hidden"
  >
    <div className={`h-96 ${isNeXTSTEP ? 'bg-[#1A1A1A]' : 'bg-gray-50'} flex items-center justify-center`}>
      <p className={`text-sm ${mutedColor}`}>
        NotebookLayout will be embedded here (Plan 80-02)
      </p>
    </div>
  </div>
</div>
```

This creates:
- A collapsed header bar (h-8, 32px) that's always visible
- BookOpen icon + "Notebook" label + pane indicator
- Chevron toggle button (up when expanded, down when collapsed)
- Expandable content area with smooth 300ms animation (using inline styles, not Tailwind arbitrary values)
- Placeholder content for Plan 02 to replace with actual NotebookLayout
  </action>
  <verify>
Run `npm run dev` and open localhost:5173.
1. Verify collapsed Notebook header appears below Command Bar
2. Click the header - panel should expand with smooth animation
3. Click again - panel should collapse with smooth animation
4. Refresh page - panel state should persist (collapsed by default on first visit)
5. Verify theme colors work (add ?theme=NeXTSTEP or toggle in UI if available)
  </verify>
  <done>
Collapsible Notebook panel skeleton renders below Command Bar with:
- Collapsed header showing BookOpen icon, "Notebook" label, and pane count
- Expand/collapse toggle with chevron indicator
- Smooth 300ms animation on expand/collapse (using inline styles)
- State persisted to localStorage (collapsed by default)
- Theme-aware styling for both NeXTSTEP and Modern themes
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. `npm run dev` starts without console errors
3. Notebook panel header visible below Command Bar
4. Click toggle expands/collapses with smooth animation
5. Refresh preserves expand/collapse state
6. No "useNotebook must be used within NotebookProvider" errors in:
   - Default route (localhost:5173)
   - Integrated route (localhost:5173/?test=integrated)
7. NotebookContext is accessible (temporary console.log test in Task 1 verification)
</verification>

<success_criteria>
- NotebookProvider wraps IntegratedLayout in BOTH App.tsx routes (default and ?test=integrated)
- Collapsible panel skeleton renders below Command Bar
- Panel defaults to collapsed state
- Expand/collapse animation is smooth (300ms) using inline styles
- Panel state persists across page refresh via localStorage
- Collapsed header shows BookOpen icon, "Notebook" label, and chevron
- Theme-aware colors applied (NeXTSTEP dark / Modern light)
- useNotebook() hook works in IntegratedLayout (NotebookContext available)
</success_criteria>

<output>
After completion, create `.planning/phases/80-notebook-integration/80-01-SUMMARY.md`
</output>
