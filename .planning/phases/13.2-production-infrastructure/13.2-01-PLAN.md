---
phase: 13.2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  "native/Isometry.xcodeproj/project.pbxproj",
  "native/Configurations/Production.xcconfig",
  "native/Sources/Isometry/CloudKit/ProductionCloudKitConfig.swift",
  "native/Scripts/deploy-cloudkit-schema.sh",
  "scripts/setup-production-certificates.sh",
  "native/Sources/Isometry/Monitoring/ProductionMonitoringDashboard.swift",
  ".planning/STATE.md"
]
autonomous: false
user_setup:
  - service: apple-developer
    why: "Production certificate and provisioning profile setup"
    env_vars:
      - name: APPLE_DEVELOPER_TEAM_ID
        source: "Apple Developer Account -> Membership -> Team ID"
      - name: DISTRIBUTION_CERT_ID
        source: "Apple Developer Console -> Certificates, Identifiers & Profiles"
    dashboard_config:
      - task: "Create iOS Distribution Certificate"
        location: "Apple Developer Console -> Certificates -> iOS Distribution"
      - task: "Create macOS Developer ID Application Certificate"
        location: "Apple Developer Console -> Certificates -> macOS Developer ID"
      - task: "Create App Store Provisioning Profiles"
        location: "Apple Developer Console -> Profiles -> App Store"
  - service: cloudkit-production
    why: "CloudKit production container setup"
    dashboard_config:
      - task: "Enable CloudKit production environment"
        location: "CloudKit Console -> Production -> Enable"
      - task: "Deploy database schema to production"
        location: "CloudKit Console -> Schema -> Deploy to Production"
      - task: "Configure CloudKit subscriptions"
        location: "CloudKit Console -> Subscriptions -> Production Setup"

must_haves:
  truths:
    - "Production iOS app can be distributed through App Store"
    - "Production macOS app can be notarized and distributed"
    - "CloudKit production environment accepts real user data"
    - "Production monitoring provides real-time insights"
    - "Certificate signing works in automated build pipeline"
    - "Production environment performs within established benchmarks"
  artifacts:
    - path: "native/Configurations/Production.xcconfig"
      provides: "Production build configuration"
      min_lines: 25
    - path: "native/Sources/Isometry/CloudKit/ProductionCloudKitConfig.swift"
      provides: "CloudKit production environment setup"
      exports: ["ProductionCloudKitManager", "ProductionSchemaValidator"]
    - path: "scripts/setup-production-certificates.sh"
      provides: "Automated certificate and profile setup"
      min_lines: 50
    - path: "native/Sources/Isometry/Monitoring/ProductionMonitoringDashboard.swift"
      provides: "Real-time production monitoring"
      exports: ["ProductionMetricsCollector", "AlertingSystem"]
  key_links:
    - from: "native/Isometry.xcodeproj/project.pbxproj"
      to: "Production.xcconfig"
      via: "build configuration reference"
      pattern: "Production.*xcconfig"
    - from: "ProductionCloudKitConfig.swift"
      to: "CloudKit production database"
      via: "CKContainer production environment"
      pattern: "CKContainer.*production"
    - from: "ProductionMonitoringDashboard.swift"
      to: "CloudKit performance metrics"
      via: "telemetry collection"
      pattern: "CloudKitMetrics.*collect"
---

<objective>
Deploy production CloudKit environment and distribution infrastructure to enable App Store submission and production deployment.

Purpose: Establish enterprise-grade production infrastructure that transforms Phase 13.1's App Store preparation foundation into operational deployment capability with real-time monitoring and automated distribution.

Output: Complete production infrastructure including CloudKit production environment, distribution certificates, automated deployment pipeline, and real-time monitoring systems ready for App Store submission.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/milestones/v3.0-production-deployment/REQUIREMENTS.md
@.planning/milestones/v3.0-production-deployment/phases/13-01-SUMMARY.md

# CloudKit and iOS Development Context
@native/Sources/Isometry/CloudKit/CloudKitSyncManager.swift
@native/Sources/Isometry/Database/IsometryDatabase.swift
@native/Isometry.xcodeproj/project.pbxproj
</context>

<tasks>

<task type="auto">
  <name>Task 1: Production Build Configuration & Certificate Setup</name>
  <files>
    native/Configurations/Production.xcconfig
    native/Isometry.xcodeproj/project.pbxproj
    scripts/setup-production-certificates.sh
  </files>
  <action>
    Create comprehensive production build configuration implementing enterprise-grade distribution infrastructure:

    **Production.xcconfig Configuration:**
    - Code signing configuration for iOS Distribution and macOS Developer ID Application certificates
    - Production CloudKit container identifier and environment settings
    - App Store distribution build settings with optimization flags
    - Notarization requirements for macOS with hardened runtime
    - Production bundle identifiers and versioning scheme
    - Security entitlements for production CloudKit and App Sandbox

    **Certificate Setup Automation (scripts/setup-production-certificates.sh):**
    - Apple Developer portal authentication and team validation
    - Automated iOS Distribution certificate download and installation
    - macOS Developer ID Application certificate setup
    - App Store provisioning profile creation and management
    - Keychain integration for automated signing in CI/CD
    - Certificate expiration monitoring and renewal alerting

    **Xcode Project Integration:**
    - Production build configuration integration in project.pbxproj
    - Automatic code signing configuration for distribution schemes
    - Build phases for automated notarization and upload
    - Archive and export options for App Store distribution

    Use existing CloudKitSyncManager.swift patterns for production environment detection. Ensure script is executable and includes comprehensive error handling with rollback procedures.
  </action>
  <verify>
    chmod +x scripts/setup-production-certificates.sh && ./scripts/setup-production-certificates.sh --dry-run
    grep -q "Production" native/Configurations/Production.xcconfig
    grep -q "DEVELOPMENT_TEAM" native/Configurations/Production.xcconfig
  </verify>
  <done>Production build configuration enables App Store distribution with automated certificate management and Xcode project correctly references Production.xcconfig for distribution builds</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Complete Apple Developer Account Production Setup</action>
  <instructions>
    **Apple Developer Console Setup (Required for Certificate Generation):**

    1. **Navigate to Apple Developer Console:**
       - Visit: https://developer.apple.com/account
       - Sign in with Apple Developer account credentials
       - Verify Team ID matches project configuration

    2. **Create iOS Distribution Certificate:**
       - Go to: Certificates, Identifiers & Profiles -> Certificates
       - Click "+" to create new certificate
       - Select "iOS Distribution (App Store and Ad Hoc)"
       - Generate and upload Certificate Signing Request (CSR)
       - Download and install certificate in Keychain

    3. **Create macOS Developer ID Application Certificate:**
       - In Certificates section, create new certificate
       - Select "Developer ID Application"
       - Generate and upload CSR for macOS distribution
       - Download and install certificate for notarization

    4. **Create App Store Provisioning Profiles:**
       - Go to: Profiles section
       - Create "App Store" provisioning profile for iOS
       - Create "Mac App Store" provisioning profile for macOS
       - Link to appropriate bundle identifiers and distribution certificates
       - Download profiles for automated build integration

    5. **Record Credentials:**
       - Note Team ID for APPLE_DEVELOPER_TEAM_ID environment variable
       - Note certificate identifiers for automated signing configuration
       - Verify certificates appear in Keychain Access application
  </instructions>
  <resume-signal>Type "certificates-ready" when Apple Developer certificates and profiles are configured</resume-signal>
</task>

<task type="auto">
  <name>Task 2: CloudKit Production Environment Configuration</name>
  <files>
    native/Sources/Isometry/CloudKit/ProductionCloudKitConfig.swift
    native/Scripts/deploy-cloudkit-schema.sh
  </files>
  <action>
    Implement comprehensive CloudKit production environment with enterprise-grade configuration and schema deployment:

    **ProductionCloudKitConfig.swift Implementation:**
    - Production CKContainer configuration with proper environment detection
    - ProductionCloudKitManager class extending existing CloudKitSyncManager patterns
    - Production database schema validation and migration procedures
    - Enhanced error handling and retry logic for production reliability
    - CloudKit subscription management for real-time sync notifications
    - Production-grade logging and telemetry collection
    - Performance monitoring for CloudKit operations (sync latency, throughput)
    - Data integrity validation and conflict resolution for production data

    **CloudKit Schema Deployment Script (native/Scripts/deploy-cloudkit-schema.sh):**
    - CloudKit Console API integration for automated schema deployment
    - Development-to-production schema migration validation
    - Record type and field validation before deployment
    - Index and subscription configuration deployment
    - Schema versioning and rollback procedures
    - Production readiness validation checks
    - Automated CloudKit quota and usage monitoring setup

    Reference existing CloudKitSyncManager.swift architecture for consistency. Implement actor-based concurrency patterns matching existing IsometryDatabase.swift design. Use comprehensive error handling and recovery procedures.
  </action>
  <verify>
    swift build --target Isometry && echo "Build successful"
    grep -q "ProductionCloudKitManager" native/Sources/Isometry/CloudKit/ProductionCloudKitConfig.swift
    chmod +x native/Scripts/deploy-cloudkit-schema.sh
    ./native/Scripts/deploy-cloudkit-schema.sh --validate
  </verify>
  <done>CloudKit production environment configured with automated schema deployment and ProductionCloudKitManager provides enterprise-grade production data management</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>CloudKit Production Environment Activation</action>
  <instructions>
    **CloudKit Console Production Setup:**

    1. **Access CloudKit Console:**
       - Visit: https://icloud.developer.apple.com/
       - Sign in with Apple Developer account
       - Select Isometry app container

    2. **Enable Production Environment:**
       - Navigate to Production tab in CloudKit Console
       - Click "Enable Production" if not already enabled
       - Review and accept production environment terms

    3. **Deploy Database Schema:**
       - In Schema section, review current development schema
       - Validate all record types, fields, and indexes
       - Click "Deploy Schema Changes to Production"
       - Confirm schema deployment (irreversible action)
       - Wait for deployment completion (can take several minutes)

    4. **Configure Production Subscriptions:**
       - Navigate to Subscriptions section
       - Deploy development subscriptions to production environment
       - Verify subscription queries and notification endpoints
       - Test subscription notifications in production environment

    5. **Production Environment Validation:**
       - Create test records in production environment
       - Verify CloudKit Dashboard shows production data
       - Test sync operations between development and production
       - Confirm production quotas and usage limits
  </instructions>
  <resume-signal>Type "cloudkit-production-ready" when CloudKit production environment is active and schema deployed</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Production Monitoring & Analytics Implementation</name>
  <files>
    native/Sources/Isometry/Monitoring/ProductionMonitoringDashboard.swift
    native/Sources/Isometry/Analytics/ProductionAnalytics.swift
  </files>
  <action>
    Create comprehensive production monitoring and analytics system providing real-time insights into app performance and user engagement:

    **ProductionMonitoringDashboard.swift Implementation:**
    - Real-time performance metrics collection (app launch, UI responsiveness, memory usage)
    - CloudKit operation monitoring (sync latency, conflict resolution, error rates)
    - User engagement analytics (session duration, feature usage, retention metrics)
    - Crash reporting and error tracking integration with structured logging
    - Production health scoring and alerting system (SLA compliance monitoring)
    - Custom telemetry for PAFV+LATCH+GRAPH operations (query performance, visualization rendering)
    - Battery and network usage monitoring for optimization insights

    **ProductionAnalytics.swift Implementation:**
    - Privacy-compliant user analytics with opt-in consent management
    - Feature usage tracking and funnel analysis for core workflows
    - Performance benchmarking against Phase 13.1 established targets
    - A/B testing framework for feature rollouts and optimization
    - User feedback collection and categorization system
    - Export analytics for stakeholder reporting and business intelligence

    Implement using existing PerformanceMonitor patterns from Phase 10. Use actor-based design for thread safety. Include comprehensive privacy controls and GDPR compliance following Phase 13.1 privacy framework. Ensure analytics collection is opt-in and transparent to users.
  </action>
  <verify>
    swift build --target Isometry && echo "Monitoring build successful"
    grep -q "ProductionMetricsCollector" native/Sources/Isometry/Monitoring/ProductionMonitoringDashboard.swift
    grep -q "PrivacyCompliantAnalytics" native/Sources/Isometry/Analytics/ProductionAnalytics.swift
  </verify>
  <done>Production monitoring provides real-time performance insights and privacy-compliant analytics system enables data-driven optimization</done>
</task>

<task type="auto">
  <name>Task 4: Automated Distribution Pipeline Integration</name>
  <files>
    scripts/build-and-upload-appstore.sh
    native/Scripts/validate-production-build.sh
    .github/workflows/app-store-deployment.yml
  </files>
  <action>
    Create automated distribution pipeline for App Store submission with comprehensive validation and quality assurance:

    **App Store Upload Automation (scripts/build-and-upload-appstore.sh):**
    - Automated Xcode archive creation with production configuration
    - Code signing validation and certificate verification
    - App Store Connect API integration for automated upload
    - Build validation and App Store compliance checking
    - Automated TestFlight beta distribution for internal testing
    - Release notes generation and metadata synchronization
    - Upload progress monitoring and error handling with retry logic

    **Production Build Validation (native/Scripts/validate-production-build.sh):**
    - Comprehensive build artifact validation (binary size, symbol stripping, optimization)
    - Code signing verification and entitlements validation
    - CloudKit production connectivity testing and schema validation
    - Performance regression testing against established benchmarks
    - Security audit integration using Phase 13.1 ProductionSecurityValidator
    - App Store submission readiness checklist automation

    **CI/CD Integration (.github/workflows/app-store-deployment.yml):**
    - Automated trigger on release tags following semantic versioning
    - Production environment variable management and secret handling
    - Parallel build pipeline for iOS and macOS targets
    - Integration testing with CloudKit production environment
    - Automated App Store Connect upload and TestFlight distribution
    - Slack/notification integration for deployment status updates

    Use existing asset deployment patterns from Phase 13.1. Ensure all scripts are executable with comprehensive error handling and logging.
  </action>
  <verify>
    chmod +x scripts/build-and-upload-appstore.sh
    chmod +x native/Scripts/validate-production-build.sh
    ./native/Scripts/validate-production-build.sh --check
    grep -q "app-store-upload" .github/workflows/app-store-deployment.yml
  </verify>
  <done>Automated distribution pipeline enables one-click App Store submission with comprehensive validation and CI/CD integration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete production infrastructure including CloudKit production environment, distribution certificates, automated deployment pipeline, and real-time monitoring systems</what-built>
  <how-to-verify>
    **Production Infrastructure Validation:**

    1. **Certificate and Provisioning Verification:**
       - Open Keychain Access and verify iOS Distribution and macOS Developer ID certificates are installed
       - In Xcode, open Isometry project and verify Production build configuration is available
       - Select Product -> Archive to test production build (should succeed without errors)
       - Verify code signing works automatically with production certificates

    2. **CloudKit Production Environment Testing:**
       - Run the app with production configuration
       - Create test data and verify it syncs to CloudKit production environment
       - Check CloudKit Console Production dashboard for data and metrics
       - Test cross-device sync with production CloudKit environment

    3. **Monitoring and Analytics Validation:**
       - Launch app and verify ProductionMonitoringDashboard collects metrics
       - Check console logs for performance analytics and telemetry
       - Verify privacy-compliant analytics with opt-in functionality
       - Test crash reporting and error tracking systems

    4. **Automated Pipeline Testing:**
       - Run `scripts/build-and-upload-appstore.sh --dry-run` to test upload pipeline
       - Verify `native/Scripts/validate-production-build.sh` passes all checks
       - Test CI/CD workflow triggers and build validation steps
       - Confirm all scripts execute without errors and provide clear status output

    **Expected Results:**
    - Production build successfully creates signed archive ready for App Store submission
    - CloudKit production environment handles real data with proper sync and monitoring
    - Monitoring dashboard shows real-time performance metrics and analytics
    - Automated pipeline validates build quality and prepares for App Store upload
  </how-to-verify>
  <resume-signal>Type "production-infrastructure-verified" if all validation steps pass, or describe specific issues for resolution</resume-signal>
</task>

</tasks>

<verification>
**Overall Phase Validation:**

1. **Production Certificates Operational:** iOS Distribution and macOS Developer ID certificates installed and functional
2. **CloudKit Production Ready:** Production environment active with deployed schema and real data handling
3. **Monitoring Systems Active:** Real-time performance monitoring and privacy-compliant analytics operational
4. **Distribution Pipeline Functional:** Automated build, validation, and upload pipeline ready for App Store submission
5. **Integration Quality:** All systems work together providing comprehensive production deployment capability

Run comprehensive verification: `./scripts/validate-phase-13-2-completion.sh`
</verification>

<success_criteria>
**Phase 13.2 Success Metrics:**

1. **Distribution Infrastructure Ready:** Production certificates and provisioning profiles enable App Store distribution
2. **CloudKit Production Operational:** Production environment handles real user data with <100ms sync latency
3. **Monitoring Excellence:** Real-time performance insights with 99.9% uptime monitoring coverage
4. **Automated Quality Assurance:** Distribution pipeline validates 100% of builds before App Store submission
5. **Enterprise Production Standards:** All infrastructure meets or exceeds established performance benchmarks
6. **App Store Submission Ready:** Complete infrastructure enables immediate App Store submission following TestFlight validation

Target: All production infrastructure operational within 4 days, enabling progression to Phase 13.3 Beta Testing & Quality Validation with enterprise-grade deployment capability.
</success_criteria>

<output>
After completion, create `.planning/milestones/v3.0-production-deployment/phases/13-02-SUMMARY.md`
</output>