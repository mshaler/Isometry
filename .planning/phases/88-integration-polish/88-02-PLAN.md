---
phase: 88-integration-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/claude-code/__tests__/cross-tab-integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Terminal output buffer is accessible from Claude AI context"
    - "GSD state updates reach terminal integration hook"
    - "WebSocket messages route correctly regardless of active tab"
  artifacts:
    - path: "src/services/claude-code/__tests__/cross-tab-integration.test.ts"
      provides: "Cross-tab data flow tests"
      contains: "terminal.*claude|gsd.*terminal"
  key_links:
    - from: "cross-tab-integration.test.ts"
      to: "ClaudeCodeServer"
      via: "WebSocket message routing verification"
      pattern: "messageRouter|dispatch"
---

<objective>
Verify cross-tab data flow for success criteria 2 and 3: terminal output accessibility and GSD trigger correctness.

Purpose: Confirm that data flows correctly between tabs even though they run independent state. This validates the existing integration hooks without building new features.

Output: Test file proving terminal output is accessible and GSD commands trigger correctly from terminal context.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/88-integration-polish/88-RESEARCH.md
@src/hooks/useGSDTerminalIntegration.ts
@src/services/claude-code/ClaudeCodeServer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cross-tab data flow tests</name>
  <files>src/services/claude-code/__tests__/cross-tab-integration.test.ts</files>
  <action>
Create tests verifying data flows correctly between Shell tabs.

**Terminal → Claude AI data flow:**
1. Test that terminal output buffer is readable (not just internal state)
2. Test that terminal output can be passed to a save function (mock the save, verify data reaches it)
3. Verify output buffer retains last N lines for context sharing

**GSD ↔ Terminal data flow:**
4. Test useGSDTerminalIntegration.processTerminalOutput correctly parses phase info
5. Test GSD state updates when terminal output contains GSD patterns (e.g., "Phase 88 Plan 01")
6. Test GSD session state accessible from terminal context

**WebSocket routing:**
7. Test messageRouter dispatches to correct handler regardless of active tab
8. Test gsd_file_update messages reach GSD hooks even when Terminal tab is active

Mock setup:
- Mock WebSocket with send/receive vi.fn()
- Mock output buffer with predictable content
- Use claudeCodeParser from existing implementation

Verify with `npm run test -- cross-tab-integration.test`.
  </action>
  <verify>npm run test -- cross-tab-integration.test --run</verify>
  <done>8 test cases pass covering Terminal→Claude and GSD↔Terminal data flows</done>
</task>

<task type="auto">
  <name>Task 2: Verify GSD command trigger flow</name>
  <files>src/services/claude-code/__tests__/cross-tab-integration.test.ts</files>
  <action>
Add tests to the same file verifying GSD phase execution triggers correctly.

**GSD trigger tests:**
1. Terminal output containing "/gsd:new-milestone" triggers GSD service (if pattern detection exists)
2. Terminal output with phase markers updates GSD progress display
3. GSD phase completion events reach terminal integration hook
4. useGSDTerminalIntegration.onStateUpdate callback fires with correct phase/status

Note: If pattern detection doesn't exist for /gsd: commands, document this as expected behavior - the success criteria may be about GSD file changes triggering terminal output updates, not terminal input triggering GSD.

Review useGSDTerminalIntegration.ts to understand actual trigger mechanism before writing tests.
  </action>
  <verify>npm run test -- cross-tab-integration.test --run</verify>
  <done>4+ additional test cases verify GSD trigger flow (or document expected behavior if triggers are reverse direction)</done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Run: `npm run test -- cross-tab-integration.test --run`
2. Verify 12+ test cases pass
3. Confirm tests document actual behavior, not imagined features
</verification>

<success_criteria>
- [ ] cross-tab-integration.test.ts exists with 12+ passing tests
- [ ] Terminal output accessibility is verified
- [ ] GSD trigger mechanism is documented (forward or reverse direction)
- [ ] WebSocket message routing verified
- [ ] `npm run typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/88-integration-polish/88-02-SUMMARY.md`
</output>
