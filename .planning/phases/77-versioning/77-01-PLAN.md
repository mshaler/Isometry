---
phase: 77-versioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema.sql
  - src/db/init.ts
  - src/hooks/database/useDatabaseService.ts
autonomous: true

must_haves:
  truths:
    - "UPDATE on nodes table increments version column automatically"
    - "Version starts at 1 for new nodes"
    - "Version increments even for position-only updates"
    - "Manual version setting is respected (trigger doesn't override)"
  artifacts:
    - path: "src/db/schema.sql"
      provides: "Version increment trigger"
      exports: ["increment_version_on_update trigger"]
  key_links:
    - from: "trigger"
      to: "nodes table"
      via: "AFTER UPDATE"
      pattern: "UPDATE nodes SET version"
---

<objective>
Add SQL trigger to automatically increment node version on any UPDATE.

Purpose: Ensure version tracking works automatically for all update paths without requiring manual intervention in each update function.

Output: Trigger in schema.sql, verified by tests.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Add version increment trigger to schema</name>
  <files>src/db/schema.sql</files>
  <action>
Add trigger after nodes table definition:

```sql
-- Version increment trigger
-- Automatically increments version on any UPDATE to nodes table
CREATE TRIGGER IF NOT EXISTS increment_version_on_update
AFTER UPDATE ON nodes
FOR EACH ROW
WHEN NEW.version = OLD.version  -- Only increment if version wasn't manually changed
BEGIN
    UPDATE nodes SET version = OLD.version + 1 WHERE id = NEW.id;
END;
```

Place after FTS5 triggers section.
  </action>
  <verify>Schema file contains trigger definition</verify>
  <done>Trigger defined in schema.sql</done>
</task>

<task type="auto">
  <name>Task 2: Verify trigger executes on database init</name>
  <files>src/db/init.ts</files>
  <action>
The schema.sql is loaded via initializeDatabase(). Verify:
1. CREATE TRIGGER IF NOT EXISTS syntax works with sql.js
2. Trigger is created when database initializes
3. No errors on repeated initialization

If sql.js doesn't support triggers, fall back to:
- Add version increment to execute() wrapper for UPDATE queries
- Or add explicit version bump to useDatabaseService update functions
  </action>
  <verify>Database initializes without errors, trigger exists</verify>
  <done>Trigger created on init</done>
</task>

<task type="auto">
  <name>Task 3: Write version increment test</name>
  <files>src/db/__tests__/version-increment.test.ts</files>
  <action>
Create test file:

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { initializeDatabase } from '../init';

describe('Version Increment', () => {
  let db: any;

  beforeEach(async () => {
    db = await initializeDatabase();
  });

  it('starts nodes at version 1', () => {
    db.run(`INSERT INTO nodes (id, name, created_at, modified_at) 
            VALUES ('test-1', 'Test', datetime('now'), datetime('now'))`);
    const result = db.exec(`SELECT version FROM nodes WHERE id = 'test-1'`);
    expect(result[0].values[0][0]).toBe(1);
  });

  it('increments version on update', () => {
    db.run(`INSERT INTO nodes (id, name, created_at, modified_at) 
            VALUES ('test-2', 'Test', datetime('now'), datetime('now'))`);
    
    // Update the node
    db.run(`UPDATE nodes SET name = 'Updated' WHERE id = 'test-2'`);
    
    const result = db.exec(`SELECT version FROM nodes WHERE id = 'test-2'`);
    expect(result[0].values[0][0]).toBe(2);
  });

  it('increments version on position update', () => {
    db.run(`INSERT INTO nodes (id, name, created_at, modified_at) 
            VALUES ('test-3', 'Test', datetime('now'), datetime('now'))`);
    
    // Update position
    db.run(`UPDATE nodes SET grid_x = 100, grid_y = 200 WHERE id = 'test-3'`);
    
    const result = db.exec(`SELECT version FROM nodes WHERE id = 'test-3'`);
    expect(result[0].values[0][0]).toBe(2);
  });

  it('respects manually set version', () => {
    db.run(`INSERT INTO nodes (id, name, created_at, modified_at) 
            VALUES ('test-4', 'Test', datetime('now'), datetime('now'))`);
    
    // Manually set version higher
    db.run(`UPDATE nodes SET name = 'Updated', version = 10 WHERE id = 'test-4'`);
    
    const result = db.exec(`SELECT version FROM nodes WHERE id = 'test-4'`);
    expect(result[0].values[0][0]).toBe(10); // Not 2
  });
});
```
  </action>
  <verify>npm run test -- version-increment passes</verify>
  <done>Tests verify version increment behavior</done>
</task>

</tasks>

<verification>
1. Schema contains CREATE TRIGGER increment_version_on_update
2. Database initializes without errors
3. Test confirms version increments on UPDATE
4. Test confirms manual version setting is respected
</verification>

<success_criteria>
- VER-01 satisfied: UPDATE queries increment version automatically
- Trigger uses WHEN clause to respect manual version changes
- All existing update paths work without modification
</success_criteria>
