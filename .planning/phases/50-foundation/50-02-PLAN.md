---
phase: 50-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/data/usePropertyClassification.ts
  - src/hooks/data/__tests__/usePropertyClassification.test.ts
autonomous: true

must_haves:
  truths:
    - "usePropertyClassification hook provides cached, refreshable access to classification"
    - "Hook returns classification after database initialization completes"
    - "Hook caches results and returns cached data on subsequent calls"
    - "Hook provides refresh() function that invalidates cache and reloads"
    - "Hook tracks dataVersion and invalidates cache when data changes"
  artifacts:
    - path: "src/hooks/data/usePropertyClassification.ts"
      provides: "React hook with caching and refresh"
      exports: ["usePropertyClassification", "UsePropertyClassificationResult"]
      contains: "cacheRef"
    - path: "src/hooks/data/__tests__/usePropertyClassification.test.ts"
      provides: "Hook behavior tests"
      contains: "caches results across re-renders"
  key_links:
    - from: "src/hooks/data/usePropertyClassification.ts"
      to: "src/db/SQLiteProvider.tsx"
      via: "dataVersion for cache invalidation"
      pattern: "dataVersion"
    - from: "src/hooks/data/usePropertyClassification.ts"
      to: "cacheRef.current"
      via: "useRef for caching"
      pattern: "cacheRef\\.current"
---

<objective>
Validate usePropertyClassification hook caching and refresh behavior against FOUND-03 requirement.

Purpose: FOUND-03 requires the hook to provide "React-friendly access with caching and refresh". This plan validates the existing caching implementation and adds tests specifically for the dataVersion-based cache invalidation pattern.

Output: Hook caching validated with explicit tests for cache behavior, dataVersion tracking, and refresh functionality.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-foundation/50-RESEARCH.md

# Existing implementation
@src/hooks/data/usePropertyClassification.ts
@src/hooks/data/__tests__/usePropertyClassification.test.ts
@src/db/SQLiteProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dataVersion cache invalidation tests</name>
  <files>src/hooks/data/__tests__/usePropertyClassification.test.ts</files>
  <action>
Add tests that verify the dataVersion-based cache invalidation pattern. The hook should:
1. Return cached results when dataVersion hasn't changed
2. Reload data when dataVersion increments (simulating a database mutation)

Add new test cases:

```typescript
describe('cache invalidation with dataVersion', () => {
  test('[FOUND-03] uses cached result when dataVersion unchanged', async () => {
    const { result, rerender } = renderHook(() => usePropertyClassification());

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false);
    });

    const firstResult = result.current.classification;
    const callCountBefore = mockDb.exec.mock.calls.length;

    // Rerender without changing dataVersion
    rerender();

    // Should use cache, not call exec again
    expect(mockDb.exec.mock.calls.length).toBe(callCountBefore);
    expect(result.current.classification).toBe(firstResult);
  });

  test('[FOUND-03] reloads when dataVersion changes', async () => {
    const { result, rerender } = renderHook(() => usePropertyClassification());

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false);
    });

    const callCountBefore = mockDb.exec.mock.calls.length;

    // Simulate dataVersion change (database mutation)
    mockSQLiteContext.dataVersion = 2;
    rerender();

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false);
    });

    // Should have called exec again due to version change
    expect(mockDb.exec.mock.calls.length).toBeGreaterThan(callCountBefore);
  });
});
```

Ensure the mock setup allows dataVersion to be changed between renders.
  </action>
  <verify>
Run: `npm run test -- --run src/hooks/data/__tests__/usePropertyClassification.test.ts`
All tests pass including new dataVersion tests.
  </verify>
  <done>
Cache invalidation tests pass, demonstrating that:
1. Cached results are returned when dataVersion is unchanged
2. Data reloads when dataVersion increments
  </done>
</task>

<task type="auto">
  <name>Task 2: Add requirement traceability test for FOUND-03</name>
  <files>src/hooks/data/__tests__/usePropertyClassification.test.ts</files>
  <action>
Add an explicit requirement traceability test for FOUND-03:

```typescript
describe('Phase 50 Requirements Traceability', () => {
  test('[FOUND-03] provides cached, refreshable access to classification', async () => {
    const { result, rerender } = renderHook(() => usePropertyClassification());

    // Wait for initial load
    await waitFor(() => {
      expect(result.current.isLoading).toBe(false);
    });

    // Verify classification is returned
    expect(result.current.classification).not.toBeNull();

    // Verify refresh function exists
    expect(typeof result.current.refresh).toBe('function');

    // Verify caching works (rerender returns same object)
    const firstClassification = result.current.classification;
    rerender();
    expect(result.current.classification).toBe(firstClassification);

    // Verify refresh invalidates cache
    act(() => {
      result.current.refresh();
    });

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false);
    });

    // Classification should be fresh (may or may not be same reference depending on data)
    expect(result.current.classification).not.toBeNull();
  });
});
```

This provides explicit traceability from the test to FOUND-03 requirement.
  </action>
  <verify>
Run: `npm run test -- --run src/hooks/data/__tests__/usePropertyClassification.test.ts`
FOUND-03 requirement test passes.
  </verify>
  <done>
FOUND-03 has explicit test coverage verifying caching, refresh, and React-friendly access.
  </done>
</task>

</tasks>

<verification>
1. All hook tests pass: `npm run test -- --run src/hooks/data/__tests__/usePropertyClassification.test.ts`
2. Combined service + hook tests: `npm run test -- --run property-classifier usePropertyClassification`
3. No TypeScript errors: `npm run typecheck`
4. FOUND-03 requirement explicitly validated in tests
</verification>

<success_criteria>
- All hook tests pass (7+ tests with new additions)
- dataVersion cache invalidation behavior is tested
- FOUND-03 requirement has explicit traceability test
- Caching pattern validated: same-version returns cache, different-version reloads
- Refresh function validated: clears cache and reloads
</success_criteria>

<output>
After completion, create `.planning/phases/50-foundation/50-02-SUMMARY.md`
</output>
