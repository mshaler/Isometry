---
phase: 50-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/__tests__/property-classifier.test.ts
  - src/hooks/data/__tests__/usePropertyClassification.test.ts
autonomous: true

must_haves:
  truths:
    - "classifyProperties(db) returns PropertyClassification with correct LATCH+GRAPH buckets"
    - "GRAPH bucket contains exactly 4 edge types (LINK, NEST, SEQUENCE, AFFINITY) + 2 metrics (degree, weight)"
    - "Disabled facets (enabled=0) are excluded from classification"
    - "Sort order from facets table is respected within each bucket"
    - "All property classifier tests pass"
    - "All hook tests pass"
  artifacts:
    - path: "src/services/property-classifier.ts"
      provides: "Property classification service"
      exports: ["classifyProperties", "flattenClassification", "getPropertiesForBucket"]
      status: "exists"
    - path: "src/hooks/data/usePropertyClassification.ts"
      provides: "React hook for property classification"
      exports: ["usePropertyClassification"]
      status: "exists"
    - path: "src/services/__tests__/property-classifier.test.ts"
      provides: "Service test coverage"
      contains: "classifyProperties"
      status: "exists, all passing"
    - path: "src/hooks/data/__tests__/usePropertyClassification.test.ts"
      provides: "Hook test coverage"
      contains: "usePropertyClassification"
      status: "exists, needs mock fix"
  key_links:
    - from: "src/hooks/data/usePropertyClassification.ts"
      to: "src/services/property-classifier.ts"
      via: "import { classifyProperties }"
      pattern: "classifyProperties\\(db"
    - from: "src/hooks/data/usePropertyClassification.ts"
      to: "src/db/SQLiteProvider.tsx"
      via: "useSQLite hook"
      pattern: "useSQLite\\(\\)"
    - from: "src/services/property-classifier.ts"
      to: "facets table"
      via: "db.exec SQL query"
      pattern: "FROM facets"
---

<objective>
Validate and fix existing property classification implementation against Phase 50 requirements.

Purpose: The property classification service and hook already exist with comprehensive implementation. This plan ensures all tests pass and the implementation meets FOUND-01 through FOUND-05 requirements.

Output: All tests passing, implementation validated against requirements.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-foundation/50-RESEARCH.md

# Existing implementation files (already complete)
@src/services/property-classifier.ts
@src/hooks/data/usePropertyClassification.ts
@src/services/__tests__/property-classifier.test.ts
@src/hooks/data/__tests__/usePropertyClassification.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hook test mocks for complete coverage</name>
  <files>src/hooks/data/__tests__/usePropertyClassification.test.ts</files>
  <action>
The hook tests are failing because the mock doesn't properly simulate db.exec behavior. The implementation calls db.exec() directly via classifyProperties(db), but the mock provides an empty object for db.

Fix the mock setup to properly simulate the sql.js Database interface:

1. Change the db mock from `{}` to an object with an `exec` method that returns the mocked result
2. The mock should return the same structure as sql.js: `[{ columns: [...], values: [...] }]`
3. For the error test, make db.exec throw the expected error message

Current mock issue:
```typescript
const mockSQLiteContext = {
  db: {},  // This doesn't have .exec() method
  // ...
};
```

Fix to:
```typescript
const mockDb = {
  exec: vi.fn(),
};

const mockSQLiteContext = {
  db: mockDb,
  // ...
};
```

Then update mockExecute references to use mockDb.exec.

Do NOT modify the service or hook implementation - only fix the test mocks.
  </action>
  <verify>
Run: `npm run test -- --run src/hooks/data/__tests__/usePropertyClassification.test.ts`
All 5 tests should pass.
  </verify>
  <done>
All usePropertyClassification hook tests pass (5/5).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add requirement traceability tests</name>
  <files>src/services/__tests__/property-classifier.test.ts</files>
  <action>
Add explicit test annotations linking to Phase 50 requirements. The existing tests cover the requirements but lack explicit traceability.

Add a new describe block with requirement-tagged tests:

```typescript
describe('Phase 50 Requirements Traceability', () => {
  // FOUND-01: Property classification service reads facets table and buckets into L, A, T, C, H, GRAPH
  test('[FOUND-01] buckets properties into L, A, T, C, H, GRAPH from facets table', () => {
    const classification = classifyProperties(db);

    // All buckets exist
    expect(classification).toHaveProperty('L');
    expect(classification).toHaveProperty('A');
    expect(classification).toHaveProperty('T');
    expect(classification).toHaveProperty('C');
    expect(classification).toHaveProperty('H');
    expect(classification).toHaveProperty('GRAPH');

    // Properties come from facets table (verified by count matching expected)
    const totalLATCH = Object.values(classification).flat().filter(p => p.bucket !== 'GRAPH').length;
    expect(totalLATCH).toBe(9); // 9 default facets
  });

  // FOUND-02: GRAPH bucket contains 4 edge types + 2 computed metrics
  test('[FOUND-02] GRAPH contains 4 edge types and 2 metrics', () => {
    const classification = classifyProperties(db);

    const edgeTypes = classification.GRAPH.filter(p => p.isEdgeProperty);
    const metrics = classification.GRAPH.filter(p => !p.isEdgeProperty);

    expect(edgeTypes.map(e => e.name)).toEqual(['LINK', 'NEST', 'SEQUENCE', 'AFFINITY']);
    expect(metrics.map(m => m.name)).toEqual(['Degree', 'Weight']);
  });

  // FOUND-04: Disabled facets excluded
  test('[FOUND-04] excludes disabled facets', () => {
    db.run('UPDATE facets SET enabled = 0 WHERE id = ?', ['tags']);
    const classification = classifyProperties(db);

    const allIds = Object.values(classification).flat().map(p => p.id);
    expect(allIds).not.toContain('tags');
  });

  // FOUND-05: Sort order respected
  test('[FOUND-05] respects sort_order within buckets', () => {
    const classification = classifyProperties(db);

    // Verify Time bucket is sorted by sort_order
    const timeSortOrders = classification.T.map(p => p.sortOrder);
    expect(timeSortOrders).toEqual([0, 1, 2]); // created=0, modified=1, due=2
  });
});
```

Do NOT duplicate existing tests - these are explicit requirement validations that reference the existing implementation behavior.
  </action>
  <verify>
Run: `npm run test -- --run src/services/__tests__/property-classifier.test.ts`
All tests should pass including the new requirement traceability tests.
  </verify>
  <done>
Requirement traceability tests exist and pass: FOUND-01, FOUND-02, FOUND-04, FOUND-05 all have explicit test coverage.
  </done>
</task>

</tasks>

<verification>
1. Service tests: `npm run test -- --run src/services/__tests__/property-classifier.test.ts` - all pass
2. Hook tests: `npm run test -- --run src/hooks/data/__tests__/usePropertyClassification.test.ts` - all pass
3. Combined: `npm run test -- --run src/services/__tests__/property-classifier.test.ts src/hooks/data/__tests__/usePropertyClassification.test.ts` - all pass
4. TypeScript: `npm run typecheck` - no new errors introduced
</verification>

<success_criteria>
- All 7+ service tests pass
- All 5 hook tests pass
- Requirement traceability tests exist for FOUND-01, FOUND-02, FOUND-04, FOUND-05
- No TypeScript errors introduced
- Implementation validates against all Phase 50 requirements
</success_criteria>

<output>
After completion, create `.planning/phases/50-foundation/50-01-SUMMARY.md`
</output>
