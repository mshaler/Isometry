---
phase: 46-live-data-synchronization
plan: 03
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - src/hooks/sync/useSelectionSync.ts
  - src/hooks/sync/useScrollToCard.ts
  - src/hooks/sync/index.ts
  - src/state/SelectionContext.tsx
  - src/components/notebook/CaptureComponent.tsx
  - src/components/notebook/preview-tabs/NetworkGraphTab.tsx
autonomous: true

must_haves:
  truths:
    - "User clicks card in Preview and Capture scrolls to show it (SYNC-02)"
    - "User sees selection highlighted across all three canvases simultaneously (SYNC-03)"
    - "Selection in one canvas propagates to others via event bus"
  artifacts:
    - path: "src/hooks/sync/useSelectionSync.ts"
      provides: "Hook for cross-canvas selection synchronization"
      exports: ["useSelectionSync"]
      min_lines: 30
    - path: "src/hooks/sync/useScrollToCard.ts"
      provides: "Hook for scrolling to card in TipTap editor"
      exports: ["useScrollToCardInEditor"]
      min_lines: 25
  key_links:
    - from: "src/components/notebook/preview-tabs/NetworkGraphTab.tsx"
      to: "src/services/sync/event-bus.ts"
      via: "IsometryEventBus.dispatchSelectionChange on node click"
      pattern: "dispatchSelectionChange"
    - from: "src/components/notebook/CaptureComponent.tsx"
      to: "src/hooks/sync/useScrollToCard.ts"
      via: "useScrollToCardInEditor hook for Preview->Capture scroll"
      pattern: "useScrollToCardInEditor"
    - from: "src/hooks/sync/useSelectionSync.ts"
      to: "src/state/SelectionContext.tsx"
      via: "useSelection hook for shared selection state"
      pattern: "useSelection"
---

<objective>
Implement cross-canvas selection synchronization and bidirectional navigation between Preview and Capture.

Purpose: Enable SYNC-02 (click in Preview scrolls Capture) and SYNC-03 (selection highlighted across all canvases) for seamless cross-canvas interaction.

Output: useSelectionSync and useScrollToCardInEditor hooks, integrated with Preview tabs and CaptureComponent.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-live-data-synchronization/46-RESEARCH.md
@.planning/phases/46-live-data-synchronization/46-01-SUMMARY.md

# Source files to modify
@src/state/SelectionContext.tsx
@src/components/notebook/CaptureComponent.tsx
@src/components/notebook/preview-tabs/NetworkGraphTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create selection sync and scroll-to-card hooks</name>
  <files>
    src/hooks/sync/useSelectionSync.ts
    src/hooks/sync/useScrollToCard.ts
    src/hooks/sync/index.ts
  </files>
  <action>
Create hooks for cross-canvas selection synchronization and scroll-to-card navigation.

1. Create `src/hooks/sync/useSelectionSync.ts`:
   - Import `useEffect` from 'react'
   - Import `useSelection` from '@/state/SelectionContext'
   - Import `IsometryEventBus` from '@/services/sync'
   - Implement `useSelectionSync(source: 'capture' | 'preview' | 'shell')`:
     - Get `{ selection, select }` from useSelection()
     - First useEffect: Dispatch selection change when local selection changes
       - If `selection.lastSelectedId` exists, dispatch selection event with source
       - Dependencies: [selection.lastSelectedId, source]
     - Second useEffect: Listen for selection changes from other sources
       - Subscribe to `IsometryEventBus.onSelectionChange`
       - In handler, if `event.source !== source`, call `select(event.cardId)`
       - Return cleanup function
       - Dependencies: [source, select]
     - Return `selection` for component use

2. Create `src/hooks/sync/useScrollToCard.ts`:
   - Import `useEffect` from 'react'
   - Import `IsometryEventBus` from '@/services/sync'
   - Import `Editor` type from '@tiptap/react' (or use the hook's return type)
   - Implement `useScrollToCardInEditor(editor: Editor | null)`:
     - useEffect that:
       - Returns early if `!editor`
       - Subscribes to `IsometryEventBus.onSelectionChange`
       - In handler, only react to clicks from 'preview' source: `if (event.source !== 'preview') return`
       - Find card position in editor:
         ```typescript
         const { state } = editor;
         let cardPosition: number | null = null;

         state.doc.descendants((node, pos) => {
           // Check for node ID match (wiki links have cardId in attrs)
           if (node.attrs?.id === event.cardId ||
               node.attrs?.cardId === event.cardId ||
               node.attrs?.nodeId === event.cardId) {
             cardPosition = pos;
             return false; // Stop searching
           }
           return true;
         });
         ```
       - If cardPosition found, scroll to it:
         ```typescript
         if (cardPosition !== null) {
           editor
             .chain()
             .focus()
             .setTextSelection(cardPosition)
             .scrollIntoView()
             .run();
         }
         ```
       - Return cleanup function
     - Dependencies: [editor]

3. Update `src/hooks/sync/index.ts`:
   - Add exports:
     ```typescript
     export { useSelectionSync } from './useSelectionSync';
     export { useScrollToCardInEditor } from './useScrollToCard';
     ```

IMPORTANT: The editor.chain().focus().setTextSelection().scrollIntoView().run() pattern
is the TipTap way to scroll to a position. The editor must be truthy before calling.
  </action>
  <verify>
    - `npm run typecheck` passes
    - Hooks can be imported: `import { useSelectionSync, useScrollToCardInEditor } from '@/hooks/sync'`
    - No lint errors
  </verify>
  <done>
    - useSelectionSync hook synchronizes selection across canvases
    - useScrollToCardInEditor hook scrolls TipTap to selected card
    - Proper cleanup of event listeners
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate selection sync into Preview tabs</name>
  <files>
    src/components/notebook/preview-tabs/NetworkGraphTab.tsx
  </files>
  <action>
Add selection sync to NetworkGraphTab so clicking a node dispatches selection event.

Modify `src/components/notebook/preview-tabs/NetworkGraphTab.tsx`:

1. Add import: `import { IsometryEventBus } from '@/services/sync'`

2. Modify the `handleNodeClick` callback to dispatch selection event:
   ```typescript
   const handleNodeClick = useCallback((nodeId: string) => {
     // Toggle selection
     const newSelection = selectedNodeId === nodeId ? null : nodeId;
     setSelectedNodeId(newSelection);

     // Dispatch selection event for cross-canvas sync
     if (newSelection) {
       IsometryEventBus.dispatchSelectionChange({
         cardId: newSelection,
         source: 'preview',
       });
     }

     // Call external callback if provided
     if (onNodeSelect && newSelection) {
       onNodeSelect(newSelection);
     }
   }, [selectedNodeId, setSelectedNodeId, onNodeSelect]);
   ```

3. Add listener for incoming selection changes (from Capture):
   - Add import: `import { useEffect } from 'react'` (if not already imported)
   - Add useEffect after existing hooks:
     ```typescript
     // Listen for selection changes from other canvases
     useEffect(() => {
       const unsubscribe = IsometryEventBus.onSelectionChange((event) => {
         // Only react to selections from other sources
         if (event.source === 'preview') return;

         // Update local selection to match
         setSelectedNodeId(event.cardId);
       });

       return unsubscribe;
     }, [setSelectedNodeId]);
     ```

Note: The same pattern should be applied to TimelineTab if it supports selection,
but NetworkGraphTab is the primary interaction point for GRAPH visualization.
  </action>
  <verify>
    - `npm run typecheck` passes
    - No lint errors
  </verify>
  <done>
    - NetworkGraphTab dispatches selection events on node click
    - NetworkGraphTab listens for selection changes from other canvases
    - Selection is synchronized bidirectionally
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate scroll-to-card into CaptureComponent</name>
  <files>
    src/components/notebook/CaptureComponent.tsx
  </files>
  <action>
Add scroll-to-card functionality to CaptureComponent so clicking a card in Preview scrolls the editor.

Modify `src/components/notebook/CaptureComponent.tsx`:

1. Add import: `import { useScrollToCardInEditor } from '@/hooks/sync'`

2. After the `useTipTapEditor` hook call, add the scroll-to-card hook:
   ```typescript
   const {
     editor,
     isDirty,
     isSaving,
     saveNow,
     activeCard
   } = useTipTapEditor({
     autoSaveDelay: 2000,
     enableAutoSave: true
   });

   // Enable scroll-to-card when selection changes in Preview
   useScrollToCardInEditor(editor);
   ```

3. That's it! The hook will:
   - Listen for selection changes from Preview
   - Find the corresponding card/node in the TipTap document
   - Scroll the editor to show it

IMPORTANT: The hook handles the case where editor is null gracefully.
The scroll will only work if the selected card exists in the current document.
For now, this provides the foundation - if no match found, nothing happens (no error).
  </action>
  <verify>
    - `npm run typecheck` passes
    - `npm run dev` starts without errors
    - Manual test: Click node in Network Graph, verify Capture scrolls (if card content exists)
  </verify>
  <done>
    - CaptureComponent scrolls to card when selection changes in Preview
    - SYNC-02 requirement satisfied: Click in Preview, Capture scrolls to show it
    - SYNC-03 requirement partially satisfied: Selection propagates via event bus
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm run typecheck` - must pass
2. Run `npm run dev`
3. Manual integration tests:
   - **SYNC-02 test**: Open app, view Network Graph in Preview, click a node.
     Verify the Capture editor attempts to scroll to related content.
   - **SYNC-03 test**: Select a card in Capture (if applicable), verify Network Graph
     highlights the corresponding node.
4. Check browser console for any errors during selection events
</verification>

<success_criteria>
- useSelectionSync hook provides cross-canvas selection synchronization
- useScrollToCardInEditor hook scrolls TipTap editor on Preview selection
- NetworkGraphTab dispatches and receives selection events
- CaptureComponent scrolls to card when selected in Preview
- No memory leaks (event listeners cleaned up)
- No TypeScript errors
- SYNC-02: User clicks card in Preview and Capture scrolls to show it
- SYNC-03: User sees selection highlighted across all three canvases
</success_criteria>

<output>
After completion, create `.planning/phases/46-live-data-synchronization/46-03-SUMMARY.md`
</output>
