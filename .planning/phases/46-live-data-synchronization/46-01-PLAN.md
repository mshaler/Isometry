---
phase: 46-live-data-synchronization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/visualization/useForceGraph.ts
  - src/hooks/data/useTimeline.ts
  - src/hooks/data/useDataInspector.ts
autonomous: true

must_haves:
  truths:
    - "User sees Preview auto-refresh when Capture saves a card (SYNC-01)"
    - "NetworkGraphTab re-queries when nodes/edges change in database"
    - "TimelineTab re-queries when nodes change in database"
    - "DataInspectorTab shows latest data without manual refresh"
  artifacts:
    - path: "src/hooks/visualization/useForceGraph.ts"
      provides: "Force graph hook with dataVersion-driven refresh"
      contains: "useSQLiteQuery"
    - path: "src/hooks/data/useTimeline.ts"
      provides: "Timeline hook with auto-refresh on data change"
      contains: "useSQLiteQuery"
  key_links:
    - from: "src/hooks/visualization/useForceGraph.ts"
      to: "src/hooks/database/useSQLiteQuery.ts"
      via: "dataVersion dependency propagation"
      pattern: "useSQLiteQuery"
    - from: "src/hooks/data/useTimeline.ts"
      to: "src/hooks/database/useSQLiteQuery.ts"
      via: "dataVersion dependency propagation"
      pattern: "useSQLiteQuery"
---

<objective>
Verify and document the existing dataVersion-driven auto-refresh architecture for SYNC-01.

Purpose: The research confirmed that useSQLiteQuery already includes dataVersion in its dependency array. This plan verifies the auto-refresh chain works end-to-end and documents the architecture for maintainability.

Output: Verified auto-refresh flow from Capture save to Preview re-render, with any necessary fixes.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-live-data-synchronization/46-RESEARCH.md

# Source files to verify
@src/db/SQLiteProvider.tsx
@src/db/operations.ts
@src/hooks/database/useSQLiteQuery.ts
@src/hooks/visualization/useForceGraph.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify dataVersion propagation chain and document</name>
  <files>
    src/db/operations.ts
    src/hooks/database/useSQLiteQuery.ts
    src/hooks/visualization/useForceGraph.ts
  </files>
  <action>
Verify the existing dataVersion-driven refresh chain works correctly. The research identified this pattern:

1. **Verify operations.ts increments dataVersion:**
   - Read `src/db/operations.ts`
   - Confirm that `run()` function calls `setDataVersion(prev => prev + 1)` after executing SQL
   - If NOT incrementing, add the increment

2. **Verify useSQLiteQuery includes dataVersion in deps:**
   - Read `src/hooks/database/useSQLiteQuery.ts`
   - Confirm `dataVersion` is in the fetchData useCallback dependency array
   - Line should include: `[execute, sql, paramsKey, enabled, dbLoading, fallbackData, transform, dataVersion]`

3. **Verify useForceGraph uses useSQLiteQuery:**
   - Read `src/hooks/visualization/useForceGraph.ts`
   - Confirm it calls `useSQLiteQuery()` for both nodes and edges queries
   - This inherits dataVersion reactivity automatically

4. **Add inline documentation comments:**
   - In useForceGraph.ts, add a comment above useSQLiteQuery calls:
     ```typescript
     // SYNC-01: Auto-refresh when database changes via dataVersion dependency
     const nodesQuery = useSQLiteQuery<NodeRow>(...);
     ```

5. **Verify chain works end-to-end:**
   - Trace: CaptureComponent.dbRun() → operations.run() → setDataVersion() →
     useSQLiteQuery.fetchData → useForceGraph.nodes → NetworkGraphTab re-render

If any link is broken, fix it. The research says this pattern is already implemented.
  </action>
  <verify>
    - `npm run typecheck` passes
    - Trace from operations.ts through useSQLiteQuery to useForceGraph shows dataVersion in all dependency arrays
    - Comments document the SYNC-01 auto-refresh pattern
  </verify>
  <done>
    - dataVersion propagation chain verified working from Capture save to Preview refresh
    - Architecture documented with SYNC-01 comments
    - No event bus needed—React's dependency tracking handles synchronization
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Timeline and DataInspector auto-refresh</name>
  <files>
    src/hooks/data/useTimeline.ts
    src/hooks/data/useDataInspector.ts
  </files>
  <action>
Verify that TimelineTab and DataInspectorTab also benefit from dataVersion-driven refresh.

1. **Check useTimeline hook (if it exists):**
   - Look in `src/hooks/data/` for timeline-related hooks
   - If it uses `useSQLiteQuery`, it already has auto-refresh via dataVersion
   - If it uses direct `execute()` calls, it may need to add dataVersion as a dependency
   - Add SYNC-01 documentation comment if using useSQLiteQuery

2. **Check useDataInspector hook (if it exists):**
   - Look in `src/hooks/data/` for data inspector hooks
   - The DataInspector is likely query-on-demand (user runs SQL), not auto-refresh
   - This is fine—user-triggered queries get fresh data because execute() reads current DB state
   - If there's a results cache, ensure it clears when dataVersion changes

3. **If hooks don't exist, check the Tab components directly:**
   - Read `src/components/notebook/preview-tabs/TimelineTab.tsx`
   - Read `src/components/notebook/preview-tabs/DataInspectorTab.tsx`
   - Trace their data fetching to confirm dataVersion dependency

4. **Fix any gaps found:**
   - If a component uses direct execute() without listening to dataVersion, add a useEffect that refetches when dataVersion changes
   - Example fix pattern:
     ```typescript
     const { dataVersion } = useSQLite();
     useEffect(() => {
       if (activeQuery) refetch();
     }, [dataVersion]);
     ```

The goal is ensuring ALL Preview tabs refresh when Capture saves, not just NetworkGraph.
  </action>
  <verify>
    - `npm run typecheck` passes
    - TimelineTab data comes from useSQLiteQuery or includes dataVersion dependency
    - DataInspectorTab works correctly (user-triggered queries always get fresh data)
  </verify>
  <done>
    - All Preview tabs verified to refresh on data changes
    - SYNC-01 complete: User sees Preview auto-refresh when Capture saves a card
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Run `npm run typecheck` - must pass
2. Run `npm run dev`
3. Manual integration test:
   - Open the application with Preview visible (Network Graph tab)
   - Create or edit a card in Capture using slash command /save-card
   - Verify Network Graph updates without clicking refresh
   - Switch to Timeline tab, add a new card
   - Verify Timeline updates without manual refresh
4. Check browser console for no errors during data changes
</verification>

<success_criteria>
- dataVersion propagation chain documented and verified
- NetworkGraphTab auto-refreshes when Capture saves data
- TimelineTab auto-refreshes when Capture saves data
- DataInspectorTab works correctly for user-triggered queries
- No custom event bus required—React's built-in reactivity handles SYNC-01
- SYNC-01: User sees Preview auto-refresh when Capture saves a card
</success_criteria>

<output>
After completion, create `.planning/phases/46-live-data-synchronization/46-01-SUMMARY.md`
</output>
