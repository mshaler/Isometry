---
phase: 46-live-data-synchronization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/notebook/preview-tabs/NetworkGraphTab.tsx
  - src/components/notebook/preview-tabs/TimelineTab.tsx
  - src/components/notebook/PreviewComponent.tsx
autonomous: true

must_haves:
  truths:
    - "User sees selection highlighted across all three canvases simultaneously (SYNC-03)"
    - "NetworkGraphTab updates when selection changes from other canvases"
    - "Selection in Preview propagates to shared SelectionContext"
  artifacts:
    - path: "src/components/notebook/preview-tabs/NetworkGraphTab.tsx"
      provides: "Network graph with SelectionContext integration"
      contains: "useSelection"
    - path: "src/components/notebook/preview-tabs/TimelineTab.tsx"
      provides: "Timeline with selection highlighting"
      contains: "useSelection"
  key_links:
    - from: "src/components/notebook/preview-tabs/NetworkGraphTab.tsx"
      to: "src/state/SelectionContext.tsx"
      via: "useSelection hook for shared selection state"
      pattern: "useSelection\\(\\)"
    - from: "src/components/notebook/preview-tabs/TimelineTab.tsx"
      to: "src/state/SelectionContext.tsx"
      via: "useSelection hook for shared selection state"
      pattern: "useSelection\\(\\)"
---

<objective>
Connect Preview tabs to SelectionContext for cross-canvas selection synchronization (SYNC-03).

Purpose: Currently NetworkGraphTab and TimelineTab manage selection state locally. By connecting to the existing SelectionContext, selection becomes shared across all canvases, enabling SYNC-03 where a selection in one place highlights everywhere.

Output: Preview tabs that read from and write to SelectionContext, enabling synchronized selection across Capture, Shell, and Preview.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-live-data-synchronization/46-RESEARCH.md

# Source files
@src/state/SelectionContext.tsx
@src/components/notebook/preview-tabs/NetworkGraphTab.tsx
@src/components/notebook/preview-tabs/TimelineTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Connect NetworkGraphTab to SelectionContext</name>
  <files>
    src/components/notebook/preview-tabs/NetworkGraphTab.tsx
  </files>
  <action>
Replace local selection state with SelectionContext for shared selection across canvases.

1. **Add import for useSelection:**
   ```typescript
   import { useSelection } from '../../../state/SelectionContext';
   ```

2. **Replace local selection state with context:**
   - Current code uses: `const [selectedNodeId, setSelectedNodeId] = useState<string | null>(null);`
   - Replace with:
     ```typescript
     const { selection, select, clear, isSelected } = useSelection();

     // SYNC-03: Selected node from shared context
     const selectedNodeId = selection.lastSelectedId;
     ```

3. **Update handleNodeClick to use context:**
   - Current: `setSelectedNodeId(newSelection);`
   - Replace with:
     ```typescript
     const handleNodeClick = useCallback((nodeId: string) => {
       // Toggle selection via shared context (SYNC-03)
       const isCurrentlySelected = isSelected(nodeId);
       if (isCurrentlySelected) {
         clear();
       } else {
         select(nodeId);
       }

       // Call external callback if provided
       if (onNodeSelect && !isCurrentlySelected) {
         onNodeSelect(nodeId);
       }
     }, [isSelected, select, clear, onNodeSelect]);
     ```

4. **Update selected node info retrieval:**
   - The `selectedNode` lookup already works because we're still getting `selectedNodeId`
   - Just need to remove the local state declaration

5. **Add comment documenting SYNC-03:**
   ```typescript
   // SYNC-03: Selection synchronized via SelectionContext
   // When user clicks node here, selection updates everywhere
   // When selection changes elsewhere, node highlight updates here
   ```

NOTE: The `setSelectedNodeId` that was passed to useForceGraph needs to be kept working.
Check if useForceGraph actually uses the setter. If it does, either:
- Pass the context's select() function instead
- Or remove that prop from useForceGraph if it's not needed
  </action>
  <verify>
    - `npm run typecheck` passes
    - NetworkGraphTab imports and uses useSelection
    - No local selectedNodeId state remains
    - Node click updates SelectionContext
  </verify>
  <done>
    - NetworkGraphTab reads/writes selection via SelectionContext
    - Selection changes in NetworkGraphTab propagate to other canvases
    - Selection changes from other canvases update NetworkGraphTab highlight
  </done>
</task>

<task type="auto">
  <name>Task 2: Connect TimelineTab to SelectionContext</name>
  <files>
    src/components/notebook/preview-tabs/TimelineTab.tsx
  </files>
  <action>
Add selection integration to TimelineTab for cross-canvas selection sync.

1. **Add import for useSelection:**
   ```typescript
   import { useSelection } from '../../../state/SelectionContext';
   ```

2. **Add selection context in component:**
   ```typescript
   const { selection, select, isSelected } = useSelection();
   ```

3. **Check if TimelineTab has event click handling:**
   - Look for click handlers on timeline events/nodes
   - If a click handler exists, update it to call `select(nodeId)`:
     ```typescript
     const handleEventClick = useCallback((nodeId: string) => {
       select(nodeId);  // SYNC-03: Update shared selection
       if (onEventSelect) onEventSelect(nodeId);
     }, [select, onEventSelect]);
     ```

4. **Add visual highlighting for selected events:**
   - Look for the D3 rendering code or React elements for timeline events
   - Add a 'selected' class or style based on `isSelected(nodeId)`:
     ```typescript
     // In D3 rendering:
     .classed('selected', (d: TimelineEvent) => isSelected(d.id))

     // Or in React:
     className={isSelected(event.id) ? 'selected' : ''}
     ```

5. **Add CSS for selected state if not present:**
   - If using D3, ensure there's a .selected style for events
   - If using React, add selected styling

6. **Add documentation comment:**
   ```typescript
   // SYNC-03: Selection synchronized across canvases
   // Clicking an event selects it everywhere
   // Events selected elsewhere are highlighted here
   ```

NOTE: TimelineTab may not have click handling yet. If so, just add the useSelection hook
and the highlighting logic. Click-to-select can be added as part of the integration.
  </action>
  <verify>
    - `npm run typecheck` passes
    - TimelineTab imports and uses useSelection
    - Timeline events show visual selection state
  </verify>
  <done>
    - TimelineTab connected to SelectionContext
    - Selected timeline events are visually highlighted
    - SYNC-03 works across Network Graph and Timeline tabs
  </done>
</task>

<task type="auto">
  <name>Task 3: Ensure SelectionProvider wraps Notebook</name>
  <files>
    src/components/notebook/PreviewComponent.tsx
  </files>
  <action>
Verify SelectionProvider is in the component tree above Preview tabs.

1. **Check if SelectionProvider already wraps the notebook:**
   - Look at `src/App.tsx` or `src/pages/NotebookPage.tsx` (or similar)
   - The SelectionProvider should be at a level above CaptureComponent, ShellComponent, and PreviewComponent

2. **If NOT wrapped, add SelectionProvider:**
   - In the main notebook layout component, wrap children with SelectionProvider:
     ```typescript
     import { SelectionProvider } from '../../state/SelectionContext';

     // In the JSX:
     <SelectionProvider>
       <CaptureComponent />
       <ShellComponent />
       <PreviewComponent />
     </SelectionProvider>
     ```

3. **Verify by tracing component tree:**
   - CaptureComponent, ShellComponent, PreviewComponent must all be inside SelectionProvider
   - This is required for selection to sync between canvases

4. **If already wrapped (likely), document the structure:**
   - Add comment noting that SelectionProvider enables SYNC-03 cross-canvas selection

NOTE: Based on existing SelectionContext usage in src/MVPDemo.tsx and src/components/ListItem.tsx,
SelectionProvider may already be in place. Just verify it covers the notebook canvases.
  </action>
  <verify>
    - `npm run typecheck` passes
    - SelectionProvider wraps all three notebook canvases
    - useSelection() works in all canvas components without error
  </verify>
  <done>
    - SelectionProvider verified in component tree
    - All notebook canvases share the same selection state
    - SYNC-03 architecture complete
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm run typecheck` - must pass
2. Run `npm run dev`
3. Manual integration test:
   - Open app with Network Graph tab visible
   - Click a node in Network Graph
   - Switch to Timeline tab - verify the same card is highlighted
   - Click a different event in Timeline
   - Switch back to Network Graph - verify that node is highlighted
4. Verify console shows no selection-related errors
</verification>

<success_criteria>
- NetworkGraphTab uses SelectionContext instead of local state
- TimelineTab uses SelectionContext for selection state
- SelectionProvider wraps all notebook canvases
- Selection changes in one tab are reflected in other tabs
- SYNC-03: User sees selection highlighted across all three canvases simultaneously
</success_criteria>

<output>
After completion, create `.planning/phases/46-live-data-synchronization/46-02-SUMMARY.md`
</output>
