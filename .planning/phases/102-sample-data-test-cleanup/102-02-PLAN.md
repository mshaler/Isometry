---
phase: 102-sample-data-test-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/test/fixtures.ts
autonomous: true

must_haves:
  truths:
    - "TEST_FACETS status facet has no hardcoded options list"
    - "TEST_NODES includes nodes with optional status/priority"
    - "loadTestFixtures handles missing columns without crashing"
  artifacts:
    - path: "src/test/fixtures.ts"
      provides: "Test fixtures resilient to schema variations"
      contains: "loadTestFixtures"
  key_links:
    - from: "src/test/fixtures.ts"
      to: "src/test/examples/*.test.ts"
      via: "import"
      pattern: "import.*fixtures"
---

<objective>
Update test fixtures to avoid hardcoded status options, make status/priority optional in test nodes, and add graceful error handling for missing columns.

Purpose: Tests should reflect the schema-on-read reality established in Phase 100-101. Hardcoded status options contradict dynamic discovery. Tests should be resilient to schema variations.

Output: Updated `src/test/fixtures.ts` with schema-flexible fixtures.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/102-sample-data-test-cleanup/102-RESEARCH.md
@src/test/fixtures.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove hardcoded options from TEST_FACETS</name>
  <files>src/test/fixtures.ts</files>
  <action>
Update TEST_FACETS to remove hardcoded status options and priority range.

**Before (lines 301-325):**
```typescript
{
  id: 'test-facet-status',
  name: 'Status',
  facet_type: 'select',
  axis: 'C',
  source_column: 'status',
  options: '["active", "in_progress", "completed", "blocked", "cancelled"]', // HARDCODED
  icon: 'status',
  color: '#10B981',
  enabled: true,
  sort_order: 2,
},
{
  id: 'test-facet-priority',
  name: 'Priority',
  facet_type: 'range',
  axis: 'H',
  source_column: 'priority',
  options: '{"min": 1, "max": 5, "step": 1}',  // HARDCODED range
  icon: 'priority',
  color: '#F59E0B',
  enabled: true,
  sort_order: 3,
},
```

**After:**
```typescript
{
  id: 'test-facet-status',
  name: 'Status',
  facet_type: 'select',
  axis: 'C',
  source_column: 'status',
  // Options discovered dynamically from TEST_NODES, not hardcoded
  icon: 'status',
  color: '#10B981',
  enabled: true,
  sort_order: 2,
},
{
  id: 'test-facet-priority',
  name: 'Priority',
  facet_type: 'range',
  axis: 'H',
  source_column: 'priority',
  // Range discovered via MIN/MAX query (Phase 101), not hardcoded
  icon: 'priority',
  color: '#F59E0B',
  enabled: true,
  sort_order: 3,
},
```

Remove the `options` field from both status and priority facets. Dynamic discovery handles this.
  </action>
  <verify>
    grep '"active", "in_progress"' src/test/fixtures.ts
    # Should return empty (no hardcoded status options)
    grep '"min": 1, "max": 5' src/test/fixtures.ts
    # Should return empty (no hardcoded priority range)
  </verify>
  <done>TEST_FACETS contains no hardcoded options for status or priority facets</done>
</task>

<task type="auto">
  <name>Task 2: Add schema-flexible test nodes and update loadTestFixtures</name>
  <files>src/test/fixtures.ts</files>
  <action>
Update TEST_NODES to include nodes with optional/null status and priority, and make loadTestFixtures resilient to missing columns.

**Part 1: Add schema-flexible test nodes to TEST_NODES (after existing nodes, around line 200):**

Add 2-3 new test nodes that simulate realistic imports without status/priority:

```typescript
// Add after fixture-node-8 (around line 200):
{
  id: 'fixture-node-9',
  name: 'Imported Apple Note',
  content: 'Note imported from Apple Notes without status or priority fields.',
  summary: 'Imported note without workflow columns',
  folder: 'personal',
  tags: '["imported", "apple-notes"]',
  // status: intentionally omitted (simulates import without status)
  // priority: intentionally omitted (simulates import without priority)
  created_at: '2024-01-21 10:00:00',
  modified_at: '2024-01-21 10:00:00',
},
{
  id: 'fixture-node-10',
  name: 'Safari Bookmark Import',
  content: 'Bookmark imported from Safari reading list.',
  summary: 'Bookmark without workflow fields',
  folder: 'research',
  tags: '["bookmark", "reference"]',
  // No status or priority - bookmarks don't have these
  created_at: '2024-01-22 09:00:00',
  modified_at: '2024-01-22 09:00:00',
},
{
  id: 'fixture-node-11',
  name: 'Contact Card',
  content: 'Contact information for testing.',
  summary: 'Contact without workflow fields',
  folder: 'contacts',
  tags: '["contact"]',
  status: null,   // Explicit null (vs undefined/omitted)
  priority: null, // Explicit null (vs undefined/omitted)
  created_at: '2024-01-23 08:00:00',
  modified_at: '2024-01-23 08:00:00',
},
```

**Part 2: Update loadTestFixtures error handling (lines 444-478):**

Wrap the nodes INSERT in try-catch with fallback to minimal schema:

```typescript
// Load nodes
if (nodes) {
  try {
    const stmt = db.prepare(`
      INSERT OR REPLACE INTO nodes (
        id, name, content, summary, folder, tags, status, priority, importance,
        grid_x, grid_y, created_at, modified_at, completed_at, due_at,
        location_name, latitude, longitude
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);

    for (const node of TEST_NODES) {
      stmt.run([
        node.id || '',
        node.name || '',
        node.content || '',
        node.summary || '',
        node.folder || '',
        node.tags || '',
        node.status ?? null,    // Use ?? for null-coalescing (handles undefined)
        node.priority ?? null,  // Use ?? for null-coalescing (handles undefined)
        node.importance ?? null,
        node.grid_x ?? 0,
        node.grid_y ?? 0,
        node.created_at || new Date().toISOString(),
        node.modified_at || new Date().toISOString(),
        node.completed_at ?? null,
        node.due_at ?? null,
        node.location_name ?? null,
        node.latitude ?? null,
        node.longitude ?? null,
      ]);
    }
    stmt.free();
  } catch (error) {
    // Fallback to minimal schema if some columns don't exist (TEST-03)
    console.warn('[Test] Full schema insert failed, using minimal schema:', error);
    const stmt = db.prepare(`
      INSERT OR REPLACE INTO nodes (
        id, name, content, folder, tags, created_at, modified_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?)
    `);

    for (const node of TEST_NODES) {
      stmt.run([
        node.id || '',
        node.name || '',
        node.content || '',
        node.folder || '',
        node.tags || '',
        node.created_at || new Date().toISOString(),
        node.modified_at || new Date().toISOString(),
      ]);
    }
    stmt.free();
  }
}
```

Key changes:
- Use `??` (nullish coalescing) instead of `||` for numeric/nullable fields
- Add try-catch with fallback to minimal schema
- Console.warn when falling back (helpful for debugging)
  </action>
  <verify>
    npm run typecheck
    # Should pass with no errors
    grep "fixture-node-9" src/test/fixtures.ts
    # Should find the new imported note test node
    grep "catch.*error" src/test/fixtures.ts
    # Should find the error handling block
    grep "minimal schema" src/test/fixtures.ts
    # Should find the fallback handling
  </verify>
  <done>TEST_NODES includes nodes without status/priority, loadTestFixtures handles missing columns gracefully</done>
</task>

</tasks>

<verification>
After both tasks:
1. `npm run typecheck` passes
2. TEST_FACETS status/priority have no hardcoded options
3. TEST_NODES includes 3 new nodes without status/priority
4. loadTestFixtures has try-catch with minimal schema fallback
5. Existing tests still pass: `npm run test -- src/test/examples/`
</verification>

<success_criteria>
- [ ] TEST-01: TEST_FACETS status facet has no hardcoded options list
- [ ] TEST-02: TEST_NODES includes nodes with optional/null status and priority
- [ ] TEST-03: loadTestFixtures handles missing columns gracefully via try-catch fallback
- [ ] TypeScript compilation passes
- [ ] Existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/102-sample-data-test-cleanup/102-02-SUMMARY.md`
</output>
