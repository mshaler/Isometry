---
phase: 61-view-transitions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/d3/grid-rendering/GridRenderingEngine.ts
  - src/d3/SuperGrid.ts
autonomous: true

must_haves:
  truths:
    - "User changes axis mapping and sees cards smoothly transition to new positions (300ms animation)"
    - "User changes axis mapping and sees header elements smoothly transition with cards"
    - "User has cards selected, changes axis mapping, and selected cards remain selected after transition"
  artifacts:
    - path: "src/d3/grid-rendering/GridRenderingEngine.ts"
      provides: "Card and header transitions with selection preservation"
      contains: ".transition().duration(300)"
    - path: "src/d3/SuperGrid.ts"
      provides: "SelectionContext wiring to GridRenderingEngine"
      contains: "setSelectedIds"
  key_links:
    - from: "src/d3/SuperGrid.ts"
      to: "src/d3/grid-rendering/GridRenderingEngine.ts"
      via: "setSelectedIds method call"
      pattern: "renderingEngine\\.setSelectedIds"
    - from: "src/d3/grid-rendering/GridRenderingEngine.ts"
      to: "cards with transitions"
      via: ".transition().duration(300)"
      pattern: "\\.transition\\(\\)\\.duration\\(300\\)"
    - from: "GridRenderingEngine renderProjectionHeaders"
      to: "header animations"
      via: ".transition().duration(300)"
      pattern: "col-header.*transition|row-header.*transition"
---

<objective>
Implement smooth animated view transitions when PAFV axis mappings change in the Navigator.

Purpose: Complete the view transition experience (TRANS-01, TRANS-02, TRANS-03) so users see polished animations when reorganizing the grid rather than jarring position jumps.

Output: GridRenderingEngine with coordinated card/header transitions and selection state preservation.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-view-transitions/61-RESEARCH.md
@src/d3/grid-rendering/GridRenderingEngine.ts
@src/d3/SuperGrid.ts
@src/state/SelectionContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transition interruption and standardize card animations</name>
  <files>src/d3/grid-rendering/GridRenderingEngine.ts</files>
  <action>
Modify GridRenderingEngine to properly handle view transitions:

1. **Add transition interruption at start of render()**
   - Before any rendering, call `.interrupt()` on cards, col-headers, row-headers
   - This prevents animation buildup during rapid axis changes
   - Add at start of `render()` method after container validation:
   ```typescript
   // Interrupt any ongoing transitions to prevent buildup
   this.container.selectAll('.card').interrupt();
   this.container.selectAll('.col-header').interrupt();
   this.container.selectAll('.row-header').interrupt();
   ```

2. **Standardize card animation durations in renderCards()**
   - Change enter animation from 200ms to 300ms for consistency
   - Keep update animation at 300ms (already correct)
   - Change exit animation from 200ms to 300ms
   - Use d3.easeCubicOut for enter/exit animations (already used for update)

3. **Add key function verification**
   - Verify `.data()` calls use key function `(d: CardRecord) => String(d.id)`
   - This is already present but confirm it's applied correctly for object constancy

Do NOT modify header rendering in this task — that's Task 2.
  </action>
  <verify>
Run `npm run typecheck` to verify no TypeScript errors.
Run the app with `npm run dev`, open SuperGrid preview, and rapidly change axis mappings in Navigator — cards should not jitter or stack animations.
  </verify>
  <done>
Card animations are 300ms enter/update/exit, transitions are interrupted on each render, and rapid axis changes don't cause animation buildup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add header transitions coordinated with card animations</name>
  <files>src/d3/grid-rendering/GridRenderingEngine.ts</files>
  <action>
Add D3 transitions to all header rendering methods:

1. **Modify renderProjectionHeaders() (single-level headers)**
   - Add transitions to column headers `.join()`:
   ```typescript
   .join(
     enter => enter.append('g')
       .attr('class', 'col-header')
       .attr('transform', (_, i) => `translate(${rowHeaderWidth + config.padding + i * (config.cardWidth + config.padding)}, -20)`)
       .attr('opacity', 0)
       .call(g => { /* add rect + text */ })
       .transition()
         .duration(300)
         .ease(d3.easeCubicOut)
         .attr('transform', (_, i) => `translate(${rowHeaderWidth + config.padding + i * (config.cardWidth + config.padding)}, 0)`)
         .attr('opacity', 1),
     update => update
       .transition()
         .duration(300)
         .ease(d3.easeCubicOut)
         .attr('transform', (_, i) => `translate(${rowHeaderWidth + config.padding + i * (config.cardWidth + config.padding)}, 0)`),
     exit => exit
       .transition()
         .duration(300)
         .attr('opacity', 0)
         .remove()
   );
   ```
   - Apply same pattern to row headers (vertical offset animation)

2. **Modify renderStackedProjectionHeaders()**
   - No direct transitions needed — it delegates to renderNestedAxisHeaders() and renderSimpleAxisHeaders()

3. **Modify renderNestedAxisHeaders() for hierarchical headers**
   - Currently uses `.append('g')` directly without data binding
   - Wrap parent/child header creation with opacity animation:
   ```typescript
   const parentGroup = headerContainer
     .append('g')
     .attr('class', 'row-header row-header--parent')
     .attr('transform', `translate(0, ${yPos})`)
     .attr('opacity', 0);
   // ... add content ...
   parentGroup
     .transition()
     .duration(300)
     .attr('opacity', 1);
   ```

4. **Modify renderSimpleAxisHeaders()**
   - Same `.join()` transition pattern as renderProjectionHeaders()

5. **Use same ANIMATION_DURATION constant**
   - Add at class level: `private readonly ANIMATION_DURATION = 300;`
   - Replace all `duration(300)` calls with `duration(this.config.animationDuration)` (already exists in config)
  </action>
  <verify>
Run `npm run typecheck` to verify no TypeScript errors.
Run the app, change axis mappings — column and row headers should slide into position alongside cards, not pop in/out.
  </verify>
  <done>
Headers animate with 300ms transitions coordinated with card animations. Enter headers slide in, update headers reposition smoothly, exit headers fade out.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire SelectionContext to GridRenderingEngine for persistence</name>
  <files>
src/d3/grid-rendering/GridRenderingEngine.ts
src/d3/SuperGrid.ts
  </files>
  <action>
Preserve selection state across view transitions:

1. **Add selectedIds state to GridRenderingEngine**
   ```typescript
   // Add to class properties
   private selectedIds: Set<string> = new Set();

   /**
    * Set selected card IDs for visual highlighting
    * Called from SuperGrid when SelectionContext changes
    */
   public setSelectedIds(selectedIds: Set<string>): void {
     this.selectedIds = selectedIds;
   }
   ```

2. **Apply selection styling in renderCards() after transitions**
   - In the card update transition, add `.on('end')` callback to re-apply selection:
   ```typescript
   cardSelection
     .transition()
     .duration(this.config.animationDuration)
     .ease(d3.easeCubicOut)
     .attr('transform', (d: CardRecord) =>
       `translate(${(d.x as number) || 0}, ${(d.y as number) || 0})`
     )
     .on('end', (d: CardRecord, i: number, nodes: SVGGElement[]) => {
       const card = d3.select(nodes[i]);
       const isSelected = this.selectedIds.has(String(d.id));
       card.classed('selected', isSelected);
       card.select('.card-bg')
         .attr('stroke', isSelected ? '#2563eb' : '#e1e5e9')
         .attr('stroke-width', isSelected ? 2 : 1);
     });
   ```

3. **Apply selection to entering cards too**
   - After cardEnter transition, apply selection styling:
   ```typescript
   cardEnter
     .transition()
     .duration(this.config.animationDuration)
     .attr('opacity', 1)
     .on('end', (d: CardRecord, i: number, nodes: SVGGElement[]) => {
       const card = d3.select(nodes[i]);
       const isSelected = this.selectedIds.has(String(d.id));
       card.classed('selected', isSelected);
       card.select('.card-bg')
         .attr('stroke', isSelected ? '#2563eb' : '#e1e5e9')
         .attr('stroke-width', isSelected ? 2 : 1);
     });
   ```

4. **Wire from SuperGrid.ts (D3 class)**
   - In handleSelectionChange callback, update renderingEngine:
   ```typescript
   private handleSelectionChange(selectedIds: string[]): void {
     this.onSelectionChange?.(selectedIds);
     // NEW: Update rendering engine so transitions preserve selection
     this.renderingEngine.setSelectedIds(new Set(selectedIds));
   }
   ```
   - Also call setSelectedIds when cards are initially rendered via onCardRender callback

5. **Initial selection sync**
   - In SuperGrid's setSelectionState() or similar initialization method, call:
   ```typescript
   this.renderingEngine.setSelectedIds(new Set(initialSelectedIds));
   ```
  </action>
  <verify>
Run `npm run typecheck` to verify no TypeScript errors.
Test flow:
1. Open SuperGrid in preview
2. Click a card to select it (should highlight with blue border)
3. Change axis mapping in Navigator
4. Selected card should remain highlighted after transition completes
  </verify>
  <done>
Selected cards remain selected after axis mapping changes. Selection styling (blue border) persists through animated view transitions.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Type check:** `npm run typecheck` passes
2. **Quality check:** `npm run check:quick` passes (types + lint)
3. **TRANS-01 verification:** Change axis mapping, see cards animate 300ms to new positions
4. **TRANS-02 verification:** Change axis mapping, see headers animate alongside cards
5. **TRANS-03 verification:** Select card, change axis, selected card stays selected
</verification>

<success_criteria>
- All three requirements (TRANS-01, TRANS-02, TRANS-03) are implemented
- Card transitions use 300ms duration with easeCubicOut easing
- Header transitions are coordinated with card transitions (same duration)
- Selection state persists across view transitions
- Rapid axis changes don't cause animation buildup (interrupt works)
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/61-view-transitions/61-01-SUMMARY.md`
</output>
