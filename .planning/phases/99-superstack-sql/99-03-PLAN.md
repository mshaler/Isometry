---
phase: 99-superstack-sql
plan: 03
type: tdd
wave: 2
depends_on: ["99-01", "99-02"]
files_modified:
  - src/superstack/__tests__/sql-integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Tests execute against real sql.js database (not mocks)"
    - "Multi-select facet explosion verified (tags appear as separate rows)"
    - "Time facet extraction verified (year/month correctly parsed)"
    - "Tree building from SQL results produces correct spans and counts"
    - "Query completes in <100ms for test dataset"
  artifacts:
    - path: "src/superstack/__tests__/sql-integration.test.ts"
      provides: "Integration tests for SQL query builders with real sql.js"
      contains: "describe('SuperStack SQL Integration'"
  key_links:
    - from: "src/superstack/__tests__/sql-integration.test.ts"
      to: "buildHeaderDiscoveryQuery"
      via: "import from queries/header-discovery"
      pattern: "import.*buildHeaderDiscoveryQuery.*from.*header-discovery"
    - from: "src/superstack/__tests__/sql-integration.test.ts"
      to: "buildHeaderTree"
      via: "import from builders/header-tree-builder"
      pattern: "import.*buildHeaderTree.*from.*header-tree-builder"
---

<objective>
Create integration tests for SuperStack SQL queries using real sql.js database.

Purpose: Verify that SQL query builders generate valid queries, handle multi-select and time facets correctly, and integrate properly with the existing buildHeaderTree function. Tests run against actual sql.js database, not mocks.

Output: `src/superstack/__tests__/sql-integration.test.ts` with comprehensive integration tests.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/99-superstack-sql/99-RESEARCH.md

# Query builders (created in 99-01, 99-02)
@src/superstack/queries/header-discovery.ts
@src/superstack/queries/query-utils.ts

# Existing infrastructure
@src/superstack/builders/header-tree-builder.ts
@src/superstack/config/superstack-defaults.ts
@src/superstack/types/superstack.ts

# Reference specification
@superstack-phase2-sql-integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sql-integration.test.ts with real sql.js tests</name>
  <files>src/superstack/__tests__/sql-integration.test.ts</files>
  <action>
Create integration test file with:

1. **Test Setup:**
   - Import initSqlJs and Database from 'sql.js'
   - Import vitest functions: describe, it, expect, beforeEach, afterEach
   - Import buildHeaderDiscoveryQuery, buildAggregateQuery from '../queries/header-discovery'
   - Import buildHeaderTree from '../builders/header-tree-builder'
   - Import COMMON_FACETS from '../config/superstack-defaults'
   - Import QueryRow from '../types/superstack'

2. **Schema and Sample Data:**
   - Create SCHEMA constant with cards table (id, name, folder, tags, status, priority, created_at, deleted_at, card_type)
   - IMPORTANT: Use `cards` table, not `nodes`
   - Create SAMPLE_CARDS with 12 test cards across Work/Personal/Archive folders
   - Include diverse tags, dates spanning 2023-2024, one deleted card

3. **beforeEach/afterEach:**
   - Initialize sql.js, create database
   - Run schema and insert sample data
   - Close database in afterEach

4. **Test Suites:**

   **buildHeaderDiscoveryQuery:**
   - 'builds valid SQL for folder + tags rows, year + month columns' - verify SQL contains expected clauses
   - 'executes and returns expected results' - verify result columns
   - 'excludes deleted cards by default' - verify Trash folder excluded
   - 'includes deleted cards when requested' - verify includeDeleted: true works
   - 'handles multi_select facets with json_each' - verify tags exploded
   - 'applies filters correctly' - verify parameterized filter works
   - 'returns correct card counts' - verify counts match expected

   **buildHeaderTree with SQL results:**
   - 'builds correct tree from SQL results' - verify tree structure
   - 'calculates spans correctly from SQL data' - parent span = sum of children
   - 'accumulates counts correctly from SQL data' - verify aggregate.count

   **Time facet extraction:**
   - 'extracts year correctly' - verify strftime('%Y') works
   - 'extracts month correctly' - verify strftime('%m') works

   **Performance:**
   - 'completes query in reasonable time' - verify <100ms

   **buildAggregateQuery:**
   - 'returns correct aggregate stats' - verify total_cards, unique_folders

5. **Helper function for result conversion:**
   Create helper to convert db.exec() results to QueryRow[] format for tree building tests.
  </action>
  <verify>
```bash
cd /Users/mshaler/Developer/Projects/Isometry && npm test -- --run src/superstack/__tests__/sql-integration.test.ts 2>&1 | tail -30
```
All tests pass against real sql.js database.
  </verify>
  <done>
- Tests use real sql.js Database, not mocks
- Multi-select facet explosion tests pass (tags appear as separate rows)
- Time facet extraction tests pass (year/month correctly parsed)
- Tree building tests pass (correct spans and counts)
- Performance test confirms <100ms query time
- All tests pass: `npm test -- --run src/superstack/__tests__/sql-integration.test.ts`
  </done>
</task>

</tasks>

<verification>
1. `npm test -- --run src/superstack/__tests__/sql-integration.test.ts` - all tests pass
2. Tests use actual sql.js database instance
3. Performance test confirms <100ms for test dataset
</verification>

<success_criteria>
- TEST-01: Tests execute against real sql.js database (not mocks)
- TEST-02: Multi-select facet explosion verified (tags appear as separate rows)
- TEST-03: Time facet extraction verified (year/month correctly parsed)
- TEST-04: Tree building from SQL results produces correct spans and counts
- TEST-05: Query completes in <100ms for test dataset
</success_criteria>

<output>
After completion, create `.planning/phases/99-superstack-sql/99-03-SUMMARY.md`
</output>
