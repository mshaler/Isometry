---
phase: 99-superstack-sql
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/superstack/queries/header-discovery.ts
autonomous: true

must_haves:
  truths:
    - "SQL query builds correctly for folder + tags rows, year + month columns"
    - "Multi-select facets handled via json_each() CROSS JOIN"
    - "Time facets extracted via strftime() with proper format"
    - "Deleted cards excluded by default"
    - "Card counts returned per facet combination"
  artifacts:
    - path: "src/superstack/queries/header-discovery.ts"
      provides: "SQL query builder with parameterized queries"
      exports: ["buildHeaderDiscoveryQuery", "buildSingleAxisQuery", "buildAggregateQuery", "QueryFilter", "QueryOptions", "BuiltQuery"]
  key_links:
    - from: "src/superstack/queries/header-discovery.ts"
      to: "FacetConfig type"
      via: "import from ../types/superstack"
      pattern: "import.*FacetConfig.*from.*types/superstack"
---

<objective>
Create SQL query builders for SuperStack header discovery.

Purpose: Generate parameterized SQL queries that extract unique facet combinations with card counts from the cards table. This enables SuperStack to display headers based on actual data instead of hardcoded mocks.

Output: `src/superstack/queries/header-discovery.ts` with buildHeaderDiscoveryQuery and supporting functions.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/99-superstack-sql/99-RESEARCH.md

# Existing SuperStack infrastructure
@src/superstack/types/superstack.ts
@src/superstack/config/superstack-defaults.ts

# Reference specification
@superstack-phase2-sql-integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create header-discovery.ts with query builder functions</name>
  <files>src/superstack/queries/header-discovery.ts</files>
  <action>
Create the queries directory and header-discovery.ts file with:

1. **Types/Interfaces:**
   - `QueryFilter` interface with facetId, operator (eq/neq/contains/gt/lt/gte/lte/between/in), and value
   - `QueryOptions` interface with includeDeleted, limit, nodeTypes
   - `BuiltQuery` interface with sql string and params array

2. **buildHeaderDiscoveryQuery function:**
   - Accept rowFacets, colFacets, filters, options parameters
   - Build SELECT clause using `buildSelectClause` helper
   - Handle multi_select facets: CROSS JOIN json_each with aliases `je0`, `je1`, etc.
   - Handle time facets: strftime with facet.timeFormat
   - CRITICAL: In buildSelectClause for multi_select, use `je${index}.value AS ${facet.id}` NOT `json_each.value`
   - Build WHERE clause: default `cards.deleted_at IS NULL` (use `cards` table not `nodes`)
   - Build GROUP BY using aliases for multi_select facets
   - Add HAVING card_count > 0
   - Return `{ sql, params }` for parameterized queries

3. **Helper functions:**
   - `buildSelectClause(facet, multiSelectIndex)` - dispatch on dataType
   - `buildFilterClause(filter, allFacets)` - build WHERE fragment with params
   - `getFilterColumn(facet)` - get appropriate column reference

4. **Additional query builders:**
   - `buildSingleAxisQuery(facets, filters, options)` - wrapper for single axis
   - `buildAggregateQuery(filters, options)` - COUNT(*), MIN/MAX dates, AVG priority

IMPORTANT: Use `cards` table (not `nodes`) per Phase 84 migration.
  </action>
  <verify>
```bash
cd /Users/mshaler/Developer/Projects/Isometry && npm run typecheck 2>&1 | head -20
```
File exists and TypeScript compiles without errors.
  </verify>
  <done>
- buildHeaderDiscoveryQuery generates valid SQL with json_each CROSS JOIN for multi_select facets
- buildHeaderDiscoveryQuery generates strftime extraction for time facets
- All functions properly typed with QueryFilter, QueryOptions, BuiltQuery interfaces
- Uses `cards` table, not `nodes`
- Multi-select aliases use `je${index}.value` format
  </done>
</task>

<task type="auto">
  <name>Task 2: Add exports to SuperStack index</name>
  <files>src/superstack/index.ts</files>
  <action>
Update src/superstack/index.ts to export the new query functions:

```typescript
// Queries (NEW in Phase 99)
export {
  buildHeaderDiscoveryQuery,
  buildSingleAxisQuery,
  buildAggregateQuery,
  type QueryFilter,
  type QueryOptions,
  type BuiltQuery,
} from './queries/header-discovery';
```

Add this export block after the existing "Builders" exports section.
  </action>
  <verify>
```bash
cd /Users/mshaler/Developer/Projects/Isometry && npm run typecheck 2>&1 | head -20
```
TypeScript compiles and exports are available from @/superstack.
  </verify>
  <done>
- Index exports buildHeaderDiscoveryQuery, buildSingleAxisQuery, buildAggregateQuery
- Index exports QueryFilter, QueryOptions, BuiltQuery types
- No TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. New file exists at src/superstack/queries/header-discovery.ts
3. Exports are accessible: `import { buildHeaderDiscoveryQuery } from '@/superstack'`
</verification>

<success_criteria>
- QUERY-01: buildHeaderDiscoveryQuery builds valid SQL for row + column facets with GROUP BY
- QUERY-02: Multi-select facets handled via json_each() CROSS JOIN with correct aliases
- QUERY-03: Time facets extracted via strftime() with proper format (%Y, %m, etc.)
- QUERY-05: Card counts returned per facet combination
- QUERY-06: Deleted cards excluded by default (optional includeDeleted flag)
</success_criteria>

<output>
After completion, create `.planning/phases/99-superstack-sql/99-01-SUMMARY.md`
</output>
