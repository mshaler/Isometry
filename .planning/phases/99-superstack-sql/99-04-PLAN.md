---
phase: 99-superstack-sql
plan: 04
type: execute
wave: 2
depends_on: ["99-01", "99-02"]
files_modified:
  - src/superstack/hooks/useSuperStackData.ts
autonomous: true

must_haves:
  truths:
    - "useSuperStackData returns { rowTree, colTree, isLoading, error, refetch }"
    - "Hook builds query from facet configurations automatically"
    - "Hook transforms query results into HeaderTree via buildHeaderTree"
    - "Hook tracks query execution time (queryTime metric)"
    - "useRowHeaders and useColHeaders lightweight variants available"
  artifacts:
    - path: "src/superstack/hooks/useSuperStackData.ts"
      provides: "React hook for fetching SuperStack data from sql.js"
      exports: ["useSuperStackData", "useRowHeaders", "useColHeaders", "SuperStackDataConfig", "SuperStackDataResult"]
  key_links:
    - from: "src/superstack/hooks/useSuperStackData.ts"
      to: "useDatabaseService"
      via: "import from @/hooks/database"
      pattern: "useDatabaseService"
    - from: "src/superstack/hooks/useSuperStackData.ts"
      to: "buildHeaderDiscoveryQuery"
      via: "import from ../queries/header-discovery"
      pattern: "buildHeaderDiscoveryQuery"
    - from: "src/superstack/hooks/useSuperStackData.ts"
      to: "buildHeaderTree"
      via: "import from ../builders/header-tree-builder"
      pattern: "buildHeaderTree"
---

<objective>
Create React hook for fetching and building SuperStack header data.

Purpose: Provide a React hook that builds SQL queries from facet configurations, executes them via useDatabaseService, transforms results into HeaderTree structures using buildHeaderTree, and manages loading/error states.

Output: `src/superstack/hooks/useSuperStackData.ts` with useSuperStackData and variants.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/99-superstack-sql/99-RESEARCH.md

# Query builders (created in 99-01)
@src/superstack/queries/header-discovery.ts

# Database hook pattern
@src/hooks/database/useDatabaseService.ts

# Tree builder
@src/superstack/builders/header-tree-builder.ts
@src/superstack/types/superstack.ts

# Reference specification
@superstack-phase2-sql-integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSuperStackData hook</name>
  <files>src/superstack/hooks/useSuperStackData.ts</files>
  <action>
Create src/superstack/hooks/useSuperStackData.ts with:

1. **Type Definitions:**
   - `SuperStackDataConfig` interface:
     - rowFacets: FacetConfig[]
     - colFacets: FacetConfig[]
     - filters?: QueryFilter[]
     - options?: QueryOptions
     - enabled?: boolean (default true)
     - refetchInterval?: number (default 0, disabled)

   - `SuperStackDataResult` interface:
     - rowTree: HeaderTree | null
     - colTree: HeaderTree | null
     - rows: QueryRow[]
     - isLoading: boolean
     - error: Error | null
     - refetch: () => Promise<void>
     - lastFetched: Date | null
     - queryTime: number | null

2. **useSuperStackData hook:**
   - Use useDatabaseService() for database access
   - State: rows, isLoading, error, lastFetched, queryTime
   - Memoize query with useMemo to prevent rebuilds on every render
   - CRITICAL: Check db.isReady() before executing queries
   - Use performance.now() for query timing
   - Use useCallback for fetchData function
   - useEffect for auto-fetch on mount and when dependencies change
   - Optional useEffect for refetchInterval
   - Memoize rowTree and colTree with useMemo using buildHeaderTree
   - Handle empty results: return empty HeaderTree (leafCount=0, roots=[]), NOT null

3. **useRowHeaders variant:**
   - Lightweight wrapper that only fetches row headers
   - Returns Pick<SuperStackDataResult, 'rowTree' | 'isLoading' | 'error' | 'refetch'>

4. **useColHeaders variant:**
   - Lightweight wrapper that only fetches column headers
   - Returns Pick<SuperStackDataResult, 'colTree' | 'isLoading' | 'error' | 'refetch'>

Import from useDatabaseService via '@/hooks/database/useDatabaseService'.
Use the db.query() method for executing SQL.
  </action>
  <verify>
```bash
cd /Users/mshaler/Developer/Projects/Isometry && npm run typecheck 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>
- useSuperStackData returns { rowTree, colTree, isLoading, error, refetch, queryTime }
- Query memoized with useMemo to prevent infinite loops
- Uses db.isReady() check before query execution
- Tracks query time with performance.now()
- useRowHeaders and useColHeaders variants exist
- Empty results return empty HeaderTree, not null
  </done>
</task>

<task type="auto">
  <name>Task 2: Add hook exports to SuperStack index</name>
  <files>src/superstack/index.ts</files>
  <action>
Update src/superstack/index.ts to export the hook and types.

Add after the query-utils exports:

```typescript
// Hooks (NEW in Phase 99)
export {
  useSuperStackData,
  useRowHeaders,
  useColHeaders,
  type SuperStackDataConfig,
  type SuperStackDataResult,
} from './hooks/useSuperStackData';
```
  </action>
  <verify>
```bash
cd /Users/mshaler/Developer/Projects/Isometry && npm run typecheck 2>&1 | head -20
```
TypeScript compiles and all exports are available.
  </verify>
  <done>
- Index exports useSuperStackData, useRowHeaders, useColHeaders
- Index exports SuperStackDataConfig, SuperStackDataResult types
- No TypeScript errors
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. New file exists at src/superstack/hooks/useSuperStackData.ts
3. Hook exports accessible from @/superstack
</verification>

<success_criteria>
- HOOK-01: useSuperStackData returns { rowTree, colTree, isLoading, error, refetch }
- HOOK-02: Hook builds query from facet configurations automatically
- HOOK-03: Hook transforms query results into HeaderTree via buildHeaderTree
- HOOK-04: Hook tracks query execution time (queryTime metric)
- HOOK-05: useRowHeaders and useColHeaders lightweight variants available
</success_criteria>

<output>
After completion, create `.planning/phases/99-superstack-sql/99-04-SUMMARY.md`
</output>
