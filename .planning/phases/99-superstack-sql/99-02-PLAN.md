---
phase: 99-superstack-sql
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/superstack/queries/query-utils.ts
autonomous: true

must_haves:
  truths:
    - "createTimeFacetChain generates year/quarter/month/week/day configs"
    - "createCategoryFacetChain generates folder/status/tags configs"
    - "validateFacetConfigs detects missing/invalid facet settings"
    - "estimateQueryComplexity returns 1-10 complexity score"
  artifacts:
    - path: "src/superstack/queries/query-utils.ts"
      provides: "Facet chain creation and validation utilities"
      exports: ["createTimeFacetChain", "createCategoryFacetChain", "validateFacetConfigs", "estimateQueryComplexity"]
  key_links:
    - from: "src/superstack/queries/query-utils.ts"
      to: "COMMON_FACETS"
      via: "import from ../config/superstack-defaults"
      pattern: "import.*COMMON_FACETS.*from.*superstack-defaults"
---

<objective>
Create query utility functions for facet chain creation and validation.

Purpose: Provide helper functions that simplify creating common facet configurations (time chains like year→month, category chains like folder→tags) and validate configurations before query execution.

Output: `src/superstack/queries/query-utils.ts` with utility functions.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/99-superstack-sql/99-RESEARCH.md

# Existing SuperStack infrastructure
@src/superstack/types/superstack.ts
@src/superstack/config/superstack-defaults.ts

# Reference specification
@superstack-phase2-sql-integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create query-utils.ts with utility functions</name>
  <files>src/superstack/queries/query-utils.ts</files>
  <action>
Create src/superstack/queries/query-utils.ts with:

1. **createTimeFacetChain function:**
   - Parameters: sourceColumn (default 'created_at'), levels array of ('year' | 'quarter' | 'month' | 'week' | 'day')
   - Default levels: ['year', 'month']
   - Return FacetConfig[] based on COMMON_FACETS with overridden sourceColumn
   - Time formats: year='%Y', quarter='%Y-Q' (needs post-processing), month='%m', week='%W', day='%d'

2. **createCategoryFacetChain function:**
   - Parameters: levels array of ('folder' | 'status' | 'tags' | 'type')
   - Default levels: ['folder', 'tags']
   - Return FacetConfig[] from COMMON_FACETS

3. **validateFacetConfigs function:**
   - Accept FacetConfig[] array
   - Return string[] of error messages (empty if valid)
   - Check: id exists, sourceColumn exists, time facets have timeFormat
   - Check for duplicate IDs

4. **estimateQueryComplexity function:**
   - Accept rowFacets, colFacets
   - Return number 1-10
   - Scoring: base from facet count (max 4), +2 per multi_select facet, +0.5 per time facet
   - Cap at 10

Import COMMON_FACETS from '../config/superstack-defaults'.
Import FacetConfig from '../types/superstack'.
  </action>
  <verify>
```bash
cd /Users/mshaler/Developer/Projects/Isometry && npm run typecheck 2>&1 | head -20
```
TypeScript compiles without errors.
  </verify>
  <done>
- createTimeFacetChain returns correct FacetConfig[] with timeFormat set
- createCategoryFacetChain returns correct FacetConfig[] from COMMON_FACETS
- validateFacetConfigs returns error messages for invalid configs
- estimateQueryComplexity returns score 1-10
  </done>
</task>

<task type="auto">
  <name>Task 2: Add query-utils exports to SuperStack index</name>
  <files>src/superstack/index.ts</files>
  <action>
Update src/superstack/index.ts to export the query utility functions.

Add after the header-discovery exports:

```typescript
export {
  createTimeFacetChain,
  createCategoryFacetChain,
  validateFacetConfigs,
  estimateQueryComplexity,
} from './queries/query-utils';
```
  </action>
  <verify>
```bash
cd /Users/mshaler/Developer/Projects/Isometry && npm run typecheck 2>&1 | head -20
```
TypeScript compiles and all exports are available.
  </verify>
  <done>
- Index exports all four utility functions
- No TypeScript errors
- Functions accessible via `import { createTimeFacetChain } from '@/superstack'`
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. New file exists at src/superstack/queries/query-utils.ts
3. All four functions exported from @/superstack
</verification>

<success_criteria>
- QUTIL-01: createTimeFacetChain generates year/quarter/month/week/day configs
- QUTIL-02: createCategoryFacetChain generates folder/status/tags configs
- QUTIL-03: validateFacetConfigs detects missing/invalid facet settings
- QUTIL-04: estimateQueryComplexity returns 1-10 complexity score
</success_criteria>

<output>
After completion, create `.planning/phases/99-superstack-sql/99-02-SUMMARY.md`
</output>
