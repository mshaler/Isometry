---
phase: 56-supergrid-pafv-projection
plan: 01
type: execute
wave: 1
depends_on: ["51-02"]
files_modified:
  - src/types/grid.ts
  - src/d3/SuperGrid.ts
  - src/components/SuperGridDemo.tsx
autonomous: true

must_haves:
  truths:
    - "PAFVProjection type exists in grid.ts"
    - "SuperGrid has setProjection() method"
    - "SuperGridDemo extracts PAFV state and passes to SuperGrid"
  artifacts:
    - path: "src/types/grid.ts"
      provides: "PAFVProjection interface"
      exports: ["PAFVProjection"]
    - path: "src/d3/SuperGrid.ts"
      provides: "setProjection method"
      contains: "setProjection"
    - path: "src/components/SuperGridDemo.tsx"
      provides: "PAFV state wiring"
      contains: "state.mappings"
  key_links:
    - from: "src/components/SuperGridDemo.tsx"
      to: "src/d3/SuperGrid.ts"
      via: "superGrid.setProjection(projection)"
      pattern: "setProjection"
---

<objective>
Wire PAFV state from Navigator to SuperGrid so axis mappings reach the rendering engine.

Purpose: Establish the data flow from PAFVContext → SuperGridDemo → SuperGrid → GridRenderingEngine.

Output: SuperGrid receives PAFV projection configuration that it can use for 2D layout.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/56-supergrid-pafv-projection/56-RESEARCH.md
@src/types/pafv.ts
@src/hooks/data/usePAFV.ts
@src/d3/SuperGrid.ts
@src/components/SuperGridDemo.tsx
@src/types/grid.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PAFVProjection type to grid.ts</name>
  <files>
    src/types/grid.ts
  </files>
  <action>
Add the following types at the end of src/types/grid.ts (before the closing):

```typescript
// ============================================================================
// PAFV Projection types for axis-based grid layout
// ============================================================================

import type { LATCHAxis, Plane } from './pafv';

/**
 * Single axis configuration from PAFV mapping
 */
export interface AxisProjection {
  axis: LATCHAxis;
  facet: string;  // Column name in database (e.g., 'created_at', 'folder')
}

/**
 * Complete PAFV projection configuration for SuperGrid
 * Defines which facets map to which visual planes
 */
export interface PAFVProjection {
  xAxis: AxisProjection | null;  // Column headers
  yAxis: AxisProjection | null;  // Row headers
  colorAxis?: AxisProjection | null;  // Future: color encoding
}

/**
 * Cell position computed from PAFV projection
 */
export interface ProjectedCellPosition {
  row: number;       // Y-axis index (-1 = unassigned)
  col: number;       // X-axis index (-1 = unassigned)
  rowValue: string | null;  // Actual facet value for row
  colValue: string | null;  // Actual facet value for column
}

/**
 * Convert AxisMapping array to PAFVProjection
 */
export function mappingsToProjection(mappings: Array<{ plane: Plane; axis: LATCHAxis; facet: string }>): PAFVProjection {
  const xMapping = mappings.find(m => m.plane === 'x');
  const yMapping = mappings.find(m => m.plane === 'y');
  const colorMapping = mappings.find(m => m.plane === 'color');

  return {
    xAxis: xMapping ? { axis: xMapping.axis, facet: xMapping.facet } : null,
    yAxis: yMapping ? { axis: yMapping.axis, facet: yMapping.facet } : null,
    colorAxis: colorMapping ? { axis: colorMapping.axis, facet: colorMapping.facet } : null,
  };
}
```
  </action>
  <verify>
    - npm run typecheck (may have existing errors, but new code should not add new ones)
    - PAFVProjection interface exists
    - mappingsToProjection function exists
  </verify>
  <done>
    - PAFVProjection type defined with xAxis, yAxis, colorAxis
    - ProjectedCellPosition type defined
    - mappingsToProjection helper function added
  </done>
</task>

<task type="auto">
  <name>Task 2: Add setProjection to SuperGrid</name>
  <files>
    src/d3/SuperGrid.ts
  </files>
  <action>
1. Add import at top of file:
   ```typescript
   import type { PAFVProjection } from '../types/grid';
   ```

2. Add private member after `private currentData`:
   ```typescript
   private currentProjection: PAFVProjection | null = null;
   ```

3. Add public method after the `query` method (around line 216):
   ```typescript
   /**
    * Set PAFV projection configuration
    * Updates how cards are positioned based on axis mappings
    */
   public setProjection(projection: PAFVProjection | null): void {
     const hasChanged = JSON.stringify(this.currentProjection) !== JSON.stringify(projection);
     this.currentProjection = projection;

     if (hasChanged) {
       superGridLogger.debug('PAFV projection updated:', {
         xAxis: projection?.xAxis?.facet || 'none',
         yAxis: projection?.yAxis?.facet || 'none',
       });

       // Re-render with new projection if we have data
       if (this.currentData) {
         this.updateModulesWithData();
         this.render();
       }
     }
   }

   /**
    * Get current PAFV projection
    */
   public getProjection(): PAFVProjection | null {
     return this.currentProjection;
   }
   ```

4. Update `updateModulesWithData` method to pass projection to rendering engine:
   ```typescript
   private updateModulesWithData(): void {
     if (this.currentData) {
       this.selectionController.setGridData(this.currentData);
       this.dragDropController.setGridData(this.currentData);
       this.renderingEngine.setGridData(this.currentData);

       // Pass projection to rendering engine
       if (this.currentProjection) {
         this.renderingEngine.setProjection(this.currentProjection);
       }
     }
   }
   ```
  </action>
  <verify>
    - SuperGrid has setProjection method
    - SuperGrid has getProjection method
    - currentProjection private member exists
  </verify>
  <done>
    - setProjection() stores projection and triggers re-render
    - getProjection() returns current projection
    - updateModulesWithData passes projection to renderingEngine
  </done>
</task>

<task type="auto">
  <name>Task 3: Add setProjection stub to GridRenderingEngine</name>
  <files>
    src/d3/grid-rendering/GridRenderingEngine.ts
  </files>
  <action>
1. Add import at top of file:
   ```typescript
   import type { PAFVProjection } from '../../types/grid';
   ```

2. Add private member after `private isHeadersInitialized`:
   ```typescript
   private currentProjection: PAFVProjection | null = null;
   ```

3. Add public method after `updateCallbacks`:
   ```typescript
   /**
    * Set PAFV projection for axis-based layout
    * This will be used in Plan 56-02 for position computation
    */
   public setProjection(projection: PAFVProjection | null): void {
     this.currentProjection = projection;
     superGridLogger.debug('GridRenderingEngine: projection set', {
       xAxis: projection?.xAxis?.facet || 'none',
       yAxis: projection?.yAxis?.facet || 'none',
     });
   }

   /**
    * Get current projection
    */
   public getProjection(): PAFVProjection | null {
     return this.currentProjection;
   }
   ```
  </action>
  <verify>
    - GridRenderingEngine has setProjection method
    - GridRenderingEngine has getProjection method
  </verify>
  <done>
    - GridRenderingEngine stores projection (will be used in 56-02)
  </done>
</task>

<task type="auto">
  <name>Task 4: Wire PAFV state in SuperGridDemo</name>
  <files>
    src/components/SuperGridDemo.tsx
  </files>
  <action>
1. Add import at top (near other imports):
   ```typescript
   import { mappingsToProjection } from '../types/grid';
   ```

2. Change line 53 from:
   ```typescript
   usePAFV();
   ```
   to:
   ```typescript
   const { state: pafvState } = usePAFV();
   ```

3. Add useEffect after the filter setup useEffect (around line 77) to sync PAFV state to SuperGrid:
   ```typescript
   // Sync PAFV projection to SuperGrid
   useEffect(() => {
     if (!superGrid) return;

     const projection = mappingsToProjection(pafvState.mappings);
     superGrid.setProjection(projection);

     contextLogger.setup('SuperGridDemo: PAFV projection synced', {
       mappings: pafvState.mappings.length,
       xAxis: projection.xAxis?.facet || 'none',
       yAxis: projection.yAxis?.facet || 'none',
     });
   }, [superGrid, pafvState.mappings]);
   ```
  </action>
  <verify>
    - usePAFV result is destructured to get state
    - useEffect syncs pafvState.mappings to superGrid.setProjection
    - mappingsToProjection is imported and used
  </verify>
  <done>
    - SuperGridDemo extracts PAFV state
    - PAFV mappings are converted to PAFVProjection
    - Projection is passed to SuperGrid on mapping changes
  </done>
</task>

</tasks>

<verification>
1. grep for "PAFVProjection" in src/types/grid.ts
2. grep for "setProjection" in src/d3/SuperGrid.ts
3. grep for "pafvState.mappings" in src/components/SuperGridDemo.tsx
4. Visual: Open dev tools, change Navigator mapping, see console log "PAFV projection updated"
</verification>

<success_criteria>
- PAFVProjection type exists and is importable
- SuperGrid.setProjection() accepts and stores projection
- GridRenderingEngine.setProjection() stub exists
- SuperGridDemo syncs PAFV mappings to SuperGrid
- Changing Navigator mapping triggers console log in SuperGrid
</success_criteria>

<output>
After completion, create `.planning/phases/56-supergrid-pafv-projection/56-01-SUMMARY.md`
</output>
