---
phase: 07.3-migration-completion
plan: 02
type: execute
wave: 2
depends_on: ["07.3-01"]
files_modified: [
  "src/utils/rollback-manager.ts",
  "src/db/migration-safety.ts",
  "native/Sources/Isometry/Migration/RollbackCoordinator.swift",
  "scripts/migration-rollback.sh"
]
autonomous: true

must_haves:
  truths:
    - "Rollback procedures allow safe reversion to sql.js if needed"
    - "Migration safety checks prevent data loss during rollback"
    - "Automated rollback triggers activate on critical failures"
    - "Manual rollback procedures provide admin control"
    - "Rollback validation ensures complete restoration of sql.js functionality"
  artifacts:
    - path: "src/utils/rollback-manager.ts"
      provides: "React-side rollback coordination and validation"
      min_lines: 150
      exports: ["RollbackManager", "initiateRollback", "validateRollback"]
    - path: "native/Sources/Isometry/Migration/RollbackCoordinator.swift"
      provides: "Native rollback coordination and data export"
      min_lines: 200
      exports: ["RollbackCoordinator", "exportToSQLjs", "restoreBackup"]
    - path: "scripts/migration-rollback.sh"
      provides: "Automated rollback script for emergency situations"
      min_lines: 100
      contains: ["rollback_to_sqljs", "backup_native_data", "restore_sqljs"]
  key_links:
    - from: "RollbackManager.initiateRollback()"
      to: "native RollbackCoordinator"
      via: "WebView bridge rollback message"
      pattern: "webkit\\.messageHandlers\\.rollback\\.postMessage"
    - from: "RollbackCoordinator.exportToSQLjs()"
      to: "IsometryDatabase export"
      via: "GRDB data export to sql.js format"
      pattern: "database\\.export.*sqljs.*format"
    - from: "Migration safety checks"
      to: "data integrity validation"
      via: "checksum and consistency verification"
      pattern: "validateIntegrity.*checksum.*consistency"
---

<objective>
Implement comprehensive rollback mechanisms and safety procedures to enable safe reversion to sql.js implementation if migration issues arise.

Purpose: Provide confidence and safety for sql.js migration by ensuring ability to rollback completely with no data loss if problems occur.

Output: Production-ready rollback system with automated safety checks, manual procedures, and complete restoration capabilities.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.3-migration-completion/07.3-01-PLAN.md
@src/contexts/EnvironmentContext.tsx
@src/utils/sync-manager.ts
@native/Sources/Isometry/Database/IsometryDatabase.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create React-side rollback coordination system</name>
  <files>
    src/utils/rollback-manager.ts
    src/db/migration-safety.ts
  </files>
  <action>
    Create rollback-manager.ts for comprehensive rollback coordination:

    Export RollbackManager class with safety procedures:
    - initiateRollback(reason: string): Begin controlled rollback process
    - validateRollback(): Verify rollback safety before execution
    - exportNativeData(): Export current native data for preservation
    - restoreSqlJsEnvironment(): Restore sql.js provider configuration
    - verifyRollbackSuccess(): Validate rollback completion

    Rollback validation and safety:
    ```typescript
    interface RollbackPlan {
      reason: string;
      timestamp: Date;
      dataSafety: 'safe' | 'risky' | 'dangerous';
      estimatedDuration: number;
      requiredSteps: RollbackStep[];
      backupLocation: string;
    }

    interface RollbackStep {
      name: string;
      description: string;
      critical: boolean;
      estimatedTime: number;
      validation: () => Promise<boolean>;
    }
    ```

    Create migration-safety.ts for safety validation:
    - assessRollbackSafety(): Evaluate rollback safety based on current state
    - createDataBackup(): Create comprehensive backup before rollback
    - validateDataIntegrity(): Ensure no data corruption before rollback
    - testSqlJsCompatibility(): Verify sql.js can handle current data
    - generateRollbackReport(): Document rollback process and outcomes

    Rollback trigger conditions:
    - Critical performance regression (>50% slower than baseline)
    - Data corruption detected during validation
    - Security vulnerabilities in WebView bridge
    - App Store rejection due to bridge implementation
    - User-initiated rollback for compatibility issues

    Safety mechanisms:
    - Pre-rollback data export and validation
    - Incremental rollback with validation checkpoints
    - Automatic rollback halt if integrity issues detected
    - Manual intervention points for admin control
    - Complete audit trail of rollback operations

    Recovery procedures:
    - Restore sql.js DatabaseContext as primary provider
    - Export all native data to IndexedDB format
    - Validate data consistency after rollback
    - Test all React components with sql.js provider
    - Update environment configuration to disable bridge

    Include comprehensive error handling and recovery for failed rollback attempts.
  </action>
  <verify>
    Rollback manager can assess rollback safety accurately
    Data backup and validation procedures work correctly
    sql.js compatibility testing identifies potential issues
  </verify>
  <done>
    Rollback manager provides comprehensive safety validation and controlled rollback procedures with complete data protection
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement native rollback coordination</name>
  <files>
    native/Sources/Isometry/Migration/RollbackCoordinator.swift
    native/Sources/Isometry/Migration/DataExporter.swift
  </files>
  <action>
    Create RollbackCoordinator.swift for native rollback management:

    Export RollbackCoordinator class with comprehensive rollback support:
    - initiateRollback(plan: RollbackPlan): Begin native-side rollback
    - exportToSQLjs(): Export all native data in sql.js compatible format
    - createRollbackBackup(): Create complete backup of current state
    - validateRollbackSafety(): Verify rollback can proceed safely
    - completeRollback(): Finalize rollback and cleanup resources

    Data export functionality:
    ```swift
    struct SQLjsExportFormat {
        let schema: String          // CREATE TABLE statements
        let data: [String]         // INSERT statements
        let indexes: [String]      // CREATE INDEX statements
        let metadata: ExportMetadata
    }

    class DataExporter {
        func exportToSQLjs() async throws -> SQLjsExportFormat
        func validateExportIntegrity(_ export: SQLjsExportFormat) throws -> Bool
        func optimizeForSQLjs(_ export: SQLjsExportFormat) -> SQLjsExportFormat
    }
    ```

    Create DataExporter.swift for format conversion:
    - Convert GRDB data to sql.js compatible SQL statements
    - Handle data type mappings between SQLite implementations
    - Preserve all relationships and constraints
    - Include FTS5 data and indexes
    - Maintain CloudKit sync metadata where possible

    Native rollback procedures:
    - Pause all database operations during export
    - Create atomic backup of current database state
    - Export data with integrity validation
    - Test export compatibility with sql.js
    - Provide progress reporting to React side

    CloudKit integration during rollback:
    - Preserve CloudKit sync state where possible
    - Handle CloudKit schema differences gracefully
    - Provide option to maintain CloudKit sync vs local-only
    - Document CloudKit implications of rollback
    - Support re-migration path if rollback temporary

    Rollback validation and safety:
    - Verify all data can be exported without loss
    - Test sql.js compatibility with exported data
    - Validate schema compatibility and constraints
    - Check for data size limitations in sql.js
    - Confirm all relationships preserved correctly

    Performance considerations:
    - Optimize export process for large datasets
    - Support incremental export for huge databases
    - Provide progress reporting and cancellation
    - Minimize app downtime during rollback
    - Handle memory constraints during export

    Include comprehensive logging and error recovery for all rollback operations.
  </action>
  <verify>
    Native data export produces valid sql.js compatible format
    Rollback coordinator handles all database sizes correctly
    Data integrity validation confirms no loss during export
  </verify>
  <done>
    Native rollback coordinator provides comprehensive data export and rollback capabilities with full integrity validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create automated rollback scripts and procedures</name>
  <files>
    scripts/migration-rollback.sh
    scripts/rollback-validation.js
    docs/ROLLBACK-PROCEDURES.md
  </files>
  <action>
    Create migration-rollback.sh for automated emergency rollback:

    Export comprehensive rollback automation:
    - rollback_to_sqljs(): Complete automated rollback process
    - backup_native_data(): Create safety backup before rollback
    - restore_sqljs_environment(): Restore sql.js configuration
    - validate_rollback_success(): Verify rollback completion
    - cleanup_rollback_artifacts(): Clean up temporary files

    Script functionality:
    ```bash
    #!/bin/bash
    set -e

    # Emergency rollback to sql.js
    rollback_to_sqljs() {
        echo "ðŸ”„ Starting emergency rollback to sql.js..."

        # 1. Create safety backup
        backup_native_data

        # 2. Export native data
        export_to_sqljs_format

        # 3. Restore sql.js environment
        restore_sqljs_environment

        # 4. Validate rollback
        validate_rollback_success

        echo "âœ… Rollback completed successfully"
    }
    ```

    Create rollback-validation.js for automated validation:
    - Test sql.js environment after rollback
    - Validate all data imported correctly
    - Test React component functionality
    - Verify performance meets baseline
    - Generate rollback success report

    Rollback automation features:
    - Support for both manual and automatic triggering
    - Comprehensive logging and progress reporting
    - Safety checks and validation at each step
    - Rollback halt on critical errors
    - Complete audit trail generation

    Create ROLLBACK-PROCEDURES.md documentation:
    - Step-by-step manual rollback procedures
    - Emergency rollback contact information
    - Troubleshooting guide for rollback failures
    - Data recovery procedures for edge cases
    - Post-rollback validation checklist

    Integration with CI/CD and monitoring:
    - Support for remote rollback triggering
    - Integration with monitoring alerts
    - Automated rollback testing in staging
    - Performance regression detection
    - Automated safety validation

    Emergency procedures:
    - One-command emergency rollback
    - Support for partial rollback scenarios
    - Data preservation priorities during emergencies
    - Communication templates for stakeholders
    - Recovery time estimation and reporting

    Include comprehensive error handling and recovery procedures for all rollback scenarios.
  </action>
  <verify>
    Automated rollback script successfully completes full rollback process
    Validation scripts confirm sql.js environment works correctly
    Documentation provides clear procedures for manual rollback
  </verify>
  <done>
    Automated rollback scripts provide reliable emergency procedures with comprehensive validation and documentation
  </done>
</task>

</tasks>

<verification>
1. Rollback procedures enable safe reversion to sql.js with no data loss
2. Safety validation prevents rollback when data integrity at risk
3. Automated scripts provide reliable emergency rollback capabilities
4. Manual procedures support admin control and troubleshooting
5. Comprehensive documentation ensures rollback can be executed by any team member
</verification>

<success_criteria>
- [ ] Rollback manager provides comprehensive safety validation and procedures
- [ ] Native data export produces valid sql.js compatible format
- [ ] Automated rollback scripts enable reliable emergency procedures
- [ ] Manual rollback procedures support admin control and edge cases
- [ ] Documentation ensures rollback can be executed safely by any team member
</success_criteria>

<output>
After completion, create `.planning/phases/07.3-migration-completion/07.3-02-SUMMARY.md`
</output>