# Plan 75-04: SuperAudit — Computed Value Highlighting

**Phase:** 75 (SuperGrid Phase C)
**Plan:** 04 of 04
**Status:** READY
**Priority:** P2 — Visual polish
**Estimated Effort:** 0.5 day

## Goal

Implement visual distinction between raw data values and computed/enriched values, with a toggle to show/hide audit indicators and CRUD flash animations on changes.

## Requirements Covered

- AUDIT-01: Computed cells have subtle background tint
- AUDIT-02: Toggle in toolbar to show/hide audit indicators
- AUDIT-03: CRUD flash animation on cell changes

## Current State

All cells render with the same styling. No distinction between user data and computed values. No change animations.

## Target State

```
With audit mode enabled:
┌────────────────────────────────────────────┐
│ Name       │ Status   │ Computed Score    │
├────────────┼──────────┼───────────────────┤
│ Project A  │ Active   │ ▣ 85 (enriched)   │  ← Tinted background
│ Project B  │ Done     │ ▣ 92 (formula)    │  ← Different tint
│ Project C★ │ Active   │ ▣ 78              │  ← ★ = recently changed
└────────────────────────────────────────────┘

Legend:
▣ = Computed indicator (subtle dot or corner)
★ = Recent CRUD operation (flash animation)
```

## Tasks

### Task 1: Define Audit Types

**Files:** `src/d3/SuperGridEngine/types.ts`

**Implementation:**

```typescript
type ValueSource = 'raw' | 'computed' | 'enriched' | 'formula';

interface CellAuditInfo {
  source: ValueSource;
  computedAt?: string;  // ISO timestamp
  formula?: string;     // For formula cells
  enrichedBy?: string;  // ETL source
}

interface AuditState {
  enabled: boolean;
  showFormulas: boolean;
  recentChanges: Map<string, { type: 'create' | 'update' | 'delete'; timestamp: number }>;
}
```

**TDD:**
- Test: CellAuditInfo validates source types
- Test: AuditState tracks recent changes
- Test: Old changes are cleaned up (> 2s)

### Task 2: Create AuditRenderer

**Files:** `src/d3/SuperGridEngine/AuditRenderer.ts` (NEW)

**Implementation:**

```typescript
class AuditRenderer {
  private colors = {
    computed: 'rgba(59, 130, 246, 0.1)',   // Blue tint
    enriched: 'rgba(16, 185, 129, 0.1)',   // Green tint
    formula: 'rgba(139, 92, 246, 0.1)'     // Purple tint
  };

  renderAuditOverlay(
    selection: d3.Selection<SVGGElement, CellDescriptor, SVGGElement, unknown>,
    auditState: AuditState,
    getAuditInfo: (cellId: string) => CellAuditInfo | undefined
  ): void {
    if (!auditState.enabled) {
      selection.selectAll('.audit-overlay').remove();
      return;
    }

    selection.each(function(d) {
      const info = getAuditInfo(d.id);
      if (!info || info.source === 'raw') return;

      const group = d3.select(this);

      // Background tint
      group.selectAll('.audit-overlay')
        .data([info])
        .join('rect')
        .attr('class', 'audit-overlay')
        .attr('width', d.position?.width ?? 100)
        .attr('height', d.position?.height ?? 32)
        .attr('fill', this.colors[info.source])
        .attr('pointer-events', 'none');

      // Indicator dot
      group.selectAll('.audit-indicator')
        .data([info])
        .join('circle')
        .attr('class', 'audit-indicator')
        .attr('cx', 8)
        .attr('cy', 8)
        .attr('r', 3)
        .attr('fill', this.getIndicatorColor(info.source));
    });
  }

  private getIndicatorColor(source: ValueSource): string {
    return {
      computed: '#3B82F6',
      enriched: '#10B981',
      formula: '#8B5CF6',
      raw: 'transparent'
    }[source];
  }
}
```

**TDD:**
- Test: Computed cells get blue tint
- Test: Enriched cells get green tint
- Test: Raw cells have no overlay
- Test: Indicator dot renders in corner

### Task 3: Implement CRUD Flash Animation

**Files:** `src/d3/SuperGridEngine/AuditRenderer.ts`

**Implementation:**

```typescript
class AuditRenderer {
  // ... existing

  animateCRUDChange(
    selection: d3.Selection<SVGGElement, unknown, SVGGElement, unknown>,
    changeType: 'create' | 'update' | 'delete'
  ): void {
    const colors = {
      create: '#10B981',  // Green
      update: '#3B82F6',  // Blue
      delete: '#EF4444'   // Red
    };

    // Flash overlay
    selection.append('rect')
      .attr('class', 'crud-flash')
      .attr('width', '100%')
      .attr('height', '100%')
      .attr('fill', colors[changeType])
      .attr('opacity', 0.4)
      .transition()
      .duration(500)
      .attr('opacity', 0)
      .on('end', function() {
        d3.select(this).remove();
      });

    // Border pulse
    selection.select('.cell-border')
      .transition()
      .duration(200)
      .attr('stroke', colors[changeType])
      .attr('stroke-width', 2)
      .transition()
      .duration(300)
      .attr('stroke', '#e5e7eb')
      .attr('stroke-width', 1);
  }

  trackChange(cellId: string, type: 'create' | 'update' | 'delete'): void {
    this.auditState.recentChanges.set(cellId, {
      type,
      timestamp: Date.now()
    });

    // Clean up old changes
    setTimeout(() => {
      this.auditState.recentChanges.delete(cellId);
    }, 2000);
  }
}
```

**TDD:**
- Test: Create flash is green
- Test: Update flash is blue
- Test: Delete flash is red
- Test: Flash completes in 500ms
- Test: Recent changes cleaned up after 2s

### Task 4: Add Audit Toggle to Toolbar

**Files:** `src/components/supergrid/AuditToggle.tsx` (NEW)

**Implementation:**

```typescript
interface AuditToggleProps {
  enabled: boolean;
  onToggle: (enabled: boolean) => void;
}

export function AuditToggle({ enabled, onToggle }: AuditToggleProps) {
  return (
    <button
      className={cn(
        'flex items-center gap-2 px-3 py-1.5 rounded-md text-sm',
        enabled ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'
      )}
      onClick={() => onToggle(!enabled)}
      title="Toggle computed value highlighting"
    >
      <EyeIcon className="w-4 h-4" />
      <span>Audit</span>
    </button>
  );
}
```

**TDD:**
- Test: Toggle renders with correct state
- Test: Click calls onToggle with opposite value
- Test: Active state has blue styling

### Task 5: Wire to SuperGridEngine

**Files:** `src/d3/SuperGridEngine/index.ts`

**Implementation:**

```typescript
class SuperGridEngine {
  private auditRenderer: AuditRenderer;
  private auditState: AuditState = { enabled: false, showFormulas: false, recentChanges: new Map() };

  setAuditEnabled(enabled: boolean): void {
    this.auditState.enabled = enabled;
    this.render();
  }

  onCellChange(cellId: string, changeType: 'create' | 'update' | 'delete'): void {
    this.auditRenderer.trackChange(cellId, changeType);

    const selection = this.getCellSelection(cellId);
    if (selection) {
      this.auditRenderer.animateCRUDChange(selection, changeType);
    }
  }
}
```

## Files to Create/Modify

- `src/d3/SuperGridEngine/AuditRenderer.ts` — NEW
- `src/d3/SuperGridEngine/__tests__/AuditRenderer.test.ts` — NEW
- `src/components/supergrid/AuditToggle.tsx` — NEW
- `src/d3/SuperGridEngine/types.ts` — Add audit types
- `src/d3/SuperGridEngine/index.ts` — Wire AuditRenderer
- `src/d3/SuperGridEngine/Renderer.ts` — Call audit overlay

## Commit Sequence

```bash
# Commit 1: Audit types and renderer
feat(supergrid): add AuditRenderer with computed value tinting

# Commit 2: CRUD animations
feat(supergrid): implement CRUD flash animations on cell changes

# Commit 3: Toolbar toggle
feat(supergrid): add AuditToggle component to toolbar
```

## Verification Gates

| Test | Action | Pass Criteria |
|------|--------|---------------|
| Audit tinting | Enable audit, view computed cells | Blue/green/purple tints visible |
| Raw cells | Enable audit, view raw data | No tinting on raw cells |
| CRUD flash | Create new card | Green flash animation |
| Toggle | Click audit button | Tinting appears/disappears |
| Performance | Render 1000 cells with audit | < 16ms render time |
