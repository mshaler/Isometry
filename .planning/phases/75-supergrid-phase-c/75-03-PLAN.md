# Plan 75-03: SuperCards — Generated Header Cards

**Phase:** 75 (SuperGrid Phase C)
**Plan:** 03 of 04
**Status:** READY
**Priority:** P1 — Visual polish
**Estimated Effort:** 0.5 day

## Goal

Implement visually distinct header cards (SuperCards) and aggregation rows that show computed values at density boundaries.

## Requirements Covered

- CARD-01: Header cells have distinct chrome styling (muted background)
- CARD-02: Aggregation row renders at grid bottom
- CARD-03: Aggregation cells show COUNT by default
- CARD-04: SuperCards excluded from search results

## Current State

Headers render with basic styling. No aggregation rows. No visual distinction between header cards and data cards.

## Target State

```
┌───────────────────────────────────────────────┐
│ ░░░░░░░░░░ │ ░░░░░░░░░░ │ ░░░░░░░░░░ │       │
│ ░ Q1     ░ │ ░ Q2     ░ │ ░ Q3     ░ │       │  ← Chrome headers
│ ░░░░░░░░░░ │ ░░░░░░░░░░ │ ░░░░░░░░░░ │       │
├────────────┼────────────┼────────────┤       │
│   Card 1   │   Card 3   │   Card 5   │       │  ← Data cards
│   Card 2   │   Card 4   │            │       │
├────────────┼────────────┼────────────┼───────┤
│ ░ Count:2░ │ ░ Count:2░ │ ░ Count:1░ │ ░ 5 ░ │  ← Aggregation row
└────────────┴────────────┴────────────┴───────┘
```

## Tasks

### Task 1: Define SuperCard Types

**Files:** `src/d3/SuperGridEngine/types.ts`

**Implementation:**

```typescript
type CardType = 'data' | 'header' | 'aggregation';

interface SuperCard {
  id: string;
  type: CardType;
  // For header cards
  headerId?: string;
  headerLevel?: number;
  // For aggregation cards
  aggregationType?: 'count' | 'sum' | 'avg';
  aggregationValue?: number;
  // Common
  gridX: number;
  gridY: number;
  width: number;
  height: number;
}

function isSuperCard(card: SuperCard): boolean {
  return card.type === 'header' || card.type === 'aggregation';
}
```

**TDD:**
- Test: isSuperCard returns true for header type
- Test: isSuperCard returns true for aggregation type
- Test: isSuperCard returns false for data type

### Task 2: Create SuperCardRenderer

**Files:** `src/d3/SuperGridEngine/SuperCardRenderer.ts` (NEW)

**Implementation:**

```typescript
class SuperCardRenderer {
  private chromeGradient = {
    start: '#f8f8f8',
    end: '#e8e8e8'
  };

  renderHeaderCard(
    selection: d3.Selection<SVGGElement, SuperCard, SVGGElement, unknown>
  ): void {
    selection.select('rect.header-bg')
      .attr('fill', `url(#chrome-gradient)`)
      .attr('stroke', '#ccc')
      .attr('stroke-width', 1);

    // Add subtle shadow
    selection.select('rect.header-bg')
      .attr('filter', 'url(#header-shadow)');
  }

  renderAggregationCard(
    selection: d3.Selection<SVGGElement, SuperCard, SVGGElement, unknown>
  ): void {
    selection.select('rect.agg-bg')
      .attr('fill', '#f0f4f8')
      .attr('stroke', '#d0d8e0')
      .attr('stroke-width', 1);

    selection.select('text.agg-value')
      .attr('fill', '#4a5568')
      .attr('font-weight', 'bold')
      .text(d => `Count: ${d.aggregationValue}`);
  }

  createDefs(svg: d3.Selection<SVGSVGElement, unknown, null, undefined>): void {
    const defs = svg.append('defs');

    // Chrome gradient for headers
    const gradient = defs.append('linearGradient')
      .attr('id', 'chrome-gradient')
      .attr('x1', '0%').attr('y1', '0%')
      .attr('x2', '0%').attr('y2', '100%');

    gradient.append('stop')
      .attr('offset', '0%')
      .attr('stop-color', this.chromeGradient.start);

    gradient.append('stop')
      .attr('offset', '100%')
      .attr('stop-color', this.chromeGradient.end);

    // Header shadow filter
    const filter = defs.append('filter')
      .attr('id', 'header-shadow')
      .attr('x', '-10%').attr('y', '-10%')
      .attr('width', '120%').attr('height', '120%');

    filter.append('feDropShadow')
      .attr('dx', 0).attr('dy', 1)
      .attr('stdDeviation', 1)
      .attr('flood-opacity', 0.15);
  }
}
```

**TDD:**
- Test: Header card has gradient fill
- Test: Header card has shadow filter
- Test: Aggregation card shows count value
- Test: Defs are created in SVG

### Task 3: Generate Aggregation Row

**Files:** `src/d3/SuperGridEngine/AggregationManager.ts` (NEW)

**Implementation:**

```typescript
interface AggregationConfig {
  type: 'count' | 'sum' | 'avg';
  enabled: boolean;
}

class AggregationManager {
  private config: AggregationConfig = { type: 'count', enabled: true };

  generateAggregationRow(
    cells: CellDescriptor[],
    headers: HeaderDescriptor[]
  ): SuperCard[] {
    if (!this.config.enabled) return [];

    const aggregationCards: SuperCard[] = [];
    const maxGridY = Math.max(...cells.map(c => c.gridY)) + 1;

    // One aggregation card per column
    const columnGroups = this.groupByColumn(cells);

    for (const [gridX, columnCells] of columnGroups.entries()) {
      const count = columnCells.reduce((sum, c) => sum + c.nodeCount, 0);

      aggregationCards.push({
        id: `agg-${gridX}`,
        type: 'aggregation',
        aggregationType: 'count',
        aggregationValue: count,
        gridX,
        gridY: maxGridY,
        width: this.getColumnWidth(gridX, headers),
        height: 32  // Fixed aggregation row height
      });
    }

    // Total cell
    const total = cells.reduce((sum, c) => sum + c.nodeCount, 0);
    aggregationCards.push({
      id: 'agg-total',
      type: 'aggregation',
      aggregationType: 'count',
      aggregationValue: total,
      gridX: headers.length,
      gridY: maxGridY,
      width: 80,
      height: 32
    });

    return aggregationCards;
  }

  private groupByColumn(cells: CellDescriptor[]): Map<number, CellDescriptor[]>;
  private getColumnWidth(gridX: number, headers: HeaderDescriptor[]): number;
}
```

**TDD:**
- Test: Aggregation row has one cell per column
- Test: Count values match cell nodeCount sums
- Test: Total cell sums all columns
- Test: Disabled config returns empty array

### Task 4: Exclude SuperCards from Search

**Files:** `src/d3/SuperGridEngine/index.ts`

**Implementation:**

```typescript
// In search handler
handleSearch(query: string): SearchResult[] {
  const results = this.fts5Search(query);

  // Filter out SuperCard IDs
  return results.filter(r => {
    const card = this.getCardById(r.id);
    return card && !isSuperCard(card);
  });
}

// In card ID check
isSuperCardId(id: string): boolean {
  return id.startsWith('header-') || id.startsWith('agg-');
}
```

**TDD:**
- Test: Search results exclude header cards
- Test: Search results exclude aggregation cards
- Test: Data cards appear in search normally

## Files to Create/Modify

- `src/d3/SuperGridEngine/SuperCardRenderer.ts` — NEW
- `src/d3/SuperGridEngine/AggregationManager.ts` — NEW
- `src/d3/SuperGridEngine/__tests__/SuperCardRenderer.test.ts` — NEW
- `src/d3/SuperGridEngine/__tests__/AggregationManager.test.ts` — NEW
- `src/d3/SuperGridEngine/types.ts` — Add SuperCard types
- `src/d3/SuperGridEngine/Renderer.ts` — Use SuperCardRenderer
- `src/d3/SuperGridEngine/index.ts` — Wire managers, exclude from search

## Commit Sequence

```bash
# Commit 1: SuperCard types and renderer
feat(supergrid): add SuperCardRenderer with chrome header styling

# Commit 2: Aggregation row
feat(supergrid): generate aggregation row with column counts

# Commit 3: Search exclusion
feat(supergrid): exclude SuperCards from FTS5 search results
```

## Verification Gates

| Test | Action | Pass Criteria |
|------|--------|---------------|
| Header styling | Render grid | Headers have chrome gradient |
| Aggregation row | Render grid with data | Bottom row shows counts |
| Count accuracy | Check count vs data | Count = sum of nodeCount |
| Search exclusion | Search for header text | No SuperCards in results |
