# Plan 75-01: SuperFilter — Header Dropdown Filters

**Phase:** 75 (SuperGrid Phase C)
**Plan:** 01 of 04
**Status:** READY
**Priority:** P0 — Core filtering UX
**Estimated Effort:** 1 day

## Goal

Implement Excel-style auto-filter dropdowns on headers that compile to SQL WHERE clauses through the LATCH filter pipeline.

## Requirements Covered

- FILT-01: Click filter icon on header opens dropdown with unique values
- FILT-02: Checkbox selection filters grid to matching rows
- FILT-03: Multiple value selection uses OR logic
- FILT-04: Clear filter button restores all rows
- FILT-05: Active filter indicator visible on header

## Current State

ClickZoneManager detects header clicks but no filter dropdown exists. FilterProvider exists but is not connected to header UI.

## Target State

```
Click filter icon on "Status" header:
┌──────────────────────┐
│ ☐ Select All         │
│ ───────────────────  │
│ ☑ Active    (12)     │
│ ☑ Pending   (8)      │
│ ☐ Done      (25)     │
│ ☐ Blocked   (3)      │
│ ───────────────────  │
│ [Clear] [Apply]      │
└──────────────────────┘
          ↓
Grid shows only Active + Pending rows
Status header shows filter indicator (funnel icon)
```

## Tasks

### Task 1: Create FilterManager

**Files:** `src/d3/SuperGridEngine/FilterManager.ts` (NEW)

**Implementation:**

```typescript
interface HeaderFilter {
  headerId: string;
  axis: LATCHAxis;
  facet: string;
  selectedValues: Set<string>;
  allValues: string[];
}

interface FilterManagerState {
  activeFilters: Map<string, HeaderFilter>;
  openDropdownId: string | null;
}

class FilterManager {
  private state: FilterManagerState;
  private onFilterChange: (filters: HeaderFilter[]) => void;

  getUniqueValues(headerId: string, cells: CellDescriptor[]): string[];
  openDropdown(headerId: string, position: { x: number; y: number }): void;
  closeDropdown(): void;
  toggleValue(headerId: string, value: string): void;
  selectAll(headerId: string): void;
  clearFilter(headerId: string): void;
  applyFilter(headerId: string): void;
  hasActiveFilter(headerId: string): boolean;
}
```

**TDD:**
- Test: getUniqueValues extracts distinct values from cells
- Test: toggleValue adds/removes from selectedValues set
- Test: clearFilter resets to all selected
- Test: hasActiveFilter returns true when not all values selected

### Task 2: Implement Filter Dropdown Component

**Files:** `src/d3/SuperGridEngine/FilterDropdown.ts` (NEW)

**Implementation:**

```typescript
class FilterDropdown {
  private container: d3.Selection<HTMLDivElement, unknown, null, undefined>;
  private filterManager: FilterManager;

  render(
    headerId: string,
    position: { x: number; y: number },
    uniqueValues: Array<{ value: string; count: number }>
  ): void {
    // Create positioned dropdown container
    this.container = d3.select('body')
      .append('div')
      .attr('class', 'supergrid-filter-dropdown')
      .style('position', 'fixed')
      .style('left', `${position.x}px`)
      .style('top', `${position.y}px`);

    // Render select all
    this.renderSelectAll();

    // Render value checkboxes with counts
    this.renderValueList(uniqueValues);

    // Render action buttons
    this.renderActions();
  }

  private renderValueList(values: Array<{ value: string; count: number }>): void;
  private renderSelectAll(): void;
  private renderActions(): void;
  destroy(): void;
}
```

**TDD:**
- Test: Dropdown renders at specified position
- Test: Checkbox click toggles value selection
- Test: Clear button resets selection
- Test: Apply button closes dropdown and triggers filter

### Task 3: Wire to ClickZoneManager

**Files:** `src/d3/SuperGridEngine/ClickZoneManager.ts`

**Implementation:**

```typescript
// Add filter-icon zone detection
getZone(event: MouseEvent, header: HeaderDescriptor): ClickZone {
  const rect = this.getHeaderRect(header);
  const relativeX = event.clientX - rect.left;
  const relativeY = event.clientY - rect.top;

  // Filter icon is 16x16 in top-right corner, 4px from edges
  const filterIconRect = {
    left: rect.width - 20,
    top: 4,
    width: 16,
    height: 16
  };

  if (this.isInRect(relativeX, relativeY, filterIconRect)) {
    return { zone: 'filter-icon', header };
  }

  // ... existing zone detection
}
```

**TDD:**
- Test: Filter icon click detected in top-right corner
- Test: Non-filter area clicks return existing zones
- Test: Filter zone only active on leaf headers

### Task 4: Render Filter Icon on Headers

**Files:** `src/d3/SuperGridEngine/Renderer.ts`

**Implementation:**

```typescript
function renderFilterIcon(
  headerGroup: d3.Selection<SVGGElement, HeaderDescriptor, SVGGElement, unknown>,
  filterManager: FilterManager
) {
  const icon = headerGroup.selectAll('.filter-icon')
    .data(d => [d])
    .join('g')
    .attr('class', 'filter-icon')
    .attr('transform', d => `translate(${d.position.width - 20}, 4)`);

  // Funnel icon path
  icon.selectAll('path')
    .data(d => [d])
    .join('path')
    .attr('d', 'M0,0 L12,0 L8,6 L8,10 L4,12 L4,6 Z')
    .attr('fill', d => filterManager.hasActiveFilter(d.id) ? '#3B82F6' : '#999')
    .attr('cursor', 'pointer');
}
```

**TDD:**
- Test: Filter icon renders on each header
- Test: Active filter changes icon color to blue
- Test: Icon click opens dropdown

### Task 5: Compile to FilterProvider

**Files:** `src/d3/SuperGridEngine/FilterManager.ts`, `src/state/FilterContext.tsx`

**Implementation:**

```typescript
// In FilterManager
function compileHeaderFiltersToLATCH(
  headerFilters: HeaderFilter[]
): LATCHFilter[] {
  return headerFilters.map(hf => ({
    axis: hf.axis,
    facet: hf.facet,
    operator: 'in',
    values: Array.from(hf.selectedValues)
  }));
}

// Wire to FilterProvider
onFilterChange(filters: HeaderFilter[]) {
  const latchFilters = compileHeaderFiltersToLATCH(filters);
  filterProvider.setFilters(latchFilters);
}
```

**TDD:**
- Test: Single value filter compiles to WHERE axis = 'value'
- Test: Multiple values compile to WHERE axis IN ('v1', 'v2')
- Test: Clear filter removes WHERE clause
- Test: Grid re-renders with filtered data

## Files to Create/Modify

- `src/d3/SuperGridEngine/FilterManager.ts` — NEW
- `src/d3/SuperGridEngine/FilterDropdown.ts` — NEW
- `src/d3/SuperGridEngine/__tests__/FilterManager.test.ts` — NEW
- `src/d3/SuperGridEngine/ClickZoneManager.ts` — Add filter-icon zone
- `src/d3/SuperGridEngine/Renderer.ts` — Add filter icon rendering
- `src/d3/SuperGridEngine/index.ts` — Wire FilterManager

## Commit Sequence

```bash
# Commit 1: FilterManager core
feat(supergrid): add FilterManager with unique value extraction

# Commit 2: Dropdown UI
feat(supergrid): implement filter dropdown with checkbox selection

# Commit 3: Header integration
feat(supergrid): render filter icons on headers with active indicator

# Commit 4: FilterProvider wiring
feat(supergrid): compile header filters to LATCH WHERE clauses
```

## Verification Gates

| Test | Action | Pass Criteria |
|------|--------|---------------|
| Open dropdown | Click filter icon | Dropdown appears with values |
| Select values | Check Active, Pending | Only those rows visible |
| Clear filter | Click Clear | All rows visible |
| Multiple filters | Filter Status AND Category | Combined WHERE clause |
| Active indicator | Apply filter | Blue funnel icon |
