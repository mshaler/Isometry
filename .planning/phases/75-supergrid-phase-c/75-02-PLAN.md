# Plan 75-02: SuperSort — Enhanced Multi-Sort

**Phase:** 75 (SuperGrid Phase C)
**Plan:** 02 of 04
**Status:** READY
**Priority:** P1 — Essential UX
**Estimated Effort:** 0.5 day

## Goal

Enhance existing sort functionality with multi-sort capability (Shift+click) and visual sort indicators showing sort direction and priority.

## Requirements Covered

- SORT-01: Click header sorts ascending, click again descending, third click clears
- SORT-02: Sort indicator (arrow) visible on sorted column
- SORT-03: Shift+click adds secondary sort level
- SORT-04: Sort priority badges (1, 2, 3) for multi-sort

## Current State

Basic sort exists via header click (from Phase 60). Single sort with toggle cycle. No visual indicators beyond basic styling.

## Target State

```
Single sort:
┌────────┬────────┬────────┐
│ Name   │ Status↑│ Date   │  ← Arrow indicates sort direction
└────────┴────────┴────────┘

Multi-sort (Shift+click Date after Status):
┌────────┬────────┬────────┐
│ Name   │ Status↑│ Date↓  │
│        │   ①    │   ②    │  ← Priority badges
└────────┴────────┴────────┘

SQL: ORDER BY status ASC, date DESC
```

## Tasks

### Task 1: Enhance SortState for Multi-Sort

**Files:** `src/d3/SuperGridEngine/types.ts`, `src/contexts/PAFVContext.tsx`

**Implementation:**

```typescript
interface SortLevel {
  headerId: string;
  axis: LATCHAxis;
  facet: string;
  direction: 'asc' | 'desc';
  priority: number;  // 1 = primary, 2 = secondary, etc.
}

interface MultiSortState {
  levels: SortLevel[];
  maxLevels: number;  // Default 3
}

// In PAFVContext
interface PAFVContextValue {
  // ... existing
  sortState: MultiSortState;
  toggleSort(headerId: string, addLevel: boolean): void;
  clearAllSorts(): void;
}
```

**TDD:**
- Test: toggleSort with addLevel=false replaces existing sort
- Test: toggleSort with addLevel=true appends new level
- Test: Max 3 sort levels enforced
- Test: Same header toggles through asc → desc → clear

### Task 2: Create SortManager

**Files:** `src/d3/SuperGridEngine/SortManager.ts` (NEW)

**Implementation:**

```typescript
class SortManager {
  private state: MultiSortState = { levels: [], maxLevels: 3 };

  handleHeaderClick(
    headerId: string,
    axis: LATCHAxis,
    facet: string,
    isShiftHeld: boolean
  ): MultiSortState {
    const existing = this.state.levels.find(l => l.headerId === headerId);

    if (existing) {
      // Toggle direction or clear
      if (existing.direction === 'asc') {
        existing.direction = 'desc';
      } else {
        // Remove this level
        this.state.levels = this.state.levels.filter(l => l.headerId !== headerId);
        this.renumberPriorities();
      }
    } else if (isShiftHeld && this.state.levels.length < this.state.maxLevels) {
      // Add new level
      this.state.levels.push({
        headerId,
        axis,
        facet,
        direction: 'asc',
        priority: this.state.levels.length + 1
      });
    } else {
      // Replace all with single sort
      this.state.levels = [{
        headerId,
        axis,
        facet,
        direction: 'asc',
        priority: 1
      }];
    }

    return this.state;
  }

  private renumberPriorities(): void;
  compileToSQL(): string;  // "ORDER BY status ASC, date DESC"
  getSortLevel(headerId: string): SortLevel | undefined;
}
```

**TDD:**
- Test: Single click replaces all sorts with new primary
- Test: Shift+click adds secondary sort
- Test: Third click on sorted header clears it
- Test: compileToSQL generates correct ORDER BY

### Task 3: Render Sort Indicators

**Files:** `src/d3/SuperGridEngine/Renderer.ts`

**Implementation:**

```typescript
function renderSortIndicator(
  headerGroup: d3.Selection<SVGGElement, HeaderDescriptor, SVGGElement, unknown>,
  sortManager: SortManager
) {
  headerGroup.each(function(d) {
    const sortLevel = sortManager.getSortLevel(d.id);
    const group = d3.select(this);

    // Remove existing indicators
    group.selectAll('.sort-indicator').remove();

    if (!sortLevel) return;

    const indicator = group.append('g')
      .attr('class', 'sort-indicator')
      .attr('transform', `translate(${d.position.width - 40}, 8)`);

    // Arrow
    indicator.append('path')
      .attr('d', sortLevel.direction === 'asc'
        ? 'M0,8 L4,0 L8,8'  // Up arrow
        : 'M0,0 L4,8 L8,0'  // Down arrow
      )
      .attr('fill', '#3B82F6')
      .attr('stroke', 'none');

    // Priority badge for multi-sort
    if (sortManager.state.levels.length > 1) {
      indicator.append('circle')
        .attr('cx', 14)
        .attr('cy', 4)
        .attr('r', 6)
        .attr('fill', '#3B82F6');

      indicator.append('text')
        .attr('x', 14)
        .attr('y', 7)
        .attr('text-anchor', 'middle')
        .attr('fill', 'white')
        .attr('font-size', '9px')
        .text(sortLevel.priority);
    }
  });
}
```

**TDD:**
- Test: Arrow renders for sorted column
- Test: Arrow direction matches sort direction
- Test: Priority badge shows for multi-sort
- Test: No indicator for unsorted columns

### Task 4: Wire to Click Handler

**Files:** `src/d3/SuperGridEngine/index.ts`

**Implementation:**

```typescript
handleHeaderClick(event: MouseEvent, header: HeaderDescriptor) {
  const zone = this.clickZoneManager.hitTest(event);

  if (zone.zone === 'parent-label' || zone.zone === 'leaf-label') {
    // Sort on label click
    const newState = this.sortManager.handleHeaderClick(
      header.id,
      header.axis,
      header.facet,
      event.shiftKey
    );

    // Update context and re-render
    this.pafvContext.setSortState(newState);
    this.requery();
  }
}
```

**TDD:**
- Test: Click without Shift replaces sort
- Test: Click with Shift adds sort level
- Test: Grid re-queries with new ORDER BY

## Files to Create/Modify

- `src/d3/SuperGridEngine/SortManager.ts` — NEW
- `src/d3/SuperGridEngine/__tests__/SortManager.test.ts` — NEW
- `src/d3/SuperGridEngine/types.ts` — Add MultiSortState
- `src/d3/SuperGridEngine/Renderer.ts` — Add sort indicators
- `src/d3/SuperGridEngine/index.ts` — Wire SortManager
- `src/contexts/PAFVContext.tsx` — Add sortState to context

## Commit Sequence

```bash
# Commit 1: SortManager with multi-sort
feat(supergrid): add SortManager with multi-level sort support

# Commit 2: Visual indicators
feat(supergrid): render sort arrows and priority badges

# Commit 3: Shift+click integration
feat(supergrid): wire Shift+click for secondary sort levels
```

## Verification Gates

| Test | Action | Pass Criteria |
|------|--------|---------------|
| Single sort | Click Status header | Rows sorted, arrow visible |
| Toggle direction | Click again | Arrow flips, order reverses |
| Clear sort | Click third time | No indicator, original order |
| Multi-sort | Shift+click Date | Both sorted, badges show 1, 2 |
| SQL generation | Apply multi-sort | ORDER BY has both columns |
