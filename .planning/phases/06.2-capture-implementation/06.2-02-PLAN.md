---
phase: 06.2-capture-implementation
plan: 02
type: execute
wave: 2
depends_on: ["06.2-01"]
files_modified: [
  "native/Sources/Isometry/Views/Notebook/PropertyEditor.swift",
  "native/Sources/Isometry/Views/Notebook/PropertyField.swift",
  "native/Sources/Isometry/Models/NotebookPropertyModel.swift",
  "native/Sources/Isometry/Views/Notebook/NotebookCaptureView.swift"
]
autonomous: true

must_haves:
  truths:
    - "User can view card properties in collapsible panel"
    - "User can edit text, date, and tag properties with native controls"
    - "Property changes save automatically to CloudKit"
    - "Property validation prevents invalid data entry"
  artifacts:
    - path: "native/Sources/Isometry/Views/Notebook/PropertyEditor.swift"
      provides: "SwiftUI form with property field rendering"
      min_lines: 80
    - path: "native/Sources/Isometry/Views/Notebook/PropertyField.swift"
      provides: "Generic property field component with type-specific rendering"
      exports: ["PropertyField", "PropertyType"]
    - path: "native/Sources/Isometry/Models/NotebookPropertyModel.swift"
      provides: "Property management with validation and CloudKit sync"
      exports: ["NotebookPropertyModel", "PropertyValidation"]
  key_links:
    - from: "native/Sources/Isometry/Views/Notebook/NotebookCaptureView.swift"
      to: "PropertyEditor"
      via: "collapsible panel integration"
      pattern: "PropertyEditor.*showingProperties"
    - from: "native/Sources/Isometry/Models/NotebookPropertyModel.swift"
      to: "IsometryDatabase.updateNotebookCard"
      via: "property change trigger"
      pattern: "updateNotebookCard.*properties"
---

<objective>
Implement native property management interface that provides type-safe property editing with CloudKit integration and validation

Purpose: Enable rich metadata editing through native SwiftUI forms while maintaining data consistency and sync reliability
Output: Collapsible property panel integrated into NotebookCaptureView with full CRUD operations
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06.1-foundation-layout/06.1-02-SUMMARY.md
@.planning/phases/06.2-capture-implementation/06.2-01-PLAN.md
@native/Sources/Isometry/Models/NotebookCard.swift
@src/components/notebook/PropertyEditor.tsx
@src/types/notebook.ts
</context>

<tasks>

<task type="auto">
  <name>Create Property Management Model</name>
  <files>native/Sources/Isometry/Models/NotebookPropertyModel.swift</files>
  <action>
    Create ObservableObject for property state management and validation:

    1. Define property types matching React prototype:
       - PropertyType enum: text, number, date, boolean, select, tags, reference
       - PropertyValue: Union type for type-safe value storage
       - PropertyDefinition: Schema for property configuration
    2. Implement NotebookPropertyModel with:
       - @Published properties: [String: PropertyValue]
       - @Published isDirty: Bool (unsaved property changes)
       - @Published validationErrors: [String: String]
       - activeCard: NotebookCard? (current editing context)
    3. Add property operations:
       - updateProperty(key, value) -> validates and updates
       - removeProperty(key) -> removes with confirmation
       - addProperty(key, type) -> adds new property
       - validateProperties() -> runs all validation rules
    4. Implement validation system:
       - Required field validation
       - Type-specific validation (email format, number ranges)
       - Cross-field validation (start date < end date)
       - User feedback for validation errors
    5. Add CloudKit integration:
       - Automatic save with debouncing (1-second delay)
       - Conflict resolution for concurrent property edits
       - Use existing IsometryDatabase.updateNotebookCard
       - Handle sync errors gracefully
    6. State management best practices:
       - MainActor conformance for UI updates
       - Combine subscription management
       - Memory cleanup for property change subscriptions

    Pattern: Follow React PropertyEditor.tsx validation and state patterns.
    Integration: Use existing NotebookCard property storage format.
  </action>
  <verify>Model compiles with property validation and CloudKit integration</verify>
  <done>NotebookPropertyModel provides complete property management with type-safe validation</done>
</task>

<task type="auto">
  <name>Create Property Field Components</name>
  <files>native/Sources/Isometry/Views/Notebook/PropertyField.swift</files>
  <action>
    Create reusable property field components for different data types:

    1. Implement PropertyField struct with:
       - Generic property field container with label and validation
       - Type-specific field rendering based on PropertyType
       - Binding integration with NotebookPropertyModel
       - Error state display with user feedback
    2. Create field type components:
       - TextPropertyField: TextField with character limits and validation
       - NumberPropertyField: TextField with numeric keyboard and validation
       - DatePropertyField: DatePicker with range constraints
       - BooleanPropertyField: Toggle with proper labeling
       - SelectPropertyField: Picker with predefined options
       - TagsPropertyField: Chip-style tag editor with auto-completion
       - ReferencePropertyField: Searchable picker for node references
    3. Implement field validation UI:
       - Real-time validation with error highlighting
       - Error message display below fields
       - Success indicators for valid fields
       - Accessible error announcement for screen readers
    4. Add field enhancements:
       - Placeholder text and help hints
       - Field focus management and tab order
       - Copy/paste support for appropriate fields
       - Undo/redo integration where applicable
    5. Style integration:
       - Match existing app theme and color system
       - Consistent spacing and typography
       - Focus indicators matching platform conventions
       - Dark/light theme support

    Pattern: Factory pattern for field type rendering, similar to React field factories.
    Accessibility: Full VoiceOver and accessibility support for all field types.
  </action>
  <verify>All property field types render with proper validation and theme integration</verify>
  <done>PropertyField components provide type-safe property editing with native SwiftUI controls</done>
</task>

<task type="auto">
  <name>Create Property Editor Interface</name>
  <files>native/Sources/Isometry/Views/Notebook/PropertyEditor.swift</files>
  <action>
    Create main property editing interface with form layout and operations:

    1. Implement PropertyEditor struct with:
       - ScrollView container for property list
       - Add/remove property controls
       - Property search and filtering
       - Bulk property operations (copy, paste, clear)
    2. Create property management UI:
       - Property list with drag-to-reorder support
       - Add property button with type selection menu
       - Remove property with swipe-to-delete gesture
       - Property search field with real-time filtering
    3. Add property organization features:
       - Property grouping by category (user-defined sections)
       - Favorite properties for quick access
       - Recent property types for faster addition
       - Property templates for common property sets
    4. Implement validation and feedback:
       - Form-level validation with summary
       - Save status indicators and progress
       - Batch validation for multiple properties
       - User confirmation for destructive operations
    5. Add advanced features:
       - Property history and change tracking
       - Property export/import for sharing
       - Bulk property operations across cards
       - Property analytics and usage insights
    6. Performance optimizations:
       - Lazy loading for large property lists
       - Debounced validation to prevent excessive checks
       - Efficient property change diffing
       - Memory management for property value storage

    Pattern: Follow React PropertyEditor.tsx layout and organization patterns.
    UX: Focus on rapid property editing workflow with minimal friction.
  </action>
  <verify>Property editor renders complete interface with add/edit/remove functionality</verify>
  <done>PropertyEditor provides comprehensive property management interface with validation and organization</done>
</task>

<task type="auto">
  <name>Integrate Properties into Capture View</name>
  <files>native/Sources/Isometry/Views/Notebook/NotebookCaptureView.swift</files>
  <action>
    Integrate PropertyEditor into NotebookCaptureView with collapsible panel design:

    1. Add property state management:
       - @StateObject var propertyModel = NotebookPropertyModel()
       - @State var showingProperties = false
       - Property count badge and expansion state
    2. Implement collapsible panel UI:
       - Expandable section at bottom of capture view
       - Property count indicator in collapse header
       - Smooth expand/collapse animations
       - Panel height management and scrolling
    3. Connect with editor state:
       - Load properties when activeCard changes
       - Sync property model with editor model
       - Handle property changes while editing text
       - Maintain property state during card switches
    4. Add property panel controls:
       - Toggle button in capture header
       - Property count badge with live updates
       - Quick property actions (add, clear, export)
       - Panel resize handle for user customization
    5. Implement system property display:
       - Card metadata (ID, created, modified)
       - Read-only system properties section
       - Card type and template information
       - Sync status and conflict indicators
    6. Handle panel interactions:
       - Keyboard shortcuts for property panel toggle
       - Focus management between editor and properties
       - Property panel state persistence
       - Accessibility support for panel navigation

    Pattern: Match React CaptureComponent.tsx collapsible properties panel.
    Integration: Seamless connection between text editing and property management.
  </action>
  <verify>Properties panel integrates seamlessly with capture view and shows property count badge</verify>
  <done>Property management fully integrated into NotebookCaptureView with collapsible panel and system properties</done>
</task>

</tasks>

<verification>
1. Properties panel expands/collapses with smooth animation
2. Property fields validate input and show error states
3. Property changes save automatically with CloudKit sync
4. Property count badge updates in real-time
5. System properties display card metadata correctly
</verification>

<success_criteria>
1. User can view and edit all property types through native controls
2. Property validation prevents invalid data with clear feedback
3. Properties save automatically with visual confirmation
4. Property panel integrates seamlessly with text editor workflow
5. CloudKit sync handles property changes reliably
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-capture-implementation/06.2-02-SUMMARY.md`
</output>