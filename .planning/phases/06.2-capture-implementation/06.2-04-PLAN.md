---
phase: 06.2-capture-implementation
plan: 04
type: execute
wave: 2
depends_on: ["06.2-01"]
files_modified: [
  "native/Sources/Isometry/Views/Notebook/SlashCommandMenu.swift",
  "native/Sources/Isometry/Models/SlashCommandManager.swift",
  "native/Sources/Isometry/Views/Notebook/MarkdownEditor.swift",
  "native/Sources/Isometry/Models/NotebookEditorModel.swift"
]
autonomous: true

must_haves:
  truths:
    - "User can trigger slash command menu by typing '/' in editor"
    - "User can select commands using keyboard navigation"
    - "Commands insert properly formatted Isometry DSL patterns"
    - "Command suggestions adapt to current context and content"
  artifacts:
    - path: "native/Sources/Isometry/Views/Notebook/SlashCommandMenu.swift"
      provides: "Native overlay menu for command selection"
      min_lines: 80
    - path: "native/Sources/Isometry/Models/SlashCommandManager.swift"
      provides: "Command detection, filtering, and execution"
      exports: ["SlashCommandManager", "SlashCommand"]
    - path: "native/Sources/Isometry/Views/Notebook/MarkdownEditor.swift"
      provides: "Text editor with slash command integration"
      contains: "textDidChange.*slashCommand"
  key_links:
    - from: "native/Sources/Isometry/Views/Notebook/MarkdownEditor.swift"
      to: "SlashCommandManager"
      via: "text change detection for '/' trigger"
      pattern: "textDidChange.*commandDetection"
    - from: "native/Sources/Isometry/Models/SlashCommandManager.swift"
      to: "MarkdownEditor text insertion"
      via: "command execution callback"
      pattern: "insertText.*command.*execution"
---

<objective>
Port React slash command system to native using NSTextView/UITextView input methods for Isometry DSL pattern insertion

Purpose: Provide rapid access to Isometry DSL patterns and templates through native text completion interface
Output: Slash command system integrated into native markdown editor with keyboard navigation
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-capture-implementation/02-SUMMARY.md
@.planning/phases/06.2-capture-implementation/06.2-01-PLAN.md
@src/hooks/useSlashCommands.ts
@src/components/notebook/CaptureComponent.tsx
@native/Sources/Isometry/Views/Notebook/MarkdownEditor.swift
</context>

<tasks>

<task type="auto">
  <name>Create Slash Command Model and Manager</name>
  <files>native/Sources/Isometry/Models/SlashCommandManager.swift</files>
  <action>
    Create slash command detection, filtering, and execution system:

    1. Define SlashCommand struct with:
       - id: String (unique identifier)
       - label: String (display name)
       - description: String (help text)
       - category: CommandCategory (isometry, template, format)
       - shortcut: String (quick trigger like 'pafv')
       - content: String (template content to insert)
       - cursorOffset: Int (cursor position after insertion)
    2. Implement CommandCategory enum:
       - isometry (PAFV, LATCH, GRAPH patterns)
       - template (meeting, code, project snippets)
       - format (headers, lists, code blocks)
    3. Create SlashCommandManager ObservableObject with:
       - @Published isMenuVisible: Bool
       - @Published filteredCommands: [SlashCommand]
       - @Published selectedIndex: Int
       - @Published menuPosition: CGPoint
       - currentQuery: String (user search input)
    4. Implement built-in command library (matching React prototype):
       - /pafv → PAFV query template with planes/axes/facets/values
       - /latch → LATCH filter with location/alphabet/time/category/hierarchy
       - /meeting → Meeting template with agenda/attendees/actions
       - /code → Code snippet with language and description
       - /todo → Task list with checkboxes
       - /table → Markdown table template
       - /graph → GRAPH connection pattern
       - /retrospective → Retro template with sections
    5. Add command detection and filtering:
       - detectSlashCommand(text, cursor) -> finds '/' trigger
       - filterCommands(query) -> fuzzy search with ranking
       - getCommandAtIndex(index) -> selection management
       - executeCommand(command, context) -> text insertion
    6. Implement context awareness:
       - Analyze surrounding text for relevant suggestions
       - Suggest commands based on current card properties
       - Learn from user command usage patterns
       - Provide contextual command variations

    Pattern: Port React useSlashCommands.ts functionality to native Swift.
    Performance: Efficient fuzzy search with results ranking and caching.
  </action>
  <verify>SlashCommandManager detects commands and provides fuzzy filtering</verify>
  <done>SlashCommandManager provides complete command detection, filtering, and execution</done>
</task>

<task type="auto">
  <name>Create Slash Command Menu Interface</name>
  <files>native/Sources/Isometry/Views/Notebook/SlashCommandMenu.swift</files>
  <action>
    Create native overlay menu for command selection and navigation:

    1. Implement SlashCommandMenu struct with:
       - Overlay positioning relative to cursor
       - Command list with search results
       - Keyboard navigation support
       - Visual feedback for selection state
    2. Create menu layout:
       - Floating overlay with background blur/shadow
       - Header with search query and help text
       - Scrollable command list with category grouping
       - Footer with navigation instructions
    3. Add command list items:
       - Command name and description display
       - Category icons and color coding
       - Shortcut text display for quick access
       - Selection highlighting with animation
    4. Implement keyboard navigation:
       - Arrow keys for command selection
       - Enter key for command execution
       - Escape key for menu dismissal
       - Tab key for command completion
    5. Add accessibility support:
       - VoiceOver announcements for command selection
       - Voice control integration for command names
       - High contrast mode support
       - Reduced motion support for animations
    6. Style integration:
       - Match existing app overlay patterns
       - Theme support (light/dark modes)
       - Consistent typography and spacing
       - Platform-appropriate menu styling
    7. Performance optimizations:
       - Efficient command list rendering
       - Smooth animation performance
       - Optimal overlay positioning calculations
       - Memory management for menu lifecycle

    Pattern: Native overlay menu similar to Xcode autocompletion or system text suggestions.
    UX: Minimal, focused interface that doesn't interrupt typing flow.
  </action>
  <verify>Command menu renders with proper positioning, navigation, and styling</verify>
  <done>SlashCommandMenu provides native overlay interface with keyboard navigation and accessibility</done>
</task>

<task type="auto">
  <name>Integrate Slash Commands into Markdown Editor</name>
  <files>native/Sources/Isometry/Views/Notebook/MarkdownEditor.swift</files>
  <action>
    Integrate slash command detection and menu into existing markdown editor:

    1. Add slash command state to editor coordinator:
       - SlashCommandManager instance
       - Text change monitoring for '/' detection
       - Cursor position tracking for menu positioning
       - Command execution callback handling
    2. Implement text change detection:
       - Monitor textDidChange for '/' character
       - Extract query text following '/'
       - Calculate cursor position for menu placement
       - Handle command menu visibility state
    3. Add keyboard event handling:
       - Intercept arrow keys when menu is visible
       - Handle Enter key for command execution
       - Handle Escape key for menu dismissal
       - Pass through normal typing when menu hidden
    4. Implement command execution:
       - Replace '/' and query with command content
       - Position cursor according to command specification
       - Dismiss menu after successful execution
       - Handle command execution errors gracefully
    5. Add menu positioning:
       - Calculate cursor position in text view coordinates
       - Account for scroll position and view bounds
       - Ensure menu stays within visible area
       - Handle text view resizing and orientation changes
    6. Integrate with existing editor features:
       - Maintain syntax highlighting during command insertion
       - Preserve undo/redo functionality
       - Handle auto-save triggers after command insertion
       - Maintain editor focus and selection state
    7. Performance considerations:
       - Efficient text change monitoring
       - Optimal menu positioning calculations
       - Smooth menu show/hide animations
       - Memory management for command state

    Pattern: Extend existing MarkdownEditor coordinator with command functionality.
    Integration: Seamless command system that enhances rather than disrupts typing.
  </action>
  <verify>Editor detects slash commands, shows menu, and handles command execution</verify>
  <done>MarkdownEditor integrates slash command system with text change detection and execution</done>
</task>

<task type="auto">
  <name>Connect Slash Commands to Editor Model</name>
  <files>native/Sources/Isometry/Models/NotebookEditorModel.swift</files>
  <action>
    Integrate slash command system with editor state management and auto-save:

    1. Add slash command support to editor model:
       - commandManager: SlashCommandManager property
       - isCommandMenuVisible: Published property
       - selectedCommand: Published property for UI binding
    2. Implement command context awareness:
       - analyzeCurrentContext() -> examines surrounding text
       - getContextualSuggestions() -> provides relevant commands
       - updateCommandContext() -> refreshes based on cursor position
       - handleCommandInsertion() -> manages post-insertion state
    3. Add command execution handling:
       - executeSlashCommand(command) -> processes command insertion
       - handleCommandContent(content) -> inserts and formats text
       - triggerAutoSave() -> saves after command execution
       - updateEditorState() -> refreshes editor after insertion
    4. Implement command history and analytics:
       - Track frequently used commands for suggestions
       - Store command usage patterns for improvements
       - Provide command recommendation engine
       - Export command usage analytics
    5. Add error handling and validation:
       - Validate command content before insertion
       - Handle command execution failures gracefully
       - Provide user feedback for command errors
       - Rollback functionality for failed commands
    6. Integrate with existing editor features:
       - Coordinate with auto-save system
       - Maintain dirty state tracking
       - Preserve editor focus and selection
       - Handle concurrent editing operations
    7. Performance optimizations:
       - Efficient command context analysis
       - Debounced command suggestion updates
       - Optimal command execution performance
       - Memory management for command history

    Pattern: Extend existing NotebookEditorModel with command functionality.
    State: Maintain consistent editor state during command operations.
  </action>
  <verify>Editor model handles command execution and maintains proper state management</verify>
  <done>NotebookEditorModel integrates slash command system with auto-save and state management</done>
</task>

</tasks>

<verification>
1. Typing '/' in editor triggers command menu
2. Arrow keys navigate command selection properly
3. Enter key executes selected command and inserts content
4. Command menu dismisses with Escape key
5. Commands insert proper Isometry DSL patterns
</verification>

<success_criteria>
1. User can trigger slash commands by typing '/' in native text editor
2. Command menu provides keyboard navigation matching platform conventions
3. Command execution inserts properly formatted content with cursor positioning
4. Command system integrates seamlessly with auto-save and editor state
5. Built-in commands provide access to key Isometry DSL patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-capture-implementation/06.2-04-SUMMARY.md`
</output>