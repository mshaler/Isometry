---
phase: 98-isometry-embeds
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/notebook/editor/extensions/EmbedExtension.ts
  - src/components/notebook/editor/nodes/EmbedNode.tsx
  - src/components/notebook/editor/extensions/slash-commands.ts
  - src/components/notebook/editor/extensions/index.ts
autonomous: true

must_haves:
  truths:
    - "User can type /supergrid and see live SuperGrid in document"
    - "User can type /network and see live force graph in document"
    - "User can type /timeline and see live timeline in document"
  artifacts:
    - path: "src/components/notebook/editor/extensions/EmbedExtension.ts"
      provides: "TipTap Node extension for Isometry embeds"
      exports: ["EmbedExtension"]
    - path: "src/components/notebook/editor/nodes/EmbedNode.tsx"
      provides: "React NodeView renderer for embed visualization"
      exports: ["EmbedNode"]
  key_links:
    - from: "slash-commands.ts"
      to: "EmbedExtension"
      via: "setEmbed command"
      pattern: "setEmbed.*type.*supergrid"
    - from: "EmbedNode.tsx"
      to: "SuperGridEngine"
      via: "dynamic import"
      pattern: "SuperGridEngine|ForceGraphRenderer|TimelineRenderer"
---

<objective>
Create the core Isometry embed infrastructure: TipTap extension, React NodeView, and slash command integration.

Purpose: Enable users to embed live D3.js visualizations (SuperGrid, Network, Timeline) directly in their documents. This is the keystone feature of Phase 98 - bringing Isometry's PAFV data projections into the writing surface.

Output: Working /supergrid, /network, /timeline slash commands that insert live visualization embeds
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/notebook/editor/extensions/BookmarkExtension.ts
@src/components/notebook/editor/nodes/BookmarkNode.tsx
@src/components/notebook/editor/extensions/CalloutExtension.ts
@src/components/notebook/editor/extensions/slash-commands.ts
@src/d3/SuperGridEngine/index.ts
@src/d3/visualizations/network/ForceGraphRenderer.ts
@src/d3/visualizations/timeline/TimelineRenderer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EmbedExtension TipTap Node</name>
  <files>
    src/components/notebook/editor/extensions/EmbedExtension.ts
    src/components/notebook/editor/extensions/embed-types.ts
  </files>
  <action>
Create TipTap Node extension following BookmarkExtension pattern:

1. Create `embed-types.ts` with shared types:
   - `EmbedType = 'supergrid' | 'network' | 'timeline'`
   - `EmbedAttributes { type: EmbedType, filter?: string, width?: number, height?: number }`
   - Default dimensions: { width: 600, height: 400 }

2. Create `EmbedExtension.ts`:
   - Node.create with name: 'embed', group: 'block', atom: true
   - Attributes: type, filter (LATCH filter string), width, height
   - Use ReactNodeViewRenderer(EmbedNode)
   - Add command `setEmbed(type: EmbedType, filter?: string)`
   - parseHTML: `div[data-embed]` with data-type attribute
   - renderHTML: data-embed, data-type, data-filter attributes

Key patterns from BookmarkExtension to follow:
- atom: true (non-editable inline content)
- mergeAttributes for proper HTML serialization
- Commands interface declaration

Do NOT add shouldRerenderOnTransaction yet - that's Task 2.
  </action>
  <verify>
TypeScript compiles: `npm run typecheck`
Extension exports: grep for "export const EmbedExtension"
  </verify>
  <done>
EmbedExtension.ts exists with proper TipTap Node structure, atom: true, and setEmbed command
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EmbedNode React Component</name>
  <files>
    src/components/notebook/editor/nodes/EmbedNode.tsx
    src/components/notebook/editor/nodes/EmbedNode.css
  </files>
  <action>
Create React NodeView component for embed visualization:

1. Create `EmbedNode.tsx`:
   - Import NodeViewWrapper, NodeViewProps from @tiptap/react
   - Use useRef for D3 SVG container
   - Use useState for loading state
   - Use useEffect for mounting D3 renderer based on embed type

2. Conditional rendering by type:
   ```typescript
   switch (node.attrs.type) {
     case 'supergrid':
       return <SuperGridEmbed {...props} />;
     case 'network':
       return <NetworkEmbed {...props} />;
     case 'timeline':
       return <TimelineEmbed {...props} />;
   }
   ```

3. Create internal components:
   - `SuperGridEmbed`: Mount SuperGridEngine to SVG ref, use useSQLiteQuery for data
   - `NetworkEmbed`: Mount ForceGraphRenderer to SVG ref
   - `TimelineEmbed`: Mount TimelineRenderer to SVG ref

4. Each embed component must:
   - Create SVG element with default 600x400 dimensions
   - Show loading spinner while data loads
   - Handle empty state gracefully
   - Use ResizeObserver for responsive sizing (native, not library)

5. Create `EmbedNode.css`:
   - .embed wrapper with min-height, border, border-radius
   - .embed__loading spinner styles
   - .embed__error for error states
   - .embed--supergrid, .embed--network, .embed--timeline variants

Key decision from prior phases:
- BOOKMARK-01: atom: true for non-editable content
- Use contentEditable={false} on interactive elements (CALL-03)
  </action>
  <verify>
TypeScript compiles: `npm run typecheck`
Component exports: grep for "export function EmbedNode"
CSS file exists with .embed classes
  </verify>
  <done>
EmbedNode.tsx renders appropriate D3 visualization based on type attribute, with loading states and responsive sizing
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Embed Slash Commands and Wire Extension</name>
  <files>
    src/components/notebook/editor/extensions/slash-commands.ts
    src/components/notebook/editor/extensions/index.ts
  </files>
  <action>
1. Add embed commands to slash-commands.ts:

```typescript
{
  id: 'supergrid',
  label: 'SuperGrid',
  description: 'Embed live SuperGrid visualization',
  category: 'isometry',
  shortcut: 'grid',
  action: ({ editor, range }) => {
    editor.chain().focus().deleteRange(range).setEmbed('supergrid').run();
  },
},
{
  id: 'network',
  label: 'Network Graph',
  description: 'Embed live network visualization',
  category: 'isometry',
  shortcut: 'network',
  action: ({ editor, range }) => {
    editor.chain().focus().deleteRange(range).setEmbed('network').run();
  },
},
{
  id: 'timeline',
  label: 'Timeline',
  description: 'Embed live timeline visualization',
  category: 'isometry',
  shortcut: 'timeline',
  action: ({ editor, range }) => {
    editor.chain().focus().deleteRange(range).setEmbed('timeline').run();
  },
},
```

2. Update extensions/index.ts:
   - Import EmbedExtension
   - Add to exports
   - Add to default extensions array if one exists

3. Ensure EmbedExtension is registered in editor configuration where other extensions are configured.
  </action>
  <verify>
TypeScript compiles: `npm run typecheck`
Commands added: grep for "supergrid\|network\|timeline" in slash-commands.ts
Extension exported: grep for "EmbedExtension" in index.ts
  </verify>
  <done>
/supergrid, /network, /timeline commands appear in slash menu and insert embed nodes
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. Start dev server: `npm run dev`
3. Open Capture pane, create new note
4. Type `/supergrid` - should see command in dropdown
5. Select command - should insert embed placeholder
6. Repeat for /network and /timeline
</verification>

<success_criteria>
- EmbedExtension.ts exists with TipTap Node structure
- EmbedNode.tsx renders D3 visualization by type
- /supergrid, /network, /timeline commands work in slash menu
- Embeds display with correct dimensions and loading states
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/98-isometry-embeds/98-01-SUMMARY.md`
</output>
