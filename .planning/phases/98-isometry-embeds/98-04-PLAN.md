---
phase: 98-isometry-embeds
plan: 04
type: execute
wave: 3
depends_on: ["98-01", "98-02"]
files_modified:
  - src/components/notebook/editor/extensions/EmbedExtension.ts
  - src/components/notebook/editor/nodes/EmbedNode.tsx
  - src/components/notebook/CaptureComponent.tsx
autonomous: false

must_haves:
  truths:
    - "Editor maintains 60fps with 10K+ character documents containing embeds"
    - "Large embeds do not cause editor input lag"
  artifacts:
    - path: "src/components/notebook/editor/extensions/EmbedExtension.ts"
      provides: "Performance-optimized embed extension"
      contains: "shouldRerenderOnTransaction: false"
  key_links:
    - from: "EmbedExtension.ts"
      to: "EmbedNode.tsx"
      via: "isolated re-render"
      pattern: "shouldRerenderOnTransaction"
---

<objective>
Optimize embed performance to maintain 60fps typing with large documents and multiple embeds.

Purpose: POLISH-03 requires editor performance at 60fps with 10K+ character documents. Embeds with D3 visualizations must not block the main thread or cause input lag.

Output: Embeds render independently of editor re-renders, achieving smooth typing performance
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/98-isometry-embeds/98-01-SUMMARY.md
@.planning/phases/98-isometry-embeds/98-02-SUMMARY.md
@src/components/notebook/editor/extensions/EmbedExtension.ts
@src/components/notebook/editor/nodes/EmbedNode.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shouldRerenderOnTransaction Optimization</name>
  <files>
    src/components/notebook/editor/extensions/EmbedExtension.ts
  </files>
  <action>
Add performance optimization to prevent re-renders on every keystroke:

1. Update addNodeView in EmbedExtension.ts:
```typescript
addNodeView() {
  return ReactNodeViewRenderer(EmbedNode, {
    // CRITICAL: Prevents re-render on every transaction (keystroke)
    // Embed only re-renders when its attributes change
    shouldRerenderOnTransaction: () => false,
  });
},
```

This is already a known pattern from research:
- TipTap's shouldRerenderOnTransaction controls when React component re-renders
- Default behavior: re-render on every ProseMirror transaction (every keystroke)
- With false: only re-render when node attributes change

2. Add comment explaining why this is critical:
```typescript
// Performance: atom nodes with shouldRerenderOnTransaction: false
// prevent D3 visualization re-renders on every keystroke.
// This is essential for maintaining 60fps with embeds.
```
  </action>
  <verify>
Pattern present: grep for "shouldRerenderOnTransaction" in EmbedExtension.ts
  </verify>
  <done>
EmbedExtension uses shouldRerenderOnTransaction: false to isolate embed re-renders
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Lazy Loading and RAF Batching to EmbedNode</name>
  <files>
    src/components/notebook/editor/nodes/EmbedNode.tsx
  </files>
  <action>
Optimize EmbedNode rendering with lazy loading and requestAnimationFrame:

1. Add lazy loading for D3 renderers to reduce initial bundle:
```typescript
// Lazy load heavy D3 components
const SuperGridEmbed = lazy(() => import('./embeds/SuperGridEmbed'));
const NetworkEmbed = lazy(() => import('./embeds/NetworkEmbed'));
const TimelineEmbed = lazy(() => import('./embeds/TimelineEmbed'));
```

2. Create separate embed files (if not already split):
- `src/components/notebook/editor/nodes/embeds/SuperGridEmbed.tsx`
- `src/components/notebook/editor/nodes/embeds/NetworkEmbed.tsx`
- `src/components/notebook/editor/nodes/embeds/TimelineEmbed.tsx`

3. Wrap in Suspense with loading fallback:
```typescript
<Suspense fallback={<div className="embed__loading">Loading visualization...</div>}>
  {node.attrs.type === 'supergrid' && <SuperGridEmbed node={node} />}
  {node.attrs.type === 'network' && <NetworkEmbed node={node} />}
  {node.attrs.type === 'timeline' && <TimelineEmbed node={node} />}
</Suspense>
```

4. In each embed component, batch D3 renders with RAF:
```typescript
useEffect(() => {
  if (!containerRef.current || loading) return;

  // Use RAF to avoid blocking main thread
  const frameId = requestAnimationFrame(() => {
    // D3 rendering here
  });

  return () => {
    cancelAnimationFrame(frameId);
    // Cleanup D3
  };
}, [nodes, loading]);
```

5. Add debounced resize handling:
```typescript
useEffect(() => {
  if (!containerRef.current) return;

  const resizeObserver = new ResizeObserver(
    // Debounce to 100ms to avoid thrashing
    debounce((entries) => {
      const { width, height } = entries[0].contentRect;
      // Update D3 dimensions
    }, 100)
  );

  resizeObserver.observe(containerRef.current);
  return () => resizeObserver.disconnect();
}, []);
```
  </action>
  <verify>
Lazy imports: grep for "lazy.*import" in EmbedNode.tsx
RAF usage: grep for "requestAnimationFrame" in embeds/*.tsx
  </verify>
  <done>
Embeds use lazy loading, RAF batching, and debounced resize for optimal performance
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify 60fps Performance with Large Documents</name>
  <what-built>
Performance optimizations for embeds:
- shouldRerenderOnTransaction: false on EmbedExtension
- Lazy loading of D3 renderer components
- RAF batching for D3 renders
- Debounced resize handling
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open Capture pane
3. Insert multiple embeds:
   - Type /supergrid, press Enter
   - Type /network, press Enter
   - Type /timeline, press Enter
4. Add 10,000+ characters of text (paste lorem ipsum or similar)
5. Test typing performance:
   - Type rapidly in the editor
   - Characters should appear immediately
   - No visible lag or stuttering
6. Open Chrome DevTools Performance tab:
   - Record while typing
   - Verify no long tasks (>50ms) during typing
   - Frame rate should stay above 50fps
7. Verify embeds still update when data changes:
   - Add a new card via another method
   - Embeds should reflect the new card
  </how-to-verify>
  <resume-signal>Type "approved" if typing is smooth at 60fps with embeds, or describe performance issues observed</resume-signal>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes
2. Performance profiling shows no long tasks during typing
3. Embeds render correctly after lazy load
4. Type in large document - no lag
5. Data changes still propagate to embeds
</verification>

<success_criteria>
- shouldRerenderOnTransaction: false present in EmbedExtension
- Lazy loading implemented for embed components
- RAF batching prevents main thread blocking
- Typing at 60fps with 10K+ character documents containing embeds
- No visual lag or stuttering during rapid typing
</success_criteria>

<output>
After completion, create `.planning/phases/98-isometry-embeds/98-04-SUMMARY.md`
</output>
