---
phase: 03-shell-integration
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified:
  - src/hooks/useCommandHistory.ts
  - src/components/notebook/ShellComponent.tsx
  - src/utils/commandHistory.ts
  - src/types/shell.ts
autonomous: true

must_haves:
  truths:
    - "Command history persists across browser sessions"
    - "User can navigate history with up/down arrows"
    - "History shows clear indicators for command types"
    - "User can search and filter command history"
  artifacts:
    - path: "src/hooks/useCommandHistory.ts"
      provides: "Command history management with persistence"
      exports: ["useCommandHistory"]
    - path: "src/utils/commandHistory.ts"
      provides: "History persistence and search utilities"
      exports: ["saveHistory", "loadHistory", "searchHistory"]
    - path: "src/types/shell.ts"
      provides: "Extended shell types for history management"
      contains: "HistoryEntry interface"
  key_links:
    - from: "src/hooks/useCommandHistory.ts"
      to: "localStorage"
      via: "History persistence"
      pattern: "(localStorage\\.setItem|localStorage\\.getItem).*history"
    - from: "src/components/notebook/ShellComponent.tsx"
      to: "useCommandHistory hook"
      via: "Arrow key navigation and history display"
      pattern: "useCommandHistory\\(.*\\)"
---

<objective>
Implement persistent command history with search, navigation, and clear type indicators.

Purpose: Provide comprehensive command history management for both system and Claude commands
Output: Complete history system with persistence, navigation, and search capabilities
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-shell-integration/03-03-SUMMARY.md
@src/hooks/useCommandRouter.ts
@src/types/shell.ts
</context>

<tasks>

<task type="auto">
  <name>Extend shell types for history</name>
  <files>src/types/shell.ts</files>
  <action>
    Extend existing shell type definitions to support history:

    Add new interfaces:
    ```typescript
    export interface HistoryEntry {
      id: string;
      command: string;
      type: CommandType;
      timestamp: Date;
      response?: CommandResponse;
      duration?: number;
      cwd?: string;
      context?: {
        cardId?: string;
        cardTitle?: string;
      };
    }

    export interface HistoryFilter {
      type?: CommandType;
      dateRange?: { start: Date; end: Date };
      searchQuery?: string;
      success?: boolean;
    }

    export interface HistoryState {
      entries: HistoryEntry[];
      currentIndex: number;
      maxEntries: number;
    }
    ```

    Extend existing types:
    - Add optional history fields to ShellCommand interface
    - Update CommandResponse to include history reference
    - Add search and filter result types

    Constants:
    - MAX_HISTORY_ENTRIES: 1000 (prevent unbounded growth)
    - HISTORY_STORAGE_KEY: 'isometry-shell-history'
    - HISTORY_SEARCH_DEBOUNCE: 300ms
  </action>
  <verify>Extended shell types compile without errors</verify>
  <done>Shell types support comprehensive history management</done>
</task>

<task type="auto">
  <name>Create command history utilities</name>
  <files>src/utils/commandHistory.ts</files>
  <action>
    Create history persistence and search utilities:

    Storage functions:
    - saveHistory(entries: HistoryEntry[]): Save to localStorage with compression
    - loadHistory(): Load and validate history from localStorage
    - clearHistory(): Clear stored history data
    - migrateHistoryFormat(): Handle version migrations for stored data

    Search functions:
    - searchHistory(entries: HistoryEntry[], query: string): Fuzzy search implementation
    - filterHistory(entries: HistoryEntry[], filter: HistoryFilter): Apply filters
    - sortHistory(entries: HistoryEntry[], sortBy: 'timestamp' | 'type' | 'duration'): Sort options

    Maintenance functions:
    - pruneHistory(entries: HistoryEntry[], maxEntries: number): Remove old entries
    - compressHistory(entries: HistoryEntry[]): Remove duplicate consecutive commands
    - exportHistory(entries: HistoryEntry[], format: 'json' | 'text'): Export functionality

    Search algorithm:
    - Fuzzy matching on command text
    - Type-based filtering (system vs Claude)
    - Date range filtering
    - Success/failure filtering
    - Context-based search (card title, project state)

    Data validation:
    - Validate stored data structure on load
    - Handle corrupted or outdated storage format
    - Sanitize search queries for security
    - Enforce storage size limits
  </action>
  <verify>History utilities compile and export expected functions</verify>
  <done>History utilities provide robust persistence and search capabilities</done>
</task>

<task type="auto">
  <name>Create command history hook</name>
  <files>src/hooks/useCommandHistory.ts</files>
  <action>
    Create command history management hook:

    Hook interface:
    - addHistoryEntry(entry: HistoryEntry): Add new command to history
    - getHistory(): Return current history entries
    - searchHistory(query: string): Search history with debounced queries
    - navigateHistory(direction: 'up' | 'down'): Navigate for arrow keys
    - clearHistory(): Clear all history
    - exportHistory(): Export history data
    - currentHistoryIndex: number for navigation state

    State management:
    - Load history on hook initialization
    - Auto-save on history changes
    - Debounced search to prevent excessive filtering
    - Navigation index for up/down arrow support

    History navigation:
    - Up arrow: Navigate to previous command
    - Down arrow: Navigate to next command (or empty for new command)
    - Remember navigation position across searches
    - Reset navigation when new command entered

    Integration points:
    - Connect with useCommandRouter for automatic entry addition
    - Provide callbacks for ShellComponent keyboard handling
    - Maintain synchronization with command execution state

    Performance optimization:
    - Lazy loading for large history sets
    - Debounced search to prevent excessive filtering
    - Efficient storage compression
    - Memory management for large datasets

    Auto-cleanup:
    - Remove entries older than 30 days
    - Limit total entries to prevent storage bloat
    - Compress consecutive duplicate commands
    - Preserve important commands (Claude responses)
  </action>
  <verify>Command history hook compiles and integrates with existing command infrastructure</verify>
  <done>History hook provides complete command history lifecycle management</done>
</task>

<task type="auto">
  <name>Integrate history with ShellComponent</name>
  <files>src/components/notebook/ShellComponent.tsx</files>
  <action>
    Integrate command history into shell interface:

    History integration:
    1. Add useCommandHistory hook to component
    2. Connect command execution to history tracking
    3. Implement arrow key navigation for history
    4. Add visual indicators for command types in history display
    5. Show command context (card name) for Claude commands

    Keyboard handling:
    - Up arrow: Navigate to previous command and populate input
    - Down arrow: Navigate to next command (or clear for new)
    - Escape: Clear current input and reset navigation
    - Tab completion: Show history suggestions for partial matches

    Visual enhancements:
    - History indicators in terminal output:
      - üñ•Ô∏è for system commands
      - ü§ñ for Claude commands
      - ‚úÖ for successful commands
      - ‚ùå for failed commands
    - Timestamp display for command history
    - Context indicators (card names, duration)

    History display:
    - Show recent commands in terminal output
    - Highlight current navigation position
    - Format Claude responses with proper markdown
    - Preserve command output formatting

    Search interface (optional enhancement):
    - Ctrl+R: Reverse history search mode
    - Display search query and results
    - Clear search with Escape
    - Execute selected history item with Enter

    Performance considerations:
    - Virtualize history display for large sets
    - Lazy load command outputs
    - Efficient re-rendering on navigation
    - Debounced search input handling
  </action>
  <verify>ShellComponent provides complete history navigation and display with keyboard shortcuts</verify>
  <done>Shell component offers comprehensive command history experience</done>
</task>

</tasks>

<verification>
Command history verification:
1. Commands added to history automatically on execution
2. Up/down arrows navigate through command history properly
3. History persists across browser sessions and refreshes
4. Command type indicators show clearly in history
5. Search functionality finds commands by text and type
6. History display shows context (card names, timestamps)
7. History cleanup prevents unlimited storage growth
</verification>

<success_criteria>
- Command history persists across browser sessions
- Arrow key navigation works smoothly with visual feedback
- History shows clear type indicators (system vs Claude commands)
- Search functionality helps users find previous commands
- History cleanup prevents storage bloat
- Context information enhances command discoverability
</success_criteria>

<output>
After completion, create `.planning/phases/03-shell-integration/03-04-SUMMARY.md`
</output>