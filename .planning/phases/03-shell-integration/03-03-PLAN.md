---
phase: 03-shell-integration
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/hooks/useCommandRouter.ts
  - src/hooks/useProjectContext.ts
  - src/components/notebook/ShellComponent.tsx
  - src/utils/commandParsing.ts
autonomous: true

must_haves:
  truths:
    - "User can distinguish system commands from Claude commands"
    - "Commands execute through appropriate handler (system vs AI)"
    - "Current notebook card content provides context for Claude"
    - "Project directory and database state accessible to commands"
  artifacts:
    - path: "src/hooks/useCommandRouter.ts"
      provides: "Command type detection and routing logic"
      exports: ["useCommandRouter"]
    - path: "src/hooks/useProjectContext.ts"
      provides: "Project state context for AI commands"
      exports: ["useProjectContext"]
    - path: "src/utils/commandParsing.ts"
      provides: "Command parsing and prefix detection"
      exports: ["parseCommand", "detectCommandType", "extractClaudePrompt"]
  key_links:
    - from: "src/hooks/useCommandRouter.ts"
      to: "useTerminal and useClaudeAPI"
      via: "Route commands to appropriate handler"
      pattern: "(useTerminal|useClaudeAPI).*executeCommand"
    - from: "src/hooks/useProjectContext.ts"
      to: "useNotebook and project files"
      via: "Context aggregation for AI commands"
      pattern: "(activeCard|projectRoot|dbState)"
---

<objective>
Implement command routing that distinguishes system commands from Claude commands and provides project context.

Purpose: Enable intelligent command dispatch with full project awareness
Output: Command router that executes commands through appropriate handlers with context
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/03-shell-integration/03-01-SUMMARY.md
@.planning/phases/03-shell-integration/03-02-SUMMARY.md
@src/hooks/useTerminal.ts
@src/hooks/useClaudeAPI.ts
@src/contexts/NotebookContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Create command parsing utility</name>
  <files>src/utils/commandParsing.ts</files>
  <action>
    Create command parsing utilities:

    Functions:
    - parseCommand(input: string): Parse raw terminal input into structured command
    - detectCommandType(command: string): Determine if command is system or Claude
    - extractClaudePrompt(input: string): Extract Claude prompt from prefixed commands
    - formatSystemCommand(command: string): Prepare system commands for execution
    - sanitizeInput(input: string): Security validation for command input

    Command detection logic:
    - Claude commands: Start with "claude", "ai", or "ask" prefixes
    - System commands: Everything else (ls, pwd, npm, git, etc.)
    - Special cases: "help claude", "claude help" show AI command documentation

    Examples:
    - "ls -la" â†’ { type: 'system', command: 'ls -la' }
    - "claude explain this code" â†’ { type: 'claude', prompt: 'explain this code' }
    - "ai what is this error" â†’ { type: 'claude', prompt: 'what is this error' }
    - "ask help with debugging" â†’ { type: 'claude', prompt: 'help with debugging' }

    Security considerations:
    - Validate command length limits
    - Sanitize special characters in system commands
    - Prevent command injection in Claude prompts
  </action>
  <verify>Command parsing utility compiles and exports expected functions</verify>
  <done>Command parsing provides reliable system vs Claude command detection</done>
</task>

<task type="auto">
  <name>Create project context hook</name>
  <files>src/hooks/useProjectContext.ts</files>
  <action>
    Create project context aggregation for AI commands:

    Hook interface:
    - getActiveCardContext(): Current notebook card content and properties
    - getProjectContext(): Project directory structure and key files
    - getDatabaseContext(): Recent cards, nodes, and relationships
    - formatContextForClaude(type: 'card' | 'project' | 'full'): Format context for AI

    Context aggregation:
    - Active card: Content, properties, creation date, type
    - Project files: package.json, README, key source files summary
    - Database state: Recent cards, related nodes, connection patterns
    - Working directory: Current terminal location and recent commands

    Context formatting:
    - Markdown format for Claude consumption
    - Relevant code snippets (truncated for token limits)
    - File tree structure (limited depth)
    - Database relationships and recent activity

    Token optimization:
    - Prioritize active card content over project context
    - Truncate large files with smart summarization
    - Include only relevant database relationships
    - Maximum context size limits to prevent API overload

    Use existing hooks:
    - useNotebook for active card and notebook state
    - useDatabase for related nodes and recent activity
    - Integrate with project root detection for file context
  </action>
  <verify>Project context hook compiles and integrates with existing notebook context</verify>
  <done>Project context provides comprehensive AI command context</done>
</task>

<task type="auto">
  <name>Create command router hook</name>
  <files>src/hooks/useCommandRouter.ts</files>
  <action>
    Create command routing hook that dispatches to appropriate handlers:

    Hook interface:
    - executeCommand(input: string): Route command to system or Claude handler
    - getCommandHistory(): Return history with command types indicated
    - clearHistory(): Clear command history
    - isExecuting: boolean state for loading indicators

    Routing logic:
    1. Parse command using commandParsing utility
    2. Route system commands to useTerminal.executeCommand
    3. Route Claude commands to useClaudeAPI with project context
    4. Track command history with timestamps and types
    5. Handle execution state and error propagation

    Claude command enhancement:
    - Automatically include active card context
    - Add project context based on command type
    - Format responses for terminal display
    - Handle streaming responses if API supports it

    System command passthrough:
    - Direct execution through terminal hook
    - No modification or context addition
    - Standard terminal behavior preserved

    History tracking:
    - Command type indicators (ðŸ“± for Claude, ðŸ’» for system)
    - Execution time and success status
    - Searchable command history
    - Persist history in localStorage

    Error handling:
    - Network failures for Claude commands
    - Permission issues for system commands
    - Invalid command format detection
    - Clear user feedback for all error types
  </action>
  <verify>Command router hook compiles and integrates both terminal and Claude API hooks</verify>
  <done>Command router provides unified command execution with intelligent dispatch</done>
</task>

<task type="auto">
  <name>Integrate command router with ShellComponent</name>
  <files>src/components/notebook/ShellComponent.tsx</files>
  <action>
    Replace direct terminal integration with command router:

    1. Import useCommandRouter and useProjectContext hooks
    2. Replace terminal command execution with router.executeCommand
    3. Update command display to show type indicators
    4. Add context awareness display in status bar
    5. Show execution state for both system and Claude commands
    6. Update connection status to reflect both terminal and API state

    UI enhancements:
    - Visual indicators for command types (icons or colors)
    - Loading states for Claude API calls (spinner, progress)
    - Context summary in status bar (active card name, project info)
    - Clear error display for both command types

    Command history display:
    - Show command type in prompt (different colors/icons)
    - Format Claude responses with proper markdown
    - Preserve terminal scrolling and output formatting
    - Add copy-to-clipboard for Claude responses

    Status bar updates:
    - Terminal connection status (bash/zsh)
    - Claude API connection status (connected/error)
    - Active context summary (card name, file count)
    - Command execution progress

    Maintain existing features:
    - Minimize/maximize functionality
    - Theme consistency and responsive layout
    - Keyboard shortcuts and terminal behavior
  </action>
  <verify>ShellComponent integrates command router and displays both system and Claude commands properly</verify>
  <done>Shell component provides unified terminal interface with AI command support</done>
</task>

</tasks>

<verification>
Command routing verification:
1. System commands execute normally (ls, pwd, npm commands)
2. Claude commands detect properly (claude, ai, ask prefixes)
3. Claude commands include active notebook card context
4. Command history shows type indicators for both command types
5. Status bar displays current context and connection states
6. Error handling works for both system and API failures
</verification>

<success_criteria>
- User can execute system commands without any behavior change
- User can execute Claude commands with "claude", "ai", or "ask" prefixes
- Claude commands automatically include current notebook card content
- Command history distinguishes between system and AI commands
- Status indicators show both terminal and API connection status
- Project context enhances Claude command relevance and accuracy
</success_criteria>

<output>
After completion, create `.planning/phases/03-shell-integration/03-03-SUMMARY.md`
</output>