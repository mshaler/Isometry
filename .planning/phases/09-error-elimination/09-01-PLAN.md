---
phase: 09-error-elimination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  "src/test/final-migration-validation.test.ts",
  "src/test/migration-e2e.test.ts",
  "src/utils/rollback-manager.ts",
  "src/db/migration-safety.ts",
  "src/utils/sqliteSyncManager.ts"
]
autonomous: true

must_haves:
  truths:
    - "Test suite runs without sql.js dependency failures"
    - "No import errors for sql.js modules"
    - "Migration validation reflects completed state"
  artifacts:
    - path: "src/test/final-migration-validation.test.ts"
      provides: "Post-migration validation tests"
      min_lines: 200
    - path: "src/test/migration-e2e.test.ts"
      provides: "Updated end-to-end migration tests"
      min_lines: 100
    - path: "src/utils/rollback-manager.ts"
      provides: "Rollback manager without sql.js"
      min_lines: 200
  key_links:
    - from: "src/test/final-migration-validation.test.ts"
      to: "package.json"
      via: "import validation"
      pattern: "import.*package\\.json"
    - from: "test framework"
      to: "migration validation"
      via: "success criteria validation"
      pattern: "validateSqlJsRemoval|validatePerformanceImprovements"
---

<objective>
Eliminate all sql.js references and update migration validation tests to reflect completed migration state.

Purpose: Fix failing tests and eliminate sql.js-dependent code that prevents clean builds and deployments.
Output: Clean test suite with updated validation logic for post-migration state.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Remove sql.js imports and references from utility files</name>
  <files>
    src/utils/sqliteSyncManager.ts
    src/utils/rollback-manager.ts
    src/db/migration-safety.ts
  </files>
  <action>
    Remove direct sql.js imports and replace functionality:

    1. In sqliteSyncManager.ts:
    - Remove `import initSqlJs, { Database } from 'sql.js';`
    - Replace with native database interface or remove file entirely if unused
    - Update initialization logic to not depend on sql.js

    2. In rollback-manager.ts:
    - Remove sql.js compatibility testing functions
    - Replace rollback logic to use native database backup/restore
    - Remove functions that test sql.js loading capabilities

    3. In migration-safety.ts:
    - Remove sql.js compatibility testing
    - Update safety checks to validate native database operations
    - Remove sql.js feature limitation checks

    Focus on removing import statements and replacing with native alternatives or removing unused functionality.
  </action>
  <verify>npm run typecheck should pass without sql.js import errors</verify>
  <done>No TypeScript errors for sql.js imports in utility files</done>
</task>

<task type="auto">
  <name>Update migration validation tests to reflect completed state</name>
  <files>
    src/test/final-migration-validation.test.ts
    src/test/migration-e2e.test.ts
  </files>
  <action>
    Transform migration validation tests from "testing migration process" to "validating completed migration":

    1. In final-migration-validation.test.ts:
    - Update validateSqlJsRemoval() to confirm absence rather than test compatibility
    - Remove any attempts to import or test sql.js functionality
    - Focus on validating migration artifacts exist (native database, WebView bridge)
    - Update searchForSqlJsReferences() to only look for problematic imports
    - Remove performance comparison tests that require sql.js baseline
    - Update success criteria to reflect "migration complete" state

    2. In migration-e2e.test.ts:
    - Remove end-to-end migration process tests
    - Replace with post-migration integration tests
    - Test native API functionality and WebView bridge
    - Validate that all components work with native backend

    The goal is tests that validate the migration is complete and working, not tests that perform migration.
  </action>
  <verify>npm test -- src/test/final-migration-validation.test.ts should pass</verify>
  <done>Migration validation tests pass and confirm completed migration state</done>
</task>

<task type="auto">
  <name>Clean up remaining sql.js references in database layer</name>
  <files>
    src/db/NativeAPIClient.ts
    src/db/fts5-maintenance.ts
    src/contexts/EnvironmentContext.tsx
  </files>
  <action>
    Remove sql.js type imports and update compatibility layers:

    1. In NativeAPIClient.ts:
    - Remove `import type { Database, QueryExecResult, Statement } from 'sql.js'`
    - Define local interfaces for Database, QueryExecResult, Statement
    - Keep compatibility interface but remove sql.js dependency
    - Update comments to reflect "native-first with compatibility interface"

    2. In fts5-maintenance.ts:
    - Remove `import type { Database } from 'sql.js';`
    - Define local Database interface or use generic database interface
    - Update function signatures to not depend on sql.js types

    3. In EnvironmentContext.tsx:
    - Update SQLJS enum value to deprecated status
    - Add deprecation warnings when SQLJS environment is detected
    - Ensure fallback logic skips sql.js and goes directly to native API

    Keep compatibility interfaces but remove actual sql.js dependencies.
  </action>
  <verify>npm run typecheck shows no sql.js import errors</verify>
  <done>Database layer has no sql.js type dependencies</done>
</task>

</tasks>

<verification>
- npm test should show no failing migration validation tests
- npm run typecheck should pass without sql.js import errors
- Build process should complete without sql.js dependency warnings
</verification>

<success_criteria>
- Zero sql.js import statements in codebase
- All tests pass including updated migration validation
- TypeScript compilation succeeds without sql.js type errors
- Migration validation tests confirm completed migration state
</success_criteria>

<output>
After completion, create `.planning/phases/09-error-elimination/09-01-SUMMARY.md`
</output>