---
phase: 41-pafv-architectural-unification
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified: [
  "src/components/Canvas.tsx",
  "src/engine/renderers/ListRenderer.ts",
  "src/engine/renderers/KanbanRenderer.ts"
]
autonomous: true

must_haves:
  truths:
    - "Canvas component uses IsometryViewEngine for all data rendering"
    - "No useD3Mode toggle exists in Canvas component"
    - "List and Kanban views render through unified engine"
    - "React components contain zero data-rendering JSX"
    - "All view switching goes through ViewConfig changes"
  artifacts:
    - path: "src/components/Canvas.tsx"
      provides: "Thin React shell using ViewEngine"
      min_lines: 100
    - path: "src/engine/renderers/ListRenderer.ts"
      provides: "List view D3 renderer"
      exports: ["ListRenderer"]
    - path: "src/engine/renderers/KanbanRenderer.ts"
      provides: "Kanban view D3 renderer"
      exports: ["KanbanRenderer"]
  key_links:
    - from: "src/components/Canvas.tsx"
      to: "src/engine/IsometryViewEngine.ts"
      via: "useEffect with engine.render() calls"
      pattern: "engineRef\\.current\\.render\\("
    - from: "src/engine/IsometryViewEngine.ts"
      to: "src/engine/renderers/*"
      via: "renderer map registration"
      pattern: "renderers\\.set\\("
---

<objective>
Transform Canvas component to use unified ViewEngine and eliminate dual rendering paths.

Purpose: Remove useD3Mode toggle and establish Canvas as thin React shell that passes state to D3 engine only, completing the "D3 renders, React controls" architectural contract.
Output: Unified Canvas component and additional D3 renderers for complete view coverage.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-pafv-architectural-unification/41-RESEARCH.md
@src/components/Canvas.tsx
@src/components/views/ListView.tsx
@src/components/views/KanbanView.tsx
@src/d3/ListView.ts
@src/d3/KanbanView.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create List and Kanban D3 renderers</name>
  <files>
    src/engine/renderers/ListRenderer.ts
    src/engine/renderers/KanbanRenderer.ts
  </files>
  <action>
    Implement ListRenderer and KanbanRenderer classes following GridRenderer pattern:

    ListRenderer:
    - Implements ViewRenderer interface
    - Creates hierarchical list view with nested groups based on HIERARCHY axis mapping
    - Uses D3 .data().join() with key functions for smooth enter/update/exit
    - Applies vertical layout positioning via transforms
    - Handles expand/collapse interactions for nested items
    - References existing src/d3/ListView.ts for layout algorithms

    KanbanRenderer:
    - Implements ViewRenderer interface
    - Creates column-based layout using CATEGORY axis for columns
    - Cards positioned within columns based on status or categorical grouping
    - Drag and drop support using D3 drag behavior
    - Column headers show aggregate counts
    - References existing src/d3/KanbanView.ts for column layout patterns

    Both renderers use pure D3 DOM manipulation, no React JSX. Apply consistent event handling patterns, use d3.transition() for smooth animations, implement proper cleanup in destroy methods.
  </action>
  <verify>
    Both renderer classes compile without TypeScript errors.
    ListRenderer creates hierarchical DOM structure using D3.
    KanbanRenderer creates column-based layout with D3.
    D3 data joins work with Node[] data arrays.
    Event handlers fire without runtime exceptions.
  </verify>
  <done>
    ListRenderer and KanbanRenderer implement D3-only visualization following ViewRenderer interface with proper data binding and interaction support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update IsometryViewEngine with new renderers</name>
  <files>src/engine/IsometryViewEngine.ts</files>
  <action>
    Extend IsometryViewEngine to support List and Kanban rendering:

    - Add ListRenderer and KanbanRenderer to constructor renderer map
    - Update renderer map: 'list' -> ListRenderer, 'kanban' -> KanbanRenderer, 'grid' -> GridRenderer
    - Ensure render() method properly dispatches to all three renderer types
    - Add validation for ViewConfig.viewType enum values
    - Update transition() method to handle view type changes (grid ↔ list ↔ kanban)
    - Add error handling for unsupported view type configurations

    Import new renderer classes and register them in the renderers Map. Maintain backward compatibility with existing grid rendering. Test viewType dispatch logic covers all supported view types.
  </action>
  <verify>
    IsometryViewEngine compiles with new renderer imports.
    render() method accepts 'list' and 'kanban' viewType configurations.
    Renderer dispatch works for all three view types.
    transition() handles view type changes without errors.
  </verify>
  <done>
    IsometryViewEngine supports grid, list, and kanban rendering through unified interface with proper view type dispatch and transition support.
  </done>
</task>

<task type="auto">
  <name>Task 3: Transform Canvas component to use ViewEngine</name>
  <files>src/components/Canvas.tsx</files>
  <action>
    Rewrite Canvas component to eliminate dual rendering paths:

    1. Remove useD3Mode state and toggle completely
    2. Remove all CSS-based view component imports and usage (ListView, GridView, KanbanView, etc.)
    3. Add useRef for IsometryViewEngine instance
    4. Add useEffect that creates engine once and calls engine.render() when data/config changes
    5. Replace renderView() function with simple container div for D3 engine
    6. Remove performance monitoring specific to D3 mode (apply to all rendering)
    7. Update ViewConfig creation from activeView state using existing PAFV context
    8. Remove RealTimeRenderer wrapper - ViewEngine handles performance internally

    Keep existing event handlers (handleNodeClick), FilterBar, sheet tabs, selectedNode display. Only replace the view rendering section. Use containerRef for D3 engine container div. Apply proper cleanup on unmount.
  </action>
  <verify>
    Canvas component compiles without errors after removing dual paths.
    No CSS view components remain in imports or JSX.
    useD3Mode toggle and related UI controls are completely removed.
    Container div exists for IsometryViewEngine attachment.
    Component renders without runtime errors in development mode.
  </verify>
  <done>
    Canvas component transformed into thin React shell that uses IsometryViewEngine for all data visualization with dual rendering paths eliminated.
  </done>
</task>

</tasks>

<verification>
Verify Canvas.tsx compiles and renders without useD3Mode toggle.
Test view switching works through activeView state changes.
Confirm no CSS view components are rendered for data display.
Verify IsometryViewEngine handles all three view types correctly.
Check that performance monitoring applies to unified rendering path.
</verification>

<success_criteria>
- Canvas component uses IsometryViewEngine exclusively for data rendering
- useD3Mode toggle completely removed from UI and logic
- List, Grid, and Kanban views render through unified D3 engine
- No data-rendering JSX exists in Canvas component
- View transitions work through ViewConfig changes only
</success_criteria>

<output>
After completion, create `.planning/phases/41-pafv-architectural-unification/41-02-SUMMARY.md`
</output>