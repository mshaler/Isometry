# Phase 66-01: SuperGrid Spreadsheet-like Scroll Behavior

## Problem Statement

SuperGrid's scroll and zoom behavior feels unpredictable because two independent systems compete:

1. **CSS native scroll** (`overflow: auto`) on `.supergrid__data-grid` container
2. **D3 zoom transforms** operating on SVG elements via `SuperGridZoom.ts`

When the user scrolls or zooms, these systems don't coordinate, causing:
- Headers that don't stay fixed during content scroll
- Unpredictable zoom anchor points
- Competing pan behaviors between CSS scroll and D3 translate

## Target Behavior (Excel/Numbers Model)

1. **Fixed Headers**: Row and column headers stay pinned at edges while content scrolls
2. **Upper-Left Anchor**: Content always anchored to upper-left corner (0,0)
3. **Predictable Scroll**: Wheel scroll moves content, headers stay fixed
4. **Zoom Behavior**: Zoom scales content around upper-left, not center or cursor
5. **No Competing Systems**: Single source of truth for viewport position

## Approach: CSS Grid with Sticky Positioning

Use CSS Grid with `position: sticky` for headers (the spreadsheet pattern):

```
┌─────────────────────────────────────────────────┐
│ Corner    │ Column Headers (sticky top)         │
│ (sticky)  │ ← scrolls horizontally with content │
├───────────┼─────────────────────────────────────┤
│ Row       │                                     │
│ Headers   │  Content Area                       │
│ (sticky   │  ← scrolls both directions          │
│  left)    │                                     │
│     ↑     │                                     │
│ scrolls   │                                     │
│ vertically│                                     │
└───────────┴─────────────────────────────────────┘
```

## Requirements

- **SCROLL-01**: Headers remain fixed during content scroll (CSS sticky)
- **SCROLL-02**: Upper-left corner pinned at (0,0) during all operations
- **SCROLL-03**: Wheel scroll produces predictable content movement
- **SCROLL-04**: Zoom scales content from upper-left anchor, not center
- **SCROLL-05**: Remove competing D3 zoom panning (use CSS scroll only for pan)

## Implementation Tasks

### Task 1: Restructure Grid Layout for Sticky Headers

**File**: `src/d3/grid-rendering/GridRenderingEngine.ts`

Update the DOM structure to support sticky positioning:
- Separate row headers, column headers, and content into distinct containers
- Use CSS Grid on the scroll container
- Apply `position: sticky` to header containers

### Task 2: Update CSS for Sticky Headers

**File**: `src/components/supergrid/SuperGrid.css` (or equivalent)

```css
.supergrid__container {
  display: grid;
  grid-template-columns: auto 1fr;
  grid-template-rows: auto 1fr;
  overflow: auto;
  /* Single scroll container for entire grid */
}

.supergrid__corner {
  position: sticky;
  top: 0;
  left: 0;
  z-index: 3;
}

.supergrid__column-headers {
  position: sticky;
  top: 0;
  z-index: 2;
}

.supergrid__row-headers {
  position: sticky;
  left: 0;
  z-index: 1;
}

.supergrid__content {
  /* Normal flow - scrolls with container */
}
```

### Task 3: Simplify D3 Zoom to Scale-Only

**File**: `src/d3/SuperGridZoom.ts`

Modify D3 zoom behavior:
- Remove translateExtent (no D3 panning)
- Keep scaleExtent for zoom levels
- Apply scale transform to content only, not headers
- Remove competing pan handlers

### Task 4: Coordinate Zoom with Sticky Headers

When zooming:
- Scale the content area
- Adjust header sizes to match scaled content
- Maintain sticky positioning throughout

## Test Plan

### Test 1: Sticky Header Behavior
```typescript
test('column headers stay fixed when scrolling vertically', async () => {
  // Scroll content down
  // Assert column headers remain at top of viewport
});

test('row headers stay fixed when scrolling horizontally', async () => {
  // Scroll content right
  // Assert row headers remain at left of viewport
});
```

### Test 2: Upper-Left Anchor
```typescript
test('content anchored to upper-left after scroll', async () => {
  // Scroll to arbitrary position
  // Assert first visible cell aligns with scroll offset
  // No unexpected jumps or drift
});

test('zoom maintains upper-left anchor', async () => {
  // Zoom in
  // Assert upper-left corner stays at (0,0)
  // Content expands down and right, not centered
});
```

### Test 3: No Competing Pan
```typescript
test('D3 zoom does not translate content', async () => {
  // Attempt D3 drag pan
  // Assert transform.x and transform.y remain 0
  // Only transform.k (scale) changes
});
```

## Success Criteria

1. Headers visually "stick" during scroll (verified via screenshot)
2. Zoom anchor always upper-left (verified via test)
3. No jittery or competing scroll behavior
4. Scroll feels as predictable as Excel/Numbers

## Files to Modify

| File | Change |
|------|--------|
| `src/d3/grid-rendering/GridRenderingEngine.ts` | DOM structure for sticky layout |
| `src/components/supergrid/SuperGrid.css` | Sticky positioning styles |
| `src/d3/SuperGridZoom.ts` | Remove pan, keep scale-only |
| `src/d3/SuperGrid.ts` | Coordinate zoom with new layout |

## Estimated Complexity

Medium - structural CSS changes with D3 integration adjustments

## Dependencies

None - this is a self-contained UX fix

---
*Created: 2026-02-12*
*Phase: 66 (SuperGrid Scroll Fix)*
