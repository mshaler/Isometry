---
phase: 79-catalog-browser
plan: 02
type: execute
wave: 2
depends_on: [79-01]
files_modified:
  - src/components/catalog/CatalogBrowser.tsx
  - src/components/catalog/FolderTree.tsx
  - src/components/catalog/TagCloud.tsx
  - src/components/catalog/StatusChips.tsx
autonomous: true

must_haves:
  truths:
    - "Folder tree with expand/collapse functionality"
    - "Tag cloud or list with counts displayed"
    - "Click any facet value to filter SuperGrid"
    - "Active filter state reflected visually"
  artifacts:
    - path: "src/components/catalog/CatalogBrowser.tsx"
      provides: "Main catalog component"
      exports: ["CatalogBrowser"]
    - path: "src/components/catalog/FolderTree.tsx"
      provides: "Hierarchical folder tree"
      exports: ["FolderTree"]
---

<objective>
Build the Catalog Browser UI component with folder tree, tag cloud, and status chips.

Purpose: Provide users with a visual overview of their data organized by LATCH facets, enabling quick filtering and navigation.

Output: CatalogBrowser component wired to useFacetAggregates and FilterContext.
</objective>

<context>
@.planning/phases/79-catalog-browser/79-01-PLAN.md
@src/hooks/data/useFacetAggregates.ts
@src/state/FilterContext.tsx
@src/components/Navigator/PafvNavigator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FolderTree component</name>
  <files>src/components/catalog/FolderTree.tsx</files>
  <action>
Create hierarchical folder tree:

```typescript
import React, { useState, useCallback } from 'react';
import { ChevronRight, ChevronDown, Folder } from 'lucide-react';
import { cn } from '../../lib/utils';
import type { FacetCount } from '../../hooks/data/useFacetAggregates';

interface FolderTreeProps {
  folders: FacetCount[];
  activeFolder: string | null;
  onFolderClick: (folder: string) => void;
}

interface FolderNode {
  name: string;
  path: string;
  count: number;
  children: FolderNode[];
}

/**
 * Build tree structure from flat folder paths
 * e.g., "work/projects/alpha" becomes nested hierarchy
 */
function buildTree(folders: FacetCount[]): FolderNode[] {
  const root: FolderNode[] = [];
  const map = new Map<string, FolderNode>();

  folders.forEach(({ value, count }) => {
    const parts = value.split('/');
    let currentPath = '';

    parts.forEach((part, index) => {
      const parentPath = currentPath;
      currentPath = currentPath ? `${currentPath}/${part}` : part;

      if (!map.has(currentPath)) {
        const node: FolderNode = {
          name: part,
          path: currentPath,
          count: index === parts.length - 1 ? count : 0,
          children: []
        };
        map.set(currentPath, node);

        if (parentPath) {
          map.get(parentPath)?.children.push(node);
        } else {
          root.push(node);
        }
      } else if (index === parts.length - 1) {
        // Update count for existing node
        map.get(currentPath)!.count += count;
      }
    });
  });

  return root;
}

export function FolderTree({ folders, activeFolder, onFolderClick }: FolderTreeProps) {
  const [expanded, setExpanded] = useState<Set<string>>(new Set());
  const tree = buildTree(folders);

  const toggleExpand = useCallback((path: string, e: React.MouseEvent) => {
    e.stopPropagation();
    setExpanded(prev => {
      const next = new Set(prev);
      if (next.has(path)) {
        next.delete(path);
      } else {
        next.add(path);
      }
      return next;
    });
  }, []);

  const renderNode = (node: FolderNode, depth = 0) => {
    const hasChildren = node.children.length > 0;
    const isExpanded = expanded.has(node.path);
    const isActive = activeFolder === node.path;

    return (
      <div key={node.path}>
        <button
          onClick={() => onFolderClick(node.path)}
          className={cn(
            'flex items-center gap-2 w-full px-2 py-1.5 rounded text-left hover:bg-gray-100 dark:hover:bg-gray-800',
            isActive && 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300'
          )}
          style={{ paddingLeft: `${depth * 16 + 8}px` }}
        >
          {hasChildren ? (
            <button onClick={(e) => toggleExpand(node.path, e)} className="p-0.5">
              {isExpanded ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
            </button>
          ) : (
            <span className="w-5" />
          )}
          <Folder className="w-4 h-4 text-gray-500" />
          <span className="flex-1 truncate">{node.name}</span>
          <span className="text-xs text-gray-400">{node.count}</span>
        </button>

        {hasChildren && isExpanded && (
          <div>
            {node.children.map(child => renderNode(child, depth + 1))}
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="space-y-0.5">
      {tree.map(node => renderNode(node))}
    </div>
  );
}

export default FolderTree;
```
  </action>
  <verify>Component renders without errors</verify>
  <done>FolderTree with expand/collapse created</done>
</task>

<task type="auto">
  <name>Task 2: Create TagCloud component</name>
  <files>src/components/catalog/TagCloud.tsx</files>
  <action>
Create tag cloud with weighted sizing:

```typescript
import React from 'react';
import { Tag } from 'lucide-react';
import { cn } from '../../lib/utils';
import type { FacetCount } from '../../hooks/data/useFacetAggregates';

interface TagCloudProps {
  tags: FacetCount[];
  activeTags: string[];
  onTagClick: (tag: string) => void;
}

export function TagCloud({ tags, activeTags, onTagClick }: TagCloudProps) {
  // Calculate size based on count distribution
  const maxCount = Math.max(...tags.map(t => t.count), 1);
  const minCount = Math.min(...tags.map(t => t.count), 1);

  const getSize = (count: number): 'sm' | 'base' | 'lg' | 'xl' => {
    const ratio = (count - minCount) / (maxCount - minCount || 1);
    if (ratio > 0.75) return 'xl';
    if (ratio > 0.5) return 'lg';
    if (ratio > 0.25) return 'base';
    return 'sm';
  };

  const sizeClasses = {
    sm: 'text-xs px-2 py-0.5',
    base: 'text-sm px-2.5 py-1',
    lg: 'text-base px-3 py-1',
    xl: 'text-lg px-3.5 py-1.5'
  };

  return (
    <div className="flex flex-wrap gap-2">
      {tags.map(({ value, count }) => {
        const isActive = activeTags.includes(value);
        const size = getSize(count);

        return (
          <button
            key={value}
            onClick={() => onTagClick(value)}
            className={cn(
              'inline-flex items-center gap-1 rounded-full border transition-colors',
              sizeClasses[size],
              isActive
                ? 'bg-blue-500 text-white border-blue-600'
                : 'bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-700'
            )}
          >
            <Tag className="w-3 h-3" />
            <span>{value}</span>
            <span className="text-xs opacity-70">({count})</span>
          </button>
        );
      })}
    </div>
  );
}

export default TagCloud;
```
  </action>
  <verify>Component renders without errors</verify>
  <done>TagCloud with weighted sizing created</done>
</task>

<task type="auto">
  <name>Task 3: Create StatusChips component</name>
  <files>src/components/catalog/StatusChips.tsx</files>
  <action>
Create status filter chips:

```typescript
import React from 'react';
import { Circle, CheckCircle, Clock, Archive } from 'lucide-react';
import { cn } from '../../lib/utils';
import type { FacetCount } from '../../hooks/data/useFacetAggregates';

interface StatusChipsProps {
  statuses: FacetCount[];
  activeStatus: string | null;
  onStatusClick: (status: string | null) => void;
}

const statusIcons: Record<string, React.ReactNode> = {
  active: <Circle className="w-4 h-4" />,
  done: <CheckCircle className="w-4 h-4" />,
  pending: <Clock className="w-4 h-4" />,
  archived: <Archive className="w-4 h-4" />
};

const statusColors: Record<string, string> = {
  active: 'bg-green-100 text-green-700 border-green-200',
  done: 'bg-blue-100 text-blue-700 border-blue-200',
  pending: 'bg-yellow-100 text-yellow-700 border-yellow-200',
  archived: 'bg-gray-100 text-gray-700 border-gray-200'
};

export function StatusChips({ statuses, activeStatus, onStatusClick }: StatusChipsProps) {
  return (
    <div className="flex flex-wrap gap-2">
      {/* All statuses chip */}
      <button
        onClick={() => onStatusClick(null)}
        className={cn(
          'inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-colors',
          activeStatus === null
            ? 'bg-gray-800 text-white border-gray-900'
            : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'
        )}
      >
        <span>All</span>
      </button>

      {statuses.map(({ value, count }) => {
        const isActive = activeStatus === value;
        const Icon = statusIcons[value] || <Circle className="w-4 h-4" />;
        const colorClass = statusColors[value] || 'bg-gray-100 text-gray-700 border-gray-200';

        return (
          <button
            key={value}
            onClick={() => onStatusClick(value)}
            className={cn(
              'inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-colors',
              isActive ? 'ring-2 ring-blue-500 ring-offset-1' : '',
              colorClass
            )}
          >
            {Icon}
            <span className="capitalize">{value}</span>
            <span className="text-xs opacity-70">({count})</span>
          </button>
        );
      })}
    </div>
  );
}

export default StatusChips;
```
  </action>
  <verify>Component renders without errors</verify>
  <done>StatusChips component created</done>
</task>

<task type="auto">
  <name>Task 4: Create CatalogBrowser container</name>
  <files>src/components/catalog/CatalogBrowser.tsx</files>
  <action>
Create main catalog browser component:

```typescript
import React, { useCallback } from 'react';
import { useFacetAggregates } from '../../hooks/data/useFacetAggregates';
import { useFilters } from '../../state/FilterContext';
import { FolderTree } from './FolderTree';
import { TagCloud } from './TagCloud';
import { StatusChips } from './StatusChips';
import { Loader2 } from 'lucide-react';

export function CatalogBrowser() {
  const { folders, tags, statuses, isLoading } = useFacetAggregates();
  const { filters, setFilters } = useFilters();

  const handleFolderClick = useCallback((folder: string) => {
    setFilters(prev => ({
      ...prev,
      folder: prev.folder === folder ? null : folder
    }));
  }, [setFilters]);

  const handleTagClick = useCallback((tag: string) => {
    setFilters(prev => {
      const currentTags = prev.tags || [];
      const hasTag = currentTags.includes(tag);

      return {
        ...prev,
        tags: hasTag
          ? currentTags.filter(t => t !== tag)
          : [...currentTags, tag]
      };
    });
  }, [setFilters]);

  const handleStatusClick = useCallback((status: string | null) => {
    setFilters(prev => ({
      ...prev,
      status: status
    }));
  }, [setFilters]);

  if (isLoading) {
    return (
      <div className="flex items-center justify-center p-8">
        <Loader2 className="w-6 h-6 animate-spin text-gray-400" />
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-6 p-4">
      {/* Status Section */}
      <section>
        <h3 className="text-sm font-medium text-gray-500 mb-3">Status</h3>
        <StatusChips
          statuses={statuses}
          activeStatus={filters.status ?? null}
          onStatusClick={handleStatusClick}
        />
      </section>

      {/* Folders Section */}
      <section>
        <h3 className="text-sm font-medium text-gray-500 mb-3">Folders</h3>
        <FolderTree
          folders={folders}
          activeFolder={filters.folder ?? null}
          onFolderClick={handleFolderClick}
        />
      </section>

      {/* Tags Section */}
      <section>
        <h3 className="text-sm font-medium text-gray-500 mb-3">Tags</h3>
        <TagCloud
          tags={tags}
          activeTags={filters.tags || []}
          onTagClick={handleTagClick}
        />
      </section>
    </div>
  );
}

export default CatalogBrowser;
```
  </action>
  <verify>Component compiles, integrates with FilterContext</verify>
  <done>CatalogBrowser container created</done>
</task>

</tasks>

<verification>
1. All components compile without errors
2. FolderTree expands/collapses correctly
3. TagCloud shows weighted sizes
4. Clicking any facet updates FilterContext
5. Active filters highlighted visually
</verification>

<success_criteria>
- CAT-02 satisfied: Catalog browser component works
- Folder tree with hierarchy
- Tag cloud with counts
- Status chips with visual state
- All wired to FilterContext
</success_criteria>
