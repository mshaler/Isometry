---
phase: 92-data-cell-integration
plan: 03
type: execute
wave: 3
depends_on: ["92-02"]
files_modified:
  - src/d3/grid-rendering/DataCellRenderer.ts
  - src/components/supergrid/SuperGrid.tsx
  - src/hooks/useDataCellRenderer.ts
autonomous: true

must_haves:
  truths:
    - "Selection syncs between headers and data cells"
    - "Clicking a header selects all cells in that row/column"
    - "Clicking a cell toggles its selection"
    - "Selected cells show visual highlight"
  artifacts:
    - path: "src/d3/grid-rendering/DataCellRenderer.ts"
      provides: "Selection-aware cell rendering"
      contains: "selectedIds.has"
    - path: "src/components/supergrid/SuperGrid.tsx"
      provides: "Selection context integration"
      contains: "useSelection"
  key_links:
    - from: "src/d3/grid-rendering/DataCellRenderer.ts"
      to: "src/state/SelectionContext.tsx"
      via: "selectedIds prop"
      pattern: "selectedIds"
    - from: "src/components/supergrid/SuperGrid.tsx"
      to: "src/d3/grid-rendering/GridSqlHeaderAdapter.ts"
      via: "Header click → select cells"
      pattern: "selectMultiple|onFilterChange"
---

<objective>
Implement selection synchronization between headers and data cells (CELL-04)

Purpose: Connect data cell selection to SelectionContext, enabling bidirectional sync - clicking a header selects all cells in that row/column, clicking a cell updates selection, and selection state visually reflects across both headers and cells.

Output: Selection-aware DataCellRenderer, SelectionContext integration in SuperGrid, and header click → cell selection wiring.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/92-data-cell-integration/92-RESEARCH.md
@.planning/phases/92-data-cell-integration/92-01-SUMMARY.md
@.planning/phases/92-data-cell-integration/92-02-SUMMARY.md
@.planning/phases/91-interactions/91-01-SUMMARY.md

# Key existing files to reference
@src/state/SelectionContext.tsx
@src/d3/grid-rendering/GridSqlHeaderAdapter.ts
@src/hooks/useHeaderInteractions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selection state to DataCellRenderer</name>
  <files>src/d3/grid-rendering/DataCellRenderer.ts</files>
  <action>
Extend DataCellRenderer to accept selectedIds and visually highlight selected cells.

Update the render method options:
```typescript
render(
  container: d3.Selection<SVGGElement, unknown, null, undefined>,
  cells: DataCellData[],
  options: {
    onCellClick?: (node: Node) => void,
    densityState?: JanusDensityState,
    selectedIds?: Set<string>,  // NEW
  }
): void
```

In both leaf and collapsed rendering modes:
1. Add `.classed('selected', d => selectedIds?.has(d.node.id) ?? false)` to cell groups
2. Update visual styling for selected state:
   - Leaf mode (rect): stroke='#3b82f6' (blue-500), stroke-width=2, fill='#dbeafe' (blue-100)
   - Collapsed mode (circle): stroke='#3b82f6', stroke-width=2

Add CSS class styling in the render function:
```typescript
// Apply selection visual state
cellGroups.select('.cell-bg')  // or .cell-chip for collapsed
  .attr('stroke', d => selectedIds?.has(d.node.id) ? '#3b82f6' : '#e5e7eb')
  .attr('stroke-width', d => selectedIds?.has(d.node.id) ? 2 : 1)
  .attr('fill', d => selectedIds?.has(d.node.id) ? '#dbeafe' : '#ffffff');
```

Update click handler to support modifier keys (Cmd/Ctrl for toggle, Shift for range):
```typescript
cellGroups.on('click', (event: MouseEvent, d) => {
  event.stopPropagation();
  if (options.onCellClick) {
    // Pass event for modifier key detection by parent
    options.onCellClick(d.node, event);
  }
});
```

Update the onCellClick type signature in render options:
```typescript
onCellClick?: (node: Node, event: MouseEvent) => void
```

The parent component will use SelectionContext methods based on modifier keys.
  </action>
  <verify>npm run check:types passes; selected cells have different visual styling</verify>
  <done>DataCellRenderer shows blue highlight for selected cells and passes click events to parent</done>
</task>

<task type="auto">
  <name>Task 2: Update useDataCellRenderer to accept selection state</name>
  <files>src/hooks/useDataCellRenderer.ts</files>
  <action>
Extend useDataCellRenderer to accept selectedIds from SelectionContext.

Update the hook signature:
```typescript
export function useDataCellRenderer(
  containerRef: React.RefObject<SVGSVGElement>,
  cells: DataCellData[],
  densityState: JanusDensityState,
  selectedIds: Set<string>,  // NEW
  onCellClick?: (node: Node, event: MouseEvent) => void,
  options: UseDataCellRendererOptions = {}
)
```

Pass selectedIds to renderer.render():
```typescript
rendererRef.current.render(container, cells, {
  onCellClick,
  densityState,
  selectedIds,
});
```

Add selectedIds to the useEffect dependency array so cells re-render when selection changes.

Note: The parent component (SuperGrid) will extract selectedIds from useSelection() hook and pass it down.
  </action>
  <verify>npm run check:types passes; useDataCellRenderer accepts selectedIds parameter</verify>
  <done>useDataCellRenderer passes selectedIds to renderer and re-renders on selection change</done>
</task>

<task type="auto">
  <name>Task 3: Wire SelectionContext to SuperGrid for data cells</name>
  <files>src/components/supergrid/SuperGrid.tsx</files>
  <action>
Integrate SelectionContext with SuperGrid to enable bidirectional selection sync.

1. Import and use SelectionContext:
```typescript
import { useSelection } from '@/state/SelectionContext';

// Inside component:
const { selection, select, toggle, selectMultiple, setCells } = useSelection();
```

2. Create cell click handler that uses SelectionContext methods:
```typescript
const handleCellClick = useCallback((node: Node, event?: MouseEvent) => {
  if (event?.metaKey || event?.ctrlKey) {
    toggle(node.id);  // Cmd+click: toggle
  } else if (event?.shiftKey) {
    // Shift+click: range select (requires anchor from SelectionContext)
    selectRange?.(node.id);
  } else {
    select(node.id);  // Regular click: single select
  }
}, [toggle, select, selectRange]);
```

3. Wire header click to select all cells in that row/column:
Modify the existing onFilterChange callback (from Phase 91-01) to also select cells:
```typescript
const handleHeaderSelect = useCallback((header: HeaderNode, axis: 'x' | 'y') => {
  // Find all cells that match this header's value
  const matchingCellIds = cells
    .filter(cell => {
      return axis === 'x'
        ? cell.logicalX === header.leafIndex
        : cell.logicalY === header.leafIndex;
    })
    .map(cell => cell.node.id);

  selectMultiple(matchingCellIds);
}, [cells, selectMultiple]);
```

4. Pass selection state to data cell renderer:
```typescript
// When using useDataCellRenderer or direct renderer:
<DataCellsComponent
  cells={cells}
  selectedIds={selection.selectedIds}
  onCellClick={handleCellClick}
  ...
/>
```

5. Register cells with SelectionContext for range selection support:
```typescript
useEffect(() => {
  // Convert DataCellData to CellDescriptor for SelectionContext
  const cellDescriptors = cells.map(c => ({
    id: c.node.id,
    row: c.logicalY,
    column: c.logicalX,
  }));
  setCells(cellDescriptors);
}, [cells, setCells]);
```
  </action>
  <verify>npm run check:types passes; clicking a header selects cells in that row/column</verify>
  <done>SelectionContext integrated with SuperGrid for bidirectional cell/header selection sync</done>
</task>

</tasks>

<verification>
1. `npm run check:types` passes with zero TypeScript errors
2. Clicking a data cell selects it (visual highlight appears)
3. Clicking a header selects all cells in that row/column
4. Cmd+click on a cell toggles its selection
5. Selection state persists across density mode changes
</verification>

<success_criteria>
- Single-clicking a cell selects only that cell
- Cmd+clicking a cell toggles it in/out of selection
- Clicking a header selects all cells that belong to that header
- Selected cells show blue highlight (stroke and fill)
- Selection state survives view transitions (density changes, scroll)
</success_criteria>

<output>
After completion, create `.planning/phases/92-data-cell-integration/92-03-SUMMARY.md`
</output>
