---
phase: 92-data-cell-integration
plan: 04
type: execute
wave: 2
depends_on: [92-01]
files_modified:
  - src/components/supergrid/SuperGridScrollTest.tsx
  - src/components/supergrid/HierarchicalHeaderRenderer.tsx
autonomous: false

must_haves:
  truths:
    - "Hierarchical folder paths display as nested headers (e.g., 'Growth' spans 'Growth/Fitness', 'Growth/Health')"
    - "Parent headers visually span their child headers"
    - "Headers use existing NestedHeaderRenderer infrastructure"
  artifacts:
    - path: "src/components/supergrid/HierarchicalHeaderRenderer.tsx"
      provides: "Bridge between flat folder paths and NestedHeaderRenderer"
      exports: ["HierarchicalHeaderRenderer", "parseFolderHierarchy"]
    - path: "src/components/supergrid/SuperGridScrollTest.tsx"
      provides: "Updated scroll test using hierarchical headers"
      exports: ["SuperGridScrollTest"]
  key_links:
    - from: "src/components/supergrid/HierarchicalHeaderRenderer.tsx"
      to: "src/d3/grid-rendering/NestedHeaderRenderer.ts"
      via: "buildNestedHeaderData for tree construction"
      pattern: "buildNestedHeaderData"
---

<objective>
Integrate SuperStack hierarchical headers into SuperGridScrollTest

Purpose: Enable the scroll test to display folder paths like "BairesDev/Operations" as nested hierarchical headers where "BairesDev" is a parent header spanning all its children ("Operations", "HR", etc.). This delivers the SSTACK visual nesting behavior users expect.

Output: A HierarchicalHeaderRenderer component that bridges flat folder paths to the existing NestedHeaderRenderer, and an updated SuperGridScrollTest that uses multi-level headers.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/92-data-cell-integration/92-RESEARCH.md

# Key existing files to reference
@src/d3/grid-rendering/NestedHeaderRenderer.ts
@src/components/supergrid/SuperGridScrollTest.tsx
@src/components/supergrid/SuperGridScrollContainer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HierarchicalHeaderRenderer bridge component</name>
  <files>src/components/supergrid/HierarchicalHeaderRenderer.tsx</files>
  <action>
Create a HierarchicalHeaderRenderer component that bridges flat folder paths to the NestedHeaderRenderer infrastructure.

The component should:
1. Accept flat folder paths (e.g., ["Growth", "Growth/Fitness", "Growth/Health", "Family/Extended Family"])
2. Convert "/" separators to "|" separators for NestedHeaderRenderer compatibility
3. Use buildNestedHeaderData() from NestedHeaderRenderer.ts to create hierarchical structure
4. Render multi-level headers where parents span their children

Key utility functions:
```typescript
/**
 * Parse folder paths into composite keys for NestedHeaderRenderer
 * "BairesDev/Operations" -> "BairesDev|Operations"
 */
export function parseFolderHierarchy(folders: string[]): string[] {
  return folders.map(folder => folder.replace(/\//g, '|'));
}

/**
 * Calculate header levels from parsed composite keys
 * Returns max depth and structured data for rendering
 */
export function calculateHeaderLevels(compositeKeys: string[], axis: 'x' | 'y'): {
  maxDepth: number;
  headers: NestedHeaderData[];
}
```

Props:
- folders: string[] - flat folder paths (e.g., "Growth/Fitness")
- axis: 'x' | 'y' - which axis this header renders
- cellSize: number - width/height of each leaf cell
- headerHeight: number - height of each header level
- svgRef: RefObject<SVGSVGElement> - ref for D3 rendering

The component should render an SVG with:
- Multiple header rows (one per hierarchy level)
- Visual spanning where parents span their children
- Consistent styling with existing SuperGrid headers
  </action>
  <verify>npm run check:types passes; HierarchicalHeaderRenderer and parseFolderHierarchy are exported</verify>
  <done>HierarchicalHeaderRenderer bridges folder paths to NestedHeaderRenderer with proper hierarchy</done>
</task>

<task type="auto">
  <name>Task 2: Update SuperGridScrollTest to use hierarchical headers</name>
  <files>src/components/supergrid/SuperGridScrollTest.tsx</files>
  <action>
Update SuperGridScrollTest to use the new HierarchicalHeaderRenderer for the folder axis, displaying proper SuperStack visual nesting.

Changes needed:
1. Import HierarchicalHeaderRenderer and parseFolderHierarchy
2. Replace the flat row header rendering with HierarchicalHeaderRenderer
3. Adjust header height to accommodate multiple levels (headerHeight * maxDepth)
4. Update the column header rendering for consistency
5. Ensure cells still align correctly with leaf headers

Key integration points:
- When xFacet === 'folder', use HierarchicalHeaderRenderer for column headers
- When yFacet === 'folder', use HierarchicalHeaderRenderer for row headers
- For non-folder facets (like created_at dates), keep flat headers

Update header dimensions calculation:
```typescript
const folderDepth = useMemo(() => {
  // Calculate max depth from folder paths
  const depths = xLabels.map(f => f.split('/').length);
  return Math.max(...depths, 1);
}, [xLabels]);

const effectiveHeaderHeight = xFacet === 'folder'
  ? HEADER_HEIGHT * folderDepth
  : HEADER_HEIGHT;
```

Data cell positioning should remain unchanged - cells align with leaf headers.
  </action>
  <verify>npm run check:types passes; SuperGridScrollTest renders hierarchical folder headers</verify>
  <done>SuperGridScrollTest displays hierarchical folder headers with parentâ†’child spanning</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify hierarchical header rendering</name>
  <what-built>HierarchicalHeaderRenderer with SuperStack nested folder headers</what-built>
  <how-to-verify>
    1. Load http://localhost:5173/?test=sg-scroll
    2. Observe column headers for folder axis:
       - "Growth" should appear as a parent spanning "Growth/Fitness", "Growth/Health", "Growth/Play", "Growth/Travel"
       - "BairesDev" should span "BairesDev/Operations", etc.
    3. Verify parent headers visually span their children
    4. Verify data cells align correctly with leaf headers
    5. Scroll horizontally - headers should maintain correct positions
    6. Try changing X axis to a non-folder field - should show flat headers
  </how-to-verify>
  <resume-signal>Type "approved" or describe header rendering issues</resume-signal>
</task>

</tasks>

<verification>
1. `npm run check:types` passes with zero TypeScript errors
2. HierarchicalHeaderRenderer exists and exports parseFolderHierarchy
3. SuperGridScrollTest uses hierarchical headers when folder is selected
4. Parent headers span their children correctly
5. Data cells align with leaf headers at all scroll positions
</verification>

<success_criteria>
- Folder paths display as nested hierarchical headers
- "Growth/Fitness" appears under a spanning "Growth" parent header
- Existing scroll coordination (SCROLL-01 through SCROLL-05) still works
- Non-folder axes (dates) continue to work as flat headers
</success_criteria>

<output>
After completion, create `.planning/phases/92-data-cell-integration/92-04-SUMMARY.md`
</output>
