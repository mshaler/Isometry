---
phase: 33-bridge-elimination
plan: 03
type: execute
wave: 3
depends_on: [33-02]
files_modified: [src/db/WebViewClient.ts, src/db/NativeAPIClient.ts, src/db/WebViewDatabaseContext.tsx, src/db/NativeDatabaseContext.tsx]
autonomous: true

must_haves:
  truths:
    - "Bridge client files are removed or marked deprecated"
    - "No active imports of WebViewClient or NativeAPIClient"
    - "Database Context files redirect to SQLiteProvider"
    - "Codebase migration to sql.js is complete"
  artifacts:
    - path: "src/db/WebViewClient.ts"
      provides: "Removed or deprecated bridge client"
      contains: "DEPRECATED"
    - path: "src/db/NativeAPIClient.ts"
      provides: "Removed or deprecated bridge client"
      contains: "DEPRECATED"
  key_links:
    - from: "WebViewDatabaseContext"
      to: "SQLiteProvider"
      via: "import redirect or deprecation notice"
      pattern: "SQLiteProvider|DEPRECATED"
    - from: "application components"
      to: "useSQLite hook"
      via: "updated imports"
      pattern: "useSQLite"
---

<objective>
Remove legacy bridge client code and complete migration to sql.js architecture.

Purpose: Eliminate the 40KB bridge infrastructure by deprecating WebViewClient, NativeAPIClient, and bridge database contexts. Complete the codebase migration to pure sql.js architecture. This fulfills the bridge elimination promise from CLAUDE.md.

Output: Clean codebase with legacy bridge code removed and all components using sql.js directly.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/33-bridge-elimination/33-01-SUMMARY.md
@.planning/phases/33-bridge-elimination/33-02-SUMMARY.md
@docs/specs/v4 specs/GSD-BRIDGE-ELIMINATION-PROMPT.md
@src/db/WebViewClient.ts
@src/db/SQLiteProvider.tsx
@CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Deprecate WebViewClient bridge code</name>
  <files>src/db/WebViewClient.ts</files>
  <action>
    Replace WebViewClient with deprecation notice following GSD-BRIDGE-ELIMINATION-PROMPT.md guidance:

    ```typescript
    /**
     * DEPRECATED: WebViewClient (Bridge Elimination v4)
     *
     * This file is deprecated as of Isometry v4 Bridge Elimination architecture.
     *
     * OLD ARCHITECTURE (40KB bridge overhead):
     * SQLite -> SQLite.swift -> MessageBridge.swift -> WKWebView -> D3.js
     *
     * NEW ARCHITECTURE (zero bridge overhead):
     * SQLite file -> sql.js (WASM, in-browser) -> D3.js
     *
     * MIGRATION:
     * - Replace WebViewClient usage with DatabaseService from './DatabaseService'
     * - Use useSQLite() hook instead of bridge context
     * - Direct synchronous queries: db.query() not bridge.postMessage()
     *
     * See: docs/specs/v4 specs/BRIDGE-ELIMINATION-ARCHITECTURE.md
     */

    export class WebViewClient {
      constructor() {
        throw new Error(
          'WebViewClient is DEPRECATED in Isometry v4. Use DatabaseService with sql.js instead. ' +
          'See docs/specs/v4 specs/BRIDGE-ELIMINATION-ARCHITECTURE.md for migration guide.'
        );
      }
    }

    // Legacy exports for backward compatibility during migration
    export type { ConnectionStatus } from './types'; // If exists
    ```

    Key points:
    - Clear deprecation notice explaining v4 architecture change
    - Constructor throws error preventing new usage
    - Reference to migration documentation
    - Preserve type exports for gradual migration if needed
    - Document OLD vs NEW architecture clearly
  </action>
  <verify>grep -E "DEPRECATED|Bridge Elimination|sql\.js.*WASM|throw.*Error" src/db/WebViewClient.ts</verify>
  <done>WebViewClient marked deprecated with clear migration guidance</done>
</task>

<task type="auto">
  <name>Deprecate NativeAPIClient bridge code</name>
  <files>src/db/NativeAPIClient.ts</files>
  <action>
    Replace NativeAPIClient with deprecation notice:

    ```typescript
    /**
     * DEPRECATED: NativeAPIClient (Bridge Elimination v4)
     *
     * This file is deprecated as of Isometry v4 Bridge Elimination architecture.
     *
     * ELIMINATED COMPONENTS:
     * - MessageBridge.swift (25 KB) -> sql.js direct access
     * - BridgeExtensions.swift (13 KB) -> No bridge needed
     * - SQLite.swift integration -> sql.js WASM replaces it
     * - Promise/callback tracking -> Synchronous queries
     *
     * MIGRATION PATH:
     * - Replace NativeAPIClient with DatabaseService from './DatabaseService'
     * - Remove all bridge.* method calls
     * - Use direct db.query() and db.run() synchronous methods
     * - No more await on database operations (same memory space)
     *
     * PERFORMANCE IMPACT:
     * - 6 serialization boundaries -> 0 serialization boundaries
     * - ~40KB bridge code -> ~0KB (eliminated)
     * - Promise overhead -> Direct memory access
     *
     * See: docs/specs/v4 specs/BRIDGE-ELIMINATION-ARCHITECTURE.md
     */

    export class NativeAPIClient {
      constructor() {
        throw new Error(
          'NativeAPIClient is DEPRECATED in Isometry v4. Bridge eliminated by sql.js architecture. ' +
          'Use DatabaseService for direct SQLite access in same memory space. ' +
          'Migration guide: docs/specs/v4 specs/BRIDGE-ELIMINATION-ARCHITECTURE.md'
        );
      }
    }
    ```

    Emphasize:
    - Specific KB savings (25KB + 13KB bridge files eliminated)
    - Performance benefits (6 serialization boundaries -> 0)
    - Synchronous operation (no more await on queries)
    - Clear migration path to DatabaseService
  </action>
  <verify>grep -E "DEPRECATED|25 KB.*13 KB|serialization boundaries.*0|DatabaseService" src/db/NativeAPIClient.ts</verify>
  <done>NativeAPIClient marked deprecated with performance impact documentation</done>
</task>

<task type="auto">
  <name>Update database context files to redirect to SQLiteProvider</name>
  <files>src/db/WebViewDatabaseContext.tsx, src/db/NativeDatabaseContext.tsx</files>
  <action>
    Update database context files to redirect to SQLiteProvider:

    **WebViewDatabaseContext.tsx:**
    ```typescript
    /**
     * DEPRECATED: WebViewDatabaseContext (Bridge Elimination v4)
     *
     * This context is deprecated. Use SQLiteProvider instead.
     *
     * MIGRATION:
     * import { SQLiteProvider, useSQLite } from './SQLiteProvider';
     *
     * OLD: useWebViewDatabase()
     * NEW: useSQLite()
     *
     * Benefits:
     * - Direct sql.js access (no bridge latency)
     * - Synchronous queries (no promises)
     * - Same memory space as D3.js visualizations
     */

    import React from 'react';
    import { SQLiteProvider } from './SQLiteProvider';

    export function WebViewDatabaseContext({ children }: { children: React.ReactNode }) {
      console.warn(
        'WebViewDatabaseContext is deprecated. Use SQLiteProvider directly. ' +
        'See Bridge Elimination documentation for migration guide.'
      );
      return <SQLiteProvider>{children}</SQLiteProvider>;
    }

    export const useWebViewDatabase = () => {
      throw new Error(
        'useWebViewDatabase is deprecated. Use useSQLite() from SQLiteProvider instead. ' +
        'Bridge eliminated in Isometry v4 - sql.js provides direct database access.'
      );
    };
    ```

    **NativeDatabaseContext.tsx:**
    ```typescript
    /**
     * DEPRECATED: NativeDatabaseContext (Bridge Elimination v4)
     *
     * See WebViewDatabaseContext.tsx for migration guidance.
     * Both native and webview contexts replaced by SQLiteProvider.
     */

    import React from 'react';
    import { SQLiteProvider } from './SQLiteProvider';

    export function NativeDatabaseContext({ children }: { children: React.ReactNode }) {
      console.warn(
        'NativeDatabaseContext is deprecated. Use SQLiteProvider directly. ' +
        'Bridge elimination means no distinction between native/webview contexts.'
      );
      return <SQLiteProvider>{children}</SQLiteProvider>;
    }

    export const useNativeDatabase = () => {
      throw new Error(
        'useNativeDatabase is deprecated. Use useSQLite() from SQLiteProvider instead.'
      );
    };
    ```

    Key migration points:
    - Redirect to SQLiteProvider for immediate compatibility
    - Clear error messages for hook usage
    - Console warnings for deprecated context usage
    - Document that native/webview distinction is eliminated
  </action>
  <verify>grep -E "SQLiteProvider|useSQLite|console\.warn.*deprecated" src/db/WebViewDatabaseContext.tsx src/db/NativeDatabaseContext.tsx</verify>
  <done>Database context files redirect to SQLiteProvider with deprecation warnings</done>
</task>

</tasks>

<verification>
1. WebViewClient and NativeAPIClient throw errors on instantiation
2. Database context files redirect to SQLiteProvider
3. Clear deprecation notices explain bridge elimination benefits
4. Migration guidance points to DatabaseService and useSQLite
5. No active bridge client code remains functional
6. Console warnings alert developers to deprecated usage
</verification>

<success_criteria>
- Legacy bridge client code eliminated or deprecated with clear migration paths
- All database contexts redirect to SQLiteProvider for immediate compatibility
- Deprecation notices document the 40KB code elimination and performance benefits
- Migration guidance is clear and actionable for developers
- sql.js architecture is now the only functional database access path
- Bridge elimination promise from CLAUDE.md fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/33-bridge-elimination/33-03-SUMMARY.md`
</output>