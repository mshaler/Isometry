# Phase 29 Plan 01: Core Markdown Parsing Infrastructure

## Frontmatter
- **Phase:** 29
- **Plan:** 01
- **Type:** autonomous
- **Wave:** 1
- **Depends on:** AltoIndexImporter patterns

## Objective

Extend AltoIndexImporter patterns to support universal markdown formats (CommonMark, GitHub Flavored, Obsidian-style) with robust frontmatter parsing and consistent API design.

## Context

The existing `AltoIndexImporter.swift` provides a solid foundation for markdown parsing with YAML frontmatter support. This plan extends that infrastructure to handle multiple markdown flavors and frontmatter formats while maintaining the proven actor-based async API pattern.

Key extension points:
- Multi-format frontmatter parsing (YAML, TOML, JSON)
- Enhanced markdown dialect detection
- Improved error handling and validation
- Consistent API surface for all import sources

## Tasks

### Task 1: Create Universal Markdown Parser Foundation
**Type:** auto

Create `UniversalMarkdownImporter.swift` extending AltoIndexImporter patterns with multi-format support.

**Implementation:**
- Actor-based design matching `AltoIndexImporter`
- Support CommonMark, GitHub Flavored Markdown, Obsidian dialects
- Multi-format frontmatter parsing (YAML/TOML/JSON)
- Intelligent format detection
- Enhanced error reporting

**Files to create:**
- `native/Sources/Isometry/Import/UniversalMarkdownImporter.swift`

**Done when:**
- [ ] Actor implements core parsing methods
- [ ] Supports all three frontmatter formats
- [ ] Maintains AltoIndexImporter API compatibility
- [ ] Unit tests pass for basic parsing

### Task 2: Enhanced Frontmatter Processing
**Type:** auto

Extend frontmatter parsing beyond YAML to support TOML and JSON with intelligent field detection.

**Implementation:**
- TOML frontmatter support using swift-toml
- JSON frontmatter detection and parsing
- Intelligent field mapping to Node properties
- Graceful fallback for unknown formats

**Files to modify:**
- `native/Sources/Isometry/Import/UniversalMarkdownImporter.swift`

**Done when:**
- [ ] TOML frontmatter parsing works correctly
- [ ] JSON frontmatter parsing works correctly
- [ ] Field mapping handles common property names
- [ ] Error handling for invalid frontmatter

### Task 3: Markdown Dialect Detection
**Type:** auto

Implement intelligent markdown dialect detection for different parsing strategies.

**Implementation:**
- CommonMark baseline support
- GitHub Flavored Markdown extensions (tables, strikethrough, task lists)
- Obsidian-style features (wiki-links, tags, callouts)
- Format detection based on content analysis

**Files to modify:**
- `native/Sources/Isometry/Import/UniversalMarkdownImporter.swift`

**Done when:**
- [ ] Dialect detection correctly identifies formats
- [ ] Each dialect has appropriate parsing strategy
- [ ] Content parsing preserves dialect-specific features
- [ ] Format detection tests pass

### Task 4: Error Handling and Validation
**Type:** auto

Implement comprehensive error handling and validation for robust import operations.

**Implementation:**
- Detailed error types for different failure modes
- Validation of frontmatter fields
- Content validation and sanitization
- Progress reporting for batch operations

**Files to modify:**
- `native/Sources/Isometry/Import/UniversalMarkdownImporter.swift`

**Done when:**
- [ ] Comprehensive error types defined
- [ ] Field validation prevents invalid data
- [ ] Content sanitization handles security concerns
- [ ] Error reporting is detailed and actionable

## Verification

### Parsing Verification
Run test imports with sample markdown files:

```bash
cd native
swift test --filter UniversalMarkdownImporterTests
```

Expected results:
- [ ] YAML frontmatter parsing: ✓
- [ ] TOML frontmatter parsing: ✓
- [ ] JSON frontmatter parsing: ✓
- [ ] CommonMark content parsing: ✓
- [ ] GitHub Flavored Markdown features: ✓
- [ ] Obsidian-style features detected: ✓

### API Consistency Verification
Verify actor API maintains patterns from AltoIndexImporter:

```swift
let importer = UniversalMarkdownImporter(database: database)
let result = try await importer.importNotes(from: directoryURL)
```

Expected behavior:
- [ ] Same async/await patterns as AltoIndexImporter
- [ ] ImportResult structure compatibility
- [ ] Error handling consistency
- [ ] Performance characteristics similar

## Success Criteria

- [ ] Universal markdown parsing supports CommonMark, GitHub, Obsidian dialects
- [ ] Multi-format frontmatter parsing (YAML, TOML, JSON) works correctly
- [ ] API maintains consistency with existing AltoIndexImporter patterns
- [ ] Error handling is comprehensive and actionable
- [ ] Performance is acceptable for typical import operations
- [ ] All unit tests pass

## Output

**Primary deliverable:**
- `UniversalMarkdownImporter.swift` - Universal markdown parsing actor

**Test coverage:**
- Unit tests for all frontmatter formats
- Dialect detection tests
- Error handling verification
- Performance benchmarks

**API documentation:**
- Swift documentation comments
- Usage examples
- Migration guide from AltoIndexImporter