# Phase 29 Plan 02: Advanced Markdown Features and Relationship Extraction

## Frontmatter
- **Phase:** 29
- **Plan:** 02
- **Type:** autonomous
- **Wave:** 1
- **Depends on:** 29-01 core infrastructure

## Objective

Implement advanced markdown processing features including wiki-link relationship extraction, table parsing for LATCH properties, and image/attachment handling with graph-based relationship modeling.

## Context

Building on the core universal markdown parsing infrastructure from 29-01, this plan adds sophisticated content analysis features that extract structured data and relationships from markdown content.

Key capabilities:
- Wiki-link parsing for graph edge creation
- Table parsing with intelligent LATCH property mapping
- Image and attachment processing
- Relationship graph construction

## Tasks

### Task 1: Wiki-Link Relationship Extraction
**Type:** auto

Implement wiki-link parsing to create Edge graph connections between imported markdown files.

**Implementation:**
- Parse `[[wiki-links]]` and `[[display text|target]]` formats
- Extract relationships and create Edge entries
- Handle missing targets gracefully
- Support link aliases and display text

**Files to create:**
- `native/Sources/Isometry/Import/RelationshipExtractor.swift`

**Files to modify:**
- `native/Sources/Isometry/Import/UniversalMarkdownImporter.swift`

**Done when:**
- [ ] Wiki-link parsing extracts all link formats
- [ ] Edge creation connects related nodes correctly
- [ ] Missing link targets handled gracefully
- [ ] Link aliases preserved in Edge properties

### Task 2: Table Parsing with LATCH Mapping
**Type:** auto

Parse markdown tables and intelligently map columns to LATCH properties (Location, Alphabet, Time, Category, Hierarchy).

**Implementation:**
- Detect and parse markdown tables
- Intelligent column mapping to LATCH properties
- Extract structured data as Node properties
- Handle malformed tables gracefully

**Files to create:**
- `native/Sources/Isometry/Import/TableProcessor.swift`

**Files to modify:**
- `native/Sources/Isometry/Import/UniversalMarkdownImporter.swift`

**Done when:**
- [ ] Table detection and parsing works correctly
- [ ] LATCH property mapping is intelligent and accurate
- [ ] Structured data extraction preserves table relationships
- [ ] Malformed tables don't break import process

### Task 3: Image and Attachment Processing
**Type:** auto

Implement secure local file processing for images and attachments referenced in markdown.

**Implementation:**
- Detect image references `![alt](path)` and `<img>` tags
- Process attachment links `[text](file.pdf)`
- Secure file copying and path management
- Attachment metadata extraction

**Files to create:**
- `native/Sources/Isometry/Import/AttachmentProcessor.swift`

**Files to modify:**
- `native/Sources/Isometry/Import/UniversalMarkdownImporter.swift`

**Done when:**
- [ ] Image references detected and processed correctly
- [ ] Attachment files copied securely
- [ ] File paths managed safely (no path traversal)
- [ ] Attachment metadata extracted when available

### Task 4: Graph Relationship Integration
**Type:** auto

Integrate relationship extraction with the existing graph system for comprehensive node connections.

**Implementation:**
- Create Edge entries for all extracted relationships
- Link imported nodes to existing graph nodes
- Handle bidirectional relationships
- Optimize relationship queries

**Files to modify:**
- `native/Sources/Isometry/Import/RelationshipExtractor.swift`
- `native/Sources/Isometry/Import/UniversalMarkdownImporter.swift`
- `native/Sources/Isometry/Database/IsometryDatabase.swift` (if needed)

**Done when:**
- [ ] All extracted relationships create proper Edge entries
- [ ] Bidirectional relationships handled correctly
- [ ] Integration with existing graph queries works
- [ ] Performance acceptable for large relationship sets

## Verification

### Relationship Extraction Verification
Test wiki-link processing with sample files:

```bash
# Create test markdown with various link formats
echo "[[Target Node]] and [[Display Text|actual-target]]" > test.md
swift test --filter RelationshipExtractorTests
```

Expected results:
- [ ] Simple wiki-links create correct Edge entries: ✓
- [ ] Aliased links preserve display text: ✓
- [ ] Missing targets handled gracefully: ✓
- [ ] Bidirectional relationships work: ✓

### Table Processing Verification
Test table parsing with LATCH mapping:

```bash
# Create test table with common property columns
cat > table-test.md << 'EOF'
| Name | Location | Category | Date | Tags |
|------|----------|----------|------|------|
| Item1 | Room A | Documents | 2024-01-01 | work,important |
EOF

swift test --filter TableProcessorTests
```

Expected results:
- [ ] Table structure detected correctly: ✓
- [ ] LATCH property mapping works: ✓
- [ ] Data extraction preserves types: ✓
- [ ] Malformed tables don't break processing: ✓

### Integration Verification
Test full workflow with complex markdown:

```bash
swift test --filter UniversalMarkdownImporterIntegrationTests
```

Expected results:
- [ ] Wiki-links create graph relationships: ✓
- [ ] Tables become structured node properties: ✓
- [ ] Images and attachments process correctly: ✓
- [ ] All features work together without conflicts: ✓

## Success Criteria

- [ ] Wiki-link relationship extraction creates proper graph connections
- [ ] Table parsing intelligently maps to LATCH properties
- [ ] Image and attachment processing is secure and reliable
- [ ] Graph integration maintains performance and data integrity
- [ ] All advanced features work with the core parsing infrastructure
- [ ] Comprehensive test coverage for all relationship types

## Output

**Primary deliverables:**
- `RelationshipExtractor.swift` - Wiki-link and relationship processing
- `TableProcessor.swift` - Markdown table parsing and LATCH mapping
- `AttachmentProcessor.swift` - Image and file attachment handling

**Enhanced functionality:**
- Graph-aware import process with automatic relationship creation
- Structured data extraction from tables
- Secure attachment management
- Comprehensive relationship modeling

**Test coverage:**
- Relationship extraction tests
- Table parsing and LATCH mapping tests
- Attachment processing security tests
- Integration tests with existing graph system