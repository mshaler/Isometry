---
phase: 43-shell-integration-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/claude-code/claudeCodeWebSocketDispatcher.ts
  - src/hooks/useWebSocketConnection.ts
  - src/hooks/useTerminal.ts
autonomous: true

must_haves:
  truths:
    - "User sees 'connected' status when WebSocket connects successfully"
    - "User sees 'reconnecting' status when connection drops, with automatic recovery"
    - "User sees connection status in terminal prompt showing working directory"
  artifacts:
    - path: "src/services/claude-code/claudeCodeWebSocketDispatcher.ts"
      provides: "Production-ready WebSocket with heartbeat and auto-reconnect"
      contains: "startHeartbeat"
    - path: "src/hooks/useWebSocketConnection.ts"
      provides: "React hook for WebSocket connection state management"
      exports: ["useWebSocketConnection"]
    - path: "src/hooks/useTerminal.ts"
      provides: "Enhanced terminal with working directory display"
      contains: "currentDirectory"
  key_links:
    - from: "src/hooks/useWebSocketConnection.ts"
      to: "src/services/claude-code/claudeCodeWebSocketDispatcher.ts"
      via: "WebSocketClaudeCodeDispatcher import"
      pattern: "WebSocketClaudeCodeDispatcher"
    - from: "src/hooks/useTerminal.ts"
      to: "src/hooks/useWebSocketConnection.ts"
      via: "connection status subscription"
      pattern: "useWebSocketConnection"
---

<objective>
Implement production-ready WebSocket connection with heartbeat, exponential backoff reconnection, and working directory context.

Purpose: SHELL-01 (WebSocket connection) and SHELL-04 (working directory context) are foundational for all shell functionality. Without reliable connection management, the terminal cannot execute commands.

Output: WebSocket client with 30-second heartbeat, exponential backoff reconnection (1s-30s), and terminal prompt showing current working directory.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing implementation to enhance
@src/services/claude-code/claudeCodeWebSocketDispatcher.ts
@src/utils/webview/reconnection-service.ts
@src/hooks/useTerminal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance WebSocketClaudeCodeDispatcher with heartbeat and reconnection</name>
  <files>src/services/claude-code/claudeCodeWebSocketDispatcher.ts</files>
  <action>
Enhance the existing WebSocketClaudeCodeDispatcher class to add production-ready connection management:

1. **Add heartbeat mechanism:**
   - Send ping message every 30 seconds when connected
   - Track last pong received timestamp
   - If no pong received within 60 seconds, consider connection dead and trigger reconnect
   - Clear heartbeat interval on disconnect

2. **Integrate ReconnectionService:**
   - Import and use existing ReconnectionService from utils/webview/reconnection-service.ts
   - Configure: baseDelay=1000, maxDelay=30000, backoffFactor=2, jitterRange=0.1, maxAttempts=10
   - On WebSocket close, attempt reconnection automatically
   - On successful reconnect, reset attempt counter
   - Emit status events: 'connecting', 'connected', 'reconnecting', 'disconnected'

3. **Add connection state management:**
   - Add `connectionStatus: 'connecting' | 'connected' | 'reconnecting' | 'disconnected'` property
   - Add `onStatusChange: (status) => void` callback to options
   - Emit status change on each transition
   - Add `getConnectionStatus()` public method

4. **Handle pending messages during reconnect:**
   - Queue messages sent while reconnecting
   - Flush queue when connection re-establishes

Per user decisions:
- Show reconnecting status immediately on failure
- Use exponential backoff with auto-retry
  </action>
  <verify>
Run `npm run check:types` to verify no TypeScript errors.
Verify ReconnectionService import resolves correctly.
Verify heartbeat interval and pong tracking are implemented.
  </verify>
  <done>
WebSocketClaudeCodeDispatcher has heartbeat (30s ping), pong tracking, ReconnectionService integration, and emits connection status changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useWebSocketConnection React hook</name>
  <files>src/hooks/useWebSocketConnection.ts</files>
  <action>
Create a new React hook that provides WebSocket connection state to components:

1. **Hook interface:**
```typescript
interface UseWebSocketConnectionResult {
  status: 'connecting' | 'connected' | 'reconnecting' | 'disconnected';
  reconnectAttempt: number;
  maxReconnectAttempts: number;
  connect: () => Promise<void>;
  disconnect: () => void;
  isConnected: boolean;
}
```

2. **Implementation:**
   - Get dispatcher via getClaudeCodeDispatcher()
   - Subscribe to status changes via onStatusChange callback
   - Track reconnect attempt count from ReconnectionService
   - Clean up subscription on unmount
   - Memoize connect/disconnect callbacks

3. **Status synchronization:**
   - Initial status from dispatcher.getConnectionStatus()
   - Update state on each status change event
   - Expose isConnected as convenience boolean

Export the hook as named export for use in ShellComponent and terminal.
  </action>
  <verify>
Run `npm run check:types` to verify no TypeScript errors.
Verify hook exports correctly from src/hooks/index.ts.
  </verify>
  <done>
useWebSocketConnection hook provides reactive connection status, reconnect attempt tracking, and connect/disconnect methods.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enhance terminal with working directory in prompt</name>
  <files>src/hooks/useTerminal.ts</files>
  <action>
Enhance useTerminal to display working directory context in the terminal prompt:

1. **Update prompt format:**
   - Change from simple `$ ` to `[directory] $ ` format
   - Show abbreviated directory (last 2-3 path segments) to prevent prompt overflow
   - Example: `[Projects/Isometry] $ ` instead of full path

2. **Add directory state:**
   - Add `setCurrentDirectory(path: string)` method to hook return
   - Parse `cd` commands to track directory changes
   - Support relative path navigation (cd .., cd subfolder)
   - Default to project root: `/Users/mshaler/Developer/Projects/Isometry`

3. **Prompt display function:**
```typescript
const formatPrompt = (directory: string): string => {
  const parts = directory.split('/').filter(Boolean);
  const shortPath = parts.slice(-2).join('/');
  return `[${shortPath}] $ `;
};
```

4. **Handle cd command locally:**
   - When user types `cd path`, update currentDirectory state
   - Resolve relative paths against current directory
   - Write new prompt after cd command

Per user decisions:
- Working directory shown in terminal prompt/status bar
  </action>
  <verify>
Run `npm run check:types` to verify no TypeScript errors.
Verify prompt shows abbreviated path format.
  </verify>
  <done>
Terminal prompt displays working directory as `[path/segment] $ ` and tracks directory changes from cd commands.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run check:types` - should pass with no errors
2. Run `npm run check:lint` - should have no new lint errors
3. Verify WebSocket heartbeat sends ping every 30 seconds when connected
4. Verify reconnection attempts with exponential backoff (1s, 2s, 4s, 8s, ...)
5. Verify terminal prompt shows working directory
</verification>

<success_criteria>
- WebSocket has 30-second heartbeat and auto-reconnect with exponential backoff
- useWebSocketConnection hook provides connection status and reconnect tracking
- Terminal prompt displays abbreviated working directory
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/43-shell-integration-completion/43-01-SUMMARY.md`
</output>
