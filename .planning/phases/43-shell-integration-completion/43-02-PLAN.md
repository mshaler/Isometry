---
phase: 43-shell-integration-completion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useTerminal.ts
  - src/hooks/useCommandHistory.ts
  - src/components/notebook/ShellComponent.tsx
autonomous: true

must_haves:
  truths:
    - "User can copy selected text with Cmd+C when text is selected"
    - "User can paste text with Cmd+V into terminal input"
    - "User can navigate history with up/down arrows"
    - "User can reverse search history with Ctrl+R"
  artifacts:
    - path: "src/hooks/useTerminal.ts"
      provides: "Terminal with copy/paste and history navigation"
      contains: "handleCopy"
    - path: "src/hooks/useCommandHistory.ts"
      provides: "Command history manager with reverse search"
      exports: ["useCommandHistory"]
    - path: "src/components/notebook/ShellComponent.tsx"
      provides: "Shell UI with integrated terminal"
      contains: "useCommandHistory"
  key_links:
    - from: "src/hooks/useTerminal.ts"
      to: "src/hooks/useCommandHistory.ts"
      via: "history navigation callbacks"
      pattern: "useCommandHistory"
    - from: "src/components/notebook/ShellComponent.tsx"
      to: "src/hooks/useTerminal.ts"
      via: "useTerminal hook"
      pattern: "useTerminal"
---

<objective>
Implement terminal copy/paste support and command history with reverse search.

Purpose: SHELL-02 (copy/paste) and SHELL-03 (command history) are essential terminal UX features. Without them, users cannot efficiently work with terminal output or recall previous commands.

Output: Terminal supports Cmd+C/Cmd+V for copy/paste (selection-aware), up/down arrow history navigation, and Ctrl+R reverse search through command history.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing implementation to enhance
@src/hooks/useTerminal.ts
@src/utils/commandHistory.ts
@src/types/shell.ts
@src/components/notebook/ShellComponent.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement copy/paste in terminal</name>
  <files>src/hooks/useTerminal.ts</files>
  <action>
Add copy/paste support to the terminal with selection-aware Cmd+C handling:

1. **Selection-aware copy (Cmd+C):**
   - Check if terminal has text selected via `terminal.hasSelection()`
   - If text selected: copy selection to clipboard, do NOT send SIGINT
   - If no selection: send Ctrl+C (SIGINT) to running process
   - Use Clipboard API: `navigator.clipboard.writeText(terminal.getSelection())`

2. **Paste support (Cmd+V):**
   - Read from clipboard: `navigator.clipboard.readText()`
   - Write pasted text to terminal at cursor position
   - Update currentLine state with pasted content

3. **Keyboard handler update:**
   - In `terminal.onData()`, intercept copy/paste key combinations
   - For Cmd+C (meta key on Mac): check selection before acting
   - For Cmd+V: read clipboard and insert

4. **Implementation in setupTerminalInteractions:**
```typescript
// Add to onData handler
if (data === '\x03') { // Ctrl+C
  if (terminal.hasSelection()) {
    navigator.clipboard.writeText(terminal.getSelection());
    terminal.clearSelection();
    return; // Don't send SIGINT
  }
  // Otherwise, send SIGINT to process
}
```

5. **Add keyboard event listener for Cmd+V:**
   - Listen for keydown on terminal container
   - Detect metaKey + 'v' for paste
   - Prevent default browser paste, handle manually

Per user decisions:
- Cmd+C copies if text selected, otherwise sends SIGINT
- Cmd+V pastes from clipboard
  </action>
  <verify>
Run `npm run check:types` to verify no TypeScript errors.
Verify hasSelection() and getSelection() xterm.js methods are called correctly.
  </verify>
  <done>
Terminal supports Cmd+C for copying selected text (or SIGINT if no selection) and Cmd+V for pasting from clipboard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useCommandHistory hook with reverse search</name>
  <files>src/hooks/useCommandHistory.ts</files>
  <action>
Create a React hook that manages command history with up/down navigation and Ctrl+R reverse search:

1. **Hook interface:**
```typescript
interface UseCommandHistoryResult {
  history: string[];
  currentIndex: number;
  isSearchMode: boolean;
  searchQuery: string;

  addEntry: (command: string) => void;
  navigateUp: () => string | null;
  navigateDown: () => string | null;

  enterSearchMode: () => void;
  exitSearchMode: () => void;
  searchHistory: (query: string) => string | null;

  resetNavigation: () => void;
}
```

2. **History navigation:**
   - Track currentIndex for up/down navigation
   - navigateUp: increment index, return command at position (most recent first)
   - navigateDown: decrement index, return command or empty string at -1
   - resetNavigation: set index to -1 when user starts typing new command

3. **Reverse search (Ctrl+R):**
   - isSearchMode flag for search state
   - searchQuery tracks current search input
   - searchHistory: fuzzy match against history entries
   - Return most recent match, update as query changes
   - Exit search on Enter (execute match) or Escape (cancel)

4. **Integration with existing commandHistory utils:**
   - Use loadHistory() on mount
   - Use saveHistory() with debounce on addEntry
   - Use compressHistory() to dedupe consecutive commands
   - Cap at 1000 entries via pruneHistory()

5. **Persistence:**
   - Load from localStorage on mount
   - Save to localStorage on addEntry (debounced 1000ms)

Per user decisions:
- Up/Down arrows for recent commands
- Ctrl+R for reverse search through history
  </action>
  <verify>
Run `npm run check:types` to verify no TypeScript errors.
Verify hook integrates with existing commandHistory.ts utilities.
  </verify>
  <done>
useCommandHistory hook provides up/down navigation, Ctrl+R reverse search, and persistent history storage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate history hook into ShellComponent</name>
  <files>src/components/notebook/ShellComponent.tsx</files>
  <action>
Replace the inline command history state in ShellComponent with the new useCommandHistory hook:

1. **Replace inline history state:**
   - Remove `commandHistory` and `historyIndex` useState
   - Import and use `useCommandHistory` hook
   - Connect hook methods to terminal callbacks

2. **Update handleNavigateHistory:**
   - Call `history.navigateUp()` for 'up' direction
   - Call `history.navigateDown()` for 'down' direction
   - Return the command string to display in terminal

3. **Update handleCommand:**
   - Call `history.addEntry(command)` when command is executed
   - Call `history.resetNavigation()` to clear index

4. **Add Ctrl+R search mode UI:**
   - When isSearchMode is true, show search prompt in status bar
   - Display `(reverse-i-search)\`query\`: match` format
   - Exit search mode on Escape or Enter

5. **Wire up keyboard events:**
   - Detect Ctrl+R in terminal onData handler
   - Enter search mode, capture subsequent keystrokes for query
   - Exit on Escape (cancel) or Enter (accept current match)

6. **Status bar update:**
   - Show search mode indicator when active
   - Display current search query and match

Per user decisions:
- Command history with up/down arrows
- Ctrl+R for reverse search
  </action>
  <verify>
Run `npm run check:types` to verify no TypeScript errors.
Run `npm run check:lint` to verify no lint errors in ShellComponent.
  </verify>
  <done>
ShellComponent uses useCommandHistory for navigation and reverse search, with search mode indicator in status bar.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run check:types` - should pass with no errors
2. Run `npm run check:lint` - should have no new lint errors
3. Verify Cmd+C copies selected text, sends SIGINT when no selection
4. Verify Cmd+V pastes from clipboard into terminal
5. Verify up/down arrow navigates command history
6. Verify Ctrl+R enters reverse search mode
</verification>

<success_criteria>
- Terminal copy/paste works with Cmd+C (selection-aware) and Cmd+V
- Command history navigation with up/down arrows works correctly
- Ctrl+R reverse search shows matches as user types
- History persists to localStorage and loads on mount
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/43-shell-integration-completion/43-02-SUMMARY.md`
</output>
