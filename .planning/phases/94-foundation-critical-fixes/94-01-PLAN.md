---
phase: 94-foundation-critical-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/ui/useTipTapEditor.ts
  - src/hooks/ui/__tests__/useTipTapEditor.test.ts
autonomous: true

must_haves:
  truths:
    - "User can save card with bold/italic formatting and formatting persists after reload"
    - "User can save card with bullet/numbered lists and structure persists after reload"
    - "User can save card with links and links persist after reload"
    - "Markdown round-trip loses no formatting (TipTap → Markdown → TipTap)"
  artifacts:
    - path: "src/hooks/ui/useTipTapEditor.ts"
      provides: "Markdown serialization via @tiptap/markdown"
      contains: "generateMarkdown"
  key_links:
    - from: "src/hooks/ui/useTipTapEditor.ts"
      to: "@tiptap/markdown"
      via: "generateMarkdown import"
      pattern: "import.*generateMarkdown.*@tiptap/markdown"
---

<objective>
Fix critical data loss bug: migrate from lossy `editor.getText()` to proper `@tiptap/markdown` serialization

Purpose: Current implementation loses ALL formatting (bold, lists, links) on save. This is a **Phase 94 blocker** - no point adding features on a lossy foundation.

Output: `useTipTapEditor.ts` serializes content via `generateMarkdown()` preserving all TipTap formatting through save/load cycles.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/hooks/ui/useTipTapEditor.ts
@.planning/research/CAPTURE-PITFALLS.md (Pitfall 15: Markdown Serialization Loss)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement generateMarkdown serialization in useTipTapEditor</name>
  <files>src/hooks/ui/useTipTapEditor.ts</files>
  <action>
    1. Import `generateMarkdown` from `@tiptap/markdown` (package already installed)

    2. Replace `editor.getText()` with `generateMarkdown(editor, { ... })` in two locations:
       - Line ~250 (onUpdate callback): `const content = ed.getText()` → `const content = generateMarkdown(ed)`
       - Line ~267 (saveNow function): `const content = editor.getText()` → `const content = generateMarkdown(editor)`

    3. Remove the TODO comments on lines ~249 and ~266 that mention "Use proper markdown serialization"

    4. Configure generateMarkdown options if needed. Default options should work for StarterKit extensions:
       ```typescript
       const content = generateMarkdown(ed, {
         // TipTap extension mapping - defaults work for StarterKit
       });
       ```

    Note: `@tiptap/markdown` is already installed per package.json line 52. If type conflicts occur (as mentioned in 45-02-SUMMARY.md), use `generateMarkdown(ed as any)` temporarily with a @ts-expect-error comment.
  </action>
  <verify>
    1. Run `npm run typecheck` - should pass with zero errors
    2. Run `npm run dev` - editor should load without console errors
    3. Manual test: Type "**bold** and *italic*" → save → reload → formatting visible
  </verify>
  <done>
    - `generateMarkdown` imported from `@tiptap/markdown`
    - Both serialization paths (auto-save and manual save) use `generateMarkdown()`
    - TODO comments removed
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add round-trip test for Markdown serialization</name>
  <files>src/hooks/ui/__tests__/useTipTapEditor.test.ts</files>
  <action>
    Create or update test file to verify Markdown round-trip integrity:

    ```typescript
    import { describe, it, expect, vi, beforeEach } from 'vitest';
    import { generateMarkdown, parseMarkdown } from '@tiptap/markdown';
    import { Editor } from '@tiptap/core';
    import StarterKit from '@tiptap/starter-kit';
    import Link from '@tiptap/extension-link';

    describe('Markdown Serialization', () => {
      let editor: Editor;

      beforeEach(() => {
        // Create minimal TipTap editor for testing
        editor = new Editor({
          extensions: [
            StarterKit,
            Link.configure({ openOnClick: false }),
          ],
          content: '',
        });
      });

      afterEach(() => {
        editor.destroy();
      });

      it('preserves bold formatting through round-trip', () => {
        const original = '**bold text**';
        editor.commands.setContent(parseMarkdown(editor, original));
        const result = generateMarkdown(editor);
        expect(result).toContain('**bold');
      });

      it('preserves italic formatting through round-trip', () => {
        const original = '*italic text*';
        editor.commands.setContent(parseMarkdown(editor, original));
        const result = generateMarkdown(editor);
        expect(result).toContain('*italic');
      });

      it('preserves bullet lists through round-trip', () => {
        const original = '- item 1\\n- item 2';
        editor.commands.setContent(parseMarkdown(editor, original));
        const result = generateMarkdown(editor);
        expect(result).toMatch(/-\s*item/);
      });

      it('preserves links through round-trip', () => {
        const original = '[link text](https://example.com)';
        editor.commands.setContent(parseMarkdown(editor, original));
        const result = generateMarkdown(editor);
        expect(result).toContain('example.com');
      });

      it('preserves headings through round-trip', () => {
        const original = '# Heading 1\\n## Heading 2';
        editor.commands.setContent(parseMarkdown(editor, original));
        const result = generateMarkdown(editor);
        expect(result).toContain('# ');
        expect(result).toContain('## ');
      });
    });
    ```

    Adjust import paths and test patterns based on actual @tiptap/markdown API. The key assertion is that serialization → deserialization → serialization produces structurally equivalent output.
  </action>
  <verify>
    Run `npm test src/hooks/ui/__tests__/useTipTapEditor.test.ts` - all tests should pass
  </verify>
  <done>
    - Test file exists at `src/hooks/ui/__tests__/useTipTapEditor.test.ts`
    - Tests for bold, italic, lists, links, headings round-trip
    - All tests pass
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with zero errors
2. `npm test -- --run` passes all tests including new round-trip tests
3. Manual verification:
   - Open dev server (`npm run dev`)
   - Create new card in Capture
   - Type: "# Test\n\n**Bold** and *italic* with [link](https://example.com)\n\n- bullet 1\n- bullet 2"
   - Save card
   - Switch to different card and back
   - Original formatting is preserved
</verification>

<success_criteria>
- FOUND-01 requirement satisfied: Editor content persists formatting through save/load cycle
- `generateMarkdown()` used in all serialization paths
- Round-trip tests pass for: bold, italic, lists, links, headings
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/94-foundation-critical-fixes/94-01-SUMMARY.md`
</output>
