---
phase: 29-enhanced-apple-notes-live-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - native/Sources/Isometry/Import/AppleNotesLiveImporter.swift
  - native/Sources/Isometry/Import/NotesAccessManager.swift
autonomous: true

must_haves:
  truths:
    - "Live importer can detect Notes changes in real-time"
    - "Permission manager handles TCC authorization gracefully"
    - "Enhanced importer builds on proven AltoIndexImporter foundation"
  artifacts:
    - path: "native/Sources/Isometry/Import/AppleNotesLiveImporter.swift"
      provides: "Enhanced importer with live sync capability"
      min_lines: 200
    - path: "native/Sources/Isometry/Import/NotesAccessManager.swift"
      provides: "TCC permission and authorization management"
      exports: ["NotesAccessManager", "PermissionStatus"]
  key_links:
    - from: "AppleNotesLiveImporter.swift"
      to: "AltoIndexImporter.swift"
      via: "inheritance or composition"
      pattern: "class.*AltoIndexImporter|import.*AltoIndexImporter"
    - from: "NotesAccessManager.swift"
      to: "EventKit Framework"
      via: "TCC authorization request"
      pattern: "import EventKit|EKEventStore"
---

<objective>
Enhance existing AltoIndexImporter with live sync capability and implement TCC permission management for secure Notes access

Purpose: Establish foundation for real-time Apple Notes synchronization while respecting Apple's privacy and security requirements
Output: Enhanced importer with permission-aware live sync infrastructure
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-enhanced-apple-notes-live-integration/29-RESEARCH.md

# Existing foundation
@native/Sources/Isometry/Import/AltoIndexImporter.swift
@native/Sources/Isometry/Import/DirectAppleSyncManager.swift
@native/Sources/Isometry/Database/IsometryDatabase.swift
</context>

<tasks>

<task type="auto">
  <name>Create Enhanced AppleNotesLiveImporter</name>
  <files>native/Sources/Isometry/Import/AppleNotesLiveImporter.swift</files>
  <action>
    Create AppleNotesLiveImporter class that enhances AltoIndexImporter with live sync capabilities:

    1. **Foundation Integration:**
       - Inherit from or compose with AltoIndexImporter to reuse proven import logic
       - Maintain all existing functionality (6,891 notes successfully imported)
       - Add live sync extensions without breaking existing patterns

    2. **Live Sync Infrastructure:**
       - Add LiveSyncConfiguration struct (enable/disable, sync intervals, batch sizes)
       - Implement startLiveSync() method for continuous monitoring
       - Add stopLiveSync() method for graceful shutdown
       - Include sync status tracking (idle, syncing, error states)

    3. **Actor-based Background Processing:**
       - Use Swift Actor pattern for thread-safe background processing
       - Implement incremental sync methods (only changed notes)
       - Add change detection preparation (ready for FSEvents integration)
       - Include performance metrics tracking

    Reference existing AltoIndexImporter patterns for:
    - ParsedNote structure and parsing logic
    - Database integration with IsometryDatabase
    - Error handling and ImportResult patterns
    - Round-trip validation infrastructure
  </action>
  <verify>Swift compilation succeeds with `swift build` in native/ directory</verify>
  <done>AppleNotesLiveImporter class exists, compiles, and maintains AltoIndexImporter functionality while adding live sync foundation</done>
</task>

<task type="auto">
  <name>Implement NotesAccessManager for TCC Permissions</name>
  <files>native/Sources/Isometry/Import/NotesAccessManager.swift</files>
  <action>
    Create NotesAccessManager class for TCC permission and authorization management:

    1. **Permission Management:**
       - Define PermissionStatus enum (notDetermined, denied, restricted, authorized)
       - Implement requestNotesAccess() method using EventKit framework
       - Add checkCurrentPermissionStatus() for status queries
       - Include permission change monitoring with callbacks

    2. **Graceful Degradation:**
       - Define AccessLevel enum (none, readOnly, fullAccess)
       - Implement getAvailableAccessLevel() method
       - Add fallback strategies for different permission levels
       - Include clear user messaging for permission requirements

    3. **Security and Privacy Compliance:**
       - Follow Apple TCC best practices and App Store guidelines
       - Add proper Info.plist usage descriptions preparation
       - Implement sandbox-aware permission handling
       - Include audit logging for permission requests and usage

    Use EventKit framework for Notes access (EventKit can access Notes in iOS 17+).
    Follow established patterns from DirectAppleSyncManager for permission handling.
    Prepare for App Store submission with proper privacy compliance.
  </action>
  <verify>Swift compilation succeeds and EventKit import works correctly</verify>
  <done>NotesAccessManager provides comprehensive TCC permission management with graceful degradation and privacy compliance</done>
</task>

<task type="auto">
  <name>Integration Testing and Foundation Verification</name>
  <files>native/Sources/Isometry/Import/AppleNotesLiveImporter.swift, native/Sources/Isometry/Import/NotesAccessManager.swift</files>
  <action>
    Verify integration between enhanced components and existing infrastructure:

    1. **AltoIndexImporter Integration:**
       - Test that AppleNotesLiveImporter maintains all existing AltoIndexImporter functionality
       - Verify that existing import patterns (parseMarkdown, importNote) still work
       - Confirm round-trip validation continues to function properly

    2. **Database Integration:**
       - Test connection to IsometryDatabase actor
       - Verify Node creation and database operations work correctly
       - Confirm existing schema compatibility

    3. **Permission Flow Testing:**
       - Test NotesAccessManager permission status detection
       - Verify graceful degradation when permissions are denied
       - Test fallback to AltoIndexImporter when live access unavailable

    Add basic unit tests following existing Testing patterns in the codebase.
    Use existing ExportableImporterProtocol patterns for consistency.
    Ensure all components compile and basic functionality works before next wave.
  </action>
  <verify>Unit tests pass and integration with existing components verified</verify>
  <done>Enhanced importer and permission manager integrate seamlessly with existing infrastructure and maintain backward compatibility</done>
</task>

</tasks>

<verification>
1. AppleNotesLiveImporter class compiles and extends AltoIndexImporter functionality
2. NotesAccessManager provides TCC permission management with EventKit integration
3. Both components integrate properly with existing IsometryDatabase infrastructure
4. Unit tests demonstrate foundation functionality works correctly
5. Swift build succeeds in native/ directory without compilation errors
</verification>

<success_criteria>
- Enhanced Apple Notes import foundation established with live sync preparation
- TCC permission management implemented with graceful degradation
- Existing AltoIndexImporter functionality preserved and extended
- Ready for Wave 2 file system monitoring and conflict resolution implementation
</success_criteria>

<output>
After completion, create `.planning/phases/29-enhanced-apple-notes-live-integration/29-01-SUMMARY.md`
</output>