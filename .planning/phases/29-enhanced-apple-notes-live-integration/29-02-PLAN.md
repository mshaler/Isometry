---
phase: 29-enhanced-apple-notes-live-integration
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - native/Sources/Isometry/Import/AppleNotesWatcher.swift
  - native/Sources/Isometry/Import/AppleNotesConflictResolver.swift
autonomous: true

must_haves:
  truths:
    - "File system watcher detects Notes changes in real-time"
    - "Conflict resolver handles bidirectional sync conflicts"
    - "CRDT algorithms maintain data integrity during concurrent edits"
  artifacts:
    - path: "native/Sources/Isometry/Import/AppleNotesWatcher.swift"
      provides: "FSEvents file system monitoring for Notes changes"
      min_lines: 150
    - path: "native/Sources/Isometry/Import/AppleNotesConflictResolver.swift"
      provides: "CRDT bidirectional sync conflict resolution"
      min_lines: 200
  key_links:
    - from: "AppleNotesWatcher.swift"
      to: "AppleNotesLiveImporter.swift"
      via: "change notification callbacks"
      pattern: "delegate|callback|notification"
    - from: "AppleNotesConflictResolver.swift"
      to: "GRDB database operations"
      via: "transaction coordination"
      pattern: "database\\..*transaction|ValueObservation"
---

<objective>
Implement real-time file system monitoring and sophisticated conflict resolution for bidirectional Apple Notes synchronization

Purpose: Enable live change detection and maintain data integrity during multi-device collaborative editing scenarios
Output: Production-ready monitoring and conflict resolution infrastructure
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-enhanced-apple-notes-live-integration/29-RESEARCH.md

# Wave 1 foundation
@.planning/phases/29-enhanced-apple-notes-live-integration/29-01-SUMMARY.md

# Existing patterns
@native/Sources/Isometry/Bridge/ChangeNotificationBridge.swift
@native/Sources/Isometry/Bridge/ConflictResolutionBridge.swift
</context>

<tasks>

<task type="auto">
  <name>Implement FSEvents AppleNotesWatcher</name>
  <files>native/Sources/Isometry/Import/AppleNotesWatcher.swift</files>
  <action>
    Create AppleNotesWatcher class using FSEvents framework for real-time file system monitoring:

    1. **FSEvents Integration:**
       - Use FSEventStreamCreate for efficient file system monitoring
       - Monitor Notes database paths and related directories discovered by NotesAccessManager
       - Implement event filtering for Notes-specific file changes (*.sqlite, *.sqlite-wal, *.sqlite-shm)
       - Add debouncing to prevent excessive callback triggers (100ms minimum interval)

    2. **Change Detection Logic:**
       - Define NotesChangeEvent struct (fileURL, eventType, timestamp, metadata)
       - Implement startWatching() and stopWatching() methods
       - Add event coalescing to batch related changes
       - Include change source detection (Notes app, alto-index export, external tools)

    3. **Performance and Resource Management:**
       - Use background queue for FSEvents processing to avoid UI blocking
       - Implement proper FSEventStream lifecycle management
       - Add memory usage monitoring and cleanup
       - Include error handling for permission changes and file system issues

    Follow patterns from existing ChangeNotificationBridge for integration with GRDB ValueObservation.
    Use Swift concurrency (async/await, Actor) for thread-safe operation.
    Design for graceful degradation when file system monitoring fails.
  </action>
  <verify>FSEvents monitoring compiles and basic file change detection works</verify>
  <done>AppleNotesWatcher provides efficient real-time file system monitoring with proper resource management and error handling</done>
</task>

<task type="auto">
  <name>Create CRDT AppleNotesConflictResolver</name>
  <files>native/Sources/Isometry/Import/AppleNotesConflictResolver.swift</files>
  <action>
    Create AppleNotesConflictResolver class implementing CRDT algorithms for bidirectional sync:

    1. **CRDT Conflict Resolution:**
       - Define ConflictType enum (contentConflict, metadataConflict, deletionConflict, creationConflict)
       - Implement simple conflict resolution (last-write-wins for timestamps, merge for non-conflicting fields)
       - Add complex conflict detection (simultaneous content edits, conflicting deletions)
       - Include conflict history tracking for debugging and user reference

    2. **Bidirectional Sync Logic:**
       - Implement compareNoteVersions() method for detecting conflicts
       - Add automatic merge strategies for non-conflicting changes
       - Create conflict resolution UI data structures for user-guided resolution
       - Include rollback mechanisms for failed merge operations

    3. **Integration with Database Transactions:**
       - Use GRDB transaction coordination for atomic conflict resolution
       - Implement conflict queuing for sequential processing
       - Add correlation IDs for tracking conflict resolution across operations
       - Include performance metrics for conflict resolution timing

    Reference existing ConflictResolutionBridge patterns for transaction safety.
    Use patterns from existing bridge infrastructure for correlation tracking.
    Design conflict resolution to be conservative - prefer user guidance over data loss.
  </action>
  <verify>Conflict resolution compiles and basic merge logic works correctly</verify>
  <done>AppleNotesConflictResolver provides sophisticated CRDT conflict resolution with atomic transaction safety and user guidance</done>
</task>

<task type="auto">
  <name>Integration and Live Sync Wiring</name>
  <files>native/Sources/Isometry/Import/AppleNotesLiveImporter.swift</files>
  <action>
    Enhance AppleNotesLiveImporter to integrate watcher and conflict resolver:

    1. **Component Integration:**
       - Add AppleNotesWatcher and AppleNotesConflictResolver as dependencies
       - Implement live sync coordination between file monitoring and database operations
       - Add sync state management (idle, monitoring, syncing, conflictResolution, error)
       - Include graceful startup and shutdown procedures

    2. **Real-time Sync Pipeline:**
       - Wire FSEvents callbacks to trigger incremental imports
       - Implement change processing pipeline (detect -> parse -> conflict-check -> resolve -> apply)
       - Add sync throttling to prevent overwhelming the database during bulk changes
       - Include progress reporting for UI integration

    3. **Error Handling and Recovery:**
       - Add comprehensive error handling for all sync pipeline stages
       - Implement retry logic with exponential backoff for temporary failures
       - Include sync state persistence for recovery after app restarts
       - Add health monitoring and circuit breaker patterns

    Follow existing bridge patterns for error handling and retry logic.
    Use GRDB ValueObservation patterns for efficient database integration.
    Ensure all operations maintain transaction safety and data integrity.
  </action>
  <verify>Full live sync pipeline works correctly and handles basic conflict scenarios</verify>
  <done>AppleNotesLiveImporter provides complete live sync infrastructure with integrated monitoring, conflict resolution, and error recovery</done>
</task>

</tasks>

<verification>
1. AppleNotesWatcher detects Notes file system changes efficiently using FSEvents
2. AppleNotesConflictResolver handles CRDT conflict resolution with transaction safety
3. AppleNotesLiveImporter integrates all components into working live sync pipeline
4. Error handling and recovery mechanisms work correctly
5. Performance is suitable for large Notes libraries (1000+ notes)
</verification>

<success_criteria>
- Real-time file system monitoring operational with <1s change detection
- CRDT conflict resolution maintains data integrity during concurrent edits
- Live sync pipeline processes changes efficiently with proper error handling
- Ready for Wave 3 UI integration and performance optimization
</success_criteria>

<output>
After completion, create `.planning/phases/29-enhanced-apple-notes-live-integration/29-02-SUMMARY.md`
</output>