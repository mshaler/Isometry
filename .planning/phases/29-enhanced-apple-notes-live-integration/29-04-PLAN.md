---
phase: 29-enhanced-apple-notes-live-integration
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [native/Sources/Isometry/Import/AppleNotesLiveImporter.swift]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Live importer detects Notes changes in real-time without alto-index fallback"
    - "EventKit access provides direct Notes content parsing"
    - "Real-time sync operates within <1s change detection latency"
  artifacts:
    - path: "native/Sources/Isometry/Import/AppleNotesLiveImporter.swift"
      provides: "Real EventKit-based live sync implementation"
      min_lines: 800
  key_links:
    - from: "AppleNotesLiveImporter.performLiveNotesSync()"
      to: "EventKit Framework Notes access"
      via: "direct EventKit integration"
      pattern: "EKEvent.*Notes|EventKit.*access"
---

<objective>
Replace alto-index fallback with real EventKit-based live Notes synchronization

Purpose: Enable true real-time Apple Notes synchronization as promised by Phase 29 goal
Output: AppleNotesLiveImporter with functional EventKit access replacing TODO stubs
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/29-enhanced-apple-notes-live-integration/29-01-SUMMARY.md
@.planning/phases/29-enhanced-apple-notes-live-integration/29-02-SUMMARY.md
@.planning/phases/29-enhanced-apple-notes-live-integration/29-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Implement real EventKit-based Notes access</name>
  <files>native/Sources/Isometry/Import/AppleNotesLiveImporter.swift</files>
  <action>
    Replace TODO fallback in performLiveNotesSync() (line 301-304) with real EventKit implementation:
    - Import EventKit framework for Notes access
    - Implement EKEventStore Notes access with proper TCC permission checks
    - Replace alto-index fallback with direct Notes database parsing
    - Add Notes content extraction using EventKit APIs
    - Maintain existing AltoIndexImporter compatibility as fallback only when EventKit fails

    Gap reason: FSEvents monitoring exists but EventKit live sync falls back to alto-index instead of providing real-time access
    Reference existing code: NotesAccessManager provides TCC permission foundation, AppleNotesWatcher provides change detection
  </action>
  <verify>swift build from native/ directory completes successfully, grep shows no "TODO.*Wave 2" or "alto-index fallback" in performLiveNotesSync</verify>
  <done>Live sync method uses EventKit for real Notes access instead of alto-index fallback</done>
</task>

<task type="auto">
  <name>Implement incremental sync with FSEvents integration</name>
  <files>native/Sources/Isometry/Import/AppleNotesLiveImporter.swift</files>
  <action>
    Replace TODO in performIncrementalSync() (line 270) with FSEvents-based change detection:
    - Use AppleNotesWatcher FSEvents monitoring for changed Notes files
    - Implement file modification time checking for incremental processing
    - Add change correlation between FSEvents and EventKit content
    - Process only changed Notes since last sync timestamp
    - Maintain sync state to track incremental changes efficiently

    Gap reason: Incremental sync placeholder prevents efficient large library processing
    Reference existing code: AppleNotesWatcher provides FSEvents monitoring, existing metrics tracking infrastructure
  </action>
  <verify>grep shows no "TODO.*Wave 2" in performIncrementalSync, FSEvents integration code present</verify>
  <done>Incremental sync uses real-time file monitoring instead of full library scans</done>
</task>

<task type="auto">
  <name>Integrate EventKit with existing CRDT conflict resolution</name>
  <files>native/Sources/Isometry/Import/AppleNotesLiveImporter.swift</files>
  <action>
    Connect EventKit Notes access with existing AppleNotesConflictResolver:
    - Parse Notes content from EventKit into Node format for conflict detection
    - Integrate EventKit change timestamps with CRDT resolution algorithms
    - Handle EventKit content conflicts during bidirectional sync
    - Maintain transaction safety when writing resolved content back via EventKit
    - Add error handling for EventKit API failures with graceful alto-index fallback

    Gap reason: Real EventKit access needed to leverage existing CRDT infrastructure
    Reference existing code: AppleNotesConflictResolver provides CRDT algorithms, existing transaction coordination patterns
  </action>
  <verify>Successful compilation with EventKit imports, conflict resolution integration code present</verify>
  <done>EventKit Notes content integrates seamlessly with existing conflict resolution pipeline</done>
</task>

</tasks>

<verification>
swift build from native/ directory compiles successfully
grep -i "eventkit\|eknotes\|ekevent" AppleNotesLiveImporter.swift shows EventKit integration
no remaining "TODO.*fallback" or "alto-index fallback" comments in live sync methods
</verification>

<success_criteria>
Live Notes synchronization operates through EventKit instead of alto-index parsing
Real-time change detection combines FSEvents monitoring with EventKit content access
CRDT conflict resolution processes EventKit-sourced Notes content
Compilation succeeds and live sync infrastructure supports true real-time operation
</success_criteria>

<output>
After completion, create `.planning/phases/29-enhanced-apple-notes-live-integration/29-04-SUMMARY.md`
</output>