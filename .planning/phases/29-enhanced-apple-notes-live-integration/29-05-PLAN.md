---
phase: 29-enhanced-apple-notes-live-integration
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [src/components/settings/NotesIntegrationSettings.tsx]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "React settings UI communicates with native bridge for real configuration"
    - "User settings changes flow from React to native AppleNotesLiveImporter"
    - "Live sync status reflects actual native implementation state"
  artifacts:
    - path: "src/components/settings/NotesIntegrationSettings.tsx"
      provides: "Real WebView bridge communication for Notes settings"
      min_lines: 500
  key_links:
    - from: "NotesIntegrationSettings.executeQuery"
      to: "WebView bridge communication"
      via: "useLiveDataContext bridge API"
      pattern: "executeQuery.*notes\\."
---

<objective>
Replace mock executeQuery with real WebView bridge communication for Notes settings

Purpose: Enable actual React-native synchronization for Notes integration configuration
Output: NotesIntegrationSettings with functional bridge communication replacing mock data
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/29-enhanced-apple-notes-live-integration/29-01-SUMMARY.md
@.planning/phases/29-enhanced-apple-notes-live-integration/29-02-SUMMARY.md
@.planning/phases/29-enhanced-apple-notes-live-integration/29-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Replace mock executeQuery with real bridge communication</name>
  <files>src/components/settings/NotesIntegrationSettings.tsx</files>
  <action>
    Replace mock executeQuery implementation (lines 57-59) with real useLiveDataContext bridge calls:
    - Remove mock console.log and fake data returns
    - Use useLiveDataContext().executeQuery for native bridge communication
    - Implement proper error handling for bridge communication failures
    - Add loading states and user feedback for async bridge operations
    - Map React component method calls to native AppleNotesLiveImporter methods

    Specific bridge API mapping:
    - notes.getPermissionStatus → NotesAccessManager.getPermissionStatus
    - notes.requestPermission → NotesAccessManager.requestNotesAccess
    - notes.getLiveSyncStatus → AppleNotesLiveImporter.getLiveSyncStatus
    - notes.setLiveSyncEnabled → AppleNotesLiveImporter.configureLiveSync
    - notes.startLiveSync → AppleNotesLiveImporter.startLiveSync
    - notes.stopLiveSync → AppleNotesLiveImporter.stopLiveSync

    Gap reason: React component uses mock data instead of actual WebView bridge communication for settings coordination
    Reference existing code: useLiveDataContext from Phase 27, existing bridge patterns from live database integration
  </action>
  <verify>No "mock" comments remain, useLiveDataContext().executeQuery calls present, compilation succeeds with npm run build</verify>
  <done>React component communicates with native layer through functional WebView bridge</done>
</task>

<task type="auto">
  <name>Add native bridge method handlers for Notes API</name>
  <files>src/components/settings/NotesIntegrationSettings.tsx</files>
  <action>
    Enhance bridge communication with proper Notes-specific error handling:
    - Add try-catch blocks for each bridge method call
    - Implement timeout handling for bridge operations (5s timeout)
    - Add retry logic for failed permission requests (max 3 attempts)
    - Handle bridge disconnection gracefully with user notification
    - Display connection status indicator for bridge health

    Bridge error handling patterns:
    - Permission denied → show clear instructions for manual permission grant
    - Bridge timeout → retry with exponential backoff
    - Native error → display user-friendly error messages
    - Connection lost → show reconnection attempts

    Gap reason: Native API integration for settings synchronization requires proper bridge communication patterns
    Reference existing code: Bridge error handling patterns from Phase 27 integration, circuit breaker patterns from v3.1 infrastructure
  </action>
  <verify>Bridge error handling code present, timeout and retry logic implemented, user feedback for connection issues</verify>
  <done>Bridge communication includes robust error handling and user experience features</done>
</task>

<task type="auto">
  <name>Synchronize React state with native Notes integration status</name>
  <files>src/components/settings/NotesIntegrationSettings.tsx</files>
  <action>
    Add real-time state synchronization between React UI and native Notes integration:
    - Subscribe to native Notes sync status changes via bridge events
    - Update React component state when native permission status changes
    - Reflect real-time sync progress and error states in UI
    - Synchronize sync frequency and configuration changes bidirectionally
    - Handle native-initiated state changes (e.g., permission revoked by system)

    State synchronization events:
    - notes.permissionChanged → update permissionStatus state
    - notes.syncStatusChanged → update liveSyncStatus state
    - notes.syncProgress → update progress indicators
    - notes.conflictDetected → show conflict resolution UI
    - notes.errorOccurred → display error notifications

    Gap reason: React component needs to reflect actual native implementation state instead of mock data
    Reference existing code: Live data subscription patterns from Phase 26, real-time update propagation infrastructure
  </action>
  <verify>Event subscription code present, state updates from native events, bidirectional sync working</verify>
  <done>React UI reflects real-time native Notes integration status and responds to state changes</done>
</task>

</tasks>

<verification>
npm run build completes successfully from project root
grep shows no "mock" references in NotesIntegrationSettings.tsx
useLiveDataContext().executeQuery calls present for all Notes methods
bridge error handling and state synchronization code implemented
</verification>

<success_criteria>
React Notes settings UI communicates with native layer through functional bridge
User configuration changes flow from React to AppleNotesLiveImporter methods
Settings reflect actual native sync status and permission state
Bridge communication includes error handling and real-time state updates
</success_criteria>

<output>
After completion, create `.planning/phases/29-enhanced-apple-notes-live-integration/29-05-SUMMARY.md`
</output>