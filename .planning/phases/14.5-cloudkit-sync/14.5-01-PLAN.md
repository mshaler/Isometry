---
phase: 14.5-cloudkit-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  "native/Sources/Isometry/WebView/CloudKitMessageHandler.swift",
  "src/services/CloudKitSyncAdapter.ts",
  "src/hooks/useCloudKitSync.ts",
  "src/components/sync/SyncStatusIndicator.tsx"
]
autonomous: true

must_haves:
  truths:
    - "React components trigger CloudKit sync operations through WebView bridge"
    - "Real-time sync status updates appear in React UI with progress indicators"
    - "Conflict resolution prompts appear when data conflicts are detected"
    - "Offline sync queue accumulates changes for later sync when connection returns"
    - "Multi-device sync maintains data consistency across iOS/macOS apps"
  artifacts:
    - path: "native/Sources/Isometry/WebView/CloudKitMessageHandler.swift"
      provides: "WebView bridge for CloudKit sync operations"
      exports: ["CloudKitMessageHandler"]
    - path: "src/services/CloudKitSyncAdapter.ts"
      provides: "React service for CloudKit sync coordination"
      exports: ["CloudKitSyncAdapter", "SyncStatus", "ConflictEvent"]
    - path: "src/hooks/useCloudKitSync.ts"
      provides: "React hook for sync state management"
      exports: ["useCloudKitSync"]
    - path: "src/components/sync/SyncStatusIndicator.tsx"
      provides: "Visual sync status and progress component"
      exports: ["SyncStatusIndicator"]
  key_links:
    - from: "src/services/CloudKitSyncAdapter.ts"
      to: "native CloudKitSyncManager"
      via: "WebView bridge messages"
      pattern: "postMessage.*cloudKitSync"
    - from: "src/hooks/useCloudKitSync.ts"
      to: "src/services/CloudKitSyncAdapter.ts"
      via: "service instance and event listeners"
      pattern: "cloudKitSyncAdapter\\.(sync|getStatus)"
    - from: "native/Sources/Isometry/WebView/CloudKitMessageHandler.swift"
      to: "CloudKitSyncManager"
      via: "actor method calls"
      pattern: "await syncManager\\.(sync|getState)"
---

<objective>
Bridge React components to native CloudKit sync infrastructure, enabling real-time data synchronization with conflict resolution and offline queue management.

Purpose: Complete the React-native integration suite by connecting React state management to CloudKit's production-ready sync infrastructure, enabling seamless multi-device synchronization with intelligent conflict resolution.

Output: Production-ready CloudKit sync bridge with real-time status updates, conflict resolution UI, and comprehensive sync queue management.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# CloudKit Infrastructure
@native/Sources/Isometry/Sync/CloudKitSyncManager.swift
@src/utils/sync-manager.ts

# Established Bridge Patterns (Phases 14.1-14.4)
@.planning/phases/14.4-graph-integration/14.4-01-SUMMARY.md
@native/Sources/Isometry/WebView/DatabaseMessageHandler.swift
@native/Sources/Isometry/WebView/PAFVMessageHandler.swift
@src/services/GraphAnalyticsAdapter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Native CloudKit WebView Bridge</name>
  <files>native/Sources/Isometry/WebView/CloudKitMessageHandler.swift</files>
  <action>
    Create CloudKitMessageHandler.swift following established Phase 14.1-14.4 WebView bridge patterns:

    **Architecture:**
    - @MainActor class CloudKitMessageHandler: NSObject, WKScriptMessageHandler
    - Integration with existing CloudKitSyncManager actor via Task { await ... }
    - MessageHandlerPerformanceMonitor and SecurityValidator integration (existing patterns)
    - JSON encoding/decoding with ISO8601 dates for consistency

    **Supported Methods:**
    - "sync" -> Full sync operation with progress callbacks
    - "getStatus" -> Current sync state and progress
    - "getConflicts" -> Pending conflicts requiring resolution
    - "resolveConflict" -> Manual conflict resolution with chosen data
    - "setConflictStrategy" -> Configure automatic conflict resolution
    - "enableRealTimeSync" -> Start automatic sync with change notifications
    - "disableRealTimeSync" -> Stop automatic sync
    - "getQueueStatus" -> Offline sync queue status and metrics

    **Implementation Pattern:**
    ```swift
    private func handleSync(params: [String: Any], requestId: String, webView: WKWebView?) async {
        guard let syncManager = database?.syncManager else { return sendError(...) }

        // Set progress callback for React updates
        await syncManager.setProgressCallback { @MainActor progress in
            self.sendProgressUpdate(progress, requestId: requestId, webView: webView)
        }

        do {
            try await syncManager.sync()
            await sendSuccessResponse(to: webView, data: ["success": true], requestId: requestId)
        } catch {
            await sendErrorResponse(to: webView, error: error.localizedDescription, requestId: requestId)
        }
    }
    ```

    **Security & Performance:**
    - Method validation against allowed operations whitelist
    - Request rate limiting (max 10 sync requests per minute)
    - Parameter validation for conflict resolution data integrity
    - Performance monitoring for sync operation latency tracking
    - Error boundary handling with user-friendly error messages

    **Integration Points:**
    - CloudKitSyncManager.sync() for full sync operations
    - CloudKitSyncManager.getSyncState() for status queries
    - CloudKitSyncManager.getPendingConflicts() for conflict management
    - CloudKitSyncManager.setConflictResolutionStrategy() for strategy configuration
    - Real-time progress callbacks via setProgressCallback()

    Follow exact patterns from Phase 14.4 GraphMessageHandler including error handling, performance monitoring, and actor isolation.
  </action>
  <verify>Swift compilation succeeds and CloudKitMessageHandler imports correctly in WebView container</verify>
  <done>Native CloudKit bridge handles sync operations with progress callbacks and conflict resolution</done>
</task>

<task type="auto">
  <name>Task 2: React CloudKit Sync Service</name>
  <files>src/services/CloudKitSyncAdapter.ts</files>
  <action>
    Create CloudKitSyncAdapter.ts following established Phase 14.1-14.4 service patterns:

    **Architecture:**
    - Export class CloudKitSyncAdapter with singleton pattern
    - Integration with existing webViewBridge infrastructure
    - Event-driven architecture with TypeScript interfaces
    - Performance monitoring with metrics collection

    **Core Interfaces:**
    ```typescript
    export interface SyncStatus {
      isConnected: boolean;
      syncProgress: number; // 0.0 to 1.0
      lastSync: Date | null;
      pendingChanges: number;
      conflictCount: number;
      isInitialSync: boolean;
      consecutiveFailures: number;
      lastError?: string;
    }

    export interface ConflictEvent {
      id: string;
      localData: Record<string, unknown>;
      serverData: Record<string, unknown>;
      conflictType: 'both_modified' | 'local_deleted' | 'server_deleted';
      detectedAt: Date;
      requiresManualResolution: boolean;
    }

    export interface SyncQueueStatus {
      pending: number;
      processing: number;
      failed: number;
      lastProcessed: Date | null;
    }
    ```

    **Methods Implementation:**
    - async sync(): Promise&lt;void&gt; -> Trigger full sync with progress events
    - async getSyncStatus(): Promise&lt;SyncStatus&gt; -> Current sync state
    - async getPendingConflicts(): Promise&lt;ConflictEvent[]&gt; -> Conflicts needing resolution
    - async resolveConflict(conflictId: string, resolution: ConflictResolution): Promise&lt;void&gt;
    - async setConflictStrategy(strategy: ConflictStrategy): Promise&lt;void&gt;
    - async enableRealTimeSync(): Promise&lt;void&gt; -> Start automatic sync
    - async disableRealTimeSync(): Promise&lt;void&gt; -> Stop automatic sync

    **Event System:**
    - Custom events for sync progress updates ('cloudkit-sync-progress')
    - Conflict detection events ('cloudkit-conflict-detected')
    - Sync completion events ('cloudkit-sync-complete')
    - Connection status changes ('cloudkit-connection-change')
    - Error events with retry suggestions ('cloudkit-sync-error')

    **Caching & Performance:**
    - Status caching with 2-second TTL for UI performance
    - Debounced sync operations (500ms) to prevent duplicate requests
    - Progressive sync progress updates for large datasets
    - Local conflict queue with persistence across page refreshes
    - Performance metrics tracking for sync operation analysis

    **Error Handling:**
    - Comprehensive error categorization (network, auth, quota, conflicts)
    - Exponential backoff for retryable errors
    - User-friendly error messages with action suggestions
    - Offline queue management with automatic retry on reconnection

    Follow exact patterns from GraphAnalyticsAdapter.ts including caching, error boundaries, and event management.
  </action>
  <verify>TypeScript compilation succeeds and CloudKitSyncAdapter integrates with webViewBridge</verify>
  <done>React service provides full CloudKit sync coordination with progress tracking and conflict management</done>
</task>

<task type="auto">
  <name>Task 3: React Sync Hook and Status UI</name>
  <files>src/hooks/useCloudKitSync.ts, src/components/sync/SyncStatusIndicator.tsx</files>
  <action>
    Create useCloudKitSync.ts and SyncStatusIndicator.tsx following established Phase 14.1-14.4 patterns:

    **useCloudKitSync Hook:**
    ```typescript
    export function useCloudKitSync() {
      const [syncStatus, setSyncStatus] = useState<SyncStatus>({
        isConnected: false,
        syncProgress: 0,
        lastSync: null,
        pendingChanges: 0,
        conflictCount: 0,
        isInitialSync: false,
        consecutiveFailures: 0
      });

      const [conflicts, setConflicts] = useState<ConflictEvent[]>([]);
      const [queueStatus, setQueueStatus] = useState<SyncQueueStatus>({
        pending: 0,
        processing: 0,
        failed: 0,
        lastProcessed: null
      });

      // Event listeners for real-time updates
      useEffect(() => {
        const handleProgressUpdate = (event: CustomEvent) => {
          setSyncStatus(prev => ({ ...prev, ...event.detail }));
        };

        const handleConflictDetected = (event: CustomEvent) => {
          setConflicts(prev => [...prev, event.detail]);
        };

        window.addEventListener('cloudkit-sync-progress', handleProgressUpdate);
        window.addEventListener('cloudkit-conflict-detected', handleConflictDetected);

        return () => {
          window.removeEventListener('cloudkit-sync-progress', handleProgressUpdate);
          window.removeEventListener('cloudkit-conflict-detected', handleConflictDetected);
        };
      }, []);

      // Methods
      const startSync = useCallback(async () => {
        await cloudKitSyncAdapter.sync();
      }, []);

      const resolveConflict = useCallback(async (conflictId: string, resolution: ConflictResolution) => {
        await cloudKitSyncAdapter.resolveConflict(conflictId, resolution);
        setConflicts(prev => prev.filter(c => c.id !== conflictId));
      }, []);

      return {
        syncStatus,
        conflicts,
        queueStatus,
        startSync,
        resolveConflict,
        setConflictStrategy: cloudKitSyncAdapter.setConflictStrategy,
        enableRealTimeSync: cloudKitSyncAdapter.enableRealTimeSync,
        disableRealTimeSync: cloudKitSyncAdapter.disableRealTimeSync
      };
    }
    ```

    **SyncStatusIndicator Component:**
    - Visual progress bar with percentage display during active sync
    - Connection status indicator (green=connected, yellow=connecting, red=offline)
    - Last sync timestamp with relative time formatting
    - Conflict count badge with click-to-view functionality
    - Pending changes counter with queue status tooltip
    - Error state display with retry button and error message
    - Compact mode for header integration and expanded mode for settings
    - Real-time updates via useCloudKitSync hook

    **UI Features:**
    - Animated progress bar with smooth transitions during sync operations
    - Color-coded status indicators following design system patterns
    - Click-to-expand conflict resolution interface
    - Manual sync trigger button with loading state
    - Offline indicator with queued changes count
    - Auto-refresh status every 30 seconds when app is active
    - Responsive design for mobile and desktop layouts

    **Integration Points:**
    - useCloudKitSync hook for all sync state management
    - Tailwind CSS classes following established component patterns
    - React DevTools integration for debugging sync state
    - Accessibility support with proper ARIA labels and keyboard navigation
    - Error boundary integration for graceful sync error handling

    Follow exact patterns from Phase 14.4 components including state management, UI patterns, and accessibility.
  </action>
  <verify>Components render correctly and sync status updates in real-time during CloudKit operations</verify>
  <done>React hook and UI components provide comprehensive CloudKit sync status and control interface</done>
</task>

</tasks>

<verification>
1. CloudKitMessageHandler handles WebView bridge requests correctly with proper actor integration
2. CloudKitSyncAdapter provides full React interface to CloudKit sync operations
3. useCloudKitSync hook delivers real-time sync state updates to React components
4. SyncStatusIndicator shows live progress during sync operations
5. Conflict resolution workflow functions end-to-end from detection to resolution
6. Offline sync queue accumulates changes and processes when connection returns
7. Multi-device sync demonstrates data consistency across iOS/macOS apps
8. Performance monitoring tracks sync operation latency and success rates
</verification>

<success_criteria>
1. **Real-time Sync Bridge**: React components trigger CloudKit sync through WebView bridge with <100ms latency
2. **Progress Tracking**: Live progress updates appear in SyncStatusIndicator during sync operations
3. **Conflict Resolution**: Conflict detection triggers user prompts with resolution options
4. **Offline Support**: Sync queue accumulates offline changes for automatic retry on reconnection
5. **Multi-device Consistency**: Data synchronizes correctly between iOS/macOS apps via CloudKit
6. **Performance Standards**: Sync operations complete within established latency targets (<5 seconds for typical datasets)
7. **Error Handling**: Comprehensive error categorization with user-friendly messages and retry mechanisms
8. **Integration Quality**: Seamless integration with existing React state management and native CloudKit infrastructure
</success_criteria>

<output>
After completion, create `.planning/phases/14.5-cloudkit-sync/14.5-01-SUMMARY.md`
</output>