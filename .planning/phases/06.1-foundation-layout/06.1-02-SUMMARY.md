---
phase: 06.1-foundation-layout
plan: 02
subsystem: database
tags: [sqlite, cloudkit, sync, schema-migration, fts5, grdb, notebook]

# Dependency graph
requires:
  - phase: 05-xcode-migration
    provides: SQLite database infrastructure with GRDB and CloudKit sync
provides:
  - notebook_cards database table with FTS5 full-text search
  - NotebookCard Swift model with GRDB integration
  - CloudKit sync support for notebook cards
  - Complete CRUD operations for notebook data persistence
affects: [06.2-capture, 06.3-shell, 06.4-preview]

# Tech tracking
tech-stack:
  added: [notebook_cards table, NotebookCard model, CloudKit NotebookCard sync]
  patterns: [GRDB FetchableRecord/PersistableRecord conformance, CloudKit record conversion, JSON field encoding]

key-files:
  created:
    - native/Sources/Isometry/Models/NotebookCard.swift
  modified:
    - native/Sources/Isometry/Resources/schema.sql
    - native/Sources/Isometry/Database/IsometryDatabase.swift
    - native/Sources/Isometry/Sync/CloudKitSyncManager.swift

key-decisions:
  - "Use simplified [String: String] properties for Phase 6.1, extensible to complex types later"
  - "Match existing Node patterns exactly for consistent sync behavior"
  - "Add separate pushNotebookCards method for Phase 6.2 integration"

patterns-established:
  - "Database schema extension pattern: tables, indexes, FTS5, migration tracking"
  - "GRDB model pattern: init(row:), encode(to:), JSON field handling"
  - "CloudKit sync pattern: record conversion, conflict resolution, chunked uploads"

# Metrics
duration: 15min
completed: 2026-01-25
---

# Phase 06.1 Plan 02: Database Schema Extension Summary

**SQLite notebook_cards table with FTS5 search, NotebookCard Swift model with GRDB integration, and CloudKit sync support**

## Performance

- **Duration:** 15 min
- **Started:** 2026-01-25T23:33:00Z
- **Completed:** 2026-01-25T23:48:00Z
- **Tasks:** 3/3
- **Files modified:** 4

## Accomplishments
- Extended database schema with notebook_cards table using existing Node patterns
- Full-text search enabled with FTS5 virtual table and triggers
- NotebookCard Swift model with complete GRDB conformance and JSON field support
- CloudKit sync infrastructure supporting notebook card synchronization
- Complete CRUD API in IsometryDatabase for notebook card operations

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend database schema + Task 2: Create NotebookCard model** - `522af91` (feat)
2. **Task 3: Add database methods and CloudKit sync** - `d38ed8f` (feat)

## Files Created/Modified
- `native/Sources/Isometry/Models/NotebookCard.swift` - Swift model with GRDB conformance and JSON field handling
- `native/Sources/Isometry/Resources/schema.sql` - Added notebook_cards table with indexes and FTS5 support
- `native/Sources/Isometry/Database/IsometryDatabase.swift` - CRUD operations for notebook cards
- `native/Sources/Isometry/Sync/CloudKitSyncManager.swift` - CloudKit record conversion and sync support

## Decisions Made
- **Schema design approach:** Follow existing Node table patterns exactly to ensure consistent behavior and easy maintenance
- **Properties structure:** Use simplified `[String: String]` dictionary for Phase 6.1, extensible to complex types in future phases
- **Sync integration strategy:** Add NotebookCard handling to existing sync flow while maintaining separate push method for Phase 6.2 integration
- **Conflict resolution:** Use server-wins strategy for Phase 6.1, defer complex notebook-specific resolution to Phase 6.2

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed GRDB PersistenceContainer key access**
- **Found during:** Task 2 (NotebookCard model compilation)
- **Issue:** `container[CodingKeys.field]` syntax invalid, requires `.rawValue` for String keys
- **Fix:** Updated all container assignments to use `CodingKeys.field.rawValue`
- **Files modified:** NotebookCard.swift
- **Verification:** Build compiles successfully with GRDB conformance
- **Committed in:** 522af91 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 bug)
**Impact on plan:** Essential fix for GRDB integration. No scope creep.

## Issues Encountered
- GRDB PersistenceContainer requires raw string values for CodingKeys - easily resolved by following existing patterns

## Next Phase Readiness
- Database schema supports full notebook workflow with persistence and sync
- NotebookCard model ready for markdown editor integration (Phase 6.2)
- CloudKit sync infrastructure handles notebook cards alongside existing nodes
- FTS5 search ready for notebook content discovery
- Foundation complete for capture, shell, and preview data storage

## Authentication Gates
None - database and CloudKit schema extensions work with existing authentication.

---
*Phase: 06.1-foundation-layout*
*Completed: 2026-01-25*