---
phase: 95-data-layer-backlinks
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/RightSidebar.tsx
  - src/components/notebook/BacklinksPanel.tsx
  - src/utils/editor/backlinks.ts
autonomous: true

must_haves:
  truths:
    - "User can see Backlinks tab in RightSidebar"
    - "Backlinks panel shows all cards linking to current card"
    - "Clicking backlink navigates to that card"
    - "Backlink count badge shows in panel header"
  artifacts:
    - path: "src/components/notebook/BacklinksPanel.tsx"
      provides: "Backlinks list with navigation"
      exports: ["BacklinksPanel"]
    - path: "src/components/RightSidebar.tsx"
      provides: "Third tab for backlinks"
      contains: "id: 'backlinks'"
  key_links:
    - from: "BacklinksPanel.tsx"
      to: "backlinks.ts"
      via: "queryBacklinks function"
      pattern: "import.*queryBacklinks.*from"
    - from: "BacklinksPanel.tsx"
      to: "NotebookContext"
      via: "loadCard for navigation"
      pattern: "loadCard\\("
---

<objective>
Create Backlinks panel in RightSidebar showing cards that link to current card.

Purpose: Enable Obsidian-style graph navigation by showing reverse relationships (BACK-01 through BACK-04).

Output: BacklinksPanel component, Backlinks tab in RightSidebar, navigation on click.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/95-data-layer-backlinks/95-RESEARCH.md

# Existing patterns
@src/components/RightSidebar.tsx
@src/utils/editor/backlinks.ts
@src/contexts/NotebookContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update queryBacklinks to exclude self-references</name>
  <files>src/utils/editor/backlinks.ts</files>
  <action>
Update the queryBacklinks function to:
1. Exclude self-referencing links (where source_id === target_id)
2. Add LIMIT 50 for performance
3. Improve the query to handle edge cases

Update the SQL in queryBacklinks:

```typescript
export function queryBacklinks(
  db: Database | null,
  cardId: string,
  limit: number = 50
): BacklinkInfo[] {
  if (!db) return [];

  try {
    const results = db.exec(
      `SELECT DISTINCT n.id, n.name, e.created_at
       FROM nodes n
       JOIN edges e ON e.source_id = n.id
       WHERE e.target_id = ?
         AND e.source_id != ?  -- Exclude self-references
         AND e.edge_type = 'LINK'
         AND n.deleted_at IS NULL
       ORDER BY e.created_at DESC
       LIMIT ?`,
      [cardId, cardId, limit]
    );

    if (!results[0]?.values) return [];

    return results[0].values.map(([id, name, createdAt]) => ({
      id: String(id),
      name: String(name),
      createdAt: String(createdAt),
    }));
  } catch (error) {
    console.error('Failed to query backlinks:', error);
    return [];
  }
}
```

The key changes:
- Added `e.source_id != ?` to exclude self-referencing links
- Added `LIMIT ?` parameter for performance protection
- Both use the same cardId value, passed twice in params array
  </action>
  <verify>
Run `npm run typecheck` - should pass. The function signature now accepts an optional limit parameter.
  </verify>
  <done>
queryBacklinks excludes self-references and has configurable LIMIT (default 50).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create BacklinksPanel component</name>
  <files>src/components/notebook/BacklinksPanel.tsx</files>
  <action>
Create a new component that displays backlinks for the current active card:

```typescript
import { useState, useEffect, useCallback } from 'react';
import { Link2, ExternalLink } from 'lucide-react';
import { useTheme } from '@/contexts/ThemeContext';
import { useSQLite } from '@/db/SQLiteProvider';
import { useNotebook } from '@/contexts/NotebookContext';
import { queryBacklinks, type BacklinkInfo } from '@/utils/editor/backlinks';

interface BacklinksPanelProps {
  className?: string;
}

export function BacklinksPanel({ className }: BacklinksPanelProps) {
  const { theme } = useTheme();
  const { db } = useSQLite();
  const { activeCard, loadCard } = useNotebook();
  const [backlinks, setBacklinks] = useState<BacklinkInfo[]>([]);
  const [loading, setLoading] = useState(false);

  // Load backlinks when active card changes
  useEffect(() => {
    if (!activeCard?.nodeId || !db) {
      setBacklinks([]);
      return;
    }

    setLoading(true);
    try {
      const links = queryBacklinks(db, activeCard.nodeId);
      setBacklinks(links);
    } catch (error) {
      console.error('Failed to load backlinks:', error);
      setBacklinks([]);
    } finally {
      setLoading(false);
    }
  }, [activeCard?.nodeId, db]);

  // Navigate to a linked card
  const handleNavigate = useCallback((cardId: string) => {
    loadCard(cardId);
  }, [loadCard]);

  // Format date for display
  const formatDate = (dateStr: string) => {
    try {
      return new Date(dateStr).toLocaleDateString();
    } catch {
      return dateStr;
    }
  };

  const textClass = theme === 'NeXTSTEP' ? 'text-gray-700' : 'text-gray-600';
  const hoverClass = theme === 'NeXTSTEP'
    ? 'hover:bg-[#b0b0b0]'
    : 'hover:bg-gray-100';
  const borderClass = theme === 'NeXTSTEP' ? 'border-[#999999]' : 'border-gray-200';

  // No active card
  if (!activeCard) {
    return (
      <div className={`${className} p-4`}>
        <p className="text-xs text-center text-gray-500">
          No card selected
        </p>
      </div>
    );
  }

  // Loading state
  if (loading) {
    return (
      <div className={`${className} p-4`}>
        <p className="text-xs text-center text-gray-500">
          Loading backlinks...
        </p>
      </div>
    );
  }

  // No backlinks
  if (backlinks.length === 0) {
    return (
      <div className={`${className} p-4`}>
        <div className="text-center">
          <Link2 size={24} className="mx-auto mb-2 text-gray-400" />
          <p className="text-xs text-gray-500">
            No cards link to this one yet
          </p>
          <p className="text-xs text-gray-400 mt-1">
            Create a [[wiki link]] in another card to see it here
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className={`${className}`}>
      {/* Backlink count header */}
      <div className={`px-3 py-2 border-b ${borderClass} flex items-center justify-between`}>
        <span className={`text-xs font-medium ${textClass}`}>
          Linked from
        </span>
        <span className={`text-xs px-2 py-0.5 rounded-full ${
          theme === 'NeXTSTEP'
            ? 'bg-[#0066cc] text-white'
            : 'bg-blue-500 text-white'
        }`}>
          {backlinks.length}
        </span>
      </div>

      {/* Backlinks list */}
      <div className="overflow-y-auto max-h-[300px]">
        {backlinks.map(link => (
          <button
            key={link.id}
            onClick={() => handleNavigate(link.id)}
            className={`w-full text-left p-3 flex items-start gap-2 transition-colors border-b ${borderClass} ${hoverClass}`}
          >
            <ExternalLink size={14} className="mt-0.5 flex-shrink-0 text-gray-400" />
            <div className="flex-1 min-w-0">
              <div className={`text-sm font-medium truncate ${textClass}`}>
                {link.name || 'Untitled'}
              </div>
              <div className="text-xs text-gray-500">
                Linked {formatDate(link.createdAt)}
              </div>
            </div>
          </button>
        ))}
      </div>

      {/* Show more indicator if at limit */}
      {backlinks.length >= 50 && (
        <div className={`px-3 py-2 text-xs text-center text-gray-500 border-t ${borderClass}`}>
          Showing 50 most recent
        </div>
      )}
    </div>
  );
}
```

Key implementation notes:
- Uses activeCard.nodeId to query backlinks (handles both id and nodeId)
- Calls loadCard from NotebookContext for navigation
- Shows count badge
- Handles loading, empty, and populated states
- Theme-aware styling
- Respects the 50 backlinks limit with indicator
  </action>
  <verify>
Run `npm run typecheck` - should pass. Run `npm run lint` - should pass or only pre-existing warnings.
  </verify>
  <done>
BacklinksPanel.tsx exists with:
- Queries backlinks for active card
- Displays count badge
- Click navigation to linked cards
- Empty state messaging
- Loading state handling
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Backlinks tab to RightSidebar</name>
  <files>src/components/RightSidebar.tsx</files>
  <action>
Update RightSidebar.tsx to add a third "Backlinks" tab using the existing TabPanel pattern.

1. Add import for BacklinksPanel and Link2 icon:
```typescript
import { Palette, Settings as SettingsIcon, Link2 } from 'lucide-react';
import { BacklinksPanel } from './notebook/BacklinksPanel';
```

2. Update TabType union:
```typescript
type TabType = 'formats' | 'settings' | 'backlinks';
```

3. Add the backlinks tab to the tabs array (after settings):
```typescript
const tabs: Tab[] = [
  {
    id: 'formats',
    label: 'Formats',
    icon: <Palette className="w-4 h-4" />,
    content: <div className="p-2">{renderSections(formatSections, true)}</div>,
  },
  {
    id: 'settings',
    label: 'Settings',
    icon: <SettingsIcon className="w-4 h-4" />,
    content: <div className="p-2">{renderSections(settingsSections, false)}</div>,
  },
  {
    id: 'backlinks',
    label: 'Backlinks',
    icon: <Link2 className="w-4 h-4" />,
    content: <BacklinksPanel />,
  },
];
```

Note: BacklinksPanel handles its own padding, so no wrapper div needed for content.
  </action>
  <verify>
Run `npm run dev` and verify:
1. Three tabs appear in RightSidebar (Formats, Settings, Backlinks)
2. Clicking Backlinks tab shows the BacklinksPanel
3. With no card selected, shows "No card selected"
4. With a card selected, shows backlinks or "No cards link to this one yet"
5. If backlinks exist, clicking one navigates to that card
  </verify>
  <done>
RightSidebar has three tabs:
- Formats (existing)
- Settings (existing)
- Backlinks (new, shows BacklinksPanel)
  </done>
</task>

</tasks>

<verification>
1. `npm run typecheck` passes with 0 errors
2. `npm run lint` passes (or only pre-existing warnings)
3. Backlinks tab appears in RightSidebar
4. Tab shows correct empty state when no card selected
5. Tab shows correct empty state when no backlinks exist
6. Backlinks are displayed with name and date
7. Click navigation works
8. Count badge shows correct number
9. Self-references are excluded from results
</verification>

<success_criteria>
- Backlinks panel shows all cards that link to current card (BACK-01)
- Backlinks panel is accessible via tab (BACK-02 - collapsible via tab panel)
- Clicking backlink navigates to that card in Capture (BACK-03)
- Backlink count badge shows in panel header (BACK-04)
</success_criteria>

<output>
After completion, create `.planning/phases/95-data-layer-backlinks/95-03-SUMMARY.md`
</output>
