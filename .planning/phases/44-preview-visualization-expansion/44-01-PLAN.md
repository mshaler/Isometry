---
phase: 44-preview-visualization-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/notebook/preview-tabs/NetworkGraphTab.tsx
  - src/d3/visualizations/network/ForceGraphRenderer.ts
  - src/d3/visualizations/network/types.ts
  - src/d3/visualizations/network/interactions.ts
  - src/hooks/visualization/useForceGraph.ts
autonomous: true

must_haves:
  truths:
    - "User can see GRAPH relationships as D3 force-directed network"
    - "User can click nodes to select them"
    - "User can drag nodes to rearrange positions"
    - "Nodes stay in place after drag release until forces pull them back"
  artifacts:
    - path: "src/components/notebook/preview-tabs/NetworkGraphTab.tsx"
      provides: "React component rendering force-directed network graph"
      exports: ["NetworkGraphTab"]
    - path: "src/d3/visualizations/network/ForceGraphRenderer.ts"
      provides: "D3 force simulation renderer with SVG output"
      exports: ["createForceGraph", "ForceGraphRenderer"]
    - path: "src/hooks/visualization/useForceGraph.ts"
      provides: "React hook managing force graph state and data"
      exports: ["useForceGraph"]
  key_links:
    - from: "src/components/notebook/preview-tabs/NetworkGraphTab.tsx"
      to: "src/hooks/visualization/useForceGraph.ts"
      via: "useForceGraph hook"
      pattern: "useForceGraph\\("
    - from: "src/hooks/visualization/useForceGraph.ts"
      to: "src/hooks/database/useSQLiteQuery.ts"
      via: "useSQLiteQuery for edges and nodes"
      pattern: "useSQLiteQuery.*edges"
    - from: "src/components/notebook/preview-tabs/NetworkGraphTab.tsx"
      to: "src/d3/visualizations/network/ForceGraphRenderer.ts"
      via: "ForceGraphRenderer import"
      pattern: "ForceGraphRenderer|createForceGraph"
---

<objective>
Implement interactive force-directed network graph for GRAPH relationship visualization.

Purpose: Enable users to visually explore GRAPH relationships (LINK, NEST, SEQUENCE, AFFINITY edges) between nodes in an interactive force-directed layout that responds to drag, click, and hover interactions.

Output: NetworkGraphTab component replacing the placeholder in PreviewComponent, with full D3 force simulation, node selection, and drag-to-rearrange functionality.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-preview-visualization-expansion/44-RESEARCH.md

# Reference existing patterns
@src/components/notebook/PreviewComponent.tsx
@src/components/notebook/renderers/networkGraph.ts
@src/hooks/database/useSQLiteQuery.ts
@src/db/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create network graph types and ForceGraphRenderer</name>
  <files>
    src/d3/visualizations/network/types.ts
    src/d3/visualizations/network/ForceGraphRenderer.ts
    src/d3/visualizations/network/interactions.ts
  </files>
  <action>
Create the D3 force simulation infrastructure:

**types.ts:**
- Define `GraphNode` interface extending `d3.SimulationNodeDatum` with: id, label, group (folder), fx/fy for fixed positions
- Define `GraphLink` interface with: source, target, type (LINK/NEST/SEQUENCE/AFFINITY), weight
- Define `ForceGraphConfig` with: width, height, nodeRadius, linkDistance, chargeStrength, collisionRadius
- Define `ForceGraphCallbacks` with: onNodeClick, onNodeHover, onNodeDrag

**ForceGraphRenderer.ts:**
- Export `createForceGraph(container: SVGGElement, nodes: GraphNode[], links: GraphLink[], config: ForceGraphConfig, callbacks: ForceGraphCallbacks)`
- Use `d3.forceSimulation()` with forces: link, charge (-300 strength), center, collide (radius 30)
- Link distance based on weight: `100 / d.weight`
- Render links as lines with stroke-width based on weight
- Render nodes as circles with fill based on group (use d3.schemeCategory10)
- Add node labels (node name truncated to 15 chars)
- Stop simulation after 300 ticks OR 3 seconds (whichever first) per research pitfall guidance
- Return simulation instance for external control

**interactions.ts:**
- Export `createDragBehavior(simulation)` implementing d3.drag with:
  - dragstart: set fx/fy, increase alphaTarget to 0.3
  - drag: update fx/fy to event position
  - dragend: reset alphaTarget to 0, release fx/fy (set to null)
- Export `createClickBehavior(onSelect: (nodeId: string) => void)` returning d3 click handler
- Export `createHoverBehavior(onHover: (nodeId: string | null) => void)` returning mouseenter/mouseleave handlers

Follow D3 v7 `.join()` pattern with key functions for all data binding.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npm run typecheck 2>&1 | grep -E "(error|src/d3/visualizations/network)" | head -20
```
Files exist with expected exports:
```bash
grep -l "export.*createForceGraph\|export.*GraphNode\|export.*createDragBehavior" src/d3/visualizations/network/*.ts
```
  </verify>
  <done>
ForceGraphRenderer creates D3 force simulation, interactions module provides drag/click/hover behaviors, types module defines GraphNode and GraphLink interfaces.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useForceGraph hook for data management</name>
  <files>
    src/hooks/visualization/useForceGraph.ts
  </files>
  <action>
Create React hook that manages force graph data and state:

- Import `useSQLiteQuery` from `@/hooks/database`
- Import `useSQLite` from `@/db/SQLiteProvider`

**Query pattern for nodes and edges:**
```sql
-- Nodes query (limit 100 active nodes for performance)
SELECT id, name, folder FROM nodes
WHERE deleted_at IS NULL
LIMIT 100

-- Edges query (only edges between loaded nodes)
SELECT e.id, e.source_id, e.target_id, e.edge_type, e.weight
FROM edges e
WHERE e.source_id IN (?) AND e.target_id IN (?)
```

**Hook signature:**
```typescript
export function useForceGraph(options?: {
  maxNodes?: number;
  edgeTypes?: ('LINK' | 'NEST' | 'SEQUENCE' | 'AFFINITY')[];
}): {
  nodes: GraphNode[];
  links: GraphLink[];
  loading: boolean;
  error: Error | null;
  selectedNodeId: string | null;
  setSelectedNodeId: (id: string | null) => void;
  refresh: () => void;
}
```

**Implementation:**
- Use two useSQLiteQuery calls: one for nodes, one for edges
- Transform node rows to GraphNode format: `{ id, label: name, group: folder || 'default' }`
- Transform edge rows to GraphLink format: `{ source: source_id, target: target_id, type: edge_type, weight }`
- Filter edges to only include those where both source and target are in loaded nodes
- Manage selectedNodeId in local state
- Return refresh function that triggers both queries' refetch

Default options: maxNodes=100, edgeTypes=['LINK', 'NEST', 'SEQUENCE', 'AFFINITY']
  </action>
  <verify>
TypeScript compiles:
```bash
npm run typecheck 2>&1 | grep -E "(error|useForceGraph)" | head -10
```
Hook exports correctly:
```bash
grep "export.*useForceGraph" src/hooks/visualization/useForceGraph.ts
```
  </verify>
  <done>
useForceGraph hook queries nodes and edges from sql.js, transforms to D3-compatible format, manages selection state.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create NetworkGraphTab component and integrate into PreviewComponent</name>
  <files>
    src/components/notebook/preview-tabs/NetworkGraphTab.tsx
    src/components/notebook/PreviewComponent.tsx
  </files>
  <action>
**NetworkGraphTab.tsx:**
Create React component that renders the force-directed network graph:

```typescript
interface NetworkGraphTabProps {
  onNodeSelect?: (nodeId: string) => void;
}
```

- Use `useForceGraph` hook for data
- Create SVG element with ref for D3 rendering
- Use `useEffect` to call `createForceGraph` when data changes
- Pass callbacks for node click (calls setSelectedNodeId AND onNodeSelect prop), drag, hover
- Show loading spinner when loading
- Show error message if error
- Show "No graph data" placeholder if nodes.length === 0
- Display selected node info in a small overlay (node name, folder, edge count)
- Apply theme-aware styling (use useTheme context)

**PreviewComponent.tsx updates:**
- Import NetworkGraphTab
- Find and replace the network tab placeholder:
  ```bash
  # Locate the placeholder dynamically (lines may have shifted)
  grep -n "network.*placeholder\|{/\*.*network\|activeTab.*network" src/components/notebook/PreviewComponent.tsx
  ```
  Look for patterns like: `{/* Network tab placeholder */}`, `activeTab === 'network'` with placeholder content, or similar network tab content area.
- Replace the placeholder content with `<NetworkGraphTab onNodeSelect={(id) => { /* handle selection */ }} />`
- Update context info bar for network tab to show node/edge counts from graph data

Ensure proper cleanup: stop simulation on unmount via useEffect cleanup function.
  </action>
  <verify>
Component renders without errors:
```bash
npm run dev &
sleep 5
curl -s http://localhost:5173 | grep -q "Network" && echo "App renders"
kill %1
```
TypeScript compiles:
```bash
npm run typecheck 2>&1 | grep -E "error" | head -10
```
Integration complete:
```bash
grep -l "NetworkGraphTab" src/components/notebook/PreviewComponent.tsx
```
  </verify>
  <done>
NetworkGraphTab component renders force-directed graph with interaction support, integrated into PreviewComponent replacing the placeholder. User can view GRAPH relationships, click to select nodes, drag to rearrange.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Manual verification in browser:**
   - Navigate to Preview pane
   - Switch to Network tab
   - Verify force-directed graph renders with nodes and edges
   - Click a node - verify selection highlight
   - Drag a node - verify it moves and springs back
   - Verify edge types show different styling (color/opacity by type)

2. **Automated checks:**
```bash
# TypeScript compilation
npm run typecheck

# ESLint
npm run lint -- --max-warnings=700

# Verify files created
ls -la src/d3/visualizations/network/
ls -la src/hooks/visualization/
ls -la src/components/notebook/preview-tabs/
```

3. **Schema verification:**
```bash
# Verify edges table has sample data
sqlite3 :memory: ".read src/db/schema.sql" "SELECT COUNT(*) FROM edges"
```
</verification>

<success_criteria>
- NetworkGraphTab renders force-directed graph from edges table
- Nodes are positioned by D3 force simulation
- Clicking a node selects it (visual feedback + state update)
- Dragging a node moves it (fx/fy fixation during drag, release after)
- Force simulation stops after 3 seconds to save CPU
- TypeScript compiles without errors
- ESLint passes within warning budget
</success_criteria>

<output>
After completion, create `.planning/phases/44-preview-visualization-expansion/44-01-SUMMARY.md`
</output>
