---
phase: 44-preview-visualization-expansion
plan: 03
type: execute
wave: 2
depends_on: ["44-01", "44-02"]
files_modified:
  - src/components/notebook/preview-tabs/TimelineTab.tsx
  - src/d3/visualizations/timeline/TimelineRenderer.ts
  - src/d3/visualizations/timeline/types.ts
  - src/d3/visualizations/timeline/zoom.ts
  - src/hooks/visualization/useTimeline.ts
  - src/components/notebook/PreviewComponent.tsx
  - src/components/notebook/preview-tabs/index.ts
autonomous: true

must_haves:
  truths:
    - "User can view cards on Timeline by temporal LATCH facets"
    - "User can filter timeline by date range"
    - "User can zoom and pan the timeline"
    - "User can switch between temporal facets (created, modified, due)"
    - "View transitions are smooth between visualization types"
  artifacts:
    - path: "src/components/notebook/preview-tabs/TimelineTab.tsx"
      provides: "React component rendering temporal timeline"
      exports: ["TimelineTab"]
    - path: "src/d3/visualizations/timeline/TimelineRenderer.ts"
      provides: "D3 timeline renderer with scaleTime and zoom"
      exports: ["createTimeline", "TimelineRenderer"]
    - path: "src/hooks/visualization/useTimeline.ts"
      provides: "React hook managing timeline data and filtering"
      exports: ["useTimeline"]
    - path: "src/components/notebook/preview-tabs/index.ts"
      provides: "Barrel export for all preview tabs"
      exports: ["NetworkGraphTab", "DataInspectorTab", "TimelineTab"]
  key_links:
    - from: "src/components/notebook/preview-tabs/TimelineTab.tsx"
      to: "src/hooks/visualization/useTimeline.ts"
      via: "useTimeline hook"
      pattern: "useTimeline\\("
    - from: "src/hooks/visualization/useTimeline.ts"
      to: "src/hooks/database/useSQLiteQuery.ts"
      via: "useSQLiteQuery for temporal data"
      pattern: "useSQLiteQuery.*created_at|modified_at|due_at"
    - from: "src/components/notebook/preview-tabs/TimelineTab.tsx"
      to: "src/d3/visualizations/timeline/TimelineRenderer.ts"
      via: "TimelineRenderer import"
      pattern: "TimelineRenderer|createTimeline"
    - from: "src/components/notebook/PreviewComponent.tsx"
      to: "src/components/notebook/preview-tabs/index.ts"
      via: "barrel import for all tabs"
      pattern: "from.*preview-tabs"
---

<objective>
Implement Timeline visualization for temporal LATCH facets with date range filtering and zoom/pan.

Purpose: Enable users to visualize cards along a temporal axis using LATCH time facets (created_at, modified_at, due_at), with interactive zoom/pan and date range filtering for exploring temporal patterns.

Output: TimelineTab component with D3 scaleTime visualization, facet selector, date range filter, and zoom/pan controls. Final integration of all preview tabs with barrel exports.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-preview-visualization-expansion/44-RESEARCH.md

# Reference existing patterns and Phase 44 work
@src/components/notebook/PreviewComponent.tsx
@src/hooks/database/useSQLiteQuery.ts
@src/db/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create timeline types and TimelineRenderer</name>
  <files>
    src/d3/visualizations/timeline/types.ts
    src/d3/visualizations/timeline/TimelineRenderer.ts
    src/d3/visualizations/timeline/zoom.ts
  </files>
  <action>
Create the D3 timeline infrastructure:

**types.ts:**
```typescript
export interface TimelineEvent {
  id: string;
  timestamp: Date;
  label: string;
  track: string; // folder for Y-axis grouping
  color?: string;
}

export interface TimelineConfig {
  width: number;
  height: number;
  margin: { top: number; right: number; bottom: number; left: number };
  dateRange?: [Date, Date]; // Optional filter range
}

export interface TimelineCallbacks {
  onEventClick?: (eventId: string) => void;
  onEventHover?: (eventId: string | null) => void;
  onZoom?: (transform: d3.ZoomTransform) => void;
}
```

**TimelineRenderer.ts:**
```typescript
export function createTimeline(
  container: SVGGElement,
  events: TimelineEvent[],
  config: TimelineConfig,
  callbacks: TimelineCallbacks
): { xScale: d3.ScaleTime<number, number>; yScale: d3.ScaleBand<string>; update: (newEvents: TimelineEvent[]) => void }
```

Implementation (adapted from research/CardBoard-v3 patterns):
- Use `d3.scaleTime()` for X-axis
- Use `d3.scaleBand()` for Y-axis (tracks = folders)
- Handle invalid dates: filter out events with null/NaN timestamps
- Fallback domain if no valid events: last 30 days from now (per research pitfall)
- Render events as circles on their track lanes
- Add X-axis with `d3.axisBottom()` using d3.timeFormat for ticks
- Add Y-axis with `d3.axisLeft()` showing track names
- Apply theme colors from D3ChartTheme
- Return scales and update function for dynamic re-rendering

Event rendering:
- Circles at (xScale(timestamp), yScale(track) + bandwidth/2)
- Radius 6px, fill based on track color
- Hover: increase radius to 8px, show tooltip with label and formatted date
- Click: trigger onEventClick callback

**zoom.ts:**
```typescript
export function createTimelineZoom(
  svg: d3.Selection<SVGSVGElement, unknown, null, undefined>,
  xScale: d3.ScaleTime<number, number>,
  onZoom: (transform: d3.ZoomTransform) => void
): d3.ZoomBehavior<SVGSVGElement, unknown>
```

Implementation:
- Use `d3.zoom()` with scaleExtent [0.5, 10]
- On zoom event: rescale xScale, update axis, reposition events
- Support both wheel zoom and drag pan
- Return zoom behavior for external control (e.g., reset zoom button)
  </action>
  <verify>
TypeScript compiles:
```bash
npm run typecheck 2>&1 | grep -E "(error|timeline)" | head -20
```
Files exist with exports:
```bash
grep -l "export.*createTimeline\|export.*TimelineEvent\|export.*createTimelineZoom" src/d3/visualizations/timeline/*.ts
```
  </verify>
  <done>
TimelineRenderer creates D3 scaleTime visualization with tracks, zoom module provides pan/zoom behavior, types define TimelineEvent interface.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useTimeline hook for data management</name>
  <files>
    src/hooks/visualization/useTimeline.ts
  </files>
  <action>
Create React hook that manages timeline data, facet selection, and date filtering:

```typescript
export type TemporalFacet = 'created_at' | 'modified_at' | 'due_at';

export interface UseTimelineOptions {
  initialFacet?: TemporalFacet;
  maxEvents?: number;
}

export function useTimeline(options: UseTimelineOptions = {}): {
  events: TimelineEvent[];
  loading: boolean;
  error: Error | null;
  facet: TemporalFacet;
  setFacet: (facet: TemporalFacet) => void;
  dateRange: [Date, Date] | null;
  setDateRange: (range: [Date, Date] | null) => void;
  tracks: string[];
  selectedEventId: string | null;
  setSelectedEventId: (id: string | null) => void;
  refresh: () => void;
}
```

**SQL query based on selected facet:**
```sql
SELECT id, name, ${facet}, folder
FROM nodes
WHERE ${facet} IS NOT NULL
  AND deleted_at IS NULL
  ${dateRange ? `AND ${facet} BETWEEN ? AND ?` : ''}
ORDER BY ${facet} DESC
LIMIT ${maxEvents}
```

**Implementation:**
- Default facet: 'created_at', maxEvents: 500
- Transform query results to TimelineEvent: `{ id, timestamp: new Date(row[facet]), label: name, track: folder || 'default' }`
- Filter out invalid timestamps (NaN dates) per research pitfall guidance
- Extract unique tracks for Y-axis
- Manage selectedEventId in local state
- Date range stored as [Date, Date] | null (null = show all)

**Edge cases:**
- If facet value is null for a node, exclude from events
- If all events have same timestamp, add small random offset for visibility
- If dateRange start > end, swap them
  </action>
  <verify>
TypeScript compiles:
```bash
npm run typecheck 2>&1 | grep -E "(error|useTimeline)" | head -10
```
Hook exports:
```bash
grep "export.*useTimeline" src/hooks/visualization/useTimeline.ts
```
  </verify>
  <done>
useTimeline hook queries temporal data, manages facet selection, date range filtering, and transforms to TimelineEvent format.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create TimelineTab, barrel exports, and final integration</name>
  <files>
    src/components/notebook/preview-tabs/TimelineTab.tsx
    src/components/notebook/preview-tabs/index.ts
    src/components/notebook/PreviewComponent.tsx
  </files>
  <action>
**TimelineTab.tsx:**
Create React component that renders the timeline visualization:

```typescript
interface TimelineTabProps {
  onEventSelect?: (eventId: string) => void;
}

export function TimelineTab({ onEventSelect }: TimelineTabProps) {
  const { theme } = useTheme();
  const {
    events, loading, error, facet, setFacet,
    dateRange, setDateRange, tracks, selectedEventId, setSelectedEventId, refresh
  } = useTimeline();

  // Component structure:
  // 1. Toolbar: Facet selector (dropdown), Date range inputs, Reset zoom button
  // 2. SVG container for D3 timeline
  // 3. Status: event count, date range, loading/error states
}
```

**UI elements:**
- Facet selector: dropdown with options "Created", "Modified", "Due"
- Date range: two date inputs (from/to) with clear button
- Reset zoom button: resets d3.zoom transform to identity
- SVG takes remaining height with resize observer
- Loading: skeleton placeholder
- Error: error message with retry button
- Empty state: "No events with [facet] dates"

**preview-tabs/index.ts (barrel export):**
```typescript
export { NetworkGraphTab } from './NetworkGraphTab';
export { DataInspectorTab } from './DataInspectorTab';
export { TimelineTab } from './TimelineTab';
```

**PreviewComponent.tsx final updates:**
- Add 'timeline' to PreviewTab type union
- Add timeline tab definition: `{ id: 'timeline', icon: Clock, label: 'Timeline', description: 'Temporal visualization' }`
- Import from barrel: `import { NetworkGraphTab, DataInspectorTab, TimelineTab } from './preview-tabs'`
- Add case for timeline tab content: `<TimelineTab onEventSelect={...} />`
- Update context info bar for timeline: show facet name, event count
- Add Clock to lucide-react imports
- Ensure smooth transitions between tabs (CSS transition on tab content)

**Tab ordering in PreviewComponent:**
supergrid, network, timeline, data-inspector, web-preview, d3-visualization
(Timeline added between network and data-inspector for logical grouping of D3 visualizations)
  </action>
  <verify>
Component renders:
```bash
npm run dev &
sleep 5
curl -s http://localhost:5173 | grep -q "Timeline" && echo "App renders"
kill %1
```
TypeScript compiles:
```bash
npm run typecheck 2>&1 | grep -E "error" | head -10
```
All tabs integrated:
```bash
grep -E "NetworkGraphTab|DataInspectorTab|TimelineTab" src/components/notebook/PreviewComponent.tsx
```
Barrel exports:
```bash
cat src/components/notebook/preview-tabs/index.ts
```
  </verify>
  <done>
TimelineTab renders temporal visualization with facet selection and date filtering. All preview tabs have barrel exports. PreviewComponent integrates all visualization tabs with smooth transitions.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Manual verification in browser:**
   - Navigate to Preview pane
   - Switch to Timeline tab
   - Verify timeline renders with events as circles on tracks
   - Change facet dropdown - verify timeline updates (different events may appear)
   - Set date range - verify events filter to range
   - Zoom with scroll wheel - verify timeline zooms
   - Pan by dragging - verify timeline pans
   - Click Reset Zoom - verify returns to original view
   - Click an event - verify selection callback fires
   - Switch between all tabs - verify smooth transitions

2. **Full phase verification:**
```bash
# TypeScript compilation
npm run typecheck

# ESLint
npm run lint -- --max-warnings=700

# Verify all phase 44 files created
echo "=== Network Graph ===" && ls src/d3/visualizations/network/
echo "=== Timeline ===" && ls src/d3/visualizations/timeline/
echo "=== Hooks ===" && ls src/hooks/visualization/
echo "=== Preview Tabs ===" && ls src/components/notebook/preview-tabs/
echo "=== Services ===" && ls src/services/query-executor.ts
```

3. **Tab integration verification:**
```bash
# All tabs work
grep -c "activeTab ===" src/components/notebook/PreviewComponent.tsx
# Should show multiple tab cases
```
</verification>

<success_criteria>
Phase 44 complete when:
- NetworkGraphTab renders force-directed graph from edges table (PREV-01, PREV-02)
- DataInspectorTab provides SQL query interface with sortable results and export (PREV-03, PREV-04, PREV-05)
- TimelineTab renders temporal visualization with facet selection and date filtering (PREV-06, PREV-07)
- All tabs have smooth transitions when switching
- TypeScript compiles without errors
- ESLint passes within warning budget (700)
- All must_haves verified true
</success_criteria>

<output>
After completion, create `.planning/phases/44-preview-visualization-expansion/44-03-SUMMARY.md`
</output>
