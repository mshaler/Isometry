---
phase: 32-multi-environment-debugging
plan: 16
type: execute
wave: 1
depends_on: []
files_modified:
  - native/Sources/Isometry/Import/NotesAccessManager.swift
  - native/Sources/Isometry/Import/AppleNotesLiveImporter.swift
  - native/Sources/Isometry/Bridge/Reliability/CircuitBreaker.swift
  - native/Sources/Isometry/Bridge/RealTime/ChangeNotificationBridge.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "NotesAccessManager conforms to ObservableObject for SwiftUI StateObject compatibility"
    - "AppleNotesLiveImporter conforms to ObservableObject for SwiftUI StateObject compatibility"
    - "CircuitBreaker imports QuartzCore framework for CACurrentMediaTime access"
    - "ChangeNotificationBridge implements notifyWebView method for real-time conflict resolution"
  artifacts:
    - path: "native/Sources/Isometry/Import/NotesAccessManager.swift"
      provides: "ObservableObject conformance with nonisolated access"
      contains: "ObservableObject"
    - path: "native/Sources/Isometry/Import/AppleNotesLiveImporter.swift"
      provides: "ObservableObject conformance with nonisolated access"
      contains: "ObservableObject"
    - path: "native/Sources/Isometry/Bridge/Reliability/CircuitBreaker.swift"
      provides: "QuartzCore import for performance timing"
      contains: "import QuartzCore"
    - path: "native/Sources/Isometry/Bridge/RealTime/ChangeNotificationBridge.swift"
      provides: "notifyWebView method implementation"
      contains: "func notifyWebView"
  key_links:
    - from: "NotesIntegrationView.swift"
      to: "NotesAccessManager"
      via: "@StateObject conformance"
      pattern: "ObservableObject"
    - from: "NotesIntegrationView.swift"
      to: "AppleNotesLiveImporter"
      via: "@StateObject conformance"
      pattern: "ObservableObject"
    - from: "CircuitBreaker.swift"
      to: "CACurrentMediaTime()"
      via: "QuartzCore framework import"
      pattern: "import QuartzCore"
    - from: "RealTimeConflictResolver.swift"
      to: "ChangeNotificationBridge.notifyWebView"
      via: "bridge method call"
      pattern: "await bridge\\.notifyWebView"
---

<objective>
Fix critical Swift compilation errors preventing successful native iOS/macOS builds.

Purpose: Resolve ObservableObject conformance issues for SwiftUI integration, missing framework imports, and incomplete bridge method implementations that are blocking Swift compilation in Phase 32.
Output: Swift project compiles successfully without blocking errors, enabling stable multi-environment debugging capability.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Gap closure context from Phase 32 verification:
- Swift compilation errors persist despite enum conflict resolution
- ObservableObject conformance missing for StateObject requirements
- CACurrentMediaTime not found in scope - missing QuartzCore import
- ChangeNotificationBridge missing notifyWebView method for conflict resolution
</context>

<tasks>

<task type="auto">
  <name>Add ObservableObject conformance to NotesAccessManager actor</name>
  <files>native/Sources/Isometry/Import/NotesAccessManager.swift</files>
  <action>
    Add ObservableObject conformance to NotesAccessManager actor with nonisolated access patterns:

    1. Add ObservableObject conformance to actor declaration:
       `public actor NotesAccessManager: ObservableObject {`

    2. Add nonisolated @Published properties for SwiftUI binding:
       ```swift
       @Published nonisolated var permissionStatus: PermissionStatus = .notDetermined
       @Published nonisolated var isRequestingPermission: Bool = false
       ```

    3. Add nonisolated access methods for SwiftUI compatibility:
       ```swift
       nonisolated public var currentPermissionStatus: PermissionStatus {
           // Safe nonisolated access to permission status
       }
       ```

    Reference existing Actor isolation patterns from Swift decisions. Maintain thread-safe access while enabling SwiftUI StateObject usage.
    Gap reason: Missing ObservableObject conformance prevents @StateObject usage in NotesIntegrationView.swift
  </action>
  <verify>cd native && swift build --target Isometry 2>&1 | grep -i "NotesAccessManager.*ObservableObject" || echo "No NotesAccessManager ObservableObject errors"</verify>
  <done>NotesAccessManager compiles successfully with ObservableObject conformance, enabling @StateObject usage in SwiftUI</done>
</task>

<task type="auto">
  <name>Add ObservableObject conformance to AppleNotesLiveImporter actor</name>
  <files>native/Sources/Isometry/Import/AppleNotesLiveImporter.swift</files>
  <action>
    Add ObservableObject conformance to AppleNotesLiveImporter actor with nonisolated access patterns:

    1. Add ObservableObject conformance to actor declaration:
       `public actor AppleNotesLiveImporter: ObservableObject {`

    2. Add nonisolated @Published properties for live sync status:
       ```swift
       @Published nonisolated var syncStatus: SyncStatus = .idle
       @Published nonisolated var isLiveSyncEnabled: Bool = false
       @Published nonisolated var performanceMetrics: PerformanceMetrics = PerformanceMetrics()
       ```

    3. Add nonisolated access methods for SwiftUI compatibility:
       ```swift
       nonisolated public var currentSyncStatus: SyncStatus {
           // Safe nonisolated access to sync status
       }
       ```

    Follow same Actor isolation patterns as NotesAccessManager. Maintain thread-safe access while enabling SwiftUI StateObject usage.
    Gap reason: Missing ObservableObject conformance prevents @StateObject usage in NotesIntegrationView.swift
  </action>
  <verify>cd native && swift build --target Isometry 2>&1 | grep -i "AppleNotesLiveImporter.*ObservableObject" || echo "No AppleNotesLiveImporter ObservableObject errors"</verify>
  <done>AppleNotesLiveImporter compiles successfully with ObservableObject conformance, enabling @StateObject usage in SwiftUI</done>
</task>

<task type="auto">
  <name>Fix QuartzCore import in CircuitBreaker for CACurrentMediaTime access</name>
  <files>native/Sources/Isometry/Bridge/Reliability/CircuitBreaker.swift</files>
  <action>
    Add missing QuartzCore framework import to enable CACurrentMediaTime() usage:

    1. Add QuartzCore import after existing imports:
       ```swift
       import Foundation
       import OSLog
       import QuartzCore  // Add this import for CACurrentMediaTime()
       ```

    2. Verify CACurrentMediaTime() usage is maintained at existing locations:
       - Line ~143: `let startTime = CACurrentMediaTime()`
       - Line ~172: `let executionTime = CACurrentMediaTime() - startTime`
       - Line ~186: `let executionTime = CACurrentMediaTime() - startTime`
       - Line ~395: `let executionTime = CACurrentMediaTime() - startTime`

    Gap reason: CACurrentMediaTime() requires QuartzCore framework import which is missing, causing "not found in scope" error
  </action>
  <verify>cd native && swift build --target Isometry 2>&1 | grep -i "CACurrentMediaTime.*not found" && echo "CACurrentMediaTime error still exists" || echo "CACurrentMediaTime error resolved"</verify>
  <done>CircuitBreaker compiles successfully with QuartzCore import, enabling performance timing functionality</done>
</task>

<task type="auto">
  <name>Implement missing notifyWebView method in ChangeNotificationBridge</name>
  <files>native/Sources/Isometry/Bridge/RealTime/ChangeNotificationBridge.swift</files>
  <action>
    Implement the missing notifyWebView method that is called by RealTimeConflictResolver:

    1. Add notifyWebView method to ChangeNotificationBridge actor (around line 100):
       ```swift
       /// Send notification message to WebView for conflict resolution
       /// Called by RealTimeConflictResolver to notify frontend of conflicts
       public func notifyWebView(message: [String: Any]) async {
           guard let webView = webView else {
               logger.warning("Cannot notify WebView - webView reference is nil")
               return
           }

           do {
               let jsonData = try JSONSerialization.data(withJSONObject: message)
               let jsonString = String(data: jsonData, encoding: .utf8) ?? "{}"
               let javascript = "window.isometryBridge?.handleMessage(\(jsonString))"

               await webView.evaluateJavaScript(javascript)
               logger.debug("Sent conflict notification to WebView", metadata: [
                   "messageType": "\(message["type"] ?? "unknown")"
               ])
           } catch {
               logger.error("Failed to serialize conflict notification", metadata: [
                   "error": "\(error)"
               ])
           }
       }
       ```

    2. Ensure method signature matches usage in RealTimeConflictResolver line 816:
       `await bridge.notifyWebView(message: message)`

    Gap reason: RealTimeConflictResolver.swift calls notifyWebView method on ChangeNotificationBridge but method doesn't exist
  </action>
  <verify>cd native && swift build --target Isometry 2>&1 | grep -i "notifyWebView.*not.*found" && echo "notifyWebView error still exists" || echo "notifyWebView method available"</verify>
  <done>ChangeNotificationBridge implements notifyWebView method, enabling real-time conflict notifications to frontend</done>
</task>

</tasks>

<verification>
Swift native project compiles successfully:
- `cd native && swift build --target Isometry` completes without ObservableObject conformance errors
- NotesIntegrationView.swift can use @StateObject with both NotesAccessManager and AppleNotesLiveImporter
- CircuitBreaker performance timing functionality works with CACurrentMediaTime()
- RealTimeConflictResolver can successfully notify WebView through ChangeNotificationBridge
</verification>

<success_criteria>
Swift compilation completes without the four critical blocking errors identified in gap closure:
1. ObservableObject conformance errors resolved for both Notes actors
2. CACurrentMediaTime import error resolved in CircuitBreaker
3. Missing notifyWebView method implemented in ChangeNotificationBridge
4. Native iOS/macOS project builds successfully for multi-environment debugging
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-environment-debugging/32-16-SUMMARY.md`
</output>