---
phase: 32-multi-environment-debugging
plan: 03
type: execute
wave: 2
depends_on: [32-01, 32-02]
files_modified: [
  "native/Sources/Isometry/Import/NotesPermissionHandler.swift",
  "src/components/d3/Canvas.tsx",
  "src/hooks/useD3.ts",
  "src/components/views/SuperGrid.tsx"
]
autonomous: true

must_haves:
  truths:
    - "NotesPermissionHandler.swift is restored and functional"
    - "D3.js Canvas rendering works without errors"
    - "React-D3 integration handles data updates properly"
  artifacts:
    - path: "native/Sources/Isometry/Import/NotesPermissionHandler.swift"
      provides: "TCC permission management UI"
      min_lines: 700
    - path: "src/components/d3/Canvas.tsx"
      provides: "D3 SVG rendering integration"
      min_lines: 200
    - path: "src/hooks/useD3.ts"
      provides: "D3 lifecycle management"
      min_lines: 100
  key_links:
    - from: "Canvas.tsx"
      to: "useD3.ts"
      via: "D3 container management"
      pattern: "useD3.*ref"
    - from: "NotesPermissionHandler.swift"
      to: "NotesAccessManager"
      via: "TCC permission flow"
      pattern: "notesAccessManager"
---

<objective>
Restore broken Swift files and fix D3.js integration issues

Purpose: Fix critical broken files and ensure D3 visualizations work properly with React
Output: Functional Notes permission handling and working D3 Canvas rendering
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restore NotesPermissionHandler.swift</name>
  <files>native/Sources/Isometry/Import/NotesPermissionHandler.swift</files>
  <action>
    Restore the broken NotesPermissionHandler.swift file:
    1. Copy content from NotesPermissionHandler.swift.broken to NotesPermissionHandler.swift
    2. Verify all imports are correct and available
    3. Check NotesAccessManager compatibility and fix any interface mismatches
    4. Ensure EventKit framework integration is properly configured
    5. Test that all SwiftUI views compile correctly
    6. Remove .broken, .bak, .bak2 backup files after successful restoration

    The file contains comprehensive TCC permission management UI that's critical for Apple Notes integration.
  </action>
  <verify>cd native && swift build 2>&1 | grep -c "NotesPermissionHandler.*error" | test $(cat) -eq 0</verify>
  <done>NotesPermissionHandler.swift is restored and compiles successfully</done>
</task>

<task type="auto">
  <name>Task 2: Fix D3.js Canvas rendering integration</name>
  <files>src/components/d3/Canvas.tsx, src/hooks/useD3.ts</files>
  <action>
    Fix D3.js integration issues:

    Canvas.tsx:
    1. Ensure proper D3 SVG element creation and management
    2. Fix data binding and update patterns for React state changes
    3. Handle canvas resizing and responsive behavior
    4. Implement proper cleanup on component unmount
    5. Ensure compatibility with live data updates from WebView bridge

    useD3.ts:
    1. Fix D3 container lifecycle management
    2. Ensure proper cleanup of D3 event listeners
    3. Handle ref forwarding correctly for TypeScript
    4. Implement proper selection caching and performance optimization
    5. Add error handling for D3 DOM manipulation edge cases

    Focus on maintaining the existing D3 visualization patterns while ensuring React compatibility.
  </action>
  <verify>npm run dev && curl -s http://localhost:5173/ | grep -q "canvas\|svg" && echo "D3 canvas elements present"</verify>
  <done>D3 Canvas renders successfully and integrates properly with React component lifecycle</done>
</task>

<task type="auto">
  <name>Task 3: Verify SuperGrid D3 integration functionality</name>
  <files>src/components/views/SuperGrid.tsx</files>
  <action>
    Ensure SuperGrid properly integrates with D3 Canvas:
    1. Verify data flow from SuperGrid to Canvas component
    2. Check that grid layout calculations work with D3 positioning
    3. Ensure virtual scrolling doesn't interfere with D3 rendering
    4. Test data updates trigger proper D3 re-rendering
    5. Verify Canvas component receives proper props from SuperGrid
    6. Check for any memory leaks in the D3-React update cycle

    The SuperGrid should coordinate with Canvas for layout positioning and data visualization.
  </action>
  <verify>npm run build && test $? -eq 0 && echo "SuperGrid-Canvas integration builds successfully"</verify>
  <done>SuperGrid successfully coordinates with D3 Canvas for visualization rendering</done>
</task>

</tasks>

<verification>
1. cd native && swift build - confirm clean Swift build
2. npm run build - confirm clean React build
3. Check D3 canvas renders in development server
4. Verify Notes permission UI is accessible
</verification>

<success_criteria>
- NotesPermissionHandler.swift restored and functional
- D3 Canvas renders properly in React environment
- SuperGrid coordinates successfully with D3 visualization
- Both Swift and TypeScript environments compile cleanly
- Development server runs without critical runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-environment-debugging/32-03-SUMMARY.md`
</output>