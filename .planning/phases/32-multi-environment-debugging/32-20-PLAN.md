---
phase: 32-multi-environment-debugging
plan: 20
type: execute
wave: 1
depends_on: []
files_modified: [
  native/Sources/Isometry/Storage/ContentAwareStorageManager.swift,
  native/Sources/Isometry/Sync/CloudKitConflictResolver.swift
]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ContentAwareStorageManager compiles without missing method errors"
    - "CloudKitConflictResolver resolves CloudKit conformance and async context issues"
    - "Swift native project builds successfully in Xcode without blocking errors"
  artifacts:
    - path: "native/Sources/Isometry/Storage/ContentAwareStorageManager.swift"
      provides: "Complete storage performance monitoring"
      contains: "updatePerformanceMetrics method implementation"
    - path: "native/Sources/Isometry/Sync/CloudKitConflictResolver.swift"
      provides: "CloudKit-compatible conflict resolution"
      contains: "CKRecordObjCValue conformance and proper async context handling"
  key_links:
    - from: "ContentAwareStorageManager"
      to: "PerformanceMonitor"
      via: "updatePerformanceMetrics method"
      pattern: "updatePerformanceMetrics.*PerformanceMonitor"
    - from: "CloudKitConflictResolver"
      to: "CloudKit framework"
      via: "CKRecordObjCValue conformance"
      pattern: "CKRecordObjCValue|CKRecord"
---

<objective>
Fix critical Swift compilation errors in ContentAwareStorageManager and CloudKitConflictResolver to restore native build capability.

Purpose: Resolve blocking Swift compilation issues for stable multi-environment debugging
Output: Clean Swift compilation enabling native iOS/macOS development
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-multi-environment-debugging/32-18-SUMMARY.md
@.planning/phases/32-multi-environment-debugging/32-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement missing updatePerformanceMetrics method</name>
  <files>native/Sources/Isometry/Storage/ContentAwareStorageManager.swift</files>
  <action>
    Analyze the compilation error and implement the missing updatePerformanceMetrics method in ContentAwareStorageManager:

    1. Examine the file to understand the current structure and where updatePerformanceMetrics is being called
    2. Look for existing performance monitoring patterns in the codebase to match the signature
    3. Implement the method with appropriate parameters:
       - Likely takes performance metrics data (duration, memory usage, etc.)
       - Should integrate with existing PerformanceMonitor infrastructure
       - Follow Swift Actor pattern if the class is an actor

    From verification gap: "Missing updatePerformanceMetrics method in scope"
    This suggests the method is being called but not defined. Implement with proper signature and integration to existing performance monitoring system.
  </action>
  <verify>cd native && swift build 2>&1 | grep -v "updatePerformanceMetrics.*not found" | grep -c "ContentAwareStorageManager" | test $(cat) -eq 0</verify>
  <done>ContentAwareStorageManager compiles without updatePerformanceMetrics method errors</done>
</task>

<task type="auto">
  <name>Task 2: Fix CloudKit conformance and async context issues</name>
  <files>native/Sources/Isometry/Sync/CloudKitConflictResolver.swift</files>
  <action>
    Address two specific issues in CloudKitConflictResolver identified in verification:

    1. **CloudKit CKRecordObjCValue conformance error:**
       - Review array type usage with CloudKit records
       - Ensure array types conform to CKRecordObjCValue protocol
       - Use CloudKit-compatible types (NSArray, NSString, NSData, etc.)
       - Replace Swift native types with CloudKit-compatible equivalents where needed

    2. **Async context violations:**
       - Review async/await usage patterns
       - Ensure proper isolation context for Actor methods
       - Fix any calls to synchronous code from async context or vice versa
       - Use proper async patterns: Task, @MainActor, await keywords

    From verification gap: "CloudKit CKRecordObjCValue conformance error and async context violations"
    Focus on making array types CloudKit-compatible and resolving async context mismatches.
  </action>
  <verify>cd native && swift build 2>&1 | grep -v "CloudKitConflictResolver" | grep -c "CKRecordObjCValue\|async context" | test $(cat) -eq 0</verify>
  <done>CloudKitConflictResolver compiles without CloudKit conformance or async context errors</done>
</task>

</tasks>

<verification>
Test Swift compilation:
1. Run `cd native && swift build` to check for remaining compilation errors
2. Open `native/Package.swift` in Xcode and verify project builds successfully
3. Confirm no missing method or conformance errors in build output
</verification>

<success_criteria>
Swift native project compiles cleanly enabling parallel native and React development without blocking compilation errors.
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-environment-debugging/32-20-SUMMARY.md`
</output>