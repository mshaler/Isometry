---
phase: 32-multi-environment-debugging
plan: 21
type: execute
wave: 1
depends_on: []
files_modified: [
  "src/components/VirtualizedGrid/index.tsx",
  "src/components/VirtualizedList/index.tsx",
  "src/d3/hooks.ts",
  "src/contexts/LiveDataContext.tsx"
]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "TypeScript compilation completes without errors in VirtualizedGrid components"
    - "D3 hooks provide type-safe Selection operations"
    - "LiveDataContext has no unused variable declarations"
    - "Type casting from unknown to Node/Edge uses proper type guards"
  artifacts:
    - path: "src/components/VirtualizedGrid/index.tsx"
      provides: "Type-safe Node/Edge casting with guards"
      pattern: "item as (Node|Edge)"
    - path: "src/d3/hooks.ts"
      provides: "Type-safe D3 Selection operations"
      pattern: "Selection<.*BaseType.*>"
    - path: "src/contexts/LiveDataContext.tsx"
      provides: "Clean context implementation without unused variables"
      no_pattern: "(recentNodesQuery|countQuery|state).*unused"
  key_links:
    - from: "VirtualizedGrid"
      to: "Node/Edge types"
      via: "Type guard functions"
      pattern: "isNode\\(|isEdge\\("
    - from: "D3 hooks"
      to: "BaseType interface"
      via: "FlexibleSelection type alias"
      pattern: "FlexibleSelection.*BaseType"
---

<objective>
Fix critical TypeScript compilation errors preventing clean builds in React components.

Purpose: Eliminate type casting violations and unused variables that block stable development workflow
Output: Clean TypeScript compilation without errors in virtualization and D3 components
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-multi-environment-debugging/32-VERIFICATION.md
</context>

<tasks>

<task type="auto">
  <name>Fix VirtualizedGrid type casting violations</name>
  <files>src/components/VirtualizedGrid/index.tsx, src/components/VirtualizedList/index.tsx</files>
  <action>
    Fix type casting errors where unknown types are assigned to Node/Edge parameters:

    1. Add type guard functions:
    ```typescript
    function isNode(item: unknown): item is Node {
      return typeof item === 'object' && item !== null && 'id' in item && 'type' in item;
    }

    function isEdge(item: unknown): item is Edge {
      return typeof item === 'object' && item !== null && 'source' in item && 'target' in item;
    }
    ```

    2. Replace unsafe casts like `item as Node` with type-guarded operations:
    ```typescript
    // Before: const node = item as Node;
    // After: if (isNode(item)) { const node = item; }
    ```

    3. Apply same pattern in both VirtualizedGrid and VirtualizedList components
    4. Ensure proper error handling for items that don't match expected types

    Reference existing code patterns from earlier plans for consistent typing approach.
    Gap reason: Type casting 'unknown' to Node/Edge without guards violates type safety
  </action>
  <verify>npm run type-check -- --noEmit src/components/VirtualizedGrid/index.tsx src/components/VirtualizedList/index.tsx</verify>
  <done>VirtualizedGrid and VirtualizedList components compile without type casting errors</done>
</task>

<task type="auto">
  <name>Fix D3 Selection type safety issues</name>
  <files>src/d3/hooks.ts</files>
  <action>
    Fix D3 Selection type conversion without proper type safety:

    1. Update FlexibleSelection type alias to properly handle BaseType compatibility:
    ```typescript
    type FlexibleSelection<GElement extends BaseType = BaseType> =
      d3.Selection<GElement, unknown, HTMLElement, unknown>;
    ```

    2. Add type guards for D3 selection operations:
    ```typescript
    function isValidSelection<T extends BaseType>(
      selection: d3.Selection<T, unknown, HTMLElement, unknown>
    ): selection is FlexibleSelection<T> {
      return selection.size() >= 0;
    }
    ```

    3. Replace unsafe D3 Selection conversions at line 159 with guarded operations
    4. Ensure compatibility with existing D3Canvas component integration

    Reference D3Canvas implementation from 32-04 plans for integration patterns.
    Gap reason: D3 Selection conversion without proper type safety breaks integration
  </action>
  <verify>npm run type-check -- --noEmit src/d3/hooks.ts</verify>
  <done>D3 hooks provide type-safe Selection operations without conversion errors</done>
</task>

<task type="auto">
  <name>Clean up unused LiveDataContext variables</name>
  <files>src/contexts/LiveDataContext.tsx</files>
  <action>
    Clean up unused variable declarations causing compilation noise:

    1. Remove or properly use these unused variables:
       - recentNodesQuery
       - countQuery
       - state (if truly unused)

    2. If variables are intended for future use, either:
       - Use them in the component logic, OR
       - Add underscore prefix (_recentNodesQuery) to indicate intentional unused, OR
       - Remove them entirely

    3. Verify all remaining variables are properly used in component rendering
    4. Ensure LiveDataProvider integration remains functional after cleanup

    Reference LiveDataProvider integration from 32-04 completion for usage patterns.
    Gap reason: Unused variable declarations create compilation noise and code bloat
  </action>
  <verify>npm run type-check -- --noEmit src/contexts/LiveDataContext.tsx</verify>
  <done>LiveDataContext compiles cleanly without unused variable warnings</done>
</task>

</tasks>

<verification>
Run full TypeScript compilation to verify error reduction:
- npm run type-check --noEmit
- Verify error count significantly reduced from current 160 errors
- Confirm VirtualizedGrid, D3 hooks, and LiveDataContext compile cleanly
</verification>

<success_criteria>
- TypeScript compilation errors in target files eliminated
- Type casting uses proper type guards instead of unsafe assertions
- D3 Selection operations maintain type safety with BaseType compatibility
- LiveDataContext has no unused variable compilation warnings
- Overall TypeScript error count reduced substantially from 160
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-environment-debugging/32-21-SUMMARY.md`
</output>