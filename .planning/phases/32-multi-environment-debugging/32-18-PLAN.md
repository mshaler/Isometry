---
phase: 32-multi-environment-debugging
plan: 18
type: execute
wave: 1
depends_on: []
files_modified:
  - native/Sources/Isometry/Bridge/Reliability/CircuitBreaker.swift
  - native/Sources/Isometry/Bridge/RealTime/ChangeNotificationBridge.swift
  - native/Sources/Isometry/Bridge/RealTime/RealTimeConflictResolver.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "CircuitBreaker imports QuartzCore framework for CACurrentMediaTime access"
    - "ChangeNotificationBridge implements notifyWebView method for real-time conflict resolution"
    - "RealTimeConflictResolver can successfully call bridge.notifyWebView method"
  artifacts:
    - path: "native/Sources/Isometry/Bridge/Reliability/CircuitBreaker.swift"
      provides: "QuartzCore import for performance timing"
      contains: "import QuartzCore"
    - path: "native/Sources/Isometry/Bridge/RealTime/ChangeNotificationBridge.swift"
      provides: "notifyWebView method implementation"
      contains: "func notifyWebView"
    - path: "native/Sources/Isometry/Bridge/RealTime/RealTimeConflictResolver.swift"
      provides: "Working bridge.notifyWebView method calls"
      contains: "await bridge.notifyWebView"
  key_links:
    - from: "CircuitBreaker.swift"
      to: "CACurrentMediaTime()"
      via: "QuartzCore framework import"
      pattern: "import QuartzCore"
    - from: "RealTimeConflictResolver.swift"
      to: "ChangeNotificationBridge.notifyWebView"
      via: "bridge method call"
      pattern: "await bridge\\.notifyWebView"
---

<objective>
Fix missing framework imports and bridge method implementations preventing Swift compilation.

Purpose: Resolve Swift compilation errors related to missing QuartzCore import in CircuitBreaker and missing notifyWebView method in ChangeNotificationBridge that are blocking the native build.
Output: Circuit breaker performance monitoring works correctly and real-time conflict resolution bridge communication functions.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Gap closure context from Phase 32 verification:
- CACurrentMediaTime not found in scope - missing QuartzCore import
- ChangeNotificationBridge missing notifyWebView method for conflict resolution
- RealTimeConflictResolver cannot call bridge.notifyWebView method
</context>

<tasks>

<task type="auto">
  <name>Fix QuartzCore import in CircuitBreaker for CACurrentMediaTime access</name>
  <files>native/Sources/Isometry/Bridge/Reliability/CircuitBreaker.swift</files>
  <action>
    Add missing QuartzCore framework import to enable CACurrentMediaTime() usage:

    1. Add QuartzCore import after existing imports:
       ```swift
       import Foundation
       import OSLog
       import QuartzCore  // Add this import for CACurrentMediaTime()
       ```

    2. Verify CACurrentMediaTime() usage is maintained at existing locations:
       - Line ~143: `let startTime = CACurrentMediaTime()`
       - Line ~172: `let executionTime = CACurrentMediaTime() - startTime`
       - Line ~186: `let executionTime = CACurrentMediaTime() - startTime`
       - Line ~395: `let executionTime = CACurrentMediaTime() - startTime`

    Gap reason: CACurrentMediaTime() requires QuartzCore framework import which is missing, causing "not found in scope" error
  </action>
  <verify>cd native && swift build --target Isometry 2>&1 | grep -i "CACurrentMediaTime.*not found" && echo "CACurrentMediaTime error still exists" || echo "CACurrentMediaTime error resolved"</verify>
  <done>CircuitBreaker compiles successfully with QuartzCore import, enabling performance timing functionality</done>
</task>

<task type="auto">
  <name>Implement missing notifyWebView method in ChangeNotificationBridge</name>
  <files>native/Sources/Isometry/Bridge/RealTime/ChangeNotificationBridge.swift</files>
  <action>
    Implement the missing notifyWebView method that is called by RealTimeConflictResolver:

    1. Add notifyWebView method to ChangeNotificationBridge actor (around line 100):
       ```swift
       /// Send notification message to WebView for conflict resolution
       /// Called by RealTimeConflictResolver to notify frontend of conflicts
       public func notifyWebView(message: [String: Any]) async {
           guard let webView = webView else {
               logger.warning("Cannot notify WebView - webView reference is nil")
               return
           }

           do {
               let jsonData = try JSONSerialization.data(withJSONObject: message)
               let jsonString = String(data: jsonData, encoding: .utf8) ?? "{}"
               let javascript = "window.isometryBridge?.handleMessage(\(jsonString))"

               await webView.evaluateJavaScript(javascript)
               logger.debug("Sent conflict notification to WebView", metadata: [
                   "messageType": "\(message["type"] ?? "unknown")"
               ])
           } catch {
               logger.error("Failed to serialize conflict notification", metadata: [
                   "error": "\(error)"
               ])
           }
       }
       ```

    2. Ensure method signature matches usage in RealTimeConflictResolver line 816:
       `await bridge.notifyWebView(message: message)`

    Gap reason: RealTimeConflictResolver.swift calls notifyWebView method on ChangeNotificationBridge but method doesn't exist
  </action>
  <verify>cd native && swift build --target Isometry 2>&1 | grep -i "notifyWebView.*not.*found" && echo "notifyWebView error still exists" || echo "notifyWebView method available"</verify>
  <done>ChangeNotificationBridge implements notifyWebView method, enabling real-time conflict notifications to frontend</done>
</task>

</tasks>

<verification>
Swift native project compiles successfully:
- `cd native && swift build --target Isometry` completes without framework import errors
- CircuitBreaker performance timing functionality works with CACurrentMediaTime()
- RealTimeConflictResolver can successfully notify WebView through ChangeNotificationBridge
- All bridge communication methods are properly implemented
</verification>

<success_criteria>
Framework imports and bridge methods implemented correctly:
1. QuartzCore import enables CACurrentMediaTime functionality in CircuitBreaker
2. ChangeNotificationBridge implements notifyWebView method for conflict resolution
3. RealTimeConflictResolver can successfully call bridge.notifyWebView
4. Swift compilation succeeds without missing method or framework errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-environment-debugging/32-18-SUMMARY.md`
</output>