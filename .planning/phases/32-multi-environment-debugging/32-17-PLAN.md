---
phase: 32-multi-environment-debugging
plan: 17
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/views/NetworkView.tsx
  - src/d3/hooks.ts
  - src/types/d3.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "NetworkView D3 Selection types are compatible between SVGGElement and BaseType"
    - "setupZoom function accepts flexible Selection types without type casting errors"
    - "D3 drag operations work with properly typed SVGGElement selections"
    - "TypeScript compilation error count decreases significantly from 269 baseline"
  artifacts:
    - path: "src/components/views/NetworkView.tsx"
      provides: "Type-safe D3 Selection usage without SVGGElement conflicts"
      contains: "setupZoom.*Selection"
    - path: "src/d3/hooks.ts"
      provides: "Flexible setupZoom function accepting BaseType selections"
      contains: "setupZoom.*BaseType"
    - path: "src/types/d3.ts"
      provides: "D3 type aliases for compatible Selection usage"
      contains: "Selection.*BaseType"
  key_links:
    - from: "NetworkView.tsx line 192"
      to: "setupZoom function"
      via: "type-safe Selection parameter"
      pattern: "setupZoom\\(.*Selection.*\\)"
    - from: "NetworkView.tsx D3 operations"
      to: "SVGGElement selections"
      via: "compatible type casting"
      pattern: "selectAll<SVGGElement"
    - from: "setupZoom function"
      to: "BaseType Selection interface"
      via: "flexible parameter typing"
      pattern: "Selection<BaseType"
---

<objective>
Resolve critical TypeScript compilation errors caused by D3 Selection type conflicts between SVGGElement and BaseType.

Purpose: Fix the fundamental D3 type incompatibility that is causing 269+ TypeScript compilation errors, with focus on NetworkView component and setupZoom function integration. Enable stable TypeScript compilation for multi-environment debugging.
Output: TypeScript compilation succeeds with significantly reduced error count, D3 components render properly.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Gap closure context from Phase 32 verification:
- 269 TypeScript compilation errors (38% regression from previous 194)
- D3 Selection type conflicts between SVGGElement and BaseType in NetworkView
- setupZoom function type casting issues preventing proper D3 integration
- Broader ecosystem instability from D3 type incompatibilities
</context>

<tasks>

<task type="auto">
  <name>Fix D3 Selection type compatibility in setupZoom function</name>
  <files>src/d3/hooks.ts</files>
  <action>
    Modify setupZoom function to accept flexible Selection types and resolve BaseType/SVGGElement conflicts:

    1. Update setupZoom function signature to accept BaseType selections:
       ```typescript
       export function setupZoom(
         svg: d3.Selection<SVGSVGElement, unknown, null, undefined>,
         container: d3.Selection<d3.BaseType, unknown, null, undefined>,
         options: { scaleExtent?: [number, number] } = {}
       ): void {
         // Implementation remains the same - D3 zoom behavior works with BaseType
       }
       ```

    2. Add type assertion within function for SVGGElement operations if needed:
       ```typescript
       const g = container as d3.Selection<SVGGElement, unknown, null, undefined>;
       // Use g for operations that specifically need SVGGElement
       ```

    3. Ensure zoom behavior setup works with BaseType container parameter while maintaining functionality.

    Reference TypeScript error resolution patterns from accumulated decisions. Use selective type coercion to maintain D3 functionality while resolving type conflicts.
    Gap reason: setupZoom expects SVGGElement Selection but receives BaseType Selection causing type incompatibility
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep setupZoom && echo 'setupZoom errors remain' || echo 'setupZoom errors resolved'</verify>
  <done>setupZoom function accepts BaseType selections without type errors, enabling flexible D3 component integration</done>
</task>

<task type="auto">
  <name>Resolve NetworkView D3 Selection type conflicts</name>
  <files>src/components/views/NetworkView.tsx</files>
  <action>
    Fix D3 Selection type conflicts in NetworkView component, specifically around lines 190-192:

    1. Remove problematic type casting in setupZoom call (line 192):
       ```typescript
       // BEFORE (line 192):
       setupZoom(svg, g as d3.Selection<SVGGElement, unknown, null, undefined>, { scaleExtent: [0.2, 4] });

       // AFTER:
       setupZoom(svg, g, { scaleExtent: [0.2, 4] });
       ```

    2. Update D3 selection patterns to use consistent BaseType approach:
       ```typescript
       // Ensure g variable uses BaseType selection consistently
       let g = svg.select<d3.BaseType>('.network-container');
       if (g.empty()) {
         g = svg.append('g').attr('class', 'network-container');
         setupZoom(svg, g, { scaleExtent: [0.2, 4] });
       }
       ```

    3. Review selectAll operations for SVGGElement usage (around line 344) and ensure type consistency:
       ```typescript
       const node = nodesGroup
         .selectAll<SVGGElement, SimNode>('g')  // Keep this specific typing if needed for drag operations
         .data(nodes, (d: SimNode) => d.id)
       ```

    4. Ensure drag operations maintain proper typing while avoiding Selection conflicts.

    Apply D3-React integration patterns from accumulated decisions. Focus on type consistency throughout component lifecycle.
    Gap reason: Type conflicts between SVGGElement and BaseType selections causing compilation failures
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep 'NetworkView.*Selection.*SVGGElement.*BaseType' && echo 'NetworkView Selection errors remain' || echo 'NetworkView Selection errors resolved'</verify>
  <done>NetworkView component uses consistent D3 Selection types without SVGGElement/BaseType conflicts</done>
</task>

<task type="auto">
  <name>Add D3 type aliases for consistent Selection usage</name>
  <files>src/types/d3.ts</files>
  <action>
    Add type aliases to standardize D3 Selection usage across components and prevent future type conflicts:

    1. Add flexible Selection type aliases:
       ```typescript
       // D3 Selection type aliases for consistent usage
       export type FlexibleSelection<T = d3.BaseType> = d3.Selection<T, unknown, null, undefined>;
       export type SVGSelection = FlexibleSelection<SVGSVGElement>;
       export type GroupSelection = FlexibleSelection<SVGGElement>;
       export type ContainerSelection = FlexibleSelection<d3.BaseType>;
       ```

    2. Add zoom-specific type helpers:
       ```typescript
       // Zoom behavior types
       export type ZoomBehavior = d3.ZoomBehavior<SVGSVGElement, unknown>;
       export type ZoomTransform = d3.ZoomTransform;
       export type ZoomSelection = FlexibleSelection<SVGSVGElement>;
       ```

    3. Export existing types and add documentation:
       ```typescript
       // Re-export existing simulation types with documentation
       export type {
         SimulationNodeDatum,
         SimulationLinkDatum,
         D3ForceSimulation
       } from './d3';

       /**
        * Use FlexibleSelection when working with mixed D3 selection types
        * Use specific typed selections (GroupSelection, SVGSelection) when type certainty is required
        */
       ```

    Provide clean type abstractions that components can use to avoid direct BaseType/SVGGElement conflicts.
    Gap reason: Lack of standardized Selection types causing inconsistent usage across D3 components
  </action>
  <verify>grep -c "FlexibleSelection\|ContainerSelection" src/types/d3.ts</verify>
  <done>D3 type aliases provide consistent Selection typing patterns, preventing future type conflicts</done>
</task>

</tasks>

<verification>
TypeScript compilation stability improved:
- `npx tsc --noEmit` shows significant reduction in compilation errors from 269 baseline
- NetworkView component compiles without D3 Selection type conflicts
- setupZoom function accepts flexible Selection types without casting errors
- D3 type aliases provide consistent patterns for future component development
</verification>

<success_criteria>
TypeScript compilation environment stabilized for multi-environment debugging:
1. D3 Selection type conflicts resolved in NetworkView component
2. setupZoom function accepts BaseType selections without type errors
3. Compilation error count reduced significantly from 269 error baseline
4. D3 components maintain functionality while achieving type safety
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-environment-debugging/32-17-SUMMARY.md`
</output>