---
phase: 78-url-deep-linking
plan: 01
type: execute
wave: 1
depends_on: [77-01]
files_modified:
  - src/App.tsx
  - src/hooks/ui/useNodeDeepLink.ts
  - src/state/SelectionContext.tsx
autonomous: true

must_haves:
  truths:
    - "URL parameter ?nodeId={id} focuses that node on page load"
    - "Node is scrolled into view and selected"
    - "Works with Grid, List, Kanban, and Network views"
    - "Invalid nodeId shows graceful error (doesn't crash)"
  artifacts:
    - path: "src/hooks/ui/useNodeDeepLink.ts"
      provides: "Deep link hook"
      exports: ["useNodeDeepLink"]
---

<objective>
Add node deep linking via URL parameter.

Purpose: Enable sharing links to specific nodes that open focused on that node.

Output: ?nodeId={id} support in App.tsx
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Create useNodeDeepLink hook</name>
  <files>src/hooks/ui/useNodeDeepLink.ts</files>
  <action>
Create hook that:
1. Reads `nodeId` from URL search params
2. Validates node exists in database
3. Triggers selection and scroll-to-view
4. Clears URL param after focusing (or keeps it - decide)

```typescript
import { useEffect } from 'react';
import { useSearchParams } from './useURLState';
import { useSelection } from '../../state/SelectionContext';
import { useDatabase } from '../database/useDatabase';

export function useNodeDeepLink() {
  const [searchParams, setSearchParams] = useSearchParams();
  const { setSelectedIds, scrollToNode } = useSelection();
  const { db } = useDatabase();

  useEffect(() => {
    const nodeId = searchParams.get('nodeId');
    if (!nodeId || !db) return;

    // Verify node exists
    const result = db.exec(`SELECT id FROM nodes WHERE id = ? AND deleted_at IS NULL`, [nodeId]);
    if (result.length === 0 || result[0].values.length === 0) {
      console.warn(`Deep link node not found: ${nodeId}`);
      return;
    }

    // Select and scroll to node
    setSelectedIds([nodeId]);
    scrollToNode?.(nodeId);

    // Optionally clear the param (or keep for shareability)
    // setSearchParams(prev => { prev.delete('nodeId'); return prev; });
  }, [searchParams, db, setSelectedIds, scrollToNode]);

  return null;
}
```
  </action>
  <verify>Hook compiles without errors</verify>
  <done>useNodeDeepLink hook created</done>
</task>

<task type="auto">
  <name>Task 2: Add scrollToNode to SelectionContext</name>
  <files>src/state/SelectionContext.tsx</files>
  <action>
Add scrollToNode callback to SelectionContext:

```typescript
interface SelectionContextType {
  selectedIds: string[];
  setSelectedIds: (ids: string[]) => void;
  scrollToNode?: (id: string) => void;
  setScrollToNode: (fn: (id: string) => void) => void;
}
```

Views (SuperGrid, Network, etc.) register their scroll function.
This allows the deep link hook to trigger scroll regardless of active view.
  </action>
  <verify>SelectionContext exports scrollToNode</verify>
  <done>scrollToNode added to context</done>
</task>

<task type="auto">
  <name>Task 3: Wire hook into App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Add useNodeDeepLink to App component:

```typescript
import { useNodeDeepLink } from './hooks/ui/useNodeDeepLink';

function App() {
  // Existing code...
  
  // Handle deep links
  useNodeDeepLink();
  
  // Rest of component...
}
```

Ensure it runs after database and contexts are initialized.
  </action>
  <verify>App loads with ?nodeId=test shows selection</verify>
  <done>Deep link hook wired into App</done>
</task>

<task type="auto">
  <name>Task 4: Test deep linking</name>
  <files>src/hooks/ui/__tests__/useNodeDeepLink.test.ts</files>
  <action>
Write tests:
1. Valid nodeId selects and scrolls
2. Invalid nodeId logs warning, doesn't crash
3. No nodeId param does nothing
4. Works after view switch
  </action>
  <verify>Tests pass</verify>
  <done>Deep link tests written</done>
</task>

</tasks>

<verification>
1. Load app with ?nodeId=existing-id → node selected
2. Load app with ?nodeId=invalid → graceful handling
3. Share URL with nodeId → recipient sees same node focused
</verification>

<success_criteria>
- URL-01 satisfied: Node deep links work
- Selection and scroll-to-view function
- All view types supported via SelectionContext
</success_criteria>
