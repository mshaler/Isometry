---
phase: 14.4-graph-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [
  "native/Sources/Isometry/Bridge/GraphMessageHandler.swift",
  "src/services/GraphAnalyticsAdapter.ts",
  "src/components/views/NetworkView.tsx",
  "src/components/views/TreeView.tsx"
]
autonomous: true

must_haves:
  truths:
    - "React NetworkView displays connection suggestions from native analytics engine"
    - "React TreeView shows hierarchical analytics and recursive query optimization"
    - "Bridge communication provides real-time graph intelligence updates"
    - "Performance monitoring tracks graph analytics integration effectiveness"
  artifacts:
    - path: "native/Sources/Isometry/Bridge/GraphMessageHandler.swift"
      provides: "WebView bridge for graph analytics communication"
      exports: ["GraphMessageHandler", "GraphAnalyticsMessage", "GraphCommand"]
    - path: "src/services/GraphAnalyticsAdapter.ts"
      provides: "React service for native graph analytics integration"
      exports: ["GraphAnalyticsAdapter", "ConnectionSuggestion", "GraphMetrics"]
    - path: "src/components/views/NetworkView.tsx"
      provides: "Enhanced network view with native analytics integration"
      contains: "useGraphAnalytics"
    - path: "src/components/views/TreeView.tsx"
      provides: "Enhanced tree view with hierarchical analytics"
      contains: "useGraphAnalytics"
  key_links:
    - from: "src/components/views/NetworkView.tsx"
      to: "native/Sources/Isometry/Bridge/GraphMessageHandler.swift"
      via: "WebView bridge connection suggestion requests"
      pattern: "window\\.webkit\\.messageHandlers\\.graphAnalytics"
    - from: "src/services/GraphAnalyticsAdapter.ts"
      to: "native/Sources/Isometry/Graph/ConnectionSuggestionEngine.swift"
      via: "Bridge message translation and response handling"
      pattern: "suggestConnections.*ConnectionSuggestion"
---

<objective>
Create native graph analytics bridge foundation enabling React NetworkView and TreeView to access sophisticated graph intelligence from Swift ConnectionSuggestionEngine and QueryCache.

Purpose: Bridge React graph visualization components to native Swift graph analytics engine, enabling real-time connection suggestions, centrality analysis, and query optimization for enhanced user experience.
Output: WebView bridge infrastructure connecting React graph views to native analytics with seamless data flow and performance monitoring.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 14.1-14.3 completed infrastructure
@.planning/phases/14-pafv-integration/14-01-SUMMARY.md
@.planning/phases/14.2-latch-filter-integration/14.2-03-SUMMARY.md
@.planning/phases/14.3-d3-canvas-integration/14.3-02-SUMMARY.md

# Existing graph analytics infrastructure
@native/Sources/Isometry/Graph/ConnectionSuggestionEngine.swift
@native/Sources/Isometry/Graph/QueryCache.swift

# Current graph views to enhance
@src/components/views/NetworkView.tsx
@src/components/views/TreeView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Native Graph Analytics WebView Bridge</name>
  <files>native/Sources/Isometry/Bridge/GraphMessageHandler.swift</files>
  <action>
    Create GraphMessageHandler.swift following the established patterns from PAFVMessageHandler and LATCHMessageHandler:

    Core MessageHandler Implementation:
    - Actor-based thread-safe message handling with @MainActor coordination
    - GraphAnalyticsMessage enum: suggestConnections, getGraphMetrics, getCacheStats, runGraphQuery
    - GraphCommand struct with nodeId, queryType, options parameters
    - Integration with existing ConnectionSuggestionEngine and QueryCache instances

    Connection Suggestion Bridge Methods:
    - handleSuggestConnections(nodeId: String, options: SuggestionOptions) -> [ConnectionSuggestion]
    - handleBatchSuggestConnections(nodeIds: [String], options: SuggestionOptions) -> [String: [ConnectionSuggestion]]
    - Use existing engine.suggestConnections and engine.batchSuggestConnections APIs
    - Transform Swift ConnectionSuggestion to JSON with id, nodeId, reason, confidence, type fields

    Graph Analytics Bridge Methods:
    - handleGetGraphMetrics() -> SuggestionMetrics (totalNodes, totalEdges, averageTagsPerNode, graphDensity)
    - handleGetCacheStats() -> CacheStats (totalEntries, validEntries, hitRate, estimatedMemoryMB)
    - handleRunGraphQuery(queryType: String, parameters: [String: Any]) -> QueryResult
    - Integration with existing queryCache.getOrCompute and engine.getSuggestionMetrics

    Performance Integration:
    - Leverage existing RenderingPerformanceMonitor for graph operation timing
    - Add graphAnalyticsLatency and suggestionComputeTime metrics
    - Bridge performance data to React for optimization feedback
    - Follow Phase 14.3 patterns for WebView bridge efficiency (0.04ms ping performance)

    Error Handling and Validation:
    - Comprehensive error cases: invalidNodeId, engineUnavailable, cacheError, queryTimeout
    - Input validation for nodeId format and suggestion option ranges
    - Graceful degradation when native analytics unavailable
    - Error reporting to React with actionable error codes
  </action>
  <verify>grep -E "(GraphMessageHandler|suggestConnections|ConnectionSuggestion)" native/Sources/Isometry/Bridge/GraphMessageHandler.swift</verify>
  <done>GraphMessageHandler.swift exists with connection suggestion bridge, graph metrics integration, and performance monitoring following Phase 14.1-14.3 patterns</done>
</task>

<task type="auto">
  <name>Task 2: React Graph Analytics Service Adapter</name>
  <files>src/services/GraphAnalyticsAdapter.ts</files>
  <action>
    Create GraphAnalyticsAdapter.ts as React service layer for native graph analytics:

    Core Service Interface:
    - GraphAnalyticsAdapter class with WebView bridge communication
    - ConnectionSuggestion interface: id, nodeId, reason, confidence, type
    - GraphMetrics interface: totalNodes, totalEdges, averageTagsPerNode, graphDensity
    - SuggestionOptions interface: maxSuggestions, minConfidence, includeTypes, excludeExistingConnections

    Connection Suggestion Methods:
    - async suggestConnections(nodeId: string, options?: SuggestionOptions): Promise<ConnectionSuggestion[]>
    - async batchSuggestConnections(nodeIds: string[], options?: SuggestionOptions): Promise<Record<string, ConnectionSuggestion[]>>
    - Use window.webkit.messageHandlers.graphAnalytics.postMessage following Phase 14.1-14.2 patterns
    - Response correlation with request IDs for async operation management

    Graph Analytics Methods:
    - async getGraphMetrics(): Promise<GraphMetrics>
    - async getCacheStats(): Promise<CacheStats>
    - async runGraphQuery(queryType: string, parameters: Record<string, any>): Promise<any>
    - Typed response interfaces for all native analytics operations

    Performance and Caching:
    - Local caching with TTL for frequently requested suggestions (5-minute cache)
    - Performance monitoring integration with existing d3Performance.ts patterns
    - Automatic fallback to local graph analysis when native bridge unavailable
    - Request throttling and debouncing for rapid suggestion requests

    Error Handling:
    - Bridge availability detection with graceful degradation
    - Timeout handling for slow graph analytics operations (10-second default)
    - Error recovery with automatic retry for transient failures
    - User-friendly error messages for common failure scenarios
  </action>
  <verify>grep -E "(GraphAnalyticsAdapter|suggestConnections|window\.webkit)" src/services/GraphAnalyticsAdapter.ts</verify>
  <done>GraphAnalyticsAdapter.ts exists with native bridge communication, connection suggestion methods, and performance integration matching Phase 14.1-14.2 patterns</done>
</task>

<task type="auto">
  <name>Task 3: Enhanced Network and Tree Views with Native Analytics</name>
  <files>src/components/views/NetworkView.tsx, src/components/views/TreeView.tsx</files>
  <action>
    Enhance NetworkView.tsx with native graph analytics integration:

    Connection Suggestions Enhancement:
    - Add connectionSuggestions state with ConnectionSuggestion[] type
    - Integrate GraphAnalyticsAdapter for real-time suggestion fetching
    - useEffect hook triggering suggestions when selectedNode changes
    - Visual indicators for suggested connections (dashed lines, highlight color)
    - Suggestion confidence visualization using line opacity or width

    Analytics Overlay:
    - Display graph metrics: node count, edge count, graph density
    - Connection suggestion panel with reasons and confidence scores
    - Real-time analytics updates when graph structure changes
    - Performance metrics display: suggestion compute time, cache hit rate

    User Interaction Enhancement:
    - Click to apply suggested connections with confirmation dialog
    - Suggestion filtering by type (similarContent, sameCommunity, sharedTags, etc.)
    - Suggestion confidence threshold adjustment slider
    - Connection suggestion history and undo capability

    ---

    Enhance TreeView.tsx with hierarchical analytics integration:

    Hierarchical Analytics Enhancement:
    - Add hierarchicalMetrics state with depth analysis, branching factor, balance metrics
    - Integrate recursive CTE query optimization from native database layer
    - Real-time hierarchy optimization suggestions (rebalancing, pruning)
    - Path analysis between nodes using shortest path algorithms

    Tree Structure Optimization:
    - Native query optimization for large tree traversals (>1000 nodes)
    - Lazy loading of tree branches with native analytics guidance
    - Tree layout optimization based on connection strength and importance
    - Hierarchical clustering suggestions for flattened structures

    Performance Integration:
    - Tree traversal performance monitoring with native query cache integration
    - Recursive query optimization leveraging SQLite CTE capabilities
    - Memory usage tracking for large tree structures
    - Automatic query plan optimization suggestions

    Both components should:
    - Follow Phase 14.1-14.3 patterns for bridge communication
    - Integrate with existing useD3 and theme management systems
    - Maintain backward compatibility with existing functionality
    - Add comprehensive error boundaries for analytics failures
  </action>
  <verify>grep -E "(connectionSuggestions|GraphAnalyticsAdapter|hierarchicalMetrics)" src/components/views/NetworkView.tsx src/components/views/TreeView.tsx</verify>
  <done>NetworkView.tsx and TreeView.tsx enhanced with native analytics integration, connection suggestions, hierarchical analysis, and performance monitoring</done>
</task>

</tasks>

<verification>
- WebView bridge handles graph analytics messages with ConnectionSuggestionEngine integration
- React GraphAnalyticsAdapter successfully communicates with native bridge
- NetworkView displays connection suggestions with visual indicators and confidence scores
- TreeView shows hierarchical analytics and recursive query optimization
- Bridge communication maintains Phase 14.1-14.3 performance standards (<5ms latency)
- Error handling provides graceful degradation when native analytics unavailable
</verification>

<success_criteria>
- React NetworkView displays real-time connection suggestions from native ConnectionSuggestionEngine
- TreeView integration provides hierarchical analytics and query optimization feedback
- Bridge communication delivers graph intelligence with <5ms latency matching Phase 14.3 standards
- Connection suggestion accuracy leverages native algorithms (80%+ confidence suggestions)
- Performance monitoring tracks graph analytics effectiveness and optimization opportunities
- User interface seamlessly integrates native analytics without breaking existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/14.4-graph-integration/14.4-01-SUMMARY.md`
</output>