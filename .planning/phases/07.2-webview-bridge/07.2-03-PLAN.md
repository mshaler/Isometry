---
phase: 07.2-webview-bridge
plan: 03
type: execute
wave: 3
depends_on: ["07.2-02"]
files_modified: [
  "native/Sources/Isometry/WebView/FileSystemMessageHandler.swift",
  "src/utils/file-system-bridge.ts",
  "src/hooks/useFileSystem.ts",
  "native/Sources/Isometry/Security/SandboxValidator.swift"
]
autonomous: true

must_haves:
  truths:
    - "File system operations work through WebView bridge within App Sandbox"
    - "React components can read/write files with proper security validation"
    - "File access respects App Sandbox container restrictions"
    - "Export functionality works through native file system bridge"
    - "Security validation prevents unauthorized file access"
  artifacts:
    - path: "native/Sources/Isometry/WebView/FileSystemMessageHandler.swift"
      provides: "Secure file system operations for WebView"
      min_lines: 200
      contains: ["FileSystemMessageHandler", "validateFilePath", "readFile", "writeFile"]
    - path: "src/utils/file-system-bridge.ts"
      provides: "React interface for file system operations"
      min_lines: 80
      exports: ["FileSystemBridge", "readFile", "writeFile", "exportFile"]
    - path: "native/Sources/Isometry/Security/SandboxValidator.swift"
      provides: "App Sandbox compliance validation"
      min_lines: 100
      exports: ["SandboxValidator", "validatePath", "isPathAllowed"]
  key_links:
    - from: "React FileSystemBridge.readFile()"
      to: "webkit.messageHandlers.filesystem"
      via: "WebView bridge message"
      pattern: "webkit\\.messageHandlers\\.filesystem\\.postMessage.*readFile"
    - from: "FileSystemMessageHandler"
      to: "SandboxValidator"
      via: "path validation before file operations"
      pattern: "SandboxValidator\\.validatePath.*path"
    - from: "File operations"
      to: "App Sandbox container"
      via: "FileManager within container bounds"
      pattern: "FileManager.*containerURL.*applicationSupportDirectory"
---

<objective>
Implement file system abstraction layer for App Sandbox compliance, enabling React components to access files securely through WebView bridge.

Purpose: Replace direct file access with sandboxed operations while maintaining React component functionality for exports, imports, and file management.

Output: Secure file system bridge that respects App Sandbox constraints while providing necessary file operations for React prototype functionality.
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-webview-bridge/07.2-02-PLAN.md
@native/Sources/Isometry/WebView/DatabaseMessageHandler.swift
@src/utils/webview-bridge.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create App Sandbox security validation layer</name>
  <files>
    native/Sources/Isometry/Security/SandboxValidator.swift
  </files>
  <action>
    Create SandboxValidator.swift for comprehensive App Sandbox compliance:

    Export SandboxValidator class with path validation:
    - validatePath(_:for:) -> ValidationResult
    - isPathAllowed(_:operation:) -> Bool
    - getContainerPath(for:) -> URL?
    - sanitizePath(_:) -> String
    - getAllowedDirectories() -> [URL]

    App Sandbox compliance rules:
    - Only allow access to app's container directories
    - Support Documents, Library/Application Support, tmp directories
    - Validate file extensions for security (no executables)
    - Prevent path traversal attacks (../, symlinks)
    - Restrict access to system directories

    Operation-specific validation:
    - READ: Allow reading from container and bundle
    - WRITE: Only allow writing to Documents and Application Support
    - DELETE: Restrict deletion to user-created files
    - EXPORT: Validate export paths and content types
    - IMPORT: Validate imported file types and sizes

    Security features:
    - Path canonicalization to prevent traversal
    - File type validation based on extensions and content
    - Size limits for file operations (prevent DoS)
    - Logging of all file access attempts
    - Rate limiting for file operations

    Container path management:
    ```swift
    enum ContainerDirectory: CaseIterable {
        case documents
        case applicationSupport
        case caches
        case temporary

        var url: URL? {
            let fileManager = FileManager.default
            switch self {
            case .documents:
                return fileManager.urls(for: .documentDirectory, in: .userDomainMask).first
            case .applicationSupport:
                return fileManager.urls(for: .applicationSupportDirectory, in: .userDomainMask).first
            // ... etc
            }
        }
    }
    ```

    Include comprehensive logging and audit trails for security compliance.
  </action>
  <verify>
    SandboxValidator correctly identifies allowed vs restricted paths
    Path validation prevents common security vulnerabilities
    Container directory access works correctly
  </verify>
  <done>
    App Sandbox validator provides comprehensive security validation for all file system operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement secure file system MessageHandler</name>
  <files>
    native/Sources/Isometry/WebView/FileSystemMessageHandler.swift
  </files>
  <action>
    Create FileSystemMessageHandler.swift for secure file operations:

    Export FileSystemMessageHandler class conforming to WKScriptMessageHandler:
    - userContentController(_:didReceive:) main entry point
    - handleFileSystemMessage(_:) for message parsing and routing
    - readFile(path:) -> Data for file reading
    - writeFile(path:content:) for file writing
    - exportFile(path:destination:) for export operations
    - listFiles(directory:) for directory browsing

    File operation implementations:
    - All operations use SandboxValidator for security
    - Handle both text and binary file content
    - Support Base64 encoding for binary data
    - Include file metadata (size, modified date, type)
    - Handle large files with streaming when needed

    Supported file operations:
    ```swift
    enum FileSystemOperation {
        case read(path: String)
        case write(path: String, content: Data)
        case delete(path: String)
        case list(directory: String)
        case export(path: String, format: ExportFormat)
        case createDirectory(path: String)
    }
    ```

    Export functionality:
    - Support multiple formats: PDF, HTML, JSON, CSV
    - Use native export APIs (NSDocument, UIDocumentPickerViewController)
    - Handle export permissions and user selection
    - Support sharing through native share sheet
    - Include metadata and proper file naming

    Error handling and security:
    - Validate all paths through SandboxValidator
    - Handle file system errors gracefully
    - Prevent unauthorized access attempts
    - Log security violations for audit
    - Return meaningful error messages to React

    Integration with existing file patterns:
    - Support React export functionality (PDF generation, etc.)
    - Handle temporary file creation for processing
    - Clean up temporary files automatically
    - Support file watching for real-time updates

    Include comprehensive async/await support and proper error propagation.
  </action>
  <verify>
    FileSystemMessageHandler successfully handles all file operations
    Security validation prevents unauthorized access
    Export functionality works with native sharing mechanisms
  </verify>
  <done>
    File system MessageHandler provides secure file operations within App Sandbox constraints with comprehensive validation
  </done>
</task>

<task type="auto">
  <name>Task 3: Create React file system bridge interface</name>
  <files>
    src/utils/file-system-bridge.ts
    src/hooks/useFileSystem.ts
  </files>
  <action>
    Create file-system-bridge.ts for React file system operations:

    Export FileSystemBridge class with secure file operations:
    - readFile(path: string): Promise<string | ArrayBuffer>
    - writeFile(path: string, content: string | ArrayBuffer): Promise<void>
    - deleteFile(path: string): Promise<void>
    - listFiles(directory: string): Promise<FileInfo[]>
    - exportFile(path: string, format: ExportFormat): Promise<string>
    - createDirectory(path: string): Promise<void>

    Environment detection and fallback:
    - Use WebView bridge when available
    - Fall back to browser APIs (File API) when in browser
    - Provide graceful degradation for unsupported operations
    - Handle permissions and user interaction requirements

    File format support:
    ```typescript
    interface FileInfo {
        name: string;
        path: string;
        size: number;
        modified: Date;
        type: 'file' | 'directory';
        extension?: string;
        mimeType?: string;
    }

    enum ExportFormat {
        PDF = 'pdf',
        HTML = 'html',
        JSON = 'json',
        CSV = 'csv',
        MARKDOWN = 'md'
    }
    ```

    Create useFileSystem.ts hook for React components:
    - Export useFileSystem() hook with consistent interface
    - Handle loading states for async file operations
    - Provide error handling and user feedback
    - Support file operation progress tracking
    - Cache file listings for performance

    Integration with existing React patterns:
    - Support current export functionality seamlessly
    - Handle file uploads and imports
    - Provide file picker abstractions
    - Support drag-and-drop file operations
    - Maintain existing component interfaces

    Browser compatibility layer:
    - Use File API for browser environments
    - Handle download triggers for exports
    - Support local storage fallbacks where appropriate
    - Provide feature detection for capabilities

    Export operations integration:
    - Connect to existing PDF export functionality
    - Support HTML/JSON export with proper formatting
    - Handle large file exports with progress indication
    - Include native share sheet integration on mobile

    Include comprehensive error handling and TypeScript type safety.
  </action>
  <verify>
    File system bridge works correctly in both WebView and browser environments
    React components can read/write files through bridge interface
    Export functionality works with native sharing mechanisms
  </verify>
  <done>
    React file system bridge provides secure file operations with automatic environment detection and comprehensive export support
  </done>
</task>

</tasks>

<verification>
1. File system operations work securely through WebView bridge
2. App Sandbox compliance prevents unauthorized file access
3. Export functionality integrates with native sharing mechanisms
4. React components maintain same interface across environments
5. Security validation provides comprehensive protection against file system attacks
</verification>

<success_criteria>
- [ ] File system bridge enables secure file operations within App Sandbox
- [ ] Security validation prevents unauthorized access and path traversal
- [ ] Export functionality works through native mechanisms
- [ ] React components require no changes for file operations
- [ ] Performance and security meet App Store compliance requirements
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-webview-bridge/07.2-03-SUMMARY.md`
</output>