---
phase: 06.3-shell-integration
plan: 03
type: execute
wave: 3
depends_on: [06.3-02]
files_modified: [
  native/Sources/Isometry/Security/SandboxExecutor.swift,
  native/Sources/Isometry/Models/ShellModels.swift,
  native/Sources/Isometry/Security/ProcessManager.swift,
  native/Sources/Isometry/Views/Notebook/NotebookShellView.swift
]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Commands execute with proper App Sandbox file access restrictions"
    - "Background execution continues when app backgrounds (macOS)"
    - "Process cancellation works reliably without memory leaks"
    - "File operations respect sandboxed container boundaries"
  artifacts:
    - path: "native/Sources/Isometry/Security/ProcessManager.swift"
      provides: "Advanced process lifecycle management"
      exports: ["ProcessManager", "ProcessState", "BackgroundExecution"]
    - path: "native/Sources/Isometry/Security/SandboxExecutor.swift"
      provides: "Enhanced sandbox enforcement and process control"
      contains: "background execution support"
    - path: "native/Sources/Isometry/Models/ShellModels.swift"
      provides: "Process state and execution context models"
      contains: "BackgroundTask, ProcessState enums"
  key_links:
    - from: "ProcessManager.swift"
      to: "NSBackgroundActivityScheduler"
      via: "background task management"
      pattern: "NSBackgroundActivityScheduler"
    - from: "SandboxExecutor.swift"
      to: "ProcessManager"
      via: "lifecycle management"
      pattern: "processManager\\.execute"
---

<objective>
Implement advanced process execution framework with background task support and enhanced App Sandbox security

Purpose: Provide robust process management that handles long-running commands, background execution, and strict sandbox enforcement for App Store compliance
Output: Production-ready process execution system with lifecycle management and security controls
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Previous plans foundation
@.planning/phases/06.3-shell-integration/06.3-01-PLAN.md
@.planning/phases/06.3-shell-integration/06.3-02-PLAN.md

# Current shell implementation
@native/Sources/Isometry/Views/Notebook/NotebookShellView.swift
@native/Sources/Isometry/Security/SandboxExecutor.swift
@native/Sources/Isometry/Models/ShellModels.swift

# Performance infrastructure
@native/Sources/Isometry/Utils/PerformanceMonitor.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProcessManager for advanced process lifecycle control</name>
  <files>native/Sources/Isometry/Security/ProcessManager.swift</files>
  <action>
    Create comprehensive process lifecycle management system:

    - ProcessManager actor with concurrent process tracking and resource management
    - ProcessState enum: idle, running, suspended, terminated, backgrounded
    - Process cancellation with proper cleanup: terminate(), kill() with graceful shutdown
    - Background execution support using NSBackgroundActivityScheduler (macOS)
    - Process monitoring: CPU usage, memory consumption, execution time tracking
    - Resource limits: maximum concurrent processes (3), memory per process (100MB)
    - Process grouping for related commands (e.g., piped commands)
    - Cleanup handlers for orphaned processes and resource leaks

    Use iOS/macOS appropriate APIs:
    - macOS: NSBackgroundActivityScheduler for background tasks
    - iOS: UIApplication.beginBackgroundTask for short background execution
    - Both: Process.terminate() for graceful shutdown, Process.interrupt() for cancellation

    Integration with PerformanceMonitor for process performance tracking.
    Proper memory management to prevent process zombie accumulation.
  </action>
  <verify>ProcessManager successfully creates, monitors, and terminates test processes</verify>
  <done>ProcessManager provides robust process lifecycle control with platform-specific background support</done>
</task>

<task type="auto">
  <name>Task 2: Enhance SandboxExecutor with advanced security and background execution</name>
  <files>native/Sources/Isometry/Security/SandboxExecutor.swift, native/Sources/Isometry/Models/ShellModels.swift</files>
  <action>
    Significantly enhance SandboxExecutor security and capabilities:

    SandboxExecutor enhancements:
    - ProcessManager integration for advanced process control
    - Enhanced command validation: path traversal prevention, command injection protection
    - File access enforcement: strict container-only access, no system directory access
    - Background execution support for long-running commands (e.g., "find" in large directories)
    - Process cancellation with UI feedback and proper cleanup
    - Environment variable sanitization: remove sensitive environment, add safe defaults
    - Working directory validation: ensure directories exist and are accessible
    - Output streaming with backpressure control to prevent memory exhaustion

    ShellModels additions:
    - BackgroundTask model for tracking background operations
    - ProcessState enum: .starting, .running, .suspended, .completed, .failed, .cancelled
    - ExecutionLimits struct: maxExecutionTime, maxOutputSize, maxMemoryUsage
    - SecurityViolation enum for different types of sandbox violations

    Enhanced allowlist with more commands: ls, pwd, echo, cat, find, grep, wc, head, tail, date, whoami.
    NO shell operators: no pipes, redirects, or command chaining for security.
    Each command individually validated and sandboxed.
  </action>
  <verify>Enhanced executor safely runs commands with background support and prevents sandbox escapes</verify>
  <done>SandboxExecutor provides App Store compliant process execution with advanced security controls</done>
</task>

<task type="auto">
  <name>Task 3: Integrate advanced process management into shell interface</name>
  <files>native/Sources/Isometry/Views/Notebook/NotebookShellView.swift</files>
  <action>
    Enhance shell interface with advanced process management features:

    Process control UI:
    - Running process indicator with progress animation
    - Cancel button for running processes with confirmation dialog
    - Background execution indicator when app backgrounded (macOS)
    - Process status display: running time, memory usage, output size
    - Concurrent process limit notification (max 3 processes)

    Enhanced command handling:
    - Long-running command detection and background execution setup
    - Process output streaming with scroll-to-bottom behavior
    - Cancellation handling with proper cleanup and user feedback
    - Error recovery for failed or terminated processes
    - Process history with completion status and execution time

    Platform-specific features:
    - macOS: Full background execution with NSBackgroundActivityScheduler
    - iOS: Limited background with UIApplication.beginBackgroundTask
    - Both: Proper app lifecycle handling with process suspension/resumption

    Accessibility:
    - VoiceOver support for process status and controls
    - Keyboard shortcuts: Ctrl+C (cancel), Ctrl+Z (suspend on macOS)
    - Screen reader announcements for command completion and errors
  </action>
  <verify>Shell interface shows process status, allows cancellation, and handles background execution properly</verify>
  <done>Shell provides comprehensive process management UI with platform-appropriate background execution</done>
</task>

</tasks>

<verification>
Security test: Attempt to execute "cat /etc/passwd" or navigate outside sandbox, verify proper rejection
Background test: Execute long-running command, background the app, verify execution continues (macOS)
Cancellation test: Start long command, cancel it, verify process terminates and resources are cleaned up
Concurrent test: Start 4 commands simultaneously, verify 3 execute and 4th queues appropriately
</verification>

<success_criteria>
- Commands execute within strict App Sandbox file access boundaries
- Long-running processes continue execution when app backgrounds (macOS platform)
- Process cancellation works reliably without leaving orphaned processes
- Resource management prevents memory leaks and process accumulation
- UI provides clear feedback for process status and background execution
- Security framework prevents sandbox escape attempts with clear error messages
</success_criteria>

<output>
After completion, create `.planning/phases/06.3-shell-integration/06.3-03-SUMMARY.md`
</output>