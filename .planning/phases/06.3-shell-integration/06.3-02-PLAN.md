---
phase: 06.3-shell-integration
plan: 02
type: execute
wave: 2
depends_on: [06.3-01]
files_modified: [
  native/Sources/Isometry/API/ClaudeAPIClient.swift,
  native/Sources/Isometry/Models/ClaudeModels.swift,
  native/Sources/Isometry/Views/Notebook/NotebookShellView.swift,
  native/Sources/Isometry/Security/SandboxExecutor.swift
]
autonomous: false
user_setup:
  - service: anthropic
    why: "Claude Code API integration for AI-assisted development commands"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> Account -> API Keys"
    account_setup:
      - task: "Create Anthropic account if needed"
        location: "https://console.anthropic.com/"
    dashboard_config:
      - task: "Generate API key"
        location: "Console -> Account -> API Keys"

must_haves:
  truths:
    - "User can execute Claude commands with '/claude' prefix"
    - "Claude API responses appear in terminal with proper formatting"
    - "API key configuration works through app settings or environment"
    - "Command routing distinguishes between system and Claude commands"
  artifacts:
    - path: "native/Sources/Isometry/API/ClaudeAPIClient.swift"
      provides: "Native Claude API integration using URLSession"
      exports: ["ClaudeAPIClient", "APIResponse"]
    - path: "native/Sources/Isometry/Models/ClaudeModels.swift"
      provides: "Claude API request/response models"
      exports: ["ClaudeRequest", "ClaudeResponse", "MessageContent"]
    - path: "native/Sources/Isometry/Views/Notebook/NotebookShellView.swift"
      provides: "Enhanced shell with Claude integration"
      contains: "/claude command handling"
  key_links:
    - from: "NotebookShellView.swift"
      to: "ClaudeAPIClient"
      via: "command routing for /claude prefix"
      pattern: "claudeAPIClient\\.sendMessage"
    - from: "ClaudeAPIClient.swift"
      to: "URLSession"
      via: "HTTPS API calls"
      pattern: "URLSession\\.shared\\.dataTask"
---

<objective>
Integrate Claude Code API using native URLSession for AI-assisted development commands

Purpose: Enable direct Claude API communication without browser dependencies, providing native AI integration for development workflows
Output: Working Claude API client with command routing and response formatting for terminal display
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Previous plan foundation
@.planning/phases/06.3-shell-integration/06.3-01-PLAN.md

# React prototype Claude integration
@src/hooks/useClaudeAPI.ts

# Current shell implementation
@native/Sources/Isometry/Views/Notebook/NotebookShellView.swift
@native/Sources/Isometry/Models/ShellModels.swift
@native/Sources/Isometry/Security/SandboxExecutor.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Claude API data models for native integration</name>
  <files>native/Sources/Isometry/Models/ClaudeModels.swift</files>
  <action>
    Create Swift models for Claude API communication based on Anthropic API specification:

    - ClaudeRequest: model (claude-3-5-sonnet-20241022), maxTokens, temperature, messages array
    - ClaudeMessage: role (user/assistant), content array
    - ClaudeContent: type (text), text content
    - ClaudeResponse: id, type, role, content array, model, stopReason, usage
    - ClaudeUsage: inputTokens, outputTokens
    - ClaudeError: type, message for API error handling
    - APIConfiguration: apiKey, baseURL, timeout, maxRetries

    All models Codable for JSON serialization/deserialization with URLSession.
    Use proper Swift naming conventions (camelCase) with CodingKeys for snake_case API.
    Include validation methods for required fields and token limits.
    Add debugging description for development troubleshooting.
  </action>
  <verify>Models compile and can encode/decode sample Claude API JSON responses</verify>
  <done>Claude API models ready for URLSession integration with proper Swift conventions</done>
</task>

<task type="auto">
  <name>Task 2: Create ClaudeAPIClient with URLSession and error handling</name>
  <files>native/Sources/Isometry/API/ClaudeAPIClient.swift</files>
  <action>
    Create production-ready Claude API client using Foundation URLSession:

    - ClaudeAPIClient actor with async sendMessage() method
    - URLSession configuration with proper headers (x-api-key, anthropic-version: 2023-06-01)
    - Request construction with JSON encoding of ClaudeRequest
    - Response handling with proper HTTP status code checking (200, 401, 429, 500)
    - Error handling for network failures, API errors, timeout, rate limiting
    - Token counting and validation before API calls
    - Response streaming support preparation (for future real-time responses)
    - Configuration loading from Bundle.main.infoDictionary or UserDefaults

    Use structured error types: .authenticationFailed, .rateLimited, .networkError, .invalidRequest.
    Include retry logic with exponential backoff for transient failures.
    Log API usage for debugging while protecting API keys from logs.
    Follow Anthropic API documentation exactly for request format.
  </action>
  <verify>API client successfully makes test request to Claude API (requires valid API key)</verify>
  <done>ClaudeAPIClient handles API communication with proper error handling and retry logic</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Claude commands into shell interface with routing</name>
  <files>native/Sources/Isometry/Views/Notebook/NotebookShellView.swift, native/Sources/Isometry/Security/SandboxExecutor.swift</files>
  <action>
    Extend shell interface and executor to handle Claude API commands:

    NotebookShellView enhancements:
    - Command parsing: detect "/claude" prefix for AI commands vs system commands
    - Claude API client integration with @StateObject ClaudeAPIClient
    - API key configuration UI or settings integration
    - Claude response formatting with AI indicator (ðŸ¤–) and proper text wrapping
    - Loading states for API calls with cancellation support
    - Error display for API failures, missing keys, rate limits

    SandboxExecutor enhancements:
    - Add executeClaudeCommand() method alongside executeSystemCommand()
    - Command routing logic: "/claude prompt" -> API call, others -> system execution
    - Context enrichment: include current working directory, recent commands in Claude prompt
    - Response integration: format Claude responses for terminal display
    - Performance tracking: measure API call duration with PerformanceMonitor

    Maintain command history for both system and Claude commands with proper type indicators.
    Use Swift async/await for API calls to avoid blocking UI thread.
  </action>
  <verify>Shell accepts "/claude hello" command and displays formatted AI response</verify>
  <done>Shell routes commands correctly between system execution and Claude API with proper UX</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Native Claude API integration with terminal command routing</what-built>
  <how-to-verify>
    1. Open Isometry native app and navigate to notebook shell
    2. Verify system commands still work: type "pwd" and "echo test"
    3. Test Claude integration: type "/claude what is the current working directory?"
    4. Verify AI response appears with proper formatting and ðŸ¤– indicator
    5. Check error handling: type "/claude" with invalid/missing API key
    6. Test command history: use up arrow to navigate previous commands
    7. Verify performance: commands execute without blocking UI
  </how-to-verify>
  <resume-signal>Type "approved" to continue or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Integration test: Execute both system ("ls") and Claude ("/claude explain this directory") commands successfully
API test: Claude API returns proper responses with authentication and error handling
Performance test: Command execution doesn't block shell interface or cause lag
</verification>

<success_criteria>
- User can execute Claude commands using "/claude" prefix in native terminal
- Claude API responses display with proper formatting and AI indicators
- Command routing correctly distinguishes between system and AI commands
- Error handling provides clear feedback for API issues, authentication, rate limiting
- Shell maintains responsive performance during API calls with proper loading states
</success_criteria>

<output>
After completion, create `.planning/phases/06.3-shell-integration/06.3-02-SUMMARY.md`
</output>