<!DOCTYPE html>
<html>
<head>
    <title>Test Skypack sql.js-fts5</title>
</head>
<body>
    <h1>Skypack sql.js-fts5 Test</h1>
    <div id="log"></div>

    <script type="module">
        const log = document.getElementById('log');

        function writeLog(message, level = 'info') {
            const div = document.createElement('div');
            div.style.padding = '5px';
            div.style.backgroundColor = level === 'error' ? '#ffeeee' : level === 'success' ? '#eeffee' : '#f0f0f0';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(div);
            console.log(message);
        }

        writeLog('Testing Skypack sql.js-fts5...');

        try {
            // Test Skypack CDN version
            writeLog('Importing from Skypack CDN...');
            const initSqlJs = await import('https://cdn.skypack.dev/sql.js-fts5');
            writeLog('✅ Skypack sql.js-fts5 import successful', 'success');

            // Initialize
            writeLog('Initializing Skypack sql.js...');
            const SQL = await initSqlJs.default({
                locateFile: (file) => {
                    const cdnPath = `https://cdn.skypack.dev/-/sql.js-fts5@v1.4.0-0sPlGOgRQX5qc2GXGCPK/dist=${file}`;
                    writeLog(`Loading from CDN: ${cdnPath}`);
                    return cdnPath;
                }
            });
            writeLog('✅ Skypack sql.js initialization successful', 'success');

            // Test database creation
            const db = new SQL.Database();
            writeLog('✅ Database creation successful', 'success');

            // Test FTS5
            try {
                const ftsResult = db.exec("SELECT fts5_version() AS version");
                writeLog(`✅ FTS5 WORKING with Skypack: ${JSON.stringify(ftsResult)}`, 'success');

                // Test FTS5 table creation
                db.exec(`
                    CREATE VIRTUAL TABLE test_fts USING fts5(content);
                    INSERT INTO test_fts(content) VALUES ('hello world'), ('sql.js rocks'), ('full text search');
                `);

                // Test FTS5 search
                const searchResult = db.exec("SELECT * FROM test_fts WHERE test_fts MATCH 'sql'");
                writeLog(`✅ FTS5 search test: ${JSON.stringify(searchResult)}`, 'success');

            } catch (e) {
                writeLog(`❌ FTS5 test failed: ${e.message}`, 'error');
            }

            // Test recursive CTE
            try {
                const cteResult = db.exec(`
                    WITH RECURSIVE test_cte(n) AS (
                        SELECT 1
                        UNION ALL
                        SELECT n+1 FROM test_cte WHERE n < 3
                    )
                    SELECT COUNT(*) as count FROM test_cte
                `);
                writeLog(`✅ Recursive CTE test: ${JSON.stringify(cteResult)}`, 'success');
            } catch (e) {
                writeLog(`❌ Recursive CTE test failed: ${e.message}`, 'error');
            }

            db.close();
            writeLog('✅ Skypack sql.js-fts5 tests completed!', 'success');

        } catch (error) {
            writeLog(`❌ FATAL ERROR: ${error.message}`, 'error');
            writeLog(`Stack trace: ${error.stack}`, 'error');
        }
    </script>
</body>
</html>