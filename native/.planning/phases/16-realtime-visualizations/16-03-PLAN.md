---
phase: 16-realtime-visualizations
plan: 03
type: execute
wave: 2
depends_on: [16-01, 16-02]
files_modified: [
  src/contexts/PAFVContext.tsx,
  src/hooks/usePAFVLiveData.ts,
  src/components/PAFVNavigator.tsx,
  src/utils/query-builder.ts
]
autonomous: true

must_haves:
  truths:
    - "PAFV filters trigger live data subscription updates"
    - "Drag-and-drop filter changes update visualizations instantly"
    - "Filter combinations generate optimized live queries"
    - "Visual feedback shows real-time data impact"
    - "Complex filters maintain <100ms response time"
  artifacts:
    - path: "src/contexts/PAFVContext.tsx"
      provides: "PAFV context with live data integration"
      exports: ["PAFVProvider", "usePAFV"]
      min_lines: 200
    - path: "src/hooks/usePAFVLiveData.ts"
      provides: "Live data subscriptions for PAFV filters"
      exports: ["usePAFVLiveData"]
      min_lines: 150
    - path: "src/utils/query-builder.ts"
      provides: "Dynamic SQL query generation"
      exports: ["buildPAFVQuery", "optimizeQuery"]
      min_lines: 100
  key_links:
    - from: "src/contexts/PAFVContext.tsx"
      to: "useLiveData"
      via: "subscription management"
      pattern: "useLiveData.*filter"
    - from: "src/hooks/usePAFVLiveData.ts"
      to: "query-builder"
      via: "dynamic query generation"
      pattern: "buildPAFVQuery.*wells"
---

<objective>
Integrate PAFV filtering system with live data subscriptions to enable real-time visualization updates as users drag and configure filters.

Purpose: Transform the PAFV interface from static configuration into a dynamic real-time system where filter changes immediately update visualizations with live data, providing instant visual feedback on filter impact.
Output: Live PAFV system with real-time query optimization and visualization updates
</objective>

<execution_context>
@/Users/mshaler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mshaler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/16-realtime-visualizations/16-01-PLAN.md
@.planning/phases/16-realtime-visualizations/16-02-PLAN.md
@src/contexts/PAFVContext.tsx
@src/hooks/useLiveData.tsx
@src/components/PAFVNavigator.tsx
@src/filters/FilterCompiler.ts
</context>

<tasks>

<task type="auto">
  <name>Enhance PAFV Context with Live Data Integration</name>
  <files>src/contexts/PAFVContext.tsx</files>
  <action>
    Upgrade PAFVContext to integrate with live data subscriptions and real-time updates:

    Enhanced PAFVContext features:
    - Add live data state management alongside existing wells configuration
    - Integrate useLiveData for automatic subscription management
    - Add query generation based on current PAFV configuration (wells state)
    - Implement intelligent subscription pooling to avoid duplicate queries
    - Add performance tracking for filter-driven queries
    - Include automatic cache invalidation when PAFV configuration changes

    New context state additions:
    ```typescript
    interface PAFVContextType {
      // Existing wells management
      wells: Wells;
      moveChip: (...) => void;
      toggleCheckbox: (...) => void;
      transpose: () => void;

      // New live data integration
      currentQuery: string;
      filteredData: Node[];
      isLoading: boolean;
      error: string | null;
      queryMetrics: QueryPerformanceMetrics;
      refreshData: () => void;
      subscriptionId: string | null;
    }
    ```

    Integration approach:
    - Use useEffect to watch wells changes and trigger new subscriptions
    - Implement debounced updates (200ms) to prevent excessive re-querying during rapid filter changes
    - Add query optimization to combine multiple filter operations efficiently
    - Preserve existing drag-and-drop functionality while adding live updates
  </action>
  <verify>PAFV context manages live data subscriptions, wells changes trigger query updates</verify>
  <done>PAFVContext integrates live data with filter state management</done>
</task>

<task type="auto">
  <name>Create PAFV Live Data Hook and Query Builder</name>
  <files>src/hooks/usePAFVLiveData.ts, src/utils/query-builder.ts</files>
  <action>
    Build specialized hook for PAFV-driven live data subscriptions and dynamic query generation:

    usePAFVLiveData hook:
    - Accept wells configuration and generate corresponding SQL queries
    - Manage multiple subscription types (nodes, aggregations, counts)
    - Implement intelligent caching for common filter combinations
    - Add performance monitoring specific to filtering operations
    - Handle complex PAFV scenarios (multiple rows, columns, z-layers)
    - Provide subscription lifecycle management with proper cleanup

    Hook interface:
    ```typescript
    interface PAFVLiveDataResult {
      data: Node[];
      aggregations: Record<string, number>;
      isLoading: boolean;
      error: string | null;
      queryText: string;
      performance: PAFVQueryMetrics;
    }

    export function usePAFVLiveData(wells: Wells, options?: PAFVOptions): PAFVLiveDataResult
    ```

    query-builder.ts utilities:
    - buildPAFVQuery: Convert wells configuration to optimized SQL
    - optimizeQuery: Analyze and improve query performance
    - generateAggregationQuery: Build COUNT/GROUP BY queries for summary stats
    - combineFilters: Efficiently merge multiple filter conditions
    - validateQuery: Ensure query safety and performance
    - cacheQueryPlan: Store optimized query plans for reuse

    Query optimization strategies:
    - Use indexes efficiently based on filter columns
    - Minimize JOINs when possible
    - Pre-aggregate common grouping combinations
    - Use prepared statements for performance
  </action>
  <verify>Hook generates correct queries from wells, query builder produces optimized SQL</verify>
  <done>usePAFVLiveData and query builder enable dynamic filter-based subscriptions</done>
</task>

</tasks>

<verification>
- PAFV filter changes immediately trigger live data subscription updates
- Drag-and-drop operations update visualizations in real-time
- Query builder generates efficient SQL from wells configuration
- Performance monitoring tracks filter query execution times
- Complex filter combinations maintain sub-100ms response times
</verification>

<success_criteria>
- PAFV interface provides instant visual feedback on filter changes
- Live data subscriptions automatically update when filters are modified
- Query generation handles all PAFV configuration scenarios correctly
- Performance remains optimal with complex multi-dimensional filters
- Integration maintains existing PAFV drag-and-drop functionality
</success_criteria>

<output>
After completion, create `.planning/phases/16-realtime-visualizations/16-03-SUMMARY.md`
</output>