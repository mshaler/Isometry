# Implementation Plan: Canvas Pan/Zoom Controls

**Spec:** [[canvas-pan-zoom-controls]]
**Status:** Approved
**Created:** 2026-01-23
**Updated:** 2026-01-23

---

## Approach

Integrate D3's `d3-zoom` behavior with React's PAFVContext. The D3 canvas will read zoom transform from context and apply it to the SVG group. User interactions (mouse, touch, keyboard) will update the context via D3's zoom behavior callbacks.

Key insight: D3 zoom behavior can be connected to React state by using the `on('zoom')` callback to update context, rather than letting D3 manage transform internally.

## Critical Files

Files that will be modified or created:

- `src/state/PAFVContext.tsx` - Add `zoomTransform` to state, add actions to update it
- `src/hooks/useD3Zoom.ts` - NEW: Custom hook to setup D3 zoom behavior
- `src/views/Canvas.tsx` - Apply zoom transform from context to D3 SVG group
- `src/components/ZoomControls.tsx` - NEW: Reset button and keyboard shortcuts
- `src/types/pafv.ts` - Add `ZoomTransform` type

## Implementation Steps

- [ ] Step 1: Add zoom state to PAFVContext
  - Files: `src/state/PAFVContext.tsx`, `src/types/pafv.ts`
  - Risk: Low
  - Changes:
    - Add `zoomTransform: { k: number, x: number, y: number } | null` to state
    - Add `setZoomTransform(viewId: string, transform: ZoomTransform)` action
    - Add `resetZoomTransform(viewId: string)` action
    - Store per-view in Map<viewId, ZoomTransform>

- [ ] Step 2: Create useD3Zoom hook
  - Files: `src/hooks/useD3Zoom.ts` (new)
  - Risk: Medium
  - Changes:
    - Accept `containerRef` and `onZoomChange` callback
    - Setup D3 `d3.zoom()` behavior on mount
    - Configure scale extent: [0.1, 10] (min/max zoom)
    - Attach to SVG container
    - Call `onZoomChange` with transform on zoom events
    - Return reset function

- [ ] Step 3: Integrate zoom in Canvas component
  - Files: `src/views/Canvas.tsx`
  - Risk: Medium
  - Changes:
    - Get `zoomTransform` from PAFVContext for current view
    - Use `useD3Zoom` hook
    - Pass `setZoomTransform` as `onZoomChange` callback
    - Apply transform to SVG `<g>` element: `transform={translate(${x},${y}) scale(${k})}`
    - Ensure D3 elements are rendered inside transformed group

- [ ] Step 4: Add ZoomControls component
  - Files: `src/components/ZoomControls.tsx` (new)
  - Risk: Low
  - Changes:
    - Reset button that calls `resetZoomTransform`
    - Keyboard event listener for +/- keys (zoom in/out)
    - Keyboard event listener for arrow keys (pan)
    - Display current zoom level (optional)
    - Position fixed in bottom-right corner

- [ ] Step 5: Wire up keyboard shortcuts
  - Files: `src/components/ZoomControls.tsx`, `src/hooks/useD3Zoom.ts`
  - Risk: Low
  - Changes:
    - `useEffect` with keyboard event listener
    - Map + key to zoom in, - to zoom out
    - Map arrow keys to pan (modify transform.x/y)
    - Prevent default browser zoom

- [ ] Step 6: Test and refine bounds
  - Files: All above
  - Risk: Low
  - Testing:
    - Test with large dataset (100+ nodes)
    - Verify smooth performance
    - Test on mobile Safari for gesture conflicts
    - Adjust scale extent if needed

## Testing Verification

How to test end-to-end after implementation:

1. Run `npm run dev`
2. Load graph view with many nodes
3. Mouse wheel zoom - verify canvas zooms around cursor
4. Click-drag - verify canvas pans
5. Press "+" key - verify zoom in
6. Press arrow keys - verify pan
7. Switch to timeline view, then back - verify zoom is preserved
8. Click reset button - verify returns to initial state
9. On mobile: test pinch-to-zoom

Expected result: All interactions work smoothly, zoom state persists across view switches.

## Rollback Strategy

If something goes wrong:

1. Feature flag: Add `ENABLE_CANVAS_ZOOM` to config, default false
2. Conditional rendering: Only setup zoom if flag enabled
3. Revert PAFVContext changes if state updates cause issues
4. Remove ZoomControls component from Canvas if causing layout problems

## Notes

**Performance considerations:**
- D3 zoom uses CSS transforms which are GPU-accelerated
- Should be smooth even with 1000+ elements
- If not, consider virtualization (separate feature)

**Mobile Safari gesture conflicts:**
- May need `touch-action: none` CSS on SVG container
- Test thoroughly on iOS before marking complete

**Accessibility:**
- Zoom level should be announced to screen readers
- Consider adding "Zoom in/out" buttons for users who can't use keyboard shortcuts
- Test with VoiceOver/NVDA

---

*Generated by Claude Code plan mode on 2026-01-23*
