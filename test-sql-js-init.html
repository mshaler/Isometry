<!DOCTYPE html>
<html>
<head>
    <title>Test sql.js-fts5 Initialization</title>
</head>
<body>
    <h1>sql.js-fts5 Initialization Test</h1>
    <div id="log"></div>

    <script type="module">
        const log = document.getElementById('log');

        function writeLog(message, level = 'info') {
            const div = document.createElement('div');
            div.style.padding = '5px';
            div.style.backgroundColor = level === 'error' ? '#ffeeee' : level === 'success' ? '#eeffee' : '#f0f0f0';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(div);
            console.log(message);
        }

        writeLog('Starting sql.js-fts5 initialization test...');

        try {
            // Test importing sql.js-fts5
            writeLog('Importing sql.js-fts5...');
            const initSqlJs = await import('sql.js-fts5');
            writeLog('✅ sql.js-fts5 import successful', 'success');

            // Test WASM file loading
            writeLog('Initializing sql.js with WASM...');
            const SQL = await initSqlJs.default({
                locateFile: (file) => {
                    const path = `/wasm/${file}`;
                    writeLog(`Loading WASM file: ${path}`);
                    return path;
                }
            });
            writeLog('✅ sql.js WASM initialization successful', 'success');

            // Test database creation
            writeLog('Creating test database...');
            const db = new SQL.Database();
            writeLog('✅ Database creation successful', 'success');

            // Test FTS5
            try {
                const ftsResult = db.exec("SELECT fts5_version() AS version");
                writeLog(`✅ FTS5 available: ${JSON.stringify(ftsResult)}`, 'success');
            } catch (e) {
                writeLog(`❌ FTS5 test failed: ${e.message}`, 'error');
            }

            // Test recursive CTE
            try {
                const cteResult = db.exec(`
                    WITH RECURSIVE test_cte(n) AS (
                        SELECT 1
                        UNION ALL
                        SELECT n+1 FROM test_cte WHERE n < 3
                    )
                    SELECT COUNT(*) as count FROM test_cte
                `);
                writeLog(`✅ Recursive CTE test: ${JSON.stringify(cteResult)}`, 'success');
            } catch (e) {
                writeLog(`❌ Recursive CTE test failed: ${e.message}`, 'error');
            }

            // Test schema loading
            writeLog('Testing schema fetch...');
            try {
                const response = await fetch('/db/schema.sql');
                const schemaSQL = await response.text();
                writeLog(`✅ Schema fetch successful, ${schemaSQL.length} characters loaded`, 'success');

                // Test schema execution
                db.exec(schemaSQL);
                writeLog('✅ Schema execution successful', 'success');

                // Test sample data query
                const result = db.exec("SELECT COUNT(*) as count FROM nodes");
                writeLog(`✅ Sample data: ${JSON.stringify(result)} rows found`, 'success');

            } catch (e) {
                writeLog(`❌ Schema test failed: ${e.message}`, 'error');
            }

            db.close();
            writeLog('✅ All tests completed successfully!', 'success');

        } catch (error) {
            writeLog(`❌ FATAL ERROR: ${error.message}`, 'error');
            writeLog(`Stack trace: ${error.stack}`, 'error');
        }
    </script>
</body>
</html>