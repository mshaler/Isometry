<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLite Database Functionality Test</title>
</head>
<body>
    <h1>SQLite Database Test</h1>
    <div id="status">Loading...</div>
    <div id="results"></div>

    <script type="module">
        console.log('üîß Starting SQLite test...');

        async function testSQLiteDatabase() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');

            try {
                statusDiv.innerHTML = 'Loading sql.js...';
                console.log('üì¶ Loading sql.js...');

                // Import sql.js-fts5 (same as SQLiteProvider)
                const initSqlJs = await import('sql.js-fts5');
                const SQL = await initSqlJs.default({
                    locateFile: (file) => {
                        console.log(`üîç Loading WASM file: ${file}`);
                        return `/wasm/${file}`;
                    }
                });

                statusDiv.innerHTML = 'SQL.js loaded, creating database...';
                console.log('‚úÖ SQL.js loaded');

                // Create database
                const db = new SQL.Database();
                console.log('üóÑÔ∏è Empty database created');

                statusDiv.innerHTML = 'Loading schema...';
                console.log('üìã Loading schema...');

                // Load schema
                const response = await fetch('/db/schema.sql');
                if (!response.ok) {
                    throw new Error(`Failed to load schema: ${response.status} ${response.statusText}`);
                }
                const schemaSQL = await response.text();
                console.log('üìÑ Schema loaded, size:', schemaSQL.length, 'characters');

                statusDiv.innerHTML = 'Executing schema...';
                console.log('‚öôÔ∏è Executing schema...');

                // Execute schema
                db.exec(schemaSQL);
                console.log('‚úÖ Schema executed successfully');

                statusDiv.innerHTML = 'Querying data...';
                console.log('üîç Querying nodes table...');

                // Query nodes
                const stmt = db.prepare('SELECT COUNT(*) as count FROM nodes WHERE deleted_at IS NULL');
                const result = stmt.getAsObject();
                stmt.free();

                console.log('üìä Query result:', result);

                // Get all nodes
                const allNodes = db.prepare('SELECT id, name, folder, status, grid_x, grid_y FROM nodes WHERE deleted_at IS NULL LIMIT 5');
                const nodes = [];
                while (allNodes.step()) {
                    nodes.push(allNodes.getAsObject());
                }
                allNodes.free();

                console.log('üìù Sample nodes:', nodes);

                statusDiv.innerHTML = `‚úÖ SUCCESS: Found ${result.count} nodes`;
                resultsDiv.innerHTML = `
                    <h2>Results</h2>
                    <p><strong>Total nodes:</strong> ${result.count}</p>
                    <h3>Sample nodes:</h3>
                    <pre>${JSON.stringify(nodes, null, 2)}</pre>
                `;

                // Test FTS5
                try {
                    const ftsTest = db.prepare("SELECT fts5_version() AS version");
                    const ftsResult = ftsTest.getAsObject();
                    ftsTest.free();
                    console.log('üîç FTS5 version:', ftsResult.version);
                } catch (ftsError) {
                    console.warn('‚ö†Ô∏è FTS5 not available:', ftsError.message);
                }

                db.close();

            } catch (error) {
                console.error('üí• Database test failed:', error);
                statusDiv.innerHTML = `‚ùå ERROR: ${error.message}`;
                resultsDiv.innerHTML = `<pre style="color: red;">${error.stack}</pre>`;
            }
        }

        // Run test
        testSQLiteDatabase();
    </script>
</body>
</html>