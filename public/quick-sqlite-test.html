<!DOCTYPE html>
<html>
<head>
    <title>Quick SQLite Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .log { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        pre { background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px; overflow: auto; }
    </style>
</head>
<body>
    <h1>üöÄ Quick SQLite v4 Test</h1>
    <div id="output"></div>

    <script type="module">
        function addLog(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            output.appendChild(div);
            console.log(`[${type.toUpperCase()}]`, message);
        }

        async function quickTest() {
            try {
                addLog('üîß Starting quick SQLite test...', 'info');

                // Test 1: Import sql.js-fts5
                addLog('üì¶ Importing sql.js-fts5...', 'info');
                const { default: initSqlJs } = await import('/node_modules/sql.js-fts5/dist/index.js');
                addLog('‚úÖ sql.js-fts5 imported successfully', 'success');

                // Test 2: Initialize with WASM files
                addLog('üî® Initializing sql.js with WASM...', 'info');
                const SQL = await initSqlJs({
                    locateFile: (file) => `/wasm/${file}`
                });
                addLog('‚úÖ SQLite WASM initialized successfully', 'success');

                // Test 3: Create database and test FTS5
                addLog('üóÑÔ∏è Creating database and testing capabilities...', 'info');
                const db = new SQL.Database();

                // Test FTS5
                try {
                    const ftsResult = db.exec("SELECT fts5_version() AS version");
                    const version = ftsResult[0]?.values[0]?.[0];
                    addLog(`‚úÖ FTS5 working: ${version}`, 'success');
                } catch (ftsError) {
                    addLog(`‚ùå FTS5 failed: ${ftsError.message}`, 'error');
                }

                // Test JSON1
                try {
                    const jsonResult = db.exec("SELECT json('{\"test\": true}') AS result");
                    addLog('‚úÖ JSON1 support working', 'success');
                } catch (jsonError) {
                    addLog(`‚ùå JSON1 failed: ${jsonError.message}`, 'error');
                }

                // Test CTE
                try {
                    const cteResult = db.exec(`
                        WITH RECURSIVE test_cte(n) AS (
                            SELECT 1 UNION ALL
                            SELECT n+1 FROM test_cte WHERE n < 3
                        )
                        SELECT COUNT(*) as count FROM test_cte
                    `);
                    const count = cteResult[0]?.values[0]?.[0];
                    addLog(`‚úÖ Recursive CTE working: ${count}`, 'success');
                } catch (cteError) {
                    addLog(`‚ùå CTE failed: ${cteError.message}`, 'error');
                }

                // Test 4: Load schema and sample data
                addLog('üìã Loading schema...', 'info');
                const schemaResponse = await fetch('/db/schema.sql');
                if (!schemaResponse.ok) {
                    throw new Error(`Schema fetch failed: ${schemaResponse.status}`);
                }

                const schema = await schemaResponse.text();
                db.exec(schema);
                addLog('‚úÖ Schema loaded successfully', 'success');

                // Test 5: Query sample data
                const nodeCount = db.exec("SELECT COUNT(*) as count FROM nodes WHERE deleted_at IS NULL");
                const count = nodeCount[0]?.values[0]?.[0] || 0;
                addLog(`‚úÖ Found ${count} sample nodes`, 'success');

                const sampleNodes = db.exec("SELECT id, name, folder FROM nodes LIMIT 3");
                if (sampleNodes.length > 0 && sampleNodes[0].values.length > 0) {
                    addLog('üìù Sample nodes:', 'info');
                    sampleNodes[0].values.forEach((row, i) => {
                        const [id, name, folder] = row;
                        addLog(`   ${i+1}. ${name} (${folder}) [${id}]`, 'info');
                    });
                } else {
                    addLog('‚ö†Ô∏è No sample data found', 'warning');
                }

                addLog('üéâ All SQLite tests passed!', 'success');

            } catch (error) {
                addLog(`üí• Test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        // Run test immediately
        quickTest();
    </script>
</body>
</html>