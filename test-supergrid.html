<!DOCTYPE html>
<html>
<head>
    <title>SuperGrid Test - Phase 2 Implementation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            padding: 20px;
            background: #2563eb;
            color: white;
            border-bottom: 1px solid #1d4ed8;
        }

        .supergrid-container {
            height: 600px;
            background: white;
        }

        .controls {
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        select, button {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            font-size: 0.875rem;
        }

        button {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
            cursor: pointer;
        }

        button:hover {
            background: #2563eb;
        }

        .status {
            padding: 12px 16px;
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            margin: 16px;
            border-radius: 0 4px 4px 0;
        }

        .error {
            background: #fef2f2;
            border-left-color: #ef4444;
            color: #dc2626;
        }

        .success {
            background: #f0fdf4;
            border-left-color: #22c55e;
            color: #16a34a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ SuperGrid Phase 2 Test</h1>
            <p>Testing SuperStack headers + Grid Continuum with direct sql.js access</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Mode:</label>
                <select id="modeSelect">
                    <option value="gallery">Gallery (0 axes)</option>
                    <option value="list">List (1 axis)</option>
                    <option value="kanban">Kanban (1 facet)</option>
                    <option value="grid">Grid (2 axes)</option>
                    <option value="supergrid" selected>SuperGrid (n axes)</option>
                </select>
            </div>

            <div class="control-group">
                <label>X Axis:</label>
                <select id="xAxisSelect">
                    <option value="">None</option>
                    <option value="category-folder">Category ‚Üí Folder</option>
                    <option value="time-year">Time ‚Üí Year</option>
                    <option value="alphabet-name">Alphabet ‚Üí Name</option>
                    <option value="hierarchy-priority">Hierarchy ‚Üí Priority</option>
                </select>
            </div>

            <div class="control-group">
                <label>Y Axis:</label>
                <select id="yAxisSelect">
                    <option value="">None</option>
                    <option value="time-month">Time ‚Üí Month</option>
                    <option value="category-status">Category ‚Üí Status</option>
                    <option value="hierarchy-importance">Hierarchy ‚Üí Importance</option>
                </select>
            </div>

            <button onclick="refreshGrid()">üîÑ Refresh</button>
            <button onclick="toggleDebug()">üêõ Debug</button>
        </div>

        <div id="status" class="status">
            Initializing SuperGrid with sql.js...
        </div>

        <div id="superGridContainer" class="supergrid-container">
            <!-- SuperGrid will render here -->
        </div>
    </div>

    <script type="module">
        import initSqlJs from './node_modules/.vite/deps/sql__js-fts5.js?v=fcb62855';

        let SQL = null;
        let db = null;
        let nodes = [];

        const statusEl = document.getElementById('status');
        const containerEl = document.getElementById('superGridContainer');

        function updateStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        async function initDatabase() {
            try {
                updateStatus('Loading sql.js WASM...', 'info');

                SQL = await initSqlJs({
                    locateFile: file => `/wasm/${file}`
                });

                updateStatus('Creating database and loading schema...', 'info');

                db = new SQL.Database();

                // Load schema
                const schemaResponse = await fetch('/db/schema.sql');
                const schema = await schemaResponse.text();
                db.exec(schema);

                updateStatus('Loading sample data...', 'info');

                // Create sample nodes for testing
                const sampleData = generateSampleNodes(50);
                sampleData.forEach(node => {
                    db.run(`
                        INSERT INTO nodes (id, name, content, summary, folder, status, priority, importance, created_at)
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
                    `, [
                        node.id, node.name, node.content, node.summary,
                        node.folder, node.status, node.priority, node.importance,
                        node.created_at
                    ]);
                });

                // Load nodes
                const result = db.exec("SELECT * FROM nodes WHERE deleted_at IS NULL");
                nodes = result[0]?.values.map(row => {
                    const cols = result[0].columns;
                    const node = {};
                    cols.forEach((col, i) => node[col] = row[i]);
                    return node;
                }) || [];

                updateStatus(`‚úÖ SuperGrid ready! ${nodes.length} nodes loaded`, 'success');
                renderSuperGrid();

            } catch (error) {
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
                console.error('Database init error:', error);
            }
        }

        function generateSampleNodes(count) {
            const folders = ['Work', 'Personal', 'Projects', 'Archive', 'Ideas'];
            const statuses = ['Active', 'Complete', 'Pending', 'Archived'];
            const priorities = [0, 1, 2, 3];
            const importance = [0, 1, 2, 3];

            const nodes = [];
            for (let i = 0; i < count; i++) {
                const date = new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000);
                nodes.push({
                    id: `node-${i}`,
                    name: `Sample Node ${i + 1}`,
                    content: `This is sample content for node ${i + 1}. Lorem ipsum dolor sit amet.`,
                    summary: `Summary of node ${i + 1}`,
                    folder: folders[Math.floor(Math.random() * folders.length)],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    priority: priorities[Math.floor(Math.random() * priorities.length)],
                    importance: importance[Math.floor(Math.random() * importance.length)],
                    created_at: date.toISOString()
                });
            }
            return nodes;
        }

        function renderSuperGrid() {
            const mode = document.getElementById('modeSelect').value;
            const xAxis = document.getElementById('xAxisSelect').value;
            const yAxis = document.getElementById('yAxisSelect').value;

            // Simple SuperGrid rendering (mimics React component logic)
            let html = `
                <div class="supergrid supergrid--${mode}" style="height: 100%; padding: 20px;">
                    <div class="supergrid__debug" style="background: #f0f9ff; padding: 12px; margin-bottom: 16px; border-radius: 6px; border-left: 4px solid #0ea5e9;">
                        <strong>SuperGrid Debug:</strong><br>
                        Mode: ${mode}<br>
                        X Axis: ${xAxis || 'None'}<br>
                        Y Axis: ${yAxis || 'None'}<br>
                        Nodes: ${nodes.length}<br>
                        SQL.js: ‚úÖ Working<br>
                        SuperStack: ${xAxis || yAxis ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
                    </div>
            `;

            if (mode === 'gallery') {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">';
                nodes.slice(0, 20).forEach(node => {
                    html += `
                        <div style="padding: 16px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s;">
                            <div style="font-size: 2rem; margin-bottom: 8px;">üìÑ</div>
                            <div style="font-weight: 500; font-size: 0.875rem; margin-bottom: 4px;">${node.name}</div>
                            <div style="color: #6b7280; font-size: 0.75rem;">${node.folder}</div>
                        </div>
                    `;
                });
                html += '</div>';
            } else if (mode === 'list') {
                html += '<div style="display: flex; flex-direction: column; gap: 2px;">';
                nodes.forEach(node => {
                    html += `
                        <div style="padding: 12px 16px; background: white; border: 1px solid #e5e7eb; display: flex; justify-content: space-between; cursor: pointer;">
                            <div>
                                <div style="font-weight: 500;">${node.name}</div>
                                <div style="color: #6b7280; font-size: 0.875rem;">${node.summary}</div>
                            </div>
                            <div style="color: #6b7280; font-size: 0.875rem;">
                                ${node.folder} ‚Ä¢ ${node.status}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                // Grid/SuperGrid modes
                const gridData = groupNodesByAxes(nodes, xAxis, yAxis);
                html += `
                    <div style="margin-bottom: 16px; padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                        <strong>SuperStack Headers Preview:</strong><br>
                        ${xAxis ? `Column Headers: ${xAxis} (${gridData.columnHeaders.length} categories)` : 'No column headers'}<br>
                        ${yAxis ? `Row Headers: ${yAxis} (${gridData.rowHeaders.length} categories)` : 'No row headers'}<br>
                        Grid Cells: ${gridData.cells.length}
                    </div>
                `;

                html += '<div style="display: grid; gap: 1px; background: #e5e7eb;"';
                if (gridData.columnHeaders.length) {
                    html += ` grid-template-columns: repeat(${gridData.columnHeaders.length}, 1fr);`;
                }
                html += '">';

                gridData.cells.forEach(cell => {
                    html += `
                        <div style="background: white; padding: 12px; min-height: 80px; border: 1px solid #e5e7eb; cursor: pointer;">
                            <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 8px;">
                                ${cell.rowKey !== 'default' ? cell.rowKey : ''}
                                ${cell.colKey !== 'default' ? cell.colKey : ''}
                            </div>
                            <div style="font-weight: 500; margin-bottom: 4px;">
                                ${cell.nodes.length} item${cell.nodes.length !== 1 ? 's' : ''}
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                ${cell.nodes.slice(0, 2).map(n => n.name).join(', ')}
                                ${cell.nodes.length > 2 ? ` +${cell.nodes.length - 2} more` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            html += '</div>';
            containerEl.innerHTML = html;
        }

        function groupNodesByAxes(nodes, xAxis, yAxis) {
            const cells = new Map();
            const columnHeaders = new Set();
            const rowHeaders = new Set();

            nodes.forEach(node => {
                let colKey = 'default';
                let rowKey = 'default';

                if (xAxis) {
                    colKey = extractNodeValue(node, xAxis);
                    columnHeaders.add(colKey);
                }

                if (yAxis) {
                    rowKey = extractNodeValue(node, yAxis);
                    rowHeaders.add(rowKey);
                }

                const cellKey = `${rowKey}:${colKey}`;
                if (!cells.has(cellKey)) {
                    cells.set(cellKey, []);
                }
                cells.get(cellKey).push(node);
            });

            return {
                cells: Array.from(cells.entries()).map(([key, cellNodes]) => {
                    const [rowKey, colKey] = key.split(':');
                    return { rowKey, colKey, nodes: cellNodes };
                }),
                columnHeaders: Array.from(columnHeaders).sort(),
                rowHeaders: Array.from(rowHeaders).sort()
            };
        }

        function extractNodeValue(node, axisMapping) {
            const [axis, facet] = axisMapping.split('-');

            switch (axis) {
                case 'category':
                    return facet === 'folder' ? node.folder : node.status;
                case 'time':
                    const date = new Date(node.created_at);
                    if (facet === 'year') return date.getFullYear().toString();
                    if (facet === 'month') return date.toLocaleDateString('en-US', { month: 'long' });
                    return date.getFullYear().toString();
                case 'alphabet':
                    return node.name.charAt(0).toUpperCase();
                case 'hierarchy':
                    const val = facet === 'priority' ? node.priority : node.importance;
                    if (val >= 3) return 'High';
                    if (val >= 2) return 'Medium';
                    if (val >= 1) return 'Low';
                    return 'None';
                default:
                    return 'Unknown';
            }
        }

        // Global functions for buttons
        window.refreshGrid = renderSuperGrid;
        window.toggleDebug = () => {
            const debug = document.querySelector('.supergrid__debug');
            if (debug) debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
        };

        // Initialize on load
        initDatabase();
    </script>
</body>
</html>